Gs

ICS515 | ICS VISIBILITY, DETECTION, AND RESPONSE
GIAC Response and Industrial Defense (GRID)

515.2

Visibility and Asset Identification

GIAC

CERTIFICATIONS

SANS

THE MOST TRUSTED SOURCE FOR INFORMATION SECURITY TRAINING, CERTIFICATION, AND RESEARCH | sans.org

© 2021 Robert M. Lee. All rights reserved to Robert M. Lee and/or SANS Institute.

PLEASE READ THE TERMS AND CONDITIONS OF THIS COURSEWARE LICENSE AGREEMENT
("CLA") CAREFULLY BEFORE USING ANY OF THE COURSEWARE ASSOCIATED WITH THE SANS
COURSE. THIS IS A LEGAL AND ENFORCEABLE CONTRACT BETWEEN YOU (THE “USER”) AND
SANS INSTITUTE FOR THE COURSEWARE. YOU AGREE THAT THIS AGREEMENT IS
ENFORCEABLE LIKE ANY WRITTEN NEGOTIATED AGREEMENT SIGNED BY YOU.

With this CLA, SANS Institute hereby grants User a personal, non-exclusive license to use the Courseware
subject to the terms of this agreement. Courseware includes all printed materials, including course books
and lab workbooks, as well as any digital or other media, virtual machines, and/or data sets distributed by
SANS Institute to User for use in the SANS class associated with the Courseware. User agrees that the
CLA is the complete and exclusive statement of agreement between SANS Institute and you and that this
CLA supersedes any oral or written proposal, agreement or other communication relating to the subject
matter of this CLA.

BY ACCEPTING THIS COURSEWARE,USER AGREES TO BE BOUND BY THE TERMS OF THIS CLA.
BY ACCEPTING THIS SOFTWARE, USER AGREES THAT ANY BREACH OF THE TERMS OF THIS CLA
MAY CAUSE IRREPARABLE HARM AND SIGNIFICANT INJURY TO SANS INSTITUTE, AND THAT
SANS INSTITUTE MAY ENFORCE THESE PROVISIONS BY INJUNCTION (WITHOUT THE
NECESSITY OF POSTING BOND) SPECIFIC PERFORMANCE, OR OTHER EQUITABLE RELIEF.

If User does not agree, User may return the Courseware to SANS Institute for a full refund, if applicable.

User may not copy, reproduce, re-publish, distribute, display, modify or create derivative works based upon
all or any portion of the Courseware, in any medium whether printed, electronic or otherwise, for any
purpose, without the express prior written consent of SANS Institute. Additionally, User may not sell, rent,
lease, trade, or otherwise transfer the Courseware in any way, shape, or form without the express written
consent of SANS Institute.

If any provision of this CLA is declared unenforceable in any jurisdiction, then such provision shall be
deemed to be severable from this CLA and shall not affect the remainder thereof. An amendment or
addendum to this CLA may accompany this Courseware.

SANS acknowledges that any and all software and/or tools, graphics, images, tables, charts or graphs
presented in this Courseware are the sole property of their respective trademark/registered/copyright
owners, including:

AirDrop, AirPort, AirPort Time Capsule, Apple, Apple Remote Desktop, Apple TV, App Nap, Back to My
Mac, Boot Camp, Cocoa, FaceTime, FileVault, Finder, FireWire, FireWire logo, iCal, iChat, iLife, iMac,
iMessage, iPad, iPad Air, iPad Mini, iPhone, iPhoto, iPod, iPod classic, iPod shuffle, iPod nano, iPod touch,
iTunes, iTunes logo, iWork, Keychain, Keynote, Mac, Mac Logo, MacBook, MacBook Air, MacBook Pro,
Macintosh, Mac OS, Mac Pro, Numbers, OS X, Pages, Passbook, Retina, Safari, Siri, Spaces, Spotlight,
There’s an app for that, Time Capsule, Time Machine, Touch ID, Xcode, Xserve, App Store, and iCloud are
registered trademarks of Apple Inc.

PMP® and PMBOK® are registered trademarks of PMI.

SOF-ELK@® is a registered trademark of Lewes Technology Consulting, LLC. Used with permission.

SIFT® is a registered trademark of Harbingers, LLC. Used with permission.

Governing Law: This Agreement shall be governed by the laws of the State of Maryland, USA.

ICS$515_2 GO1_07

wv
ve © © Se ew BH wH

» © S&S & S&S &

a

FF © GF OG BG FG

ICS515.2 ICS Visibility, Detection, and Response

| Visibility and Asset

SANS Identification

© 2021 Robert M.Lee | All Rights Reserved | Version GOI_07

The SANS ICS515 —ICS Visibility, Detection, and Response course was developed by Robert M. Lee with input from
a collection of experts, whose diverse work experiences, knowledge, and skills truly blended to cover the specific
content areas for this course. The author would like to thank them for their support and contributions. Please see the
following page.

Robert M. Lee

Robert M. Lee is the CEO and Founder of the industrial (ICS/OT/IIoT) cyber security company Dragos, Inc. He is a
SANS Senior Instructor and the course author of SANS ICS515 — “ICS Visibility, Detection, and Response” and the
lead-author of SANS FOR578 — “Cyber Threat Intelligence.” He is currently also a Department of Energy special
service employee on the Electricity Advisory Committee as the Vice Chair of the Grid Resilience National Security
committee.

Robert obtained his start in cyber security in the U.S. Air Force where he served as a Cyber Warfare Operations
Officer in the National Security Agency. He has performed defense, intelligence, and attack missions in various
government organizations, including the establishment of a first-of-its-kind ICS/SCADA threat discovery mission
blending incident response, threat hunting, and threat intelligence together. Lastly, Robert is author of the book
SCADA and Me, Threat Intelligence and Me, Santa and Me, and the weekly webcomic

http://www. LittleBobbyComic.com

Robert may be found on Twitter @RobertMLee or contacted via email at: RLee@Dragos.com

© 2021 Robert M. Lee 1
Contributions By:

Tim Conway

Tim Conway is currently the Curriculum Lead for ICS Security at SANS. He was responsible for developing,
reviewing, and implementing technical components of the SANS ICS and SCADA product offerings and is the
course author of ICS456 — NERC CIP Essentials. He was formerly the director of CIP Compliance and Operations
Technology at Northern Indiana Public Service Company (NIPSCO). He was responsible for Operations
Technology, NERC CIP Compliance, and the NERC training environments for the operations departments within
NIPSCO Electric. Throughout his career, Tim was previously an EMS computer systems engineer at NIPSCO for
eight years, with responsibility over the control system servers and the supporting network infrastructure. Tim
previously served as the chair of the RFC CIPC, is the current chair of the NERC CIP Interpretation Drafting Team
a current member of the NESCO advisory board, the current chair of the NERC CIPC GridEx 2013 Working
Group, and current chair of the NBISE Smart Grid Cyber Security panel.

2

Michael Assante

Michael Assante was pivotal in creating this course and it was his vision that pushed me to author it. This class is
dedicated to his memory. For those of you who didn’t know Mike, it is almost guaranteed that your career that has
brought you to the ICS community was influenced by him at some point. I wrote this blog on what Mike meant to
me, and why I would not be where I am today without him, I hope these words help keep his memory alive in this
class: http://www.robertmlee.org/goodbye-mike-assante-thank-you-for-literally-everything/

Jeff Shearer and Jason Dely are both members of the SANS “SROC” team that help create and test technical
components for labs. It’s through their work and dedication with Tim that the kits in the class and interactions with
them were possible. They were the masterminds behind a lot of the hands-on kit work and helped immensely.

Dragos team members also significantly contributed to the course through their own research and just countless

conversations. Additionally, Austin Scott, Grant Freter, Jackson Evans-Davies, and others operated the range and
performed red teaming of the ICS range at the Dragos HQ that is used in the course scenario.

2 © 2021 Robert M. Lee

/ / (

q

/

ww ww et
oo 6§§ &§ © S&S S&H Ho Hw Ww

os &

oe

so G&G G&G G&G &S & & S&S J

Section 2 Outline

ICS Protocols
Lab 2.3: ICS . Analysis

Lab 2.4: ICS Network Mapping
ICS515 | ICS Visibility, Detection, and Response

This page intentionally left blank.

© 2021 Robert M. Lee 3

3

1CS515 | ICS Visibility, Detection, and Response

"Given we can never know what's coming at us, we must know what our posture is in real time (in the context of
global situational awareness) and have the ability to tighten defenses in the face of a determined, capable adversary
with the intent of bypassing our defenses or exploiting those defenses for their own purposes." —Richard Schaeffer,
former director of NSA Information Assurance Division (IAD), July 2014

In Section 1, we learned about threat intelligence and its uses for active defense. In Section 2, the goals are to
understand the purpose of asset identification and visibility. We will accomplish this by understanding some key
methodologies such as Crown Jewel Analysis and Collection Management Frameworks. We’lI put those
methodologies to practice leveraging labs with native ICS and IT communications for asset discovery culminating
in a better understanding of ICS protocols. Intelligence is useless if you do not have a good understanding of
yourself and what you care about. This will prepare us for Section 3 where we can use this information quickly for

security purposes.

4 © 2021 Robert M. Lee

4
ee F&F §& CF SF CF CF OC FSF FF we YS

ww Td w~ ow oo) 7

we

Phifeats 4»
Intelligence " *
Consumption

(PHASE 2)

Fabian ae

+ AOD Wiebbelt SER IINRINY Bite 0 raion

ICS515 | ICS Visibility, Detection, and Response

Targeted cyber-attacks are on the rise and represent a serious risk to ICS environments. Research and incident
deconstruction is beginning to show attackers are developing ICS-capable tools and have equipped themselves with
basic knowledge about ICS technology and architectures to be successful. The success of these attacks rest upon
existing ICS vulnerabilities and the inability of existing defensive strategies to deal with prolonged attack
campaigns. Many ICS defenses were optimized to protect against unstructured and nondirected/targeted cybe-
attacks. The majority of strategies rely upon a strong perimeter defense with some host-based protection and good
security hygiene. These defenses are effective against some threats, but they fail to block or illuminate more
advanced intrusion attempts. Many defenses, if breached, provide little to no knowledge of where the adversary has
been and what is occurring inside of the control network. We need to evolve beyond the static perimeter-focused
defense and build new models to complement defense strategies.

Benefits

This step in the cycle will enable you to help the architecture and defense teams stay aware of what the network
topology looks like. Building off of this network knowledge, you can identify network oddities and pair them with
alerts and events on the network to identify the type of adversaries that traditional defenses will not find. You can
help make decisions on whether incident response is needed and provide context to the team. You can also identify
critical parts of the network the team should focus on. The asset identification and NSM phase is the staple that
holds the active defense cycle together. In a more clearly stated way, people operating in this phase should think of
having four main goals:

* Identify network assets and connections that the architecture and defense teams missed and pass them to
those teams for their awareness and use.

* Make recommendations to the architecture and defense teams regarding network segmentation,
chokepoints, and additional sensors that would benefit NSM.

* Identify threats in the network past what traditional defenses would find and make recommendations to the
defense team for the tuning of sensors and defense assets.

* Identify if a threat is severe enough to initiate incident response and make recommendations to management
regarding this while offering context to the events.

© 2021 Robert M. Lee 5

5

Course Scenario Goals (1)

* Calistoga Refinery
* What are the names and IPs of the Operator stations (HMI/EWS/Historian)

What is the make and model of 10.10.20.10?

* What is the adversary’s IP address and domain?

* What is the name of the malicious project file?

* What did the adversary do to the safety PLC?

* What is the malicious routine in the logic and what does it do?

* What is the root cause of the attack?

Is the incident connected to C3P0’s incident?

°

* C3PO:
* Create a topology of the control network.

* What is the malicious action on the HMI? _

* What Register was manipulated with what value?

* What malicious file executed on the HMI and when?

ICS5IS | ICS Visibility, Detection,and Response 6

This page intentionally left blank.

6 © 2021 Robert M. Lee

/

\

/

Ww Ww Ww S
Case Study: Bhopal Disaster

o .
ICS515 | ICS Visibility, Detection,and Response 7

This page intentionally left blank.

© 2021 Robert M. Lee
Bhopal Industrial Disaster Overview

+ Bhopal, India industrial disaster the night of Dec 2-3" 1984
¢ Union Carbide India Limited (UCIL) pesticide plant

+ Corporate negligence and safety issues resulted in methyl isocyanate (MIC) gas leak \
* Over 3,000 deaths (estimates up to 20k) and hundreds of thousands injured
+ Single largest industrial safety accident up to that point in time

| e Isnoted as one of the major catalysts for the increased safety culture in industry
: + Process Safety Management received a lot more attention and companies began
—--—3) tracking safety investments and efforts at a board level to encourage a culture of safety _

ICS515 | (CS Visibility, Detection,and Response 8

On the nights of December 2" and 3" in 1984 there was an industrial accident, the worst of its kind up to that point.
An underinvestment in safety audits/training/equipment/maintenance and a culture of corporate negligence led toa
preventable accident where there was a release of methyl isocyanate (MIC) gas (used in pesticide production) into
the Bhopal, India area. The “shantytown” that had built up around the plant was under resourced, with poor hospital
staff, and it depended on the plant for much of its economy. The release of gas immediately killed around 3,000
people and unofficial numbers estimate another 16k people died in the coming weeks. Hundreds of thousands were
injured (estimated around 700,000 people) and the MIC gas was noted for increased mortality rates among the
Indian population, a significant rise in miscarriages and birth defects, and general health issues. At first, the
company and its staff distanced themselves from the accident. It was not until the Indian supreme court intervened
that the company ultimately accepted responsibility and paid out around $500M in claims and investment back into

the community.

This horrendous case study is in this class as a reminder of the types of consequences that can happen at industrial
sites even without any malicious actions taken by adversaries. Despite all its horror, the one good thing that came
out of the Bhopal incident was a revitalization of safety initiatives and efforts across the industrial community.
Safety engineering more fully developed into its own practice and effort with specialized skills, training, equipment,
certification, and resourcing to ensure companies could reduce environmental and human harm as a result of

failures at industrial sites.

Reference:
https://en.wikipedia.org/wiki/Bhopal_disaster

8 © 2021 Robert M. Lee

Ww, w wy wy ww ww

=
“pe 4s

“as

Example Systems in a MIC Process

General gas scrubbing

Clean gas

Suction Gas to
Compressor

Liquid Retngerant trom Condenser

Pure
Scrubbing liquid

ICS515 | ICS Visibility, Detection, and Response

Some of the industrial components to be familiar with for this case and as general knowledge would be the gas
scrubber, flare tower, and refrigeration tank/coolers.

A gas scrubber is an industrial process to clean waste gas. In this example, the scrubber takes steam gas (MIC in
this case study) and brings it into contact with a liquid that allows some of the gaseous components to pass through
while the gaseous components that would be considered waste or not desired in the clean gas are dissolved into the
liquid. As an example, in another industry, natural gas, unprocessed natural gas (or “sour gas”) contains hydrogen
sulfide that would damage equipment and generators. A gas scrubber can remove the contaminants so that natural
gas can be utilized without damaging equipment. From a safety perspective, and in context of Bhopal, the gas
scrubber could have cleaned the MIC gas with caustic soda, neutralizing its effects as it was released.

A flare stack is a process that can have both economical and safety considerations. In some industrial processes, the
waste product gas is more expensive to try to utilize and transport than to simply burn off. Therefore, the gas may
be undesirable and burned off over time. Separately, there can be over-pressuring of plant equipment where gas is
extracted as a byproduct (e.g., oil extraction) and during plant startups, shutdowns, maintenance, or simply
unplanned over-pressuring events. Safety valves release the gas into the flare stack to be safely burned off instead
of allowing an explosion, damage to equipment, or the gas to be leaked.

Refrigeration units are leveraged in many industrial environments including heating ventilation and cooling systems
(HVACs) in buildings. In the context of Bhopal, the refrigeration system was connected to tanks storing high purity
nitrogen and MIC. Increasing temperatures can quickly lead to an acceleration of chemical reactions, so
temperature must be niaintained at the appropriate levels. Thus, the refrigeration system, even if a small part of the
process, becomes a critical portion especially from a safety perspective.

All throughout these different processes, there would be core technologies to any industrial process such as valves,
sensors, and ultimately alarms back to operators when there is a deviation in the system beyond the expected norm.

© 2021 Robert M. Lee 9

Refrigeration systems cool gas

before they are pushed
Flare stack/systems burn off throughout the system
Gas scrubbing removes undesirable flammable gas or in

containments from gas over-pressurized situations

9
Reference:
https://emis. vito.be/en/bat/tools-overview/sheets/ gas-scrubbing-general

https://en.wikipedia.org/wiki/Gas_flare
http://siglercommercial.com/wp-content/uploads/201 7/10/03-Water-Cooled-Chillers.pdf

10 © 2021 Robert M. Lee

~~ 7 eo oO oo Oo

o-
rw we we we se ws ww ew we we we ww & ww wy

nd

MIC Process at Bhopal

ICS5I5 | ICS Visibility, Detection, and Response

At UCC a simple mockup of how these systems came together can be found in the image on the slide. MIC refining
would enter into the storage tanks mixed with high purity nitrogen so that there is no oxidization. The tanks act as
storage for the use of MIC in the pesticide production process.

Here we can more clearly see that the Vent Gas Scrubber and the Flare Tower are there from a safety perspective.
If the tanks are over-pressurized, or if they need to discharge gas, they will do so through a relief valve to the gas
scrubber or the flare tower (or ideally through the gas scrubber to the flare tower). What is not easily seen here
though is that in this design only 2 tanks should be full of MIC and the third tank should be utilized only as an
overflow tank so that if Tank 610 or 611 are having issues the MIC can be safely stored in 619. The gas scrubber
here had a capacity of 190 pounds per hour (much less than required where some facilities have scrubbers that were
performing at 60,000 pounds per hour).

The refrigeration unit is not used for overflow but is used to maintain the temperature in the tanks. The MIC in this
process should be stored at 0 degrees centigrade.

Reference:
UCC Ramifications.pdf

© 2021 Robert M. Lee 11

W

IC P&ID

MIC STORAGE TANK

(@FO PROCESS VENT HEADER (PVH)
FROM HIGH PURITY NITROGEN HEADER TO TRANSFER PUMP RETURN

FROM REFRIGERATION UNIT
TO RELIEF VALVE VENT HEADER (RVVH}

FROM MIC REFINING STILL (MRS)

TO DERIVATIVES UNIT
€}

Pi ~ PRESSURE INDICATOR TIA ~ TEMPERATURE INDICATOR/ALARM
PIC ~ PRESSURE INDICATOR/CONTROLLER LIA = LEVEL INDICATOR/ALARM

ICS51I5 | ICS Visibility, Detection, and Response

Another view of the MIC process, from a piping and instrumentation diagram (PID or P&ID) view is contained on
the slide. Here you can see how the physical process should interact with the engineering equipment such as the
valves, pumps, and indicators. The damaging of any of these components could lead to a loss of view or loss of
control of the process by the operators.

Reference:
Process-Reliability.pdf

12 © 2021 Robert M. Lee

2

= 2 2)

™-
wo www

ww we wow we ww we wb ww ww

)

wo w we we

_> «

3

Timeline of Bhopal Disaster

oud 9-11pm Dec 24 ed
: oe es i Water rushed into tank E610 niyo eeobE Dee :
Washing of several pipes tor fag where 42 tons of MIC was being Img WV °"Kers ed MIC smell and
maintenance Stored : saw the leak

40am Dec
12:15am Dec activated, fire spray s not empty
Operator realized pressure rose brought, but not tall enough and thus failed to reduce the
to its maximum value of 55 psi reach the top of the tower. pressure in E610
and a safety valve popped out Attempt
releasing the gas as the T: Police informed; no significant
Freon had been drained mobilization occurred

ICS515 | ICS Visibility, Detection, and Response

8pm Dec 24

Washing of several pipes for maintenance.

Slip blinds required as a safety procedure were not installed due to poor training.
Bleeder valve (overflow) was blocked so water did not drain appropriately.

9-1 1pm Dec 24

Water rushed into tank E610 where 42 tons of MIC was being stored.

Water and MIC create a reaction which quickly raised the pressure and temperature.
Temperature alarms had been previously disabled, and pressure was within an acceptable range.

11:30pm Dec 24
Workers noticed MIC smell and saw the leak.

12:15am Dec 3"4
Operator realized pressure rose to its maximum value of 55 psi and a safety valve popped out releasing the gas.

12:40am Dec 34
Gas sirens activated, fire water sprayers brought, but not tall enough to reach the top of the tower.
Attempts to cool the gas failed as the refrigeration system Freon had been drained

1:00am Dec 34
Spare tank 619E was not empty and thus failed to reduce the pressure in E610

Police were informed, but no significant mobilization occurred.

Reference:
Bhopal RCA.pdf

© 2021 Robert M. Lee 13
Root Cause Analysis

* Significant corporate negligence, human errors, and system errors
occurred

Often in industrial accidents it is not one failure but a series of failures that
can be hard to think about ahead of time though some are obvious

* Major system errors:

°

Vent gas scrubber was not operating or sufficient capacity at time of incident
Flare tower had been under maintenance for weeks (8-hour job normally)
Refrigeration unit offline to save money and Freon shipped to other plants
Inadequate temperature sensing in the tanks

One tank was meant to be an emergency overflow but had MIC stored in it
Inadequate design and maintenance of piping to prevent water flow into tank

ICS515 | 1CS Visibility, Detection, and Response

Root cause analysis is a common process to be performed after a failure or incident in the industrial world. This
connects very nicely with what is necessary in digital forensics and incident response. Unfortunately, with the
growing complexity of our industrial environments, and without proper planning ahead of time, it is getting more
and more difficult to perform root cause analysis. If you do not plan appropriately for what data would be needed,
from what systems or people, you may never be able to accomplish root cause analysis and thus, you cannot learn
and better the environment against the next risk.

There were numerous issues that occurred at Bhopal. Some of the system issues to focus on though were around the

poor maintenance and design of the safety equipment.

As an example, the gas scrubber was constructed to handle a flowrate of 88 Kg of MIC per hour, but the plant
flowrate was actually 20,000 Kg/hr. The storage tanks were meant to carry 5 tons a day and MIC should not be

stored for long periods of time; the MIC was stored for months at a time though and the tanks had 55 tons of MIC in

them. The safety systems that could have helped, such as relief and pressure control valves, had not worked in

months and had major maintenance issues. The MIC relief valve was reading 10 psi, but the actual pressure was 40
psi. The refrigeration unit was meant to keep MIC below 5 degrees Celsius, but it was shut down to save money and

the temperature was ambient. The Freon of the unit was shipped to other plants, so when the unit was activated, it

had no Freon to help. The temperature sensors in the process had been malfunctioning for years, so the operators

had proactively disabled the High Temperature alarms in the control room. No regular recording of temperature in
the log sheets was done as a result, which would have caught the runaway reaction much sooner.

Beyond the system failures, there was significant underpreparing, training, and investment in terms of how to
handle emergency planning and response. Plant personnel, police, and medical personnel were unprepared for the
incident, magnifying the impacts to the local population.

Reference:
UCC Ramifications.pdf

14

© 2021 Robert M. Lee

14

¥Y FY © SS @w ef oo & we mom owt oe m, = -

)

¥ ww Ww S

)

ww f
~~ wa we

-)

emes and Lessons Learned Applied to Cyberse

Understand What Can Go
Wrong (Consequence)

Map it to Cyber

Is it possible to use cyber
means to compromise those
crown jewels?

What are the crown jewels of
the operation?

What would the impact be if What would the attack path be
they failed or were and how would we
manipulated? prevent/detect/respond?

Phe 1 6 NADAS Wl sas

ICS515 | ICS Visibility, Detection, and Response

Bhopal has many corollaries to cybersecurity. Prevention mechanisms failed over time or weren’t properly
maintained. Atrophy of preventive controls in ICS networks is common (any rules in Firewalls, new connections,
not maintaining the defenses). Without the ability to identify that atrophy (visibility) you cannot maintain the value
of the preventive controls. Further, the inability to detect issues (temperature and pressure indicators, as well as
alarms in the physical world map well to collection points and detections in cybersecurity) and respond to them
(having a plan and preparing/rehearsing it) leave you ill-prepared for events.

Crown Jewels are those components of the environment which are critical to its operation. As an example, a
disabled refrigeration unit, disabled alarms, disabled gas scrubber, and disabled flare tower all were crown jewels,
and their failure led to the loss of human life. The modern industrial environment is becoming so complex that you
cannot hope to protect everything. But you should strive to start with the crown jewels and understand “how would
an adversary use cyber as a means to compromise these crown jewels?” Starting with the physical process and its
control elements to determine what’s important, and then mapping it backwards to what attack paths are now
possible through the digital enablement of those components is a very viable way to perform consequence analysis.

It is also easy to condemn that digitization. As an example, it’d be easy to say the safety system shouldn’t be
networked. That may be true in many cases, but in this case other UCC plants decided to network their safety
systems so that they could identify issues faster and be more proactive with maintenance. Those efforts have led to
the saving of human life and environments. Much of the digitization that happens in industrial isn’t just for business
value, but also safety and production value. While it is easy to critique that from a cybersecurity lens, it is important
to see the issues more holistically, and then determine what compensating controls need to be applied to reduce
cyber risk while enabling the business.

© 2021 Robert M. Lee 15

is

Asset Inventories and
Collection Management Frameworks

1CS515 | ICS Visibility, Detection, and Response

This page intentionally left blank.

© 2021 Robert M. Lee

16

ry

ww w ww ww

“s

Importance of ICS Asset Identification

Advanced security solutions are most active on.
hy of fundamental security

Threat ene acarhalietaa’ NSM, and
Incident peepee requires network knowledge

ICS5I5 | ICS Visibility, Detection, and Response

If you do not know what assets you have on your network, or even what networks belong to you, it is nearly
impossible to defend them. Creating ICS asset inventories can be incredibly challenging with the number of
systems, vendors, and contractors present on the network at any given time. Traditional IT asset management tools
that are useful such as Nmap and other forms of active scanning can be harmful to ICS networks. Therefore,
precise, measured, and validated methods are required.

ICS inventorying is also highly concerned with what type of software, firmware, components, and configurations
are operating on an asset. Taking a systematic approach to identifying these aspects is key to understanding the
network and what would be considered normal activity. Process engineers may have this type of information
already, so make sure that as an active defender, you view it and make sure it is viable for network security. (That
is, make sure it is stored in such a way that you can use it.)

It is critical to understand what devices are on each network segment, how they are able (not necessarily
configured) to communicate with each other, and how they transverse segments and networks. We must understand
the attack paths and begin to collect the necessary information to determine the existing and potential attack
surfaces. This requires in-depth knowledge of your ICS. Many organizations do not collect enough information to
aid in identifying attack paths and creating comprehensive attack surface models. In this section, | will share some
tips and tools for how to identify your assets and ready your infrastructure to collect enough of the right type of
information to be successful.

Data and artifacts presented in threat intelligence reports may not be useful without understanding whether those
artifacts are present on your network. When Windows XP reached the end of its life cycle, Oracle announced that it
would no longer support Java 7. If a threat intelligence report discussed an adversary's use of Java 7-based exploits,
it would be extremely useful to know if Java 7 operated on your environment. Are you reliant on Java 7 in your ICS
system? Can you quickly find out? If not, an active defender should quickly work with the architecture personnel to
help perform ICS asset identification. It is ultimately the architecture team's responsibility, but active defenders
possess skills and tradecraft useful to identifying and verifying assets.

© 2021 Robert M. Lee 17

ib

When ICS assets fail, the immediate impact is more important than understanding if the failure was the result of
malicious behavior, configuration errors, or hardware failure. Understanding what caused the device to fail will
quickly become important when remediating the situation in the future and preserving operations. It is critical to
identify the assets and what those assets are connected to. What other assets rely on the failed device? Identifying
assets and dependencies ahead of time can save precious time and personnel hours.

Know Yourself
To actively defend your ICS, you need to know your environment first and foremost. The knowledge you seek goes

beyond simple network maps, extending to how the ICS communicates. This is an area in which an 80-percent
solution will not provide for a credible defense. Countless field assessments have validated that high fidelity and
accurate system knowledge are hard to find. "As built" usually does not reflect the current condition "as operated."
All the existing attack paths should be identified and understood as a foundational element to build your defense.
Paths to your ICS will include network connections, remote access schemes, movement of data and files using
mobile devices, and all interactions involving computing devices. The second imperative is to strive to know how
an adversary might intrude upon, move through, and act inside of the system. You cannot possess useful knowledge
of your adversary if you don't have the ability to monitor throughout your ICS. Many ICS security guidelines
instruct you on how to build defenses that are designed to counter nonstructured and nontargeted cyber threats. This
course is designed to go beyond that guidance to provide the methods, knowledge, and required skills to actively

defend your ICS from all threats.

Network Knowledge Is One Thing Defenders Should Always Have

Ultimately, a full understanding of the network is something that defenders should always have, and attackers
should always have to work hard to obtain. Adversaries should be at a disadvantage. Although the topic may seem
idealistic or even controversial, defense is easier than offense from a technical perspective. (It's often the personnel
and business objectives that cause strife!) Well-prepared defenders who understand their information space
(network topology and activity levels/baselines) will quickly detect anomalies when attackers enter their
environments. An adversary does not "win" by penetrating a network. The adversary has goals and intended
outcomes; denying those goals such as the theft of intellectual property, or the crashing of devices is a win for
defenders. Adversaries are good when they play to their strengths, research and learn about network environments,
and automate their processes as much as possible. Automation personnel and ICS engineers should be familiar with
the idea of research and automation of processes. Use your strengths!

Field of contest knowledge (of your networks) is the defender's greatest advantage over the attacker. Lack of
preparation to exploit this important advantage leaves the majority of the advantage to an attacker. Field
assessments have historically demonstrated that many organizations have incomplete knowledge of their network

topologies, data flows, and hosts.

But That's Hard!

We've all heard it time and time again: "Defense is hard!" There's merit in that line when constantly changing
infrastructure, careless users, and third-party vendors and contractors have open access. It's also difficult when
people like the operator want to administer the system or check on the HMI remotely without concern for security.
These are challenges that make defense hard. But defense is doable. There is no easy solution, but defense can, and

should, have the upper hand over offense.

It is important for defenders to have a methodological approach and a plan of attack of their own for defense.
Security is a process. ICS people, above all else, should understand processes. It takes various tools, various
methods, fine-tuning, kicking some solutions/vendors out, and repeating until the process is perfected.

18 © 2021 Robert M. Lee

wm

A

wy FF S&S WM WO WM WH

w

a] oe

.
w

wv ww wow wo & & &

oT oF wow 8S YS YS WH Ww Hw WH Ww

“5 45

45

Remember also that network security revolves around a lot of trust relationships. Whoever you trust to connect to
your network also trusts other people. Therefore, each connection into your network may have a series of other
"trusted" connections, creating a link between networks you may not actually trust or even know about. Your
vendor network that remotely connects into you...yes, that's part of your network now as well as everything
vendors connect to. We have seen numerous times in the community where infections from an outside network
spread malware into ICS networks. This effectively shortens the ICS Kill Chain and makes it much more difficult to
identify and remediate intrusions. In a few slides, this concept of understanding the networks you are responsible
for, and what they are connected to, will be discussed more in depth.

For now, remember that an active ICS defense requires a fully integrated team to help identify and analyze suspect
behaviors and devise active security actions to disrupt kill-chain progress. Some of the information you need exists
outside of your organization and requires coordination with your ICS manufacturers or integrators to optimize a
"safe" defense action. You also need to integrate functional roles inside your organization to plan, test, and execute
defensive actions. Let's review some of the important roles to include in architecting your active defense from
ICS410.

People are used to filling in parts of the process that cannot be automated. Common roles for people in the ICS
environment are:

1) Process Engineer: Designs the systems and processes used in the control environment
2) Field Technician: Maintains and repairs field devices

3) Programmer: Implements the individual steps of the process as code and deploys the code onto the
controllers

4) Operator: Works in the operations center remotely managing and controlling the process

These traditional roles must be empowered and equipped to integrate with information technology and cyber
security roles to tackle the challenges of complexity, change, and cyber threats.

Vendors (ICS manufacturers) design and build the components used in control systems, such as PLCs and HMIs.
Many vendors offer integration services for their products or sell complete turn-key systems. Many vendors have
several different product lines and have millions upon millions of lines in their codebases. Even though nearly all
ICS vendors have begun to adopt security into their development life cycle, their legacy codebase coupled with the
slow refresh cycles in most control settings pose a security challenge for the ICS community. ICS vendors are
valuable allies to help coordinate your defense plans and assist during incidents. Contractual relationships should be
reviewed to make sure you have their support and have mutual expectations of what they can provide.

ICS vendors include but are not limited to ABB, Alstom (Areva), GE, GE Fanuc, Hitachi, Honeywell, Mitsubishi,
Rockwell Automation, Schneider Electric, Invensys, Emerson, Siemens, and Yokogawa.

Even your on-site personnel or vendor PoCs do not natively understand cyber security (and maybe they do not even
care for it); however, they absolutely have knowledge on the network and a process that you require. Their
experiences and understanding of the network is vital to your success, so be sure to interface with these personnel.
Never underestimate the value of grabbing a cold beverage with someone and asking, "What are you most worried
about?" or "If you were to compromise the facility, how would you do it?" These and other questions not only
illuminate areas you should be looking into, but they also help create trust relationships between you and the
people. When an intrusion does happen, you want people around the network to be comfortable coming to you and
reporting network "oddities." The oddities may be your first inclination of an incident, and those same personnel
may know ways to help you.

© 2021 Robert M. Lee 19
Identifying ICS Assets

_ Determine Area of Responsibility
v
Find and Utilize Existing Info
a

ICS515 | ICS Visibility, Detection, and Response

As discussed earlier, it is extremely important to identify the various assets you have as well as the networks you are
connected to. You may trust your vendors and all the networks they are connected to. You may trust the enterprise IT
networks, and you may even trust all the networks in your organization you aren't responsible for; but from a security
perspective you shouldn't. Any inbound connection and data flowing from outside the areas you have responsibility
for should be interrogated and monitored. Trust but verify.

Determine Area of Responsibility (AOR):

Figure out your AOR, even if you don't have ownership/control over all the devices in it. If you have responsibility
for the network, then you must know everything on it and everything it connects to. Management should identify to
you what your role is and what networks you have authority over. If it can't, then help it to determine this and work
out a plan for what should be considered your AOR.

Find and Utilize Exiting Info

Identify existing maps, diagrams, and inventory lists from personnel already working there, backup or existing
copies, vendors who provide support (they should know their own devices), and so on. Be sure to include all the
assets, even if you do not feel they are an ICS asset. For example, even if your UPS isn't part of your OT but it's
connected to your network via SNMP, it's now part of your responsibility. If taking down the billing server will
impact the ability to task orders through the pipeline and thus lead to a pipeline shutdown, then that billing server is
part of your efforts. This should not be extended to third order effects. As an example, trying to justify how taking
down the website would take down operations through 2™ or 3 order effects would extend too far into Enterprise
security efforts and serve as a distraction.

Validate Known Information

Any information given to you from others should be validated—always validate the information. Do not assume it
actually exists just because it's on a map. Likewise, just because something isn't on the map doesn't mean it doesn't
exist. It is extremely common in the industry to take a walk around a plant floor, point to a device, and ask, "What's
that?" The response "I don't know, it's been there since I got here" is neither fun to hear nor acceptable from a
security perspective. Do not just disconnect things you are unfamiliar with but discover what they are and document
them.

20 © 2021 Robert M. Lee

20

oo

VD)

ww ww ww w

vr P OP OP Oh wh HH HS Hw

w

we
> 7

we ww wo & ww] we ww we ww we we w&

The validation step is done by assessing how detailed the information you receive is, when it was last updated, and
taking a critical look at the reputable nature of the data received. This will allow for you to move into Collecting
and Documenting information to validate (and potentially eliminate bad information) what is least likely to be
accurate first. It is a method to evaluate and prioritize information.

Collect

When performing collection, first utilize the least-intrusive collection methods. For example, if you can use passive
scanning, do that instead of active scanning. If you can find things on maps and validate them yourself, try to avoid
bothering site personnel. When you need to walk the floor to identify assets or prepare your infrastructure for
collection, try to do so when there is a production or testing downtime. At that point, you can pull things such as
ARP tables and configurations from firewalls, routers, and switches. (We discuss this more in a few slides.) Hard
hats and knee pads are sometimes required, and that's okay, but it can be time-consuming. Find out as much as
possible in the least intrusive way to operations and your time.

Document

At this stage, you can add/remove assets and network connections at will, but always include historical records.
(Don't throw away old maps.) If connections existed into your environment but do not now, maybe they will be
turned back on in the future. If a device is no longer on the network, it's useful to have a record of what that device
was in case it shouldn't have been removed.

When you gain a new AOR, you start this process over. Whatever you had identified previously now becomes part
of your existing information. But this also means that you now have to validate that known information again. As
you gain more networks or become responsible for more networks, you might find things out about your previous
network that you did not know. For example, you may not have known that a network switch in a network you did
not control was actually the fail-over redundant point for your core router. That would have been good to know
originally, but as you learn more about other networks, you often learn more about your own.

© 2021 Robert M. Lee 21
Example of an Asset Inventory Record

Location Calistoga Refinery

Location on Site Rack 3 East Corridor

Asset Name Safety PLC
Make ‘Rockwell / Allen-Bradley

Model | 1756 L71/B LOGIX5571
Serial Number oa 011b7012

Firmware Version 33.011

IP Address /10.10.20.10

1CS515 | ICS Visibility, Detection, and Response =

Asset inventories come in many forms and how you record and store information will largely be dependent on what
you need out of the inventory. This slide shows an example of what you might find for an inventory of control
devices in an ICS network. The Serial Number and Firmware Version may not be anything you need. A common
mistake for security professionals is to collect and store every possible piece of data instead of what is necessary to
achieve their goals. That doesn’t mean you don’t want to record easy information to get that might be useful later,
but if you are not using the Firmware Version for anything (e.g., you’re not going to be patching PLCs and don’t
care about the latest firmware on the device) then going through the effort to get the firmware from every device
may be a distraction or, depending on how you collect it, some small risk to operations.

However, every piece of information can be useful with the right use-case. If you have justified what you need the
information for and plan to provide value, especially back to the operations staff, through the collection and storing

of this information, then proceeding is ideal.

In most organizations gathering the type of information listed here will be of high value not only for vulnerability
management, but also use-cases supporting threat detection and incident response.

22 © 2021 Robert M. Lee

vr we wD w

ww
ww ‘>

a> Ww

Asset Identification on a Limited Budget

° Identifying assets and documenting them

does not have to cost money:
* Paid products usually add ease, but it is possible
with open source or native tools
* Four example methodologies:
* Physical Inspection: Time-consuming and

difficult in large environments

Traffic Analysis: Packet capture analysis
safer for ICS environments

Configuration File Analysis: Great approach
to map known assets

Scanning: Fast recommended only when in
process outage or when tuned with assistance of
ICS supplier

ICS515 | ICS Visibility, Detection, and Response

There are constant news reports on how many billions of dollars the critical infrastructure community is worth.
Acquisition cycles in the millions are an industry norm. And it seems there's money out there available for just
about everything, except for the one thing you want to do. However, as asset owners realize that network
understanding and security can benefit reliance and reduce downtimes, additional funding may be made available
for "security." But if you are in the large group of people who do not have budgets to buy the latest and greatest
product, it is important to know how to perform asset identification on a limited budget. Even if you can afford
high-end tools, you need to realize that many paid tools perform functions that open-source tools perform. The paid
tools usually come with support contracts, often speed up the process, and may save precious employee hours.
However, understanding the science behind the paid tools and how to perform the same type of processes with open
source tools is important. There are four principal methodologies to perform asset identification.

Physical Inspection

Physical inspection of assets can be time-consuming and difficult in large environments, especially those that have
geographically separated networks. It can also be dangerous in certain areas. However, it's good to know how to
perform physical inspections, how to identify assets, and how to trace fiber throughout the facility to see what all is
connected and to what. It is not necessarily the best type of asset identification, but there are scenarios in which it is
useful.

Traffic Analysis

Traffic analysis tends to be the safest and least time-consuming method of performing asset identification. OSI
Layer 1 differences will exist between various types of devices (as discussed in two slides) such as serial, Ethernet,
or wireless. However, information and data must be passed between connected devices. Understanding what that
data is and how to examine it can help quickly identify assets. For example, Modbus TCP can reveal the IP and
Ethernet addresses of a device as well as the I/O and registers being accessed.

Configuration File Analysis

Configuration files can add additional validation of assets connected on the network. You can also review existing
documents such as engineering documents and network designs to determine what the environment is supposed to
look like. This information is a great overlay on other types of asset identification.

© 2021 Robert M. Lee 23
Active Scanning

The different active scanning methodologies out there range from extremely dangerous to not that risky depending
on your environment and the approaches you take. While it is the riskiest form of asset identification, it can provide
the fastest asset identification capabilities and in many cases will get more information from the asset for the
inventory. However, because we do not have the topology or how the communications are actually occurring, it can
be limited for security purposes.

24 © 2021 Robert M. Lee

To wo oo © oo wow ww HS

ip

ww

ww
we we FF FSF OF SF BS BS GS WS WwW

ov

Physical Inspection

* Slowest form of asset identification but
important for non-networked devices
and rectifying what is logically present
through other methods

Important for dual homed systems,
controllers with multiple cards and
I/O, and identifying opportunities for
collection (e.g., tracing cable to
switches)

* Non-networked equipment such as
safety/protective measures can greatly
inform how to address cyber risk

ICS515 | ICS Visibility, Detection, and Response

Before setting out to trace fiber or physically inspect devices, make sure the environment is safe and other
personnel operating in the area know that you are there. Try to identify hotspots such as marshaling cabinets,
equipment and I/O racks, and distribution panels. Overlap often exists between devices in mesh and star type
configurations, so identifying central points (such as a core router) and tracing the fiber in a hierarchical manner
can help identify devices. Marking a device after you inspected it can be helpful, but it is also likely distracting in
the network environment. So instead keep good documentation using things such as serial numbers of the devices.

Image Reference:
https://www.researchgate.net/figure/Electric-control-cabinet_fig]_323150366

© 2021 Robert M. Lee 25
Configuration Analysis

guke &

* Configurations can tell you how the system or
network is designed to operate
ARP tables identify devices registered
Firewalls identify allowed routes and
devices
Controllers identify what ports, protocols,
commands, and logic are standard

Engineering and network documents can
identify the physical or logical layout

* Useful for knowing the intention of the
configuration and design but limited on
identifying the reality of how it is used

ICS515 | ICS Visibility, Detection, and Response

ARP Tables

ARP tables will reveal MAC and IP pairings on the network. Gathering configuration files from networked devices,
especially central points such as a router or switch, will quickly identify registered devices on the network,
including rogue devices and passive sniffers. However, unmanaged switches will not have ARP tables that you can
access. Unmanaged switches still maintain ARP tables (only hubs and repeaters do not) but because you cannot
access the device, you cannot gather this data. A good methodology is to identify the managed switches in your
network (you will need to do this to passively collect traffic from them later anyway) and export the ARP tables. If
you are local, you can export the files and view them later. If you are viewing the ARP tables remotely, the files can
be used later, but it is likely just as useful to view them and document them on the spot. This will help reduce errors
as you have the original file to examine in front of you.

Vendors may have different commands to export or view the ARP table. For example, on Cisco switches, you will
log in to the switch and on the command line execute the command show arp to view the ARP table. Ona
Windows device, you would log in and then from the command line execute the command arp ~a. Notice that the
process itself is the same. Log in, run a specific command, and view the arp table. You should document what you
see and export the file. Keeping copies of the files will allow you to keep historic records and verify if there were
changes over time. However, be sure to store these files securely (that is, encrypted and password protected). If you
have configuration files, asset lists, and network maps on a computer, it is a treasure trove for adversaries to find.
Do not let them copy your homework.

Many IP-connected PLCs send out only an ARP request when it is started initially. This means that you see the
device registered on the switch with its IP and MAC address, but you cannot observe additional ARP traffic in live
captures of the network data. That is, if you run Wireshark, do not be surprised if many of your IP-connected PLCs
are not sending ARP traffic.

Value:
Find IP addresses associated with hardware addresses
Identify passive devices (potential sniffers) on the network
26 © 2021 Robert M. Lee

26

ovo ovo & wt ve oe

wo

o oo wo w wo w

oo

eC

@e
ww we wow we of Qe ww

ws

SE SF ae ae fw

oo 8 § %§%§ S&F FS WS WwW

“pe

Source:

Managed switches, routers, or individual Windows/Linux clients
Methodology:

Switches, routers, and clients have similar but vendor-specific commands

View the ARP tables on the device or export the file for viewing later

Document the observed assets and keep historical records to check and validate changes over time
The “ICS” Aspect:

Many control devices may only ARP when they are initially turned on

When systems are rebooted or maintenance periods are done, collect captures to gather ARPs

Firewall Configurations

Firewall configurations show you what routes and ports are opened or filtered on the network. When adversaries move
around the network, if they do not already have privileged access, they often collect network traffic information
through passive or active means. Most of us are familiar with the fact that a firewall can help keep attackers out by
denying them access to specific IP ranges and subnets as well as ports and services. However, a firewall can also
shape the adversary's view of the network. When the attackers’ scans and information gathering is complete, they
won't see all the traffic and devices behind a properly configured firewall. Because the attacker won't know that those
devices exist, they will likely not be the first to be impacted. Understanding your network topology is not only useful
for asset and network identification, but it's also useful to understanding how to think like the adversary and identify
key points that are likely to be impacted first.

Firewalls all have configuration files and they will be accessible through the command line or a remote management
window. Determine the type of firewall and search vendor and user manuals or Google (we don't use Bing in this
class) for the proper way to access and export the configuration files. A Linux system's configurations can be viewed
by running iptables -—L from the command line. A Windows firewall can be viewed by running the command
netsh advfirewall firewall. Most higher-end firewalls have a remote management capability where simply
logging into the firewalls management interface reveals options to view and download configuration files. In addition,
there are Windows PowerShell scripts available (once you have the basics down) for many different types of firewalls
to expedite and automate the process of exporting configuration files. Exporting firewall configurations will not let
you view them on just any system. You need to have test equipment to view the configuration files on, or be
comfortable with parsing them in Excel (many policy rules and configuration files allow Exce! viewing), or have a
paid product that examines supported configuration files (such as Solar Wind's Firewall Security Manager that can
view different vendor configuration files and make changes as needed.)

After you have viewed the configurations of the firewall, be sure to document the routes and ports in your
environment and whether they are filtered or opened. Focus on highlighting the open routes and ports and then noting
on your network map that everything else is filtered or closed. It is useful to not only know what IP addresses exist on
your network but also what ports they are currently configured with because this helps identify the type of services
they are running. For example, an IP-connected device with port 502 open is likely running Modbus TCP.

Value:
Determine routes and ports opened or filtered on the network
Source:
Firewall configuration files
Remote management window
Methodology:
Identify the type of firewall
Search for vendor or user manuals for the methods of accessing config files
Examine and document the ports, services, and routes that exist
The “ICS” Aspect:
Remote access is common in an ICS and may be rarely used
Do not close ports without fully understanding them or asking all parties involved
Monitor unused ports and set alerts for a while before closing

Image Reference:
https://www.edrawmax.com/pid/

© 2021 Robert M. Lee 27
Traffic Analysis

Passive analysis of network traffic and
extracting information out of
communication records such as
protocol analysis

Creates an inventory as well as being
vital for creating a topology of the
network

Essential for threat detection and root
cause analysis of failures/errors
Safest/Fastest method of gaining the
most complete picture

[EER AE

promainnncmnmiy
Ethernet: 16

Address w Packets Byt
Vmware _66:eb:86

AsixElec_8f:0a:a0
RsAutoma_03:8c:5¢
Rockwell_a0:a9:50
| Vmware_2e:92:98
PhoenixC_96:08:46
PhoenixC_96:80:07
PhoenixC_96:80:08
PhoenixC_b3:1f:ab
LLDP_Mutticast
1¢:1b:0d:01:16:3e
Siemens-_95:af:e1
Siemens-_95:af:e2
iPv6mcast_00:01:00:02
Broadcast

ICS515 | ICS Visibility, Detection, and Response

28

DD @® oe oe

w @®

wo

™

Traffic analysis, also known as passive scanning, is a fast and safe way to analyze communications on the network.
More importantly, instead of just giving you an inventory, it helps you identify how systems are communicating and
allows you to analyze their protocols/communications/etc. not only for further asset information but also threat
detection use cases. It is an essential part of analyzing systems especially for root cause analysis - whether a failure

@

or issue arises from a threat, or from maintenance issues.

28

© 2021 Robert M. Lee

oe @ 1D @ 7 o ® @ nD

o
>»

wo we wo we Se ee Oe we eS we I SS

Active Scanning

* Querying a device with network
communications to solicit
information
Can be done poorly (randomly
scanning devices) and well
(using native communications

and expected ICS protocols)
Helps create an inventory but
not how devices are
communicating

In any form still poses risk to the
device and operations, best used
in maintenance periods or labs

ICSS15 | ICS Visibility, Detection, and Response

While traffic analysis (or passive scanning) can pull out much of the same information that is found in active
scanning, it still must traverse the network to make that information possible. ‘his can take time and, in some cases,
may never happen. Active scanning can solicit that information directly and on demand, making it a preferred
method when that level of information is required. However, whether you are sloppily doing a scan (random nmap
scan on things you do not fully understand) or using more professional methods or tools to solicit the information
with known means to the device such as native ICS protocols, there is absolutely risk. For some reason, debate
exists about this in the community but regularly ICS515 students share stories of using even purposely developed
ICS tools in an active scanning mode and crashing controllers. There are many reasons this can happen. Sometimes
the device can handle the communication, but only a certain amount of communication records. As an example, a
specific PLC might only be able to have 10 sessions at any given time and a legitimate 11" will cause a previous
one to be dropped, which might be a critical communication. Further, you must already deeply understand your
inventory to use this type of method, which in some ways can invalidate the necessity in the first place.

In my own experience I have responded to multiple plant failures as well as noticeable and costly outages due to
active scanning, even with purpose built ICS tools. The trust between IT and operations is immediately destroyed
for years as a result. Additionally, if anything goes wrong, even if it’s not your specialized tool, when the plant trips
or a failure occurs on the network, that active scanning tool is likely the first to get blamed.

My recommendation is to leverage active scanning tools not in a continuous mode or in a permanently deployed
tool but instead as an assessment tool. Leverage it in a lab environment and then in production with the oversight of
operations during down time such as a maintenance period. Additionally, make sure there is a point to the scan, i.e.,
don’t just do it to get an understanding for a vulnerability that you are not going to do anything about anyway.
There is risk ,even if small, to any type of action taken in an ICS, and it needs to have appropriate value as a return
to justify the actions.

Image Reference:
https://github.com/mushorg/conpot/issues/373

© 2021 Robert M. Lee 29

29

e” Safety Systems

° Active Safety Systems
* Require electronic feedback or input
* May bea control system such as a PLC
* Often “takes control” at a setpoint
° Passive Safety Systems
¢ Require no electronic feedback
¢ Often designed into the overall system
* Insome cases ensure a “fail safe” scenario such as
in a nuclear reactor
* Safety systems should be standalone systems
not connected to the network when possible
* Identifying networked safety systems is a major
find and discrepancy unless absolutely required
 - * Physical controls are not often detailed in an asset
inventory but important to understand

Ref: Westinghouse AP1000 System

ICSS515 | ICS Visibility, Detection,and Response — 30

Safety systems such as the Safety Instrumented System (SIS) are governed in their design by ISA 84.01/IEC61511
and in their function by IEC 61508. There are additional versions such as IEC 61513 for specific industries (such as
nuclear) as well. These standards are robust in how systems are designed and operated, considering a wide variety
of problems that an engineer cannot predict. They are designed for safety regardless of what causes the incident,
whether it is an earthquake or a cyber-attack.

The reason it is important to understand these systems is because there are aspects of the ICS working against an
attacker’s goals. If the attacker wants to do physical damage and there is a safety system in place, they will need to
bypass it. This is easier said than done. Good safety systems are designed into the system and are the byproduct of
engineering. An “active” safety system is one that can make decisions based off of a setpoint. Consider a PLC that
governs another aspect of the process; it takes control when a set point is reached. A “passive” safety system would
be an aspect of the system that is involved regardless of logical decisions and without electrical feedback. An
example of a passive safety system would be in a nuclear reactor where pockets of steam form and slow the
reaction, thus causing the power level and temperature to lower. This is an aspect of how the system is designed—
to “fail safe” regardless of electronic feedback or operator choices. Many passive safety systems do need an
operator to make a choice at some point, though, often hours or days after the incident.

A good example of a passive safety system in nuclear power plants is the Westinghouse nuclear power AP1000
system. This is also where the image is from:

http://www.westinghousenuclear.com/New-Plants/AP1000-PWR/Safety/Passive-Safety-Systems

From the Westinghouse site:

The AP1000 plant’s passive safety systems include:
Passive Core Cooling System (PXS)

Containment Isolation

30 © 2021 Robert M. Lee

WM WS MW

vr wT TF TP TT HT WP HP PW

. © &
Passive Containment Cooling System (PCS)

Main Control Room Emergency Habitability System

High Pressure Safety Injection with Core Makeup Tanks (CMTs)
Medium Pressure Safety Injection with Accumulators

Low Pressure Reactor Coolant Make from the IRWST

Passive Residual Heat Removal

Automatic Depressurization System

© 2021 Robert M. Lee

31
Case Study: Water Distribu

° Water distribution often contains

service zones
* Elevated tanks store water
¢ Water pressure is calculable with altitude
* Over pressurizing would be bad

° Active safety system:

+ Altitude valve cuts flow to tank after a set
point is reached
* Often locally controlled and set
« Passive safety system:
* Rupture disks designed to fail at a
predetermined pressure

* Acombination of the different types
of asset discovery would be required to
see everything

ICS515 | ICS Visibility, Detection,and Response 2

To understand active and passive safety systems, consider a water distribution system. On the right, we see an HMI
for the water distribution system. It details the water reservoirs, the towers, and various components such as valves
that govern the flow of the water. If an attacker or defender got on the network, the HMI would reveal a lot about
the system. Discovery of assets connected via IP protocols would help learn a lot about the system as well.
However, the safety systems are detailed in engineering drawings, not in the network traffic. As an example, each
water tower often has a gauge on the top and bottom (underground) of the tower to determine the pressure and thus
elevation of the water. An active safety system would be a system (maybe a PLC but maybe a physical control
system) that has a set point for the allowable amount of water in the tank. This is called an Altitude Valve. If the
tank goes past the set point, the Altitude Valve will close, ensuring that more water does not flow into the tank.
These valves are often set locally. There is no remote control or connectivity involved.

A passive safety system would be something such as a rupture or burst disk. These types of components help the
system fail at designed points. Instead of allowing an over-pressure scenario to damage the water tower or people’s
homes, the burst disk is rated at a lower pressure than the piping so that if an unsafe surge exists, the disk will burst
to help drop the water pressure in that pipe. Another example would be a surge tank that allows extra water to flow
into it.

This was all detailed masterfully by Patrick Coyle in the SANS blog referenced below (with recommendations for
detecting it on the SCADA side as well as the OT staff side).

Image Reference:
SystemVIEW from Intellisyssoftware.com

Reference:

https://ics.sans.org/blog/20 1 6/04/12/ics-cross-industry-learning-water-distribution-systems-and-how-to-earn-trust-
of-operations

32 © 2021 Robert M. Lee

7-7 2 2
way wa a ‘wy

w iS

“sp ap ap “ps “» “ ww > Ad ws w w w ws ~@ we ww

Building a Collection Management Framework

* It’s not enough to know what you have for many use-cases
* What data do the assets produce?
* Where is the data stored?
* How long am I storing the data?

* Without thinking about the use-cases, threat scenarios, or
incident response scenarios you want to support, you may
not ever have the right visibility and collection in your
environment

ICS515 | ICS Visibility, Detection, and Response

There are many reasons an asset inventory can be useful. Operators and engineers will want this information for
inventory, replacements, components, etc. Security, as well as Operations, may want this information to run down
misconfigurations or troubleshoot issues in the environment. And if you are going to do any level of threat detection
or incident response, you’re going to have to know what you have.

But knowing what you have alone is not enough. It’s becoming more common for organizations to want
“visibility.” But if you don’t know what type of response scenarios you want to handle, what requirements/use-
cases you have such as specific types of TTPs/tradecraft, or what type of scenarios you want to prepare for, you
may not put in the right type of visibility.

As an example, active scanning (polling, gentle caressing, or whatever name folks want to give actively querying
information from a control system) is not really useful for threat detection and response scenarios. Active scanning
though, can be useful for other purposes such as identifying vulnerabilities in a product; given what we know about
the state of vulnerabilities, a discussion on tradeoffs and risk must be had. There are very few things you “cannot
do” in the world of ICS security. But are the things you’re doing worth the risk and investment is the real question.
Active scanning as that example, has absolutely caused plant outages and issues across the world. Multiple times a
year these cases surface. But if that risk is worth it in your organization, then there’s nothing wrong with it.

Either way, I need to know what I want to collect and what to use it for. We also don’t want to get in a situation
where we do a “collect it all” strategy; eventually, you have so much collection that you drown in the data and you
and your analysts never know what they’re looking for and are not focused enough to find it. That’s where the
concept of a collection management framework comes into play.

A collection management framework is an understanding of what you have, what type of data you can get from
your assets, where you store it, and how long you store it. You can also include other information in there, such as
what types of questions that data can answer for you, or scenarios where you’ ve used it in the past, so that you can
create repeatable playbooks, or even segment things by business units or functional purposes.

© 2021 Robert M. Lee 33

33

Whenever possible having a collection management framework (CMF) is a better investment than simply having an
asset inventory.

The paper on Collection Management Frameworks was written by Robert M. Lee, Mark Stacey, and Ben Millerand
can be found here: https://dragos.com/wp-content/uploads/CMF_For_ICS.pdf

34 © 2021 Robert M. Lee

wi

o_o . we @&

oD

' 7] 2 @

=
‘ey =» ea

‘/_

i‘ /-_

wy

A Se oS . a - ie a ed

<s

Example Collection Management Fr

Windows Network Windows Human Remote Terminal Units
Human Data Historian Monitoring Machine interface

Machine Appliance

interface

Windows Event Alarms Alerts Windows Event Logs Syslog
Logs

Exploration, Actions on internal Exploitation, Installation, Installation, Actions on
installation, Objectives Reconnaissance, Actions on Objectives Objectives }
Actions on Command and
Objectives Control, Delivery,

Actions on

Objectives

Registry Keys Set Points and Packet Capture Registry Keys Controller Logic
Tags |

Enterprise SIEM Local Enterprise SIEM Local Local

60 Days 420 Days 30 Days 30 Days 7 Days

1CS$515 | ICS Visibility, Detection, and Response

Here, from the Dragos Collection Management Framework (CMF) paper, we see part of a CMF for an electric
transmission grid company. At the top we have identified the site or location that we are looking at, such as Control
Center or Transmission Substation. If you were to go there to do threat detection or response, one of the first
questions you’ ll have is, “what do I have available to me in terms of data?” The CMF looks to resolve this, so that
you know what coverage you can have with any different type of threat detection you deploy (where can I even see
the threats?) and you have knowledge of what will be available to you in response scenarios.

Underneath each site, you can detail the different assets you have, the data they have, the storage, and the storage
time. Here, the CMF also has other options added in, such as Follow On Collection (if I want to pivot to more data
after I investigate this data, on the same asset, what can I pivot to?) and Question Type (what type of kill chain
questions can this data support?).

As an example, at the Control Center we have a Windows HMI that has Windows Event Logs stored for 60 days in
the Enterprise SIEM. If I need to pull more data, I can get registry keys. I also have a Data Historian with Alarms
stored locally that are available for 120 days. Because they aren’t in the SIEM, I’m not going to be able to use them
for threat detection natively; but in the event of an incident, I have 120 days' worth of Alarms that can help me
understand what’s going on in the physical environment.

Ata glance, | can also overlay the tradecrafi/TTPs of threats I’m concerned about and answer the question “if we
were attacked would we even be able to detect and respond to these threats?”. As an example, let’s say we have a
threat that performs a SCADA Hijack scenario where they pivot through the Enterprise and compromise the
Control Center to open up breakers in the Transmission substation. There are a lot of ways to write detections for
that behavior but it’s likely best done with packet capture (lateral movement between systems and the commands
send to the transmission substation) and whatever connectivity we have from Enterprise to the Control Center (such
as VPN logs or Firewall logs). Yet our data is focused on host and alarms only. We wouldn’t be successful. We
need to adapt our collection to support the use-cases we have.

As another example, it’s good to know that in the Transmission substation, my data is all local (I can sweep
indicators or search for TTPs all | want, but I have 0 visibility into the Transmission substation, so 1 would not see

© 2021 Robert M. Lee 35

35

anything there), and it only goes back 30 days. So if I’m looking for threats based on activity before then, it won’t
be successful.

For larger organizations, it is not efficient to map out every physical site and understand its unique collection.
Instead, we might break our sites into different classifications. As an example, we could say, A, B, and C class sites.
A class sites are the ones the business and operations deem most critical. B sites are somewhat critical. And C sites,
while important, don’t make the cut. In an A class Control Center or an A class Transmission substation, we could
set a profile to nove that we expect 60 days of host logs centrally stored, our ICS network monitoring product of
choice with logs centrally stored for 60 days, Historian logs for 120 days centrally stored, and VPN logs centrally
stored for 60 days. Sites can do more and go above those storage times, but they must have that level of collection
as a profile. Maybe at my B class sites I just have the Firewall logs for 30 days centrally stored and an ICS network
monitoring solution with logs centrally stored for 30 days. And at C class sites it’s everything else (I don’t even
have to make a profile, or I can have a very low bar).

That way, when we write detections or make incident response plans, we know how we should prepare for different
sites and what the coverage is of threat detection across our environment based on the different data types required
for those detections. It also provides us powerful metrics and insight not only for our purposes, but to show a return
on investment for our efforts. As an example, it would be good to track what % of your sites are A, B, and C class
sites and be able to show that, over time we’re moving more C class sites into a B class profile and more B into an
A class profile, or even adding all new threat scenarios and response scenarios into the A class category and
investment to give better coverage to the organization.

This can all be tracked easily in Excel or tools like Confluence and does not need specialized software.

36 © 2021 Robert M. Lee

wv

?.

sy ”? @

=
vw wow vb wes we oe wo ee eo ew

eee es ' Se ve we we ww

Processes, Threat I

Modeling

ICS515 | ICS Visibility, Detection, and Response

There is no one way to build or model a CMF. However, this is one approach that is useful to creating and
maintaining a CMF for your purposes and needs.

The process is straightforward and will be explored in depth over the next few slides:

- Develop New Requirements (what do we want the CMF for in the first place? What are our risks? What is the
problem we’re solving?)

- Develop a Collection Plan (build out the CMF using what we know and have documented or understand
already)

- Implement (figure out the processes and procedures we’re going to leverage to use the CMF to satisfy the
requirement)

- Test (make sure our collection is what we thought it was and that our processes/procedures work with this
collection)

- Update Collection Plan (update the CMF following our testing or note new requirements we need)

Following these simple steps can quickly get you into a place to have a much better understanding of what you do
and do not know in your environment and leverage that for your use-cases.

© 2021 Robert M. Lee 37
Develop New Requirements

¢ Requirements help focus the collection efforts to a need

¢ Requirements originate from a variety of sources:
¢ TIX — What scenarios does the business want to be prepared for?
* Crown Jewels Analysis — What are the most important assets?
* Risk Management — What are the risks that must be mitigated?
* Threat Modeling — What are adversaries actually doing that is relevant to us?
* Triggers — New events that drive collection such as threat hunting or incidents

» Example Requirement:
* Detect and respond to compromises of the safety system at Calistoga Refinery

ICS515 | ICS Visibility, Detection, and Response

In the Develop New Requirements phase, you are trying to identify requirements that help focus your collection
efforts. Far too often analysts take a “collect it all” approach. In some ICS locations, this can be incredibly
burdensome, if not impossible to achieve. As an example, an offshore oil rig is not going to have the bandwidth on
its connectivity methods to bring every log and every data source back to a security operations center. You have to
be more targeted. More importantly, if you actually did have all the data you’d likely drown in the data. Analysts
are better off when they determine their requirements and then expand their collection to what they need to satisfy
those requirements.

There are many ways to determine requirements. One of the best ways is to start with Risk Management practices
of what your organization has already stated they are concerned about, Crown Jewels Analysis on what is most
important to the business, or with Threat Modeling to determine the type of threats you want to be prepared for.
You’ ll likely rehearse one or more of these in a Table-Top Exercise (TTX) where you include personnel from
around the organization and go through a dry run of the scenarios you are concerned with. That should lead to
obvious questions such as: would we even be able to determine if that event happened with our current collection
efforts?

As an example, in our Calistoga Refinery we might want to be prepared to detect and respond to a compromise of
the safety system by an adversary.

38 © 2021 Robert M. Lee

www wf wh w

w

w wm w w wre ww ww ww wh

Ww

ow wr em

7D
ow

’ ve FS wwe ww ww © ww we © © © w w@&

vw vw

NY

evelop A Collection P

* Determine what data sources you’d need to meet the requirement
leveraging domain expertise, situational awareness, and/or intel
* Document what you know you have based on existing knowledge

= Calistoge Refinery Calistoga Refinery Calistoga Refinery’ Calistoge Refinery

Asset Type Triconex Safety System | Engineering Workstation| Domain Controller Network Appliance Network Appliance

Data Type Syslog Windows Host Events _| Windows Host Events _| Network Traffic Analysis Packet Capture

Data Storage Location Local Enterprise SIEM Enterprise SIEM. Network Appliance Network Appliance

Data Storage Time a 7 days 90 days 90 days 6 months 7 days and on demand

ICSSI5 | ICS Visibility, Detection,and Response 3

To satisfy our requirement, in this case about Calistoga Refinery’s safety system, we’d need to understand what
data sources we have. Here you can adapt the CMF fields to your needs, but for simplicity we will look at the Asset
Type, Data Type, Data Storage Location, and Data Storage Time. We can determine the safety system as an
example is a Triconex safety system that has Syslog stored locally for 7 days. Now we know how long we have to
look for a threat (proactively or historically), where we'd have to search, and using what types of detections (in this
case only syslog for that device). We can also document the other systems that are relevant to this requirement, such
as the Engineering Workstation, the Domain Controller on the network, and the fact that this network has a network
appliance monitoring the traffic and generating alerts and insights.

The whole point of the collection plan is building out the CMF using what you already know. It is not yet necessary

(but it’s ok if it’s done in parallel) to go through the systems and data and validate what you actually have available
to you.

© 2021 Robert M. Lee 39
* To implement a CMF you will create processes, procedures, and/or
playbooks to use the collection to meet the requirement

° Examples:
¢ Indicator Sweeps
* Create a process to consume I0Cs related to threats that could compromise safety
systems for reactive scoping; in this case using host-based logs in the SIEM and network
detections for the network appliance
* Tactics, Techniques, and Procedures
+ Create more complex detections in the network appliance and SIEM to look for adversary
behaviors beyond technical indicators for continuous monitoring

* Playbooks

* Create playbooks to quickly investigate the data sources in the event of a detection

ICS515 | ICS Visibility, Detection,and Response 40

In the Implement phase of this process, you are thinking about the requirement you have, the collection you’ve now
documented, and trying to determine how you’d leverage it. As an example, you might choose to perform indicator
sweeps to identify threats after learning about them from other sources. It is not uncommon for an analyst to run an
indicator through their tool of choice, have it come back with no results found, and declare that they are not
compromised — when in reality they may not have ever had the data in that tool to validate or invalidate the question
they just asked through the indicator. By having the CMF, we immediately know if the data the indicator is looking
for is even possible to find, thus we can create some good processes around performing indicator checks with more
confidence and against what type of data sets we can include in the search.

In the same way we might determine we want to search for tactics, techniques, and procedures (TTPs) as well
which we will cover more in Section 3’s material. Lastly, we might find that we can create an investigation
playbook which captures step-by-step what we need to do to quickly investigate the alerts that we do get and fully
leverage the collection we have.

There are many other examples including incident response playbooks and threat hunting. Ultimately it depends on
your requirement. If the requirement was operationally focused, then the procedure could include operations
personnel and processes to help identify things like failing devices or ops issues for root cause analysis work when
mishaps or downtime occurs.

40 © 2021 Robert M. Lee

rT mT TT MW WM WM WM WH

® w w w w w

.®

oe
ee Ww

oe &

» bb YU eee euee & ww & ww w Ww

ow ©

( Didwehavetis Lae ds , és Is the collection taking
collection we thought? _ | ! fully advantage of the
| « The SIEM was only | _« Are there gaps in the configuration?

storing 30 daysoflogs _ collection or process? ¢ The host events on the
' |» Not all engineering engineering workstation |
workstations at i | arenotcollectingnew
Calistoga Refinery have _ __ processes
logging enabled : |

ICS5I5 | ICS Visibility, Detection, and Response

The test phase really centers around Quantifying and Qualifying our collection as well as what we intended to do in
the Implement phase. This is all part of a larger validation effort. As you look now beyond your existing
documentation and knowledge, did you really have the data you thought you had? Are there gaps in the collection
or processes that hinder its success? Did the quality of the data make sense? As an example, you might be collecting
host-based logs but maybe you’re not collecting the right host-based events to answer the requirement.

There are many ways to test. The first is to run through the efforts in the Implement phase such as triaging a
notification or performing an indicator sweep with something that you know is present (even something not
malicious). Another excellent way is performing a threat hunt which is essentially incident response without the
incident. If you are worried about a specific threat scenario, such as the compromising of a safety system, then
performing a threat hunt for that scenario would not only validate for you that you are not currently compromised
but more importantly would reveal if the data you would need for incident response is actually present, and ensure
that your CMF matches your requirement.

© 2021 Robert M. Lee A

at

Update Collection Plan

° Update the information based on the Test phase
* From 90 days to 30 days in the SIEM based

° Guide new requirements for collection or tuning based on needs
* Moving local syslog and alerts from the network appliance to the SIEM

Asset Type
Data Type

Data Storage Location

Data Storage Time

Triconex Safety System

_ | Galistoge Refinery ©

Engineering Workstation

Domain Controller

Colistoga Refinery

Network Appliance

_ Calistoga Refinery |

Network Appliance

Syslog

Windows Host Events

Windows Host Events

Network Traffic Analysis

Packet Capture

Local

Enterprise SIEM

Enterprise SIEM

Network Appliance

Network Appliance

7 days

30 days

30 days

6 months

7 days and on demand

ICS515 | ICS Visibility, Detection, and Response

In the Update Collection Plan you can identify collection gaps to go amend, follow on requirements, or determine
that you need to tune your current CMF. As an example, in our scenario we are saying that the Local data storage
on the Triconex is not appropriate and we want to bring it into the SIEM. The previously understood 90 days
storage in the SIEM upon evaluation for the ICS networks was actually only 30 days, good to know now! And the
Network Appliance logs are also something we want to pull into the SIEM. So now we have some updated and
validated knowledge, and some action items to adapt our collection to better support the ability to detect and
respond to this threat scenario.

42

© 2021 Robert M. Lee

42

”o ») ww

o ff © OT OM OT TM MW MW WM WM WM WM wW

7, 7. ww, ww wm wn
ee ew eee be wee eee eee eee ee ee we

Ne

CMF Adaptability

¢ CMFs can be adapted in any way to suit your needs
* Linking configuration profiles, playbooks, and more can be helpful

Full Full Config
Engineering Workstation| _Domein Conteoller_| Network Appliance | _Network Appliance Dissection Dissection Changes

. - vt N/A Full Asset —_Limited Asset
Windows Host Events| Windows Host Evens (Network Taff Aaahss] pag on Daecile

Standard Host Standard Host

| contguretion* Configuration’ |e Protocoltist Protocol ist* Full Detection Full Detection Priority
Coverage Coverage Detection
Coverage

Enterprise SIEM Enterprise SIEM Network Appliance | _ Network Appliance

30 days 30 days months ‘| 7days and on demand

ICS515 | ICS Visibility, Detection, and Response

As previously noted, CMFs are entirely adaptable to your needs. Here though is an example to make the concept
more tangible. As an example, there is now a “Data Coverage” row added under Data Type. The Data Coverage
indicates the details about the data type that is available. As an example, there is no specifics to Syslog beyond the
native logging so it’s N/A. The Windows Host Events have many ways they can be configured to collect different
event IDs and information, so it’s flagged that this site is using the Standard Host Configuration that would be
developed by the security team against their requirements. This could be a hyperlink that would link to what that
collection package is currently. In the same way, for the network appliance there is a Protocol List that links out to
the coverage for the tool. As an example, you might have a few ICS protocols such as ModbusTCp, Pi-Connect,
and the Tristation protocol. How you fill these out is up to you, but in this case for simplicity the first field would be
No Dissection, Limited Dissection, Config Changes (e.g., uploads, downloads, etc.), or Full Dissection of the
protocol. The next row would tell you if the protocol dissection also pulls out no asset details, Limited Asset
Details, or Full Asset Details. The last row notes if there are also threat detections leveraging the protocol
inspection either Limited, Priority, or Full Detection Coverage against the threat scenarios and concerns the
organization. Having logical assignments can be much easier to maintain than determining each and every function
code and value processed in a protocol and each of those choices, such as Priority Detection Coverage, could link to
a knowledge resource where that list is maintained and evolves over time.

This will become more tangible when we discuss detection strategies in Section 3.

© 2021 Robert M. Lee 43

43

CMF + Security Controls as a Collection Profile

« CMFs can be used as a collection package requirement and paired with security
controls that provide collection as a standard profile across the organization

« A-class sites could require:
Host logging on HMIs, EWS, and Historians integrated to the SIEM that collects high and
medium priority events and stored for 1 year
Network appliance for ICS protocol dissection and alerts integrated with the SIEM and
stored for 1 year
Multi-Factor Authentication appliance with access logs to the SIEM for 1 year
° B-class sites might require:
* Network appliance for ICS protocol dissection and alerts to the SIEM for 1 year
* Multi-Factor Authentication appliance with access logs to the SIEM for 1 year
* C-class sites might require:
¢ Multi-Factor Authentication appliance with access logs to the SIEM for 6 months

ICS$15 | ICS Visibility, Detection, and Response

CMFs can be very powerful tools but, in especially large organizations with many sites, it can be tedious to think
about having a CMF for every site. Instead, you can leverage the combination of the Crown Jewels Analysis type
efforts to have an understanding of the different types of sites you have. As an example, you might have High,
Medium, and Low risk sites also titled as A-class, B-class, or C-class sites. You could have this for different types
of infrastructure as well such as an A, B, and C class Control Center vs. A, B, and C class Transmission substation.
The intention is to simplify the process so that the CMF represents a minimum collection profile at that site.

As an example, an A Class site would always have at a minimum a certain amount of collection, such as network
analysis and alerts dating back 1 year. If it went above | year that would be ok, but now the security and operations
teams as well as any incident responders know what they can depend on at any given site. Paring this with the
security technologies that also have logs that you want to roll out at a given site can make for an awesome
collection profile that fully enables defenders to understand what they have available at any given site. There’s no
reason to waste time responding to or investigating at sites when you know there isn’t the data to support the
investigation. Likewise, knowing what data is available on what assets significantly reduces the time and effort to
do security work at those sites.

44 © 2021 Robert M. Lee

wa)

"> a

rr wT ww WwW wh wh

@® YD wm nD w

m

7 oD ww wm ™

7 A
5b SE Ye Se ewe ee se ww eS 6 wo ww Sw w

o

ARG TERR AE SE CG I EEE EGS SY a ES TE a ara
Course Scenario:

C3PO - Intro to Electric Operations

ICS515 | ICS Visibility, Detection, and Response

This page intentionally left blank.

© 2021 Robert M. Lee 45

45

ulk Electric System Interconnections e US

Quebec
Interconnection

Interconnections ; Can we agree ~~ there
: is not a single “Grid”

Tul Tet AIR

Russia Walked Through It

Energy secretary says adversaries have capability of shutting
Nesitere down US power grid

Western Interconnection + Interconnection 8: : en
¢

i
i
I
i
!
1
| America’s Electrie Grid Has a Vulnerable Back Door—and
'
I
'
&

€ ercor ~~ About once every four days, part of the nation's power grid — a system whose

“ Interconnection» .

failure could leave millions in the dark — is struck by a cyber or physical attack, a
MMRO MNPCC GRF MSERC [CiTexasRE MWECC USA TODAY analysis of federal energy records finds.

ICS515 | ICS Visibility, Detection, and Response

As you hear about the power system in North America, you may hear a few different descriptions of the power
system layout. In North America there are 4 synchronous Interconnections Eastern Interconnection, ERCOT
(Texas), Quebec Interconnection, and the Western Interconnection, and in the U.S. there are three interconnections,
East, West, and Texas (ERCOT). Further, in North America there is the Mexico power system of which a small
part is connected to the Western Interconnection, and similarly there are isolated power systems in Alaska.

While you may hear different individuals referencing different numbers when explaining the electric system in the
U.S., or in North America the main thing to recognize is the only wrong way to talk about the electric system is by
referring to it as a single “grid”. The electric system interconnectedness each operate as a synchronous system with
acommon frequency and connect to each other for limited energy flow through DC tie lines. The conversion from
AC in one interconnection to DC and then back to AC in another interconnection ensures that any frequency related
disturbances do to move from one interconnection to another. With electricity storage being limited in capacity, we
are effectively running just in time generation production to load in an effort to balance the supply and demand in
real time all the time.

Reference:
NERC Interconnections.pdf

46 © 2021 Robert M. Lee

46

a wa ww

TT TF TPT WM WD MW WM wW

7 PF © PP OP wT WM w

we
» SS YY we YS VS BS UW WS WY WS we SS ww wo wo wo ww w

System Frequen

ICS515 | ICS Visibility, Detection, and Response

The North American electric system operates at 60Hz whereas other parts of the world tend to operate at around
50Hz. Frequency is extremely important to maintaining the electric system; disrupting the frequency can have
catastrophic effects not only in collapsing the electric system but, if done in the right ways under precise conditions,
even damaging equipment.

Reference:
http://fnetpublic.utk.edu/frequencymap.html

© 2021 Robert M. Lee 47
A Power System

Color Key:

Black: Generation
Blue: Transmission

won

Transmission lines
765, 500, 345, 230, and 138 kV
a ra

Transmission Customer

Generating 138kKV or 230kV

Step Up
Transformer

Substation
Step Down

Transformer Subtransmission

Customer
26kV and 69kV

Primary Customer
13kV and 4kV

Secondary Customer
120V and 240V

httpv/en.wikipedia.org/wiki/File:E lectricity_grid_simple-_North_America.svg

1CS515 | ICS Visibility, Detection, and Response

The referenced power system graphic displays the main components of an electric system. If you think of the
various components like any other produced good that is delivered to a customer, you can think of Power

48

® &

i)

generation as the creation of the product, Generation Step Up transformer as packing a large number of products for
delivery, the Transmission system as the product long haul delivery transport, the Step Down transformer as
separating out the packages for final delivery, the Distribution system as the delivery to consumer, and Load as the

various types of consumers large and small.

Reference:
electricity-grid-simple-North-America.pdf

48

© 2021 Robert M. Lee

rT TT TT VB VT TW WM wW

wv w

rw @® © oo

7
Vv bY &w we ww Se Sw SY © WY © © w wS w& w&

ue

Customer

| ne

| Power Meter (%)
aC fea \ Power Meter (96)

ur ICS515 Power System .

Transmission.

Switchyard ea
Breaker \ Gees
a Close | CPR,

Protection Relay

Close | Fault
ve

Reset

Generator

Transmission lines
765, 500, 345, 230. and 138 KV

Reclosure
Open Close

© 2021 SANS
Made in the USA.

|
|

Substation
Step Down
Transformer.

Secondary Customer
120V and 240V

Distribution

cnn TT

ICS5I5 | ICS Visibility, Detection,and Response 49

See previous slide notes.

© 2021 Robert M. Lee

49

Site Tours and Operations Discussion - Generation

How a Power Piant Works

Source: Edison Electric Institute (EEt)

ICSSI5S | ICS Visibility, Detection, and Response

While there are various types of power generation sources with very complex systems used to control and optimize
the process, we can look to the very basics in this EEI provided graphic and highlight the top row of three
generating processes for Coal, Natural Gas, and Nuclear as methods utilizing different fuel sources to super heat
water, designed to move a steam Turbine, which turns a generator, ultimately producing energy.

As we look to the bottom row, we see Hydro which is utilizing water to move a turbine as the water moves from a
high to low pressure elevation converting potential energy into electrical energy. Next, we look to wind as a “fuel”
source used to turn the turbine blades and convert wind energy to electrical energy. The last example highlights a
huge potential growth area for energy in the future to improve capabilities in capture and conversion of solar energy
and the use of photovoltaic components to convert it into electrical energy.

50 © 2021 Robert M. Lee

50

oo > ww

rr ff fH TF TH TH TT TF MW TMT TFT RM PPM PW WM WM w

w
Generation Facility Systems of Systems

Automatic Generation Control

Distributed Control System

ww ww ww wo oS & & & w

oe Fe wow ww S&S Ww

ob '

cz)

Passa’

A thermal coal-fired power plant has several major process and control elements:

¢ Primary Distributed Control Systems:
Coal Handling (conveyor, crushing, etc.)
Boiler control
Burner control
Turbine control
Automatic Generation Control (AGC)
° Water
Waste-water control
Steam (Recirculate) control
* Gas Emissions

Sulfur Dioxides (Sox) and Nitrogen Dioxides (NOx) monitoring

Flue gas desulfurization controls

* Solid Waste (Ash, Fly, Ash)
Electrostatic precipitators controls
Baghouse controls

¢ Historian

¢ Water chemistry

* Compressor system

° Heat rate

* Vibration monitoring

¢ Acoustic monitoring

¢ Turbine safety monitoring

¢ Fuel handling

© 2021 Robert M. Lee

i 1 Loop
Coal saeite
Handling
Scrub
Syster
eae

ICS5I5 | ICS Visibility, Detection, and Response

Turbine Monitoring
Gas Emissions
Solid Waste
Cooling
Water chemistry
Vibration Monitoring

Water System

Acoustic Monitoring

51
yl s, Interactions, and Outputs

A traditional power plant with multiple units will connect to the electric system, and
the power produced will serve local load or feed into the larger electric system,
' depending on power system flows across the transmission system and interties.

H
Uni-direetional to site

Project files (Level 2)
Files [data sheets, MSDS,]
Firmware patches (Level 1)
Software patches (Level 3 & 2)
Purchased hardware
Purchased software
Parts/equipment
Tools
Fuel supply
Labor/Contractors
Cooling water
Chemicals/materials
Deliveries
Mail (CD/DVDs/USB/letters)

=e

Bi-directional with site

AGC (Level 2)

SCADA (Level 1 & 2)

Relay protection (Level 0)

Remote Maint. Support (Level 3,2,1)
Remote Turbine Mont. (Level 0)
Historian replication (Level 3)
Plant-to-Enterprise (Level 4-5)
Internet (Level 4)

Calibration

Telephone VOIP

Telephone PBX

Satcom phone

Transmission 900 Mhz radio

Power flow

pourruis

‘Uni-directional from site/@site

Chemistry lab results

Files (reports, data, images, etc.)
Orders

Mail/shipping

Ash (waste)

Used chemicals (waste)

Scrap

Water

Removed equipment/parts
Emission monitoring

1CSS15 | ICS Visibility, Detection, and Response

A thermal power plant requires a great deal of inputs, interactions, and outputs to properly function. Many of these
inputs, interactions, and outputs can provide opportunities for access or manipulation. It is important to note that
power plants receive shipments, connect to external systems, and require data from off-site. The model presented
here forms the basis to establish a review of attack surfaces and potential access pathways.

AGC = Automatic Generation Control
SCADA = Supervisory Control and Data Acquisition

52

© 2021 Robert M. Lee

&

Tg’? FW WT VT MW ewwmen w

7-7 7 wo © © woh ©

we

’ vue Sw YS wo ww ww ww wo wo w&

ve Sb Sb &

Substation Facility
High Voltage Transformer

Circuit Breaker

1CS515 | ICS Visibility, Detection, and Response

Substations are points of the power system where voltage levels are changed and electrical pathways connect. They
contain transformers, breakers, switches, protective equipment, monitoring equipment, flexible AC transmission
(FACTS) devices for power stability such as phase monitoring units, and a variety of controls/communication
equipment. Some substations may have dedicated communication links, depending on remoteness and amount of
data gathered.

© 2021 Robert M. Lee 53
Transmission Substation Functions

Substation Controlling Power Flow
Transformations
Voltage Control
Protection of the System

. es Relays Ni h Protection of Equipment
ne ee Switching
+ Meters eh | Ui ; Power Quality

Fault Clearing

ICS$515 | ICS Visibility, Detection, and Response

Asset owners and operators perform a variety of functions at transmissions field substations through their control
area. Leveraging the transmission yard switching, load tap change capabilities of high voltage transformers, and
capacitor bank elements throughout the field — design engineers and operators can take actions to ensure reliability
across the electric system. In addition, entities design and engineer protection equipment and capabilities through
substation environments to limit impacts of system fault conditions and to call upon during emergency operations.

Devices typically found in Transmission substations include:
Protective relays (digital and electromechanical)

Remote Terminal (or Telemetry) Units (RTU)

Real Time Automation Controllers (RTAC)

Intelligent Electronic Devices (IED)

Metering devices

Wide variety of communications equipment

54 © 2021 Robert M. Lee

oo ww

rT TP Tr TT TT T DT MW WT WM SM WM SH

ww, ww wi ww wm w

a
ib vee seieswswe ws swe & w&S & ww

uo &

ew» Yb &

Supervisory Control & Data Acquisition

Control Center

SCADA Server

Communications

Dispatcher Workstation: HMI “rr oooe2}
Front End Processor

Historian Alarm Server Display Server * 800-900 Mhz
* Microwave
+ Fiber
+ Copper

Relays
RTUs
IEDs
Meters

ICS515 | ICS Visibility, Detection, and Response

Transmission-level system control centers can support functions ranging from reliability coordination and balancing
to transmission operations.

The normal footprint of a transmission SCADA-EMS includes breakers, switches, lines, transformers, and
generators, including all circuits greater than 100 kV, transformers with two or more terminals above 100 kV, and
all step-up transformers connected to generators greater than 20 MW. To ensure control center reliability, there is
often a primary center and a back-up center responsible for a control area.

Transmission control centers house critical applications including system operator terminals, mapboards and
display servers, alarms servers, SCADA application servers, databases, and the front-end processors. These central
systems communicate with field devices via a multitude of communications mediums (radio, microwave, fiber, and

copper).
The primary SCADA communications are:

*  Inter-Control Center Communications Protocol (ICCP) data links to Control Centers.
* SCADA links to plants via remote terminal units (RTUs) over various protocols like: IEC104, IEC61850,
Distributed Network Protocol (DNP3.0).

ICCP provides the needed visibility into the bulk electric system to support real-time dispatch of generation. Asset
owners and operators are spread across multiple ICCP nodes. Ideally this prevents a single point of failure, and
provides additional visibility during outages.

HMI = Human Machine Interface

EMS = Energy Management System

RTU = Remote Terminal Unit

IED = Intelligent Electronic Device

GSM = Global System for Mobile Communications

© 2021 Robert M. Lee 55
Site Tours and Operations Discussion - Distribution

Distribution substations

ICS515 | ICS Visibility, Detection, and Response

Distribution systems receive the majority of their electricity from the transmission system and then steps down the
voltage to accommodate the needs of the various customers in their service territories, including industrial,
commercial, and residential customers. Distribution companies are typically the entities that end customers view as
the “power company” and depending on the particular location the distribution company may be part of the larger,
vertically-integrated utility inclusive or generation, transmission, distribution, and control center operations, or the
distribution company may be a stand-alone entity providing the “poles, wires, and metering” services to customers.

Distribution substations will vary greatly from facility to facility, depending on the load served and location.

56 © 2021 Robert M. Lee

wo. &

rn @ 7 TF HW TT MW TF T DW MW WM W

wv wm w

”, ?, wv.

os F§ &F F&F FH Hee wHeweeeeee es

eo &

ws

Distribution Operations

¢ The distribution system at many utilities may be controlled from the
same control centers or dispatch centers that utilize a common
SCADA system or communicates with the system that is being used
to operate the Transmission facilities

¢ Many distribution facilitates share the same communication path or

communicate through Transmission facilities

¢ Distribution sites may be configured as a part of an organizations
load shed or special protection scheme

* Distribution facilities may also leverage Distribution Automation
technologies in the field to respond to changing system conditions

ICS5I5 | ICS Visibility, Detection,and Response 57

Distribution systems are typically thought of as below 100kV with typical primary service voltages at 14.4 and 12.5

kV and secondary feeds at 120, 240, and 480V that are stepped down based on specific customer needs.

Distribution feeds to customers can have a couple of designed approaches depending on location and criticality of

load. These include:

¢ A single radial feed from a distribution substation to a customer

¢ A loop feed with two lines across different geographic paths feeding customers from the same distribution
substation

¢ A dual feed with two circuits from different distribution substations feeding customers with on circuit open

© 2021 Robert M. Lee 57
Site Tours and Operations Discussion - Control Centers

Monitoring the Electric System
— Control of the Electric System

Balancing & Coordination

Dynamic Load Management

SCADA Server Fault Management
aor Outage Management
‘ront End Processor W ork D i sp a t chi n g
Safety

Dispatcher Workstation: HMI

Historian Alarm Server Display Server

ICSSt5 | ICSVisibility, Detection, and Response

Control Centers and Dispatch centers communicate to field locations and consume data from the devices. Operators
perform control actions to ensure reliability and safety in the system. A distribution control center will mirror some
of the functions and capabilities of a transmission control center, minus the need for generation control.

58 © 2021 Robert M. Lee

oo wo w

nom D7 DH TW DW DW WM W

Q,

ae, 2
wie Ww es we we Se BS w

ew & w

vo Beebe we

Control Center ICS Applica

External
Networks

Routers

av Patch — File and Print

Back Office — Suppor
Repository Repository — Servers miles po

Eng, Control Display

Operators OT Supe  Workstanon Servers Servers

_Firewalts|

Single or Muitipte
Subnets

Devices

Single or Murtipie |
Subnets

comm Directory
Servers Servers

i

tate Estimation
S — Contingency Analysis

SCADA/EMS — System Simulation

Phasor Data Concentrators

Visualization Servers

ICS515 | ICS Visibility, Detection, and Response

This is a high-level network view of typical systems found around a control center. Note that they are all typical
servers and Windows PCs. Viewing them as IT systems and not OT/ICS would be a significant failure that would
result in more impact than foreign state actors combined.

© 2021 Robert M. Lee

59
BES Perspectives

Generating Station

Step Up
Transformer

Turbine Control
Balance of Plant Systems
Distributed Control System
Air Pressure System
Relay protection System
Lube oil System
Water Chemistry system
Burner Management System
Coal Handling System
Acoustic Monitoring System
Heat Rate System
Continuous Emissions
Management
Boiler Control System

FielBus
FieldNet
ope
Profinet
Modbus
FoxNet

765, 500, 345, 230, and 138 kV
éy ES

‘Transmission Customer
A3BRV oF 230KV

Breaker Control
Switching Controls
Protective Relay
toad Tap Changers
Current Transformers CTs
Potential Transformers PTs
Metering
Capacitor Banks

SANS ICS. Version 1.4

stomer

tea sedis

Energy Management System
Data Servers
Display Servers
Communications Front Ends
State Estimators
Alarm Management
Contingency Analysis
Historians
Support Systems

Distribution Automation
Capacitor Banks
Reclosures
Switching Control
Protective Relay
Current Transformers CTs
Potential Transformers PTs
Metering

HEC 61850 |
DNP3 | Traditional TCP
Landis & Gyr |
REDAC
101/104

Power utilities are heavily reliant on a global supply chain to provide physical material and operational components.
Many countries have recognized the long lead time risk that exists across this supply chain. and have taken actions

to ensure physical equipment inventories are adequate for high consequence facilities. Some countries have enacted
supply chain cyber security specific requirements.

60

© 2021 Robert M. Lee

»

®

on 7 7 7 TOD DM Dw w

mmm Hes met es ss es ss a

mm @

=

ss &§ S&S

wow Oo &

Ve

Lab 2.1
Operating the Process

ICSSI5 | ICS Visibility, Detection,and Response 6!

This page intentionally left blank.

© 2021 Robert M. Lee

61
ICS Network Visibility
and IT Discovery Protocols

ICS515 | ICSVisibility, Detection, and Response

This page intentionally left blank.

62 © 2021 Robert M. Lee

TT wonmrnmrnrrmrirrmrrTmemrTomenD PM HO OH H &

IT Discovery Protocols

* Networks, including ICS, have * Common discovery protocols in ICS

ap

oF

ar

significant amounts of data useful for networks:

asset identification and visibility

IT Discovery Protocols are protocols

that contain information to identify
assets and information about them

Numerous ICS manufacturers leverage
common IT protocols including on
controllers (e.g., Telnet)

ARP
ICMP
SNMP
HTTP
TELNET
FTP
NETBIOS
SMB

DNS / MDNS
LLMNR
LLDP
DHCP

ICS515 | ICS Visibility, Detection, and Response

Almost all networks contain significant amounts of information in the native protocols, eliminating the need to
actively poll the devices to get the same information. Most analysts are surprised at how much you can pull out of
networks just by understanding the protocols. In ICS networks, many protocols you would not expect, e.g., DNS,
are used by various ICS equipment manufacturers. DNS as an example can be used to store asset information in
Profinet networks. Additionally, HTTP is common for landing pages on controllers as an example.

Understanding these IT discovery protocols and the value they contain is an easy early step to identifying the

equipment and its information on the network.

© 2021 Robert M. Lee 63
Wireshark Endpoints

¢ Value:
* Quickly view network endpoints (all logical endpoints)

Ethemet 33 | Fibre Channel| FDD1| sPv4: 60 | 1Pv6: 3 (Px | IXTA| ncp| reve] cre] TP:.494

Run on an interface or Ethernet En]
on a packet capture Address 4 Packets 4 Bytes 4 TxPackets ¢ TxBytes 4 RxPackets 4 Ra
Hover over statistics Vmware defidd 15487 8407454 6665 | 1657723 8.822
« Vmware_chidaef 120 523393 517 640
Select endpoints PhoenixC_0a:00:dd 7360 46512 46512
View various layers Broadcast 1974 148 500 0
Rockwell_d0:34:3e 763 114876 58 848
75 (119937 7 TS718
13619 7941608 6965 551
Rockwell_28:32:08 4 794
PhoenixC_69:aa:55 254
SiemensN\_0d:34:3¢ 17576

* Methodology:
« Open Wireshark

ICS515 | ICS Visibility, Detection, and Response

Wireshark endpoints are all the logical endpoints in each identifiable protocol on the network. For example, an
Ethernet endpoint would be the MAC address. An IP endpoint would be the IP address. And a TCP or UDP
endpoint would be the port number. ICS protocols are largely supported in Wireshark, but the endpoint dissectors in
Wireshark do not natively recognize ICS endpoints. In other words, if you view DNP3 in the default version of
Wireshark, you cannot use Endpoints to determine addresses past the MAC, IP, and port number. Keep this in mind
when using endpoints; it is a powerful way to identify many of the assets on your network, but it is not the only
process that should be used.

General methodology for using Wireshark is to either use it to open packet captures (pcap) taken off of the network,
or to capture and analyze traffic live. To process traffic live, Wireshark needs to be run on a Windows or Linux
computer and, when opened, assigned an interface. If Wireshark is run from a traditional IT computer, it does not
see all the network's traffic; it observes broadcasted data to or from the switch and other devices as well as traffic
going between that system and any other system, such as the switch. Therefore, when using Wireshark, it is best to
connect it to a network switch. (How to do this is discussed in the "NSM ICS — Collection" portion of this section's
training. In addition, to monitor traffic on an unmanaged switch, you have to "hub out," which is also discussed

later).

To use endpoints, you open Wireshark, click Capture, and choose an interface after capturing is started and let it run
for a while. Then, hover over Statistics on the toolbar, and select Endpoints from the drop-down menu. Here, you
can note the different logical endpoints observed on the network. A list should be taken of each Ethernet address,
each IP address, and then each port associated with the IPs. This traffic analysis helps identify all the active assets
and networks on or connected to your network. Remember to run Wireshark from all available network switches

and interfaces to gain a complete view.

64 © 2021 Robert M. Lee

qn vn when wmnwn en ww

eo ® @
w wo © ww ww we ww ww ww © Sw we w

wv wo wo Ww

Wireshark Conversations

° Value:
* Quickly view connections taking place on
the network (OSI 2-7)

| | | | |
_ Ethernet: 56| Fibre Channel } FDDI| Pvd: 73} 1Pv6: 2) IPX | JXTA | NCP

* Methodology:
* Open Wireshark Address A 4 Port A 4 AddressB 4 PortB 4 Pac
Run on an interface or a packet capture 10.25.22.252 58635 Odse22  so-tap

Hover over statistics 10.25.22.252 58635 10.25.22.30  ff-sm
10.25.22.252 58635 10.25.2222 sm

Select conversations 10.25,22.252 $8535 1025.22.20 dnp
View various layers 10.25.22.252 58635 10.25.2230 _profinet-rtrm
10.25,22.252 58635 1025.22.22 dnp
10.25,22,252 58635 10.25.22.22 _profinet-rtm
10.25.22,252 58636 10.25.22.22 —_profinet-rtm
10,25.22,252 58636 10.25.22.22 dnp

ICS515 | ICS Visibility, Detection, and Response

Wireshark Conversations uses the same setup and methodology as Wireshark Endpoints because they are just
different options inside of the tool. Endpoints identifies the logical addresses on the network at each protocol layer,
and Conversations identifies communications between those logical addresses. For example, if you see that you
have a Profinet-RTM device with an IP address of 10.25.22.30, it is useful to know that it is communicating with a
device using port 58635 and IP address 10.25.22.252. Identifying this route shows the live traffic on your network
and the different connections (or conversations) taking place. A single device communicating with multiple ICS
assets might indicate a SCADA server or an HMI. If you saw protocols or IP addresses you didn't expect to see,
that's important to note and then to investigate.

To use Conversations, open Wireshark, run it on an interface or process a packet capture, hover over Statistics, and
select Conversations. The various layers displayed show the logical connections and data flow of each logical
address layer. Take note of these for your network diagram. All the same network considerations of Endpoints
apply with Conversations. Be sure to take captures from every managed switch in your network and use the Hub
techniques taught later on unmanaged switches.

© 2021 Robert M. Lee 65
Using Wireshark Statistics

Go Capture Analyze. Statistics Telephony Tools Internals
) Summary
o Comments Summary

Show address resolution

Protocol Hierarchy

sourte 9 Conversations
192.168. 1. PA Endpoints
192.168.1.175 Packet Lengths...

Using a baseline packet capture we
navigate to Wireshark’s Endpoints and
view the Ethernet and IPv4 Endpoints

We will ignore Multicast and Broadcast
addresses for our purposes

Ethemet: 22

Address
Vinware 66:26:86
Rockwell_a0:
RsAutoma_03;
PhoenixC_96:80:07
PhoenixC_96:08:46
Vmware b9:08:1e
Phoenixt_ 96:80:08
LiDP_Multicast
Vinware_20:92:98
Siemens

(Pv6meast_00:01:00:02
AsixElec_8f:0a:30
Broadcast
PhoenixC_b3:1&ab
Teelb:0d,02:16:3¢
Vmware, 06:10:13
1PvGmeast 00:01:00:03

iPv4mecast_00:00:16
(Pvameast_Effefe

fo, teva: 18 v6: 9

Packets
390 996
239936
313113
292 982
297 528
14e 022

6092
6330
22345
3 660

Bytes

44 653 082
27 315 307
36 826 806
17 888 800
17 675 060
17.942 796
402 180
478 263
2137235
293 310
75.905

18 424
22.255
220 327
223322
7614
3768

451

355

900

3870

2148

Ethernet: 22

Address
192.168.1.5
192.168.1.50
192.168.1.51
192.168,1.175
192.168.1.215
192.168.1.20
192.168.1.30
192.168.1193
10.0.0.254
192.168.1.21
By

224.0.0.252
192.168.1.1
192.166.1.253
224.0.0.22
239.255.255.250

iPv4: 18 | IPv6:

Packets

390 968
239 898
323075
147 962

bytes
44 648 958
27313027
36824 526
17 937 644
2126 a62
296 260
289 590
13906
7942

14 080
4545
2220
1651

351

2360
3754

370

2148

ICSS515 | ICS Visibility, Detection, and Response

Wireshark Statistics is a set of tools/plugins that allow you to look at things like endpoints, conversations, and
protocol hierarchy to determine what is on the network from the packet capture. You’ll perform these same steps in

the lab to help you determine what is there.

66

© 2021 Robert M. Lee

onnne#nnnrvrnnrnnT Fe Wr rrwrwne = &

«, 7,
wv wow FF FS WO WO WO © OS WS Ww

ev ws SS ©

oe §& wo

we &e we we

Wireshark Protocol Hierarchy

° Value:

* Quickly identify dissected protocols

* Methodology:

Open Wireshark

Run on an interface or a packet capture
Hover over statistics

Select Protocol Hierarchy

View various protocols

A esate Protocol eco hy Satie Capture Epp

Pretoce! Percent Packets
Y Frome
Y Ghemet
 tnteietPrtecelVenion &

User Delagrern Protoco!
‘Muiticas oman Nama Systern
LinkeJocal dutcart Home Reslution
DHCP

© Internet Contot Message Protocol
Linkiocal Miticast Name Resclutin

~ intemet Procol Verion

User Datagram Protoce!
Simp Senice Discovery Proteccl
“Simpie Netwosk Management Protocol
outing ifermation Protocol
et iOS Name Seve

< NatBIO5 Batagrom Service
‘Si (ercer Message Block Pretose!)
Y SMB Mallet Pioteca!
Microsett Windows Bowee Potocel

Muiucast Domain Name Steen
Unk-local Mutcot Meme Resolution
Dynamic Host Configuration Protacet

Packets Pesca Bites
009
a

Dota
© Fancmision Contrel Protecel
NetBIOS Sesion Series
Message Bock Potecol version 2)
© S008 Geiwer Message Block retoce’)
Y SMB Pipe Protocol
‘Microslt Windows Lanman Remote AP Protscet
 Distbuled Computing Evitonment Remote Procediae Call|DCEIAPC)

' Distibuted Computing Eovronmert Remote Procede Call (OCERPC}
DCK/PC Fndocint Manoes

ICS5I5 | ICS Visibility, Detection, and Response

Wireshark Conversations uses the same setup and methodology as Wireshark Endpoints because they are just
different options inside of the tool. Endpoints identifies the logical addresses on the network at each protocol layer,
and Conversations identifies communications between those logical addresses. For example, if you see that you
have a Profinet-RTM device with an IP address of 10.25.22.30, it is useful to know that it is communicating with a
device using port 58635 and IP address 10.25.22.252. Identifying this route shows the live traffic on your network
and the different connections (or conversations) taking place. A single device communicating with multiple ICS
assets might indicate a SCADA server or an HMI. If you saw protocols or IP addresses you didn't expect to see,
that's important to note and then to investigate.

To use Conversations, open Wireshark, run it on an interface or process a packet capture, hover over Statistics, and
select Conversations. The various layers displayed show the logical connections and data flow of each logical
address layer. Take note of these for your network diagram. All the same network considerations of Endpoints
apply with Conversations. Be sure to take captures from every managed switch in your network and use the Hub
techniques taught later on unmanaged switches.

© 2021 Robert M. Lee 67

oF

ARP and ICMP

° ARP discovers link layer ” sexe 10:49106.456259 Lcroete e:58: G0 ho has 28.29.22.12 Tell
addresses (e.g., MAC) and : era eet etme
‘ ‘ pierre Sie eee
associated internet layer address F Frou Saver to bytes ox viva (on bias), oo bytes copeered Gov Hla]
2 EEnOnSct Ta) See nonee Sraiion (aeenbesiOPeian}, Dots weer A7efoe.(Gansiahesfiile)

(e.g., IPv4) Fa reo npc taf San
Hardware type: Ethernet £1)

* Ties together MAC and IP in ICS protocol type: 1004 (@x08ee}

Hardware else: 6

instead of just viewing MAC in protocel size: 4
Opeode: request (2)

the protocol which may be the Sender MA adres
last routable point Tecpel MC assress

ICMP is often used for oe TOA. Saree #5, 24525 ME , ce (peng) renest “Seema, seaedl/2506, tease (reply ts 70499)

. . so yaa 10e5428. 12706 10.25.22,200 18 28.22.191 TOP 74 tove (ping) Feply _Ldenoah, seqeii/201, t8lel24 (request 1n 79482)
diagnostics and enT0r reporting > Frawe Teva: 74 byes on wire (362 vita), ™ bytes captured (S52 bits) ae

¢ Helps show active devices and > Set 5) Wonssoueu =

© Internet Contral Message Protec:

potential errors occurring er tee ep ee

Tdentifter (LE):
Sequence Moeber
Sequence Muster

fa

> Data (32 bytes)

ICS515 | ICS Visibility, Detection, and Response

ARPs are very common in ICS networks. They are extremely useful for tying together the MAC address with the
IPv4 address. If you simply look at the MAC address in a packet it may be the last routable point (e.g., a Switch
port) depending on the network topology. Identifying and leveraging the ARP requests and responses are much
more definitive in terms of tying MAC and IPs together in a single asset.

ICMP will most often be seen where errors occur, but there are some ICS devices that will utilize ICMP anyway for
initial discovery type efforts or when connections are interrupted. Identifying these protocols can be a simple way
to identify routes between devices and some addresses that are active in the environment. ICMP’s data (as well as
responses over UDP identifying for example what ports are closed) can be used to profile devices as well. The time
to live (TTL) often equates to the operating system. As an example, a 64 TTL is likely a Linux device whereas a
128 TTL is likely a Windows device.

68 © 2021 Robert M. Lee

68

nnn? © WP MF DHMH PWD * Se WP wMWwer Oo H &

m™,

~~ 7 @

eo § §Y wb we w&

os &

—)

9

NetBIOS and SMB

NetBIOS has three main
services:

« Name Service

* Datagram Service

* Session Service
Allows communications
and connections between

assets

SMB is not required but
often present

File transfers, folder paths,

UT Workstation,
Workstation, Doran &

sete)

ser Owtagran Protocol, Src Port: 38, Ost Port: 18
NetBIOS Ontagran Service

> $9 (Serve Kessoge Block Protocol)

Y $16 Hallslot Protceat

Protocal weg lnfe
vass 126 Session request, to TOM-WORK<28> fro SCADAZ<oe>
18.25.22.161 ness 60 Positive session -espanse
Mite 12:06:25.156415 18,25.22.101 10,25.22.200 SMa Negotiate Protece) Request
rage 164375: 126 bytes on captured (1008 bits)
thecnet IZ, See: Wihare_32:29:2¢ (00:0¢:29:3¢: LcrcHeFe_ec:55:fe (28:42:
22.208

Workstation names, etc. are ~ nets session service

all discoverable in Netbios

Message Type: Session request, (@x61)
2 Flags: one
Length: 66
Called name: TOH-WORKC2@> (Server service)
Calling nave: SCADA2<@@> (Workstation/Redirector)

ICS515 | [CS Visibility, Detection, and Response

NetBIOS and SMB are different protocols and not required to be used together but are often found used together.
NetBIOS has three main services and, especially when using SMB, can provide information about the assets’
names, association with other devices and connections, file paths and folder names when they are accessed, and

more.

Shared folders and other Windows SMB-based communications are incredibly common at the L2 and L3 layer of
ICS networks and can help not only identify assets but the topology as well by showing interconnections between

assets.

© 2021 Robert M. Lee 69
NetBIOS Name Service

* NBNS is part of the NetBIOS protocol and operates similar to DNS for
address resolutions

¢ Can contain hostname information for devices and is widely used on
Windows based ICS such as HMI, EWS, and Data Historians

File Edit View Go Capture Analyze Statistics Telephony Wireless Tools Help

2faeabeaaeaku

No. Time Source Destination Protocol Length Info

3@1... 10:47:18.633532 18.25.22.100 1@.25.22.255 NBNS 92 Name query NB VTSCADA<1c>
302... 10:47:19.383352 10.25.22.100 1@.25.22.255 NBNS 92 [Nam N D E

3@2.. 10:47:20.133404 1@.25.22.100 10.25.22.255 NBNS 92 Name query
304. 10:47:21.612604 10.25.22.100 10.25.22.255 NBNS 92 Name query NB VTSCADA<ic>
304... 10:47:21.627827 10.25.22.108 10.25.22.255 NBNS 92 Name query NB SCADA2<@@>

ICS515 | ICS Visibility, Detection, and Response 9

Many operations staff know their devices by a simple name, such as the hostname of the device. “VTSCADA”
might be the HMI they are familiar with. Those hostnames are often configured in Windows for
HMIs/Historians/EWS/ete. and are often discoverable over NBNS.

NBNS thus serves a valuable role in ICS networks to associated IP addresses (e.g., 10.25.22.100) to the hostnames
(e.g., VTSCADA).

70 © 2021 Robert M. Lee

a o> @> >  ® w OH WO WOeMeeOwD wT wr

>_> = = 2 * ® @
a

a we

Vu Ww wb we we we S&S ww ww) | |] we ww

DNS and MDNS

DNS and mDNS resolve
hostnames to IP addresses

te : Some ICS equipment takes
G66. 10:52:42.478696 FeO: :06d: F402; 7212: FFB2:: fb ‘282 Stondard query response @xQ008 AMAA
Sse. 10:52:42. 7477 192.1881. 148

. 248.0.251 70S S27 stoners wry wow woscee advantage of this and some
>» Frame 66664: 282 bytes on wir 32 bytes captured (2256 bits)

5 Ethernet 11, Sec: Apple. Sed 75/Setd8:c8), Dst: TPveecast_fb (33:33:00:00:00: fb) protocols (e.g., Profinet can

+ Internet Protocol Version 6, F402: 721e:e688, Ost: FFE2::f>

«ter Datagran Protocol, See Port: 5383, Dst Port: 5353 store asset information

Y Multicast Oosain Mase System (response)

Teonctien 1D: 808 utilizing DNS)

> Plags: @xB4@ Standard query response, No error
Questions: @
Answer RRS: 4

Authority RRs: @ . . .
sind et Also useful for identifying
+ iesers

> Toms-§Phone-4, local: type AMAA, class IM, cache flush, adde fea: :a6d:f402:721e:6888 j + 7
> Waseca: Spe a Casts she too west transient devices in ICS
networks

ICS515 | ICS Visibility, Detection,and Response 7

DNS and mDNS are great protocols for the resolution of domain/hostnames to IP addresses. At first pass it may
seem odd that ICS networks, especially if highly segmented, would have DNS records. The reality is it’s very
commonly used. Some protocols, like Profinet, can even use DNS to store asset information. You’ ll often find that
the various DCS vendors will also heavily leverage DNS for their HMIs/EWS in ways that help identify the
equipment (e.g., a Yokogawa domain on a device can help identify it as a Yokogawa controller).

There will also be transient devices in ICS networks that were plugged in from other networks, ranging from
engineering laptops to the occasional smart phone. Those devices will often times try to reach out to their recently
visited websites and DNS can be incredibly useful in identifying those assets as they try to reach out to the Internet
unsuccessfully (hopefully unsuccessfully).

© 2021 Robert M. Lee 71
Link-local Multicast Name Resolution

* LLMNR is based on the DNS protocol and is used for name resolution for hosts on the same local
network similar to the functionality of NetBIOS

Time Source Destination Length Info
784... 18:54:25.094458 10.25.22.101 224.0.@.252 68 Standard query @x@614 A TOH-WORK
7B4_. 10:54:25.095191 fe80: :91a2:d44d:b7a7.. fet rd que @xoeid A
784. 10:54:25.095278 1@.25.22.200 10,

Frame 78485: 112 bytes on wire (896 bits), 112 bytes captured (896 bits)
> Ethernet If, Src: LCRCHeFe_ec:5S:fa (28:d2:44:ec:$5:fa), Dst: VMware _3e:a9:2c (00:0c:29:3e:a9:2c)
> Internet Protocol Version 6, Src: fe8@::91a2:d4dd:b7a7:1361, Dst: fe8@: :d836:2F26: 308: Fofa
> User Datagram Protocol, Src Port: 5355, Dst Port: 51616

Link-local Multicest Name Resolution (response)

Transaction ID: @xe14

>» Flags: @x8000 Standard query response, No error
Questions: 1
Answer RRs: 1
Authority RRs: 6
Additional RRs: @
> Queries
¥ Answers

> Tom-work: type A, class IN, addr 10,25.22.200

ICS515 | ICS Visibility, Detection,and Response 72

Similar in functionality to NetBIOS and sometimes used to replace it, LLMNR is leveraged for hostname to IP
resolutions. In the screenshot we see that TOM-WORK which is a phone registered to Tom that’s being used in this
ICS network is leveraging LLMNR to resolve the hostname to the IP address.

LLMNR has the same use-cases of NetBIOS for our purposes though it will contain less information typically than
the full NetBIOS suite especially when SMB is used in NetBIOS.

72 © 2021 Robert M. Lee

vemnqnewmewmnmse@*wne@wnT FF R@WRMWwseWnwnsn wh wo w

— 9 & @
wa

wa

y

ww .

AY

eye we we

ynamic Host Configuration Protocol

¢ Protocol for addressing such as gateways, domain names, name
servers, and time servers

‘Source Destnaten
| 852. 10:55:41. 902529 10.25.22.4 955.255.258.255 BooTe
855. 13.962572 10.25.22.4 255.255.255.255 OOTP 342 Boot Request from @8:28:45:35: fd: Fc (PHOENIXC

S Erame, 2 bytes on wire (2736 bits), 342 bytes captured (2736 bits)
> Ethernet ret PHOENIXC 35:Fd: Fc (80:29:45:35:fd:¥c), Ost: Broadcast (FF: FF: FEE: FF:FF)
2 Internet Protocol Version 4, Src: 1€.25.22.4, Dst: 255.255.255.255
> User Datagram Protocol, Src Port: 68, Ost Port: 67
~ dynamic Host Configuration Protocol
Message type: Boot Request (2)
Mardware type: Ethernet (@x01)
Nordware address length: €
Hops: @
Transaction 10: exeeee2ece
Seconds elapsed: €
Bootp flegs: @xe00@, Broadcast flag (Broadcast)
Client IP address:
Your (client) IP a
Next server IP address:
Reloy agent 1P eddress:
Client MAC address: PHOENINC_35:fd: fc (00:20:45:35:Fd:Fe)
Client hardware address padding: eeeeeeccvveeeas—o900

ICS515 | ICS Visibility, Detection, and Response

DHCP can be a great protocol to identify addressing such as tying MAC addresses, IP address, gateways, domain
names, and time servers together. In this screenshot we see the Phoenix Contact PLC MAC address with its
associated IP address. A significant number of ICS networks use DHCP just like enterprise IT networks for
automatic allocation of IP space.

© 2021 Robert M. Lee

73

B

Link Layer Discovery Protocol and SNMP

> Frame 95: 187 bytes on wire (1896 bits), 187 bytes captured (1496 bits)
> Ethernet IT, Src: RSAutoma_@0:76:fc (@8:0f:73:00:76:fc), Ost: LLOP_Multicast (01:82:c2:00:00:0e)
¥ Link Layer Discovery Protocol
> chassis Subtype = Locally assigned, Id: chi-00123-e5
> Port Subtype = Locally assigned, Id: port-022
> Time To Live = 20 sec
> System Name = CHL-00123-ES
> Systen Description = Hewlett-Packard HP Compaq nc6320 (RNS37AMBABA), F.0D, CNU7Z1EYH
> Capabilities
Management Address
PROFEBUS Nutzerorganisation e.V, - Port Status
PROPTEUS Nutzerorganisation e.V. ~ Chassis AAC
> Teee 802.3 - MAC/PHY Configuration/Status

* LLDP isa layer 2 protocol that advertises device information to directly
connected peers

¢ Contains information such as chassis, port ID, port description, system name
and description, IP/MAC, and more

* Often queried with SNMP which is often used for managing devices

ICS515 | ICS Visibility, Detection, and Response

LLDP is very commonly used on devices and can be especially useful for dual-homed systems to identify which
systems are dual-homed through network traffic analysis. LLDP will store information and broadcast it to its peers.
Profinet networks typically use a lot of LLDP for their systems. LLDP is only going to be on local networks though
and will not leave those local networks as it is not typically routed outside the local network.

Additionally, LLDP can help identify VLAN names, system capabilities (i.e., switching), and any system names
and descriptions stored.

LLDP information is stored in the Management Information Base (MIB) of the device which is essentially a
database for managing networked entities.

Vendors can also have proprietary link layer protocols to grab similar information. As an example, Cisco has its
Cisco Discovery Protocol (CDP), which will reveal a wide variety of information about Cisco equipment, such as
operating system version and IP address.

Simple Network Management Protocol (SNMP) will leverage MIB information to query a device, and is often used
for managing network devices. Collecting SNMP information can be a quick way to identify all the information that

comes out of LLDP or is stored in MIBs.

SNMP will also often contain OIDs, which map to different vendor product lines. They must be decoded, but are a
great source of asset identification when present.

74 © 2021 Robert M. Lee

a @

re e@ fe

1)
we S&S YS Se YS YS we we we YS we we we SS SS Ww Ww

a)

HTTP/HTT

Many controllers and ;
networked equipment, ~ ee eee

. Siig assent wnat oie oe ge Sep psc PNG AN

such as Firewalls, have | 93546. 209619 192.168.1.2 192.168.1.266 aa serieh Hele, Cored ehenee’) Server’ Maa Duo
eda cia peas PEG ie ney aie oimenloge

web pages that can be aierioilt regent chad Deseo aod nae

268 12:03:46.$99914 192. 168.1.200 192.168.1-1 6@ 1083 = 443 [ACK] SeqnI96 Ack=1510 Wine6S535 Le:

accessed over HTTP or ———————— ESS

version: v2 (2)
HTTPs sertalruber: exeessefoatra7sadoie
> sigoature (shoanithasAtneryption)
~ issuers edsequance (@)
~ rdnsequence: 7 tteas (pics-9-at-enalAddressenguardfinnoninate.con,ki-xt-commonianeniich2eSe6ib7E7a0835 foot teer foe

Parsing the webpages ; raters aunctiestekic)
i Aves (id-at-organizaticnianesInnominate Security Technologies Ad)

will reveal product Y'neloedvebiseingutsheauee Aten (id-at-orgentzatlowtanesTonontnate Security Techoologies A6)
dr 2-5-4184 at-rgentzationtone)
 OfeectorySeeingsuTeastring (3)

information Fes Hs SLi AS ee ee

> RONSequence ites: 1 ites (1d-at-orgentzationalunitane=niuard)
> RowSequence ites: 1 item (id-at-comonkament2cb2c566ib707sa035/F0OF FOO FORE Oe)
> BoSequence ites: 1 ites (pkcs-S-at-enailAdéress=nguardginnosinate.con)

ICS515 | ICS Visibility, Detection, and Response

When engineers/operators navigate to various controller webpages or access HMIs and similar across the network
the information is often in H'I'l'P and can be parsed to pull out system and equipment information. Additionally,
many security appliances, like firewalls, have such pages, though they are usually on HTTPs. Though the HTTPs
session will be TLS encrypted, the headers and key association can reveal information as well. In this example,
there is an mGuard firewall by Innominate Security Technologies which can be seen. The mGuard is a common
industrial firewall in manufacturing environments, especially in Europe.

© 2021 Robert M. Lee 75

15

Telnet and FTP

Banners on Telnet and
FTP will reveal
information such as
Product names, makes,
model, firmware, and
serial numbers

Length info
| 400, 06:09224,060367 192.168,08.49 121 Responset 228 AXIS 266 Network Comera 4.40
:14.989177 192,168.88. 88 Response: 221 Goodbye.
480 06:09:14. 995427 192.168.88.25 138 Response: 220 Sockets FIP v7.18 (Revision +

Frame 480663: 121 bytes on wire (986 bits), 121 bytes ceptured (968 bits)
Ethernet II, Src: AxisComm_7F:0b:be (00:40:8c:7F:Ab:bc), Ost: Westermo 12:61:83 (08:07: 7c:1a:61:83)
> Internet Protecol Version 4, Src: 192,168.58.49, Dst: 192.168.2.64
¥ Teansaission Control Protocol, Src Port: 21, Ost Port: 51623, Seq: 1, Ack: 1, Len: 55
File Transfer Protocol (FTP)
Y 220 AXIS 206 Network C 4.48 (Jun 28 2086) ready.\r\n
Response code: Service ready for new user (228)

S3833 + 23 [Ax] Seqes Acl

Follow TCP Stream (tcp stream eq 25572)

secavees FO. (23

MOXA Etherdevice Switch £05-50HA

| Console terminal type (12 onsifvttee, 2+ vt52) ¢ 1

$08n.(4;19eeme ; .[4;39Hetanaged Redundant switch 04759.[5:2MLocatLon : .[5;3ewItch Locacion.[7519MPirmare Version : .[7:29HVI.0 butld 21871826. [8;19HSertal
[9139N392.168-88.60.[30;290AC Address: .[10;39H0@-9@-E8-26-40-23.[@}39404759. [225 20H6-~ ceceesensenenannnte[43}20H) (13550) (145208) (24) 508]

on. (13520H

{UaBaaWAccount + -(14;22HPaseword ¢ (19539, (145334

ICS515 | ICS Visibility, Detection, and Response

Both Telnet and FTP are very common in ICS environments, especially on controllers such as PLCs and RTUs.
When engineers/operators access the equipment via this protocol, a packet capture can be used to parse the banners
and pull out significant information. As an example, the Moxa Switch being accessed over Telnet in this screenshot
shows the Make, Model, Firmware Version, Serial Number, and MAC address of the device.

Pcap Source:
4ICS-GeekLounge

76

© 2021 Robert M. Lee

76

nnnnnewnkewenewwnewnmewmeé®we*@ewTwnewn#ewewws#seesen @

ome @
56» vee Ye we ueuewke Fb weweeteweihikb & b&w

wow &

Lab 2.2
ICS Traffic Analysis

Calistoga Refinery |

ICSS15 | ICS Visibility, Detection,and Response 7

This page intentionally left blank.

© 2021 Robert M. Lee

Course Scenario Goals (2)

* Calistoga Refinery
e What are the names and IPs of the Operator stations (HMI/EWS/Historian)

10.10.10.10 — VIEW-DESIGNER (View Designer)

10.10.10.20 — FACTORY-TALK-VI (Factory Talk View)

10.10.10.30 —- ENG_WORKSTATION (Studio 5000 Logix Designer)
10.10.10.40 — FACTORY-TALK-HI (Factory Talk Historian)

ICS515 | ICS Visibility, Detection, and Response

This page intentionally left blank.

”

78 © 2021 Robert M. Lee
ee we & Vwe we we we eewewwevwewseweeeeww#e ww wow w

Ve

ve

Course Scenario Goals (3)

¢ Calistoga Refinery
A ore

What is the make and model of 10.10.20.10?
What is the adversary’s IP address and domain?
What is the name of the malicious project file?
What did the adversary do to the safety PLC?
* What is the malicious routine in the logic and what does it do?
* What is the root cause of the attack?
+ Is the incident connected to C3PO’s incident?
¢ C3PO:
* Create a topology of the control network.
* What is the malicious action on the HMI?
* What Register was manipulated with what value?
* What malicious file executed on the HMI and when?

ICSSI5 | ICS Visibility, Detection, and Response

This page intentionally left blank.

© 2021 Robert M. Lee 79
Case Study:
Ransomware and

Prevention Atrophy

ICSSIS | ICS Visibility, Detection,and Response #0

This page intentionally left blank.

80 © 2021 Robert M. Lee

(‘2

DDD DRRODR DR O& Bm MR MMMM mEm a
a

we §& |e §& Sw Sw ww we we Ye we VE we we ww

_->-—ormdmdmULwWDrU

Ransomware and Its Evolution

Traditional Ransomware Human Operated Ransomware

Accelerated in 2016+

Targeted (humans breach the .
company then deploy)

¢

Cryptocurrency usage and
-multimillion-dollar payments

ICS515 | ICS Visibility, Detection, and Response

Ransomware has existed for decades in various forms. For many years it was considered a nuisance. Users would
get phishing emails, click on them, malware would drop to the system and encrypt the files, and then you would
have to call a number to contact the adversary to get payment instructions and an encryption key.

The ransoms were usually a few hundred dollars to a few thousands eventually getting into the $20-50k USD range.
There was pressure on the adversary (traceable funds, phone records, emails, etc. for law enforcement) and not
much on the victim (some random files got encrypted, sometimes valuable, sometimes not at all).

What started happening between 2010 and 2016 was adversaries started using cryptocurrencies like Bitcoin more,
which led to less pressure on them, and gave them a mechanism to have more anonymity in their payments. The rise
of cryptocurrency usage also meant more victims were able to pay in cryptocurrency. More importantly though,
adversaries started realizing, especially towards the 2016-2020 timeframe, that they could break into companies
themselves before deploying ransomware. By doing so, they could target the right systems and files that meant
more to the company, thus raising the rate of extortion they could demand. The payments started going from $50k
range into the millions of dollars range. A rise in the connected workforce during the COVID19 pandemic meant
even more targets. The rise in payments meant even more criminals joined in the efforts, and ultimately
ransomware became, and remains, a significant concern for many organizations.

© 2021 Robert M. Lee 81

Ransomware in ICS

¢ Existed for decades but with human
operated ransomware and ransomware
worms became incredibly impactful 2017+

* 2018-2020 saw a 500% increase

° Manufacturing companies accounted for 1/3 Merck Cyberattack’s

of all known attacks $1.3 Billion Question:
Was It an Act of War?
I Ly 1 re

d

e Adversaries learned targeting ICS
operations led to higher and quicker
payouts

ICSS15 | ICS Visibility, Detection, and Response

There have been cases of ransomware in ICS for as long as ransomware has been around, including extremely
impactful cases of production loss and plant failures. However, it was in 2017 that everything started really
accelerating for the ICS community with the WannaCry and NotPetya worms that took down high profile
companies such as Merck, Maersk and FedEx in their industrial operations networks. But significantly more cases
went unreported, accounting for dozens if not hundreds of ransomware cases in ICS across various industries,
especially manufacturing.

According to research by Dragos and IBM, the ransomware attacks on industrial entities from 2018-2020 grew
more than 500%. A third of those cases were in manufacturing companies.

Ransomware groups started realizing that by targeting the ICS networks of these companies, that the companies
would more readily pay out and pay out at higher payments because of the impact to the business.

Reference:

Ransomware in ICS Environments - Dragos 2020.pdf
https://www.bloomberg.com/news/features/2019-12-03/merck-cyberattack-s- | -3-billion-question-was-it-an-act-of-
war

82 © 2021 Robert M. Lee

92

ni @ ® © ® HH OH OW DW WH OH OH OH OO DH w

on fm

”

mm ©” ”
S&S S S&S SY |S &Y ww we & &w ww Ww WwW

»v ww w ww

ICS Tailored Ransomware

pritpengine.exe Proficy Related
¢ EKANS was the first ever ICS |resevaree Biatcy Secure Gateway
tailored ransomware was prlicensemgr.exe Proficy License Server Manager
discovered in Jan 2020 imadensemecid aa
° Sixth ICS tailored malware pohcypublshenenice ore Profiey Related |
family ever proficyserver.exe Proficy Server
Proficysts.exe if Proficy Related
* Deletes ICS related system = [Pr"""** roto Ras
. prproficymgr.exe Proficy Piant Applications
services/ process: es prrds.exe Proficy Remote Data Service
prreader.exe Proficy Historian Data Calculation Service
* Indicated targeting towards |*“** —
° . prschedulemgr.exe Proficy Related
ICS among criminals —— “Tamera
prsummarymer.exe Proficy Related

2020 saw the first ICS tailored ransomware families. This began with EKANS, which was responsible for multiple
ransomware cases in the community, including the forced shut down of some of Honda’s factories as well as Enel
Group, and numerous undisclosed compromises.

EKANS is a ransomware family written in the Goland language, with a number of system processes that it stops
upon infection. These range from the routine, such as antivirus, to industrial specific processes and services.
According to a Dragos intel report the ICS related processes hit across a wide range of industrial components
including ThingWorx, GE Fanuc, Honeywell HMIWeb, a significant number of Proficy services, and common SQL
processes related to commonly used historians.

Reference:
TR-2020-41_Analysis_of EKANS_Ransomware.pdf

© 2021 Robert M. Lee 83
Prevention Atrophy

* Human operated ransomware impacts are often less about phishing emails and
much more about exposed vulnerabilities, lack of preventive controls
deployed/maintained evenly, and poor planning

Significant portions of all standards/regulations are prevention focused
* NERC CIP: 70% prevention and 30% split among detection/response/recovery
* NIST 800-53: 95% prevention
* TEC-62443: 75-100% prevention (multiple standards)

Without visibility, the prevention is applied unevenly or not maintained

So little focus on detection, response, and recovery has a prevention bias that,
when it fails, leaves organizations very vulnerable

ICS515 | ICS Visibility, Detection,and Response 4

Prevention atrophy is when preventive controls are not well maintained over time. Organizations often focus
heavily on preventive controls (largely because the various industrial standards/regulations have pushed people that
direction) with very little thought or investment in detection, response, and recovery controls. But without visibility
and detection, it is very difficult to determine if your preventive controls are applied throughout the environment,
and if they are maintained. It is extremely common in incident response cases to find that the preventive controls

a ® DH fF TF TFT OO BH O&

organizations felt confident in are returning much less value over time, due to atrophy that then leads to
ransomware cases or worse.

Reference:
https://www.dragos.com/blog/correcting-prevention-bias-in-your-ot-cyber-incident-response/

84

© 2021 Robert M. Lee

oo ov ® WW WB BW W

eo @

ef @

»

w WV WS VS SS SS Ww Ww Ww Ww WS WwW Ww WwW WwW W Ww Ww

Visibility

[ T
; TYPs of th Prati
1
F —

— == so

Focus AreaS |

Systems

ICSS15 | ICS Visibility, Detection, and Response

Visibility can help you with prevention atrophy by helping you get a more complete inventory and topology (how
things connect). You should be looking to make sure you have the architecture you think you have (e.g., no direct
internet communications). You should also ensure you detect not only the threats and their TTPs, but for prevention
atrophy, that you’re detecting endpoint protection systems, security devices, etc. through their network traffic. You
can often find when endpoints aren’t getting updates through domain searches and connectivity loss. You might
find a Symantec antivirus system beaconing out when it’s not getting updated regularly to Symantec domains,
whether or not they can connect. Additionally, you should identify key devices that are your “edge devices” such as
Firewalls, Remote Access Points, and Historians that serve as an access into the ICS/OT networks, understand the
vulnerabilities there, and remediate them quickly through patching or compensating controls.

Your active directory / domain controller is often a “highway to hell” from IT to OT and in many incidents shared
AD infrastructure leads to significantly larger impact in operations.

© 2021 Robert M. Lee 85

as

ICS Protocols

ICS515 | ICS Visibility, Detection, and Response _ as

This page intentionally left blank.

86 © 2021 Robert M. Lee

Protocol Payloads

¢ Value:
¢ Identify assets that are addressed in upper layers of the OSI model
* Identify payloads contained within protocols such as DNP3 and Modbus TCP
* Source:
* Wireshark dissectors contain protocol breakouts for many common ICS protocols; many of
the protocols’ payloads contain ICS addressing info

¢ Methodology:
* Rule out IT protocols
* Identify the ICS protocol in use (Utilize Protocol Hierarchy for quick view)
* Map out the protocol using open-source information, Wireshark, or vendor documentation
* Record non-IP-addressed assets on the network diagram

ICS515 | ICS Visibility, Detection,and Response 47

Most traditional IT assets can be identified almost entirely by gaining their MAC address, IP address, and open
ports. [P-connected ICS assets often have additional assets they are connected to that rely on them. For example, a
process controller will have I/O that could be operating equipment, such as turbines or pressure sensors. In addition,
IP-connected ICS assets might utilize multiple protocols inside of each other. These protocol payloads are valuable
to identify the type of communication that is taking place and if there are any identifiable I/O that exists.

Wireshark can be used to view these protocol payloads, but only if there is a dissector already written for it. Think
back to when we discussed the IP and TCP protocol layers in Modbus TCP. The only way that Wireshark can
analyze the traffic to determine if a protocol is IP is to have a dissector written for the IP protocol. The IP dissector
is written so that it knows there will either be a UDP or TCP protocol (following the OSI model) that is carried by
the IP protocol. The IP dissector looks at the IP packet and goes to the correct location in the packet to see what flag
is set; in IP the 0x06 flag is set when TCP is the payload. So, when Wireshark dissects the packet, it sees the 0x06
flag and then uses the TCP dissector to analyze the next layer. This same process applies to ICS protocols, but there
are often multiple layers to an ICS protocol. There can be entire sets of protocols embedded in the payload of other
protocols. This means that if you identify an ICS protocol that's used for transport (such as EtherNet/IP), you need to
look for additional protocols inside of it. For example, the Common Industrial Protocol (CIP) is carried via
EtherNet/IP and contains a Header frame and a Payload frame. The Header contains Request and Response
information, whereas the Payload contains the actual data. From an asset identification standpoint, it is useful to
know that the system is using CIP and what type of Header information is part of your baseline. The Payload data
can be used for a baseline as well, but because it is more likely to be proprietary and change over time, it can be too
time-consuming without vendor or engineer support.

It is important to note that some dissectors in Wireshark and other tools look primarily at the network port number to

determine what a protocol is. For example, a badly written dissector would look at traffic and determine that if it's
sent to port 502, it will be Modbus TCP. The dissector won't process the data correctly then and errors might occur.

© 2021 Robert M. Lee 87

Methodology

Wireshark protocol dissectors for IT assets are well documented and reliable. In addition, with the MAC and IP
address as well as the port number for IT assets, a good network diagram can be drawn. Understanding the various
services running on these assets is important, but for network diagrams, the addressing and port information is
enough. For ICS assets, though, protocol dissectors can be less reliable. Active defense personnel should use
Wireshark to identify the ICS protocols and examine them to ensure that the dissector identified all the traffic
completely or to determine if another dissector is needed. A quick way to do this is to use Wireshark and go under
Statistics where the Endpoints and Conversations options were. Instead, though, click Protocol Hierarchy. From
there identify the ICS protocol you want to inspect further (or any unidentified protocols) and right-click the
protocol name. Then select the Apply as Filter option and choose Selected. This brings back up Wireshark's packet
view but filtering out every other protocol. Then the packet can be viewed in full to determine if there is already I/O
and non-IP-addressing information available, or if there are additional protocols that aren't being dissected. If there
are additional protocols that aren't recognized, use your network knowledge, people familiar with the systems, or
the vendor to help document the protocol and write a custom and internal Wireshark dissector. If there is non-IP
addressing available, record those assets on the network diagram.

Wireshark has good dissectors for EtherNet/IP, DNP3, Modbus TCP, PROFINET, ISO-TSAP, and a few others.
However, the payloads inside those protocols are less likely to have dissectors.

88 © 2021 Robert M. Lee

7”,

7, 7T eR RR RR DRDR RDB MMH HM H HH ww
. 7 ee . ee

ww ss w

Modbus TCP Breakout

© Ethernet II, Src: Hewlett-e0:02:5e (78:e7:d1:e0:02:5e), pst: ETau_02:58:b7 (00:04:17:02:58:07)
F Internet Protocol version 4, Src: 141.81.0.10 (141.81.0.10), Ost: 141.81.0.86 (141, 81. 0.86)
© Transmission Control Protocol, Src Port: 57184 (57184), Ost Port: asa-app]-proto (502), Seq: 1, Ack: 1, Len: 12
© Modbus/TCP
Transaction Identifier: 0

Protocol Identifier: 0
Length: 6
Unit Identifier: 255
© Modbus
Function Code: Read Input Registers (4)
Reference Number: 2258
word Count: 2

ICS5I5 | ICS Visibility, Detection, and Response a2

Modbus TCP supplies us with a good example of examining ICS protocols. It is an easy-to-understand and openly
defined protocol. In this example, you see that Modbus TCP has a Transaction Identifier, Protocol Identifier, Length,
and Unit Identifier. Then, it has additional data that is identified as the payload. This next layer is titled Modbus and
shows the Function Code, Reference Number, and Word Count. Examining this individual packet can help us
understand the ICS asset. In most cases, Modbus TCP is used to communicate with an I[P-connected controller. The IP
address is usually the last bit of addressing that you would have to be worried about, and in this example, we see the
Unit Identifier set to 255, which is the standard. This 255 Unit ID lets us know that there are no other serial devices
connected to this IP-connected device. However, if the Unit Identifier were not 255 or 0, we would want to determine
if there were serial devices connected to the client. It is not common to see serial devices connected in this way, but it
can happen and shows an example of how inspecting and understanding the protocols on the network can be useful.
After determining that a Unit Identifier is not 255 or 0, the best way to proceed would be to use other available
network architecture information, and then perform a physical inspection to validate that there are serial assets
connected there. In this case, physical inspection would be used to validate the discovery, because it would not be a
common occurrence. However, if you already know through good network architecture maps that a serial device
should be connected here, then you could eliminate the need to do the physical inspection and feel confident that your
traffic analysis validated the network architecture map.

© 2021 Robert M. Lee 89
ICS Protocols

e
a)
@
- &@@ °, Identify
e A few dozen f the

“major” ICS protocol
protocols and

250+ ICS
e protocols

“normal”

Utilize port numbers,
Most are unique and Used in most industry, and
proprietary to industries and are systems to determine
specific systems the leading players the protocol and then
baseline its usage

ICS515 | ICS Visibility, Detection, and Response

There are hundreds of ICS protocols in the industry, but most are proprietary and distinct to specific systems or
customers. There are a few dozen of the “main” protocols you can expect to encounter, such as BACnet, DNP3,
Modbus TCP, EtherNet/IP, OPC, and ISO-TSAP. These will be covered over the next few slides. It is not necessary
to know every protocol. In many cases, even knowing the protocol stack doesn’t help as implementations of the
protocol may vary by vendor and asset. However, it is useful to be able to identify these protocols when possible
and determine what “normal” looks like to that ICS.

It is often very viable to determine the protocol by understanding what industry you are in (such as electric

generation vs. gas pipelines), the types of systems being used (such as a SIMATIC environment vs. a Honeywell
DCS) and identify the port numbers utilized.

90 © 2021 Robert M. Lee

Q ® ® DW DW DP OP GH ww

eo

® @®@ @ @ Df DD DMD ®

?,

7 7 ?
Frame 164: 103 bytes on wire (624 bits), 103 bytes captured (824 bits)
@) Ethernet II, Src: Rockwell_a4:01:96 (00:1d:9c:a4:01:96), Ost: CadmusCo_2a:21:33 (08:00:27:2a:21:33)
#4} Internet Protocol Version 4, Sr 172.16.1.30 (472.16.1.30), Dst: 172.16.1.10 (172.16.1.10)
4] Transmission Control Protocol, sre Port: dnp (20000), Dst Port: 49315 (49315), Seq: 18, Ack: 34, Len: 49
©) Distributed Network Protocol] 3.0
© Data Link Layer, Len: > From: 1, To: 3, PRM, Unconfirmed user Data
Start Bytes: 0x0564
Length: 38
f@ Control: Ox44 (PRM, Unconfirmed User Data)
Destination: 3
Source: 1
crc: 0xi4c8 [correct]
® Transport Layer: Oxc3 (FIR, FIN, Sequence 3)
/ Application Layer: (FIR, FIN, Sequence 2, Response)
f Control: Oxc2 (FIR, FIN, Sequence 2)
Function Code: Response (0x81)
@ Internal Indications: (0x0000)
| RESPONSE Data objects
® Object(s): Single-Bit Binary Input (Obj:01, var:01) (0x0101), 16 points
® Object(s): Binary Output Status (Obj:10, var:02) (0x0a02), 16 points

Often on TCP port 20000

Used largely in electric industry, sometimes in water, and rarely even in gas pipeline SCADA environments
Fairly common protocol stack with multiple online references as to the function codes utilized

Device level protocol (Configure devices, exchange data, communicate from supervisory to PLC)

ICS515 | ICS Visibility, Detection,and Response 9!

DNP3 is most commonly found in electric and water utilities. It works in a master/slave configuration and was
originally a serial protocol. It was ported to IP over TCP or UDP (commonly seen on TCP). There is usually
vendor-specific data inside DNP3 that you will have to work with the vendor to understand, but you can identify
the Data link Layer, Transport Layer, and Application Layer as shown on the slide. The Application Layer contains
information such as the Function Code.

Function codes will identify what is occurring, as an example:
Read: 1

Write: 2

Start application: 11

Stop application: 12

Slave configuration: 13

Unsolicited response: 81

© 2021 Robert M. Lee 91

IEC 60870-5-104 (IEC-104)

Frame 24: 70 bytes on wire (560 bits), 70 bytes captured (560 bits)
Ethernet Ir, src: Asustekc_56:0b:54 (00:22:15:56:0b:54), Ost: ZatAS_00:09:05 (00:16:01 :00:09:05)
internet Protocol version 4, src: 10.20. (10.20.102.1), Ost: 10.20.100.108 (10. 20. 100.108)
varauission control protocol, Src Port: 46413 (46413), Ost Port: 1ec-106 (2404), Seq: 79, Ack: 1525, Len: 16

EC 60B70-5-104-Apci: <- I (3,36)
rad
0 = Type: T (0x00)

asdu: ASDUSLO C_SC_NALU Act TOAS3 “single command’
0 = causeTx: act (63

. = Negative: False
= Test: False

2
1030 fF 40 30 77 00 00 68 Oe
0040 0a 00 Od 00 00 OL

Often on TCP port 2404 (can also be on 2405 if two masters are on the same network)

Largely used in the electric power SCADA industry for information, power monitoring, and control

The Application Protocol Data Unit (APDU) is broken into an Application Protocol Control Information (APCT)
and Application Service Data Unit (ASDU) where the ASDU contains the Information Object Address (IOA)

ICS515 | |CS Visibility, Detection,and Response

The IEC 60870-5-104 standard is part of the larger collection of IEC 60870 protocols. Specifically, it is the TCP/IP
version of the serial protocol 60870-5-101. The application layer data in each is the same. The only difference is in
the transport of the data. This protocol is commonly found in the electric power industry, especially in SCADA
environments. It is used for gathering information, such as monitoring the power and making control changes across
the network. The protocol can support a variety of requests like remotely restarting a device, changing
configuration, changing set points, and in general reading data and information off of systems.

92 © 2021 Robert M. Lee

eo @ @ @ @® @® ®7 Wf ff @ WwW fF MW OW WO HW OH PW

7 ®

mm @ ®
ww w Ww

w

OPC Clas

i Frame 13579: 214 bytes on wire (1712 bits), 214 bytes captured (1712 bits) on interface 0
@ Ethernet II, src: Vmware_97:df:86 (00:0c:29:97:df:86), Dst: Vmware_ec:4a:41 (00:0c:29:ec:4a:41)
@ Internet Protocol version 4, Src: 10.25.22.103 (10.25.22.103), Dst: 10.25.22.100 (10.25.22.100)
f Transmission Control Protocol, Src Port: danf-ak2 (1041), Dst Port: rsf-1 (1195), Seq: 82321, Ack:
(@ Distributed Computing Environment / Remote Procedure Call (DCE/RPC) Response, Fragment: Single, Fr
version: 5 ‘
version (minor): 0
Packet type: Response (2)
mH Packet Flags: Ox03
) Data Representation: 10000000
Frag Length: 160
Auth Length: 0
call Ip: 2868
Alloc hint: 136
Context Ip: 4
cancel count: 0
*® [No bind info for this interface Context ID - capture start too late?]
stub data (136 bytes)

¢ Often requires numerous open ports to be utilized fully
¢ Used in most industries and is commonly found linked to data historians on the network
* OPC Classic is based off of DCE/RPC and thus identifying that can help identify the OPC communications

ICS5I5 | ICS Visibility, Detection,and Response 3

OPC classic, as we have already discussed in the class, is a universal translator in the operational environment for
systems from different vendors that were not designed to work together. OPC is going to be implemented in various
ways, depending on the site and how it is architected, thus making it more difficult to truly understand OPC in class
versus how it is implemented at your site. However, there are some common understandings and considerations that
can be explored and should be understood.

OPC is meant to sit between the "Data Sink" and the "Data Source". The Data Source would be something like a
PLC, whereas the Data Sink would be something like an HMI. OPC ensures that data can be exchanged between
these two (Data Sink and Data Source) without needing them to understand the proprietary protocol each may be
using.

OPC is sometimes configured on TCP Port 135 but, as the figure shows on the slide, this is not always the case.
What is common is the use of Distributed Computer Environment / Remote Procedure Call (DCE/RPC). Identifying
this in the environment can help identify OPC communications. It will not always be OPC, but it is a good
indication, especially if you are not using these protocols in your ICS normally.

Good starting guides:

https://www.moxa.com/en/support/product-support/software-and-documentation
https://www.automation.com/pdf_articles/Guide_to_OPC.pdf

© 2021 Robert M. Lee 93
ISO-TSAP

i Frame 47617; 62 bytes on wire (496 bits), 62 bytes captured (496 bits)
jp Ethernet IZ, Src; 42:73:63:61:64:61 (42:73:63:61:64:61), Dst: Siemensn_10:94:41 (00:1¢:06:10:94:41)
i® Internet Protocol version 4, Src: 172.16.4.10 (172.16.4.10), Dst: 172.16.4.30 (172.16.4, 30)
» Transmission Control protocol, src Port: 51485 (51485), Dst Port; iso-tsap (102), Seq: 60628, Ack: 234057, Len: 7
jo TPKT, Version: 3, Length: 7
| version: 3
Reserved: 0
Length: 7
3) IS0_8073/x. 224 COTP Connection-oriented Transport Protocol
Length: 2
PDU Type: DT Data (Ox0f)
[Destination reference: 0x18c0000}
-000 0000 = TPOU number: 0x00
O... seve = Last data unit: No
COTP segment data (0 bytes)

¢ Configured for TCP port 102
* Serves as a carrier protocol for ICCP (electric generation) or S7 (Siemens protocol)
* The “data blob” is the ICCP or S7 communication and is highly proprietary

1CS515 | ICS Visibility, Detection, and Response 94

ISO-TSAP is an interesting protocol and is used in a couple of locations: primarily as the protocol that carries
Siemens’ $7 protocol as well as ICCP. Both ICCP and $7 are seen on Port 102 because they use ISO-TSAP. Inside
ISO-TSAP, the data block must be broken out to determine (purely from the packet and without environment
context) whether the protocol is $7 or ICCP. Reversing these protocols is beyond the scope of this class and that
should be done with vendor support. However, it is important to be able to understand and identify ISO-TSAP.

ISO-TSAP is the combination of TPKT and Connection-Oriented Transport Protocol (COTP). TPKT is a way to take
COTP and place it inside TCP.

COTP is an ISO-based protocol (most of the ISO documents and standards must be purchased). COTP is based on
ISO 8073 and is meant to be similar to TCP. The difference between it and TCP is that TCP is meant to be a
continuous stream of data whereas COTP is meant to be "packets" of data, but still connection-based unlike UDP.
However, placing COTP inside of TPKT, which runs over TCP, seems a bit counterintuitive. The TSAP portion of
the protocol is the data blob itself (TSAP stands for Transport Service Access Point). That data blob will oftentimes

either be S7 or ICCP in ICS environments.

So why is ISO-TSAP put over TCP if the intention was to replace TCP? Without knowing the original intention of
the developers, it seems evident that the functionality of continuous streams of data was desired from TCP, but TCP
does not support the kind of addressing that is possible in TSAP. It was an attempt to take functionality from both for

ICS environments.
Reference:

https://wiki.wireshark.org/TPKT
https://wiki.wireshark.org/COTP

94 © 2021 Robert M. Lee

rT DP ® DP DPD DM OH ww

oro @® @®@ & H BD ®

oo fo ff @ &@ @ ®
ea

‘Be a

ww BS &S Bw Bw BS Ww |W WwW WS WO WS WwW Ww Ww

S7COMM

Tne Source Destination
33 96:00:03.952501 192.168.1.10 197.268.1.48
192.268.1.49
192.168.1.18
192.268.1.40
192.168.1.48
192.168.1.10

Transmission Control Protocol, Sre Port: 4185, Ost Port:
‘TPKT, Version: 3, Length: 31
150 8073/X.224 COTP Connection-Oriented Transport Protocol
[2 COTP Segments (2 bytes): #33(@), #36(24)]
S7 Communication
Y Header: (Userdate)
Protocol Ed: x32
ROSCTR: Userdata (7)
Redundoncy Identification (Reserved): @x0008
Protocol Data Unit Reference: 2626
Parameter length: 6
Data length: 6
Y Parameter: (Request) ->(Black functions) ->{List blocks of type)
Parameter head: ox000112
Parameter length: 4
Method (Request/Response): Req (@x11)
100 .... = Type: Request (4)
ss+e 0811 # Function group: Block functions (3}
Subfunction: List blocks of type (2)
Sequence number: ©
Y data: (08)
Return code: Success (Oxff)
Transport size: OCTET STRING (8x09)
Length: 2
Block type: @8 (08)

Seq:

Length Info
61 DT TPOU (@) [COTP fragment, @ bytes)
85 ROSCTR: [Userdata] Function:(Request] -> [Block functions] -> [List blocks of type] Type:[08]
91 ROSCTR:[Userdata] Function: [Response] -> [Block functions] -> [List blocks of type]
61 OT TPOU (@) [COTP fragnent, @ bytes]
91 ROSCTR:[Userdata] Function:[Request] -> [Block functions] -> (Get block info} -> Slock:(08 1)
87 ROSCTR: [Userdata] Function: [Response] -> [Block functions) -> [Get block info] -> Errorcode:(@x4209]

359, Ack: 758, Len: 31

S7 is a Siemens proprietary protocol that leverages

ISO-TSAP

Device level protocol to connect workstations to PLCs
* Master/Client (PC) to Field/Server (PLC)

Purpose: Programming PLCs, Exchanging Data

between PLCs, and Accessing PLC data from

Supervisory systems

Primarily used with Siemens $7-300/400 PLC family

ICSS15 | ICS Visibility, Detection, and Response

S7, or S7COMM, is a proprietary Siemens protocol that leverages ISO-TSAP/COTP for communication. It is
designed to be able to facilitate interaction between supervisory systems and controllers, though it can be used for
controller-to-controller communications as well. It is primarily used for data querying and interaction, as well as
programming the PLCs. You will find it on Siemens S7-300 and 400 series PLCs.

Analyzing the protocol is useful for understanding the commands and values being read/written to controllers.

© 2021 Robert M. Lee 95

95

PROFINET

Frame 12: 64 bytes on wire (512 bits), 64 bytes captured (512 bits)
jm ethernet IZ, src: Phoenixc_cO:70:24 (00:a0:45:c0:70:24), Ost: Phoenixc_37:52:2c (00:a0:45:37:52:2c)
'm 802.1Q Virtual LAN, PRI: 6, CFI: 0, ID: 0
[= PROFINET cyclic Real-Time, RTC1(legacy), ID:0xcO10, Len: 40, Cycle: 3040 (valid, Primary ,ok,Run)
Eramerlo: OxcO10 COxCOQO-Oxe7FF: Real-Time(class=1 unicast): cyclic)
cyclecounter: 3040
 DataStatus: 0x35 (Frame: valid and Primary, Provider: ok and Run)
Transferstatus: 0x00 (OK)
| PROFINET Io Cyclic Service Data unit: 40 bytes
| User Data (including GAP and aTCPadding): 40 bytes

(0000 00 a0 45 37 52 2c 00 ad cO 70 24 81 00 cO 00
0010 88 92 Hgmeey sO 80 80 80 80 80 80 00 00 00 00
0020 80 80 0a 00 00 00 00 00 0 80 00 06 00 06 00 00
{0030 00 00 80 00 80 00 00 00 00 00 00 Ob e0 35 00

* Utilizes Ethernet but not TCP/IP unless it is using an application for configuration and diagnostics

* Uses unique IEEE EtherType 0x8892 to skip the TCP/IP stack

* PROFINET-networked equipment must have a “controller” and “devices” each have an IP and a name
¢ Fieldbus level protocol

ICSS15 | ICSVisibility, Detection,and Response %

The PROFINET (Process Field Net) protocol is often found in process and manufacturing facilities. It can transmit
data in three different protocol levels (from the standard):

¢ TCP/IP for noncritical data with reaction times in the range of 100ms
* RT (real time) for PROFINET IO applications and has up to Ims cycle times (most commonly used)
* IRT (Jsochronous Real Time) for applications with cycle times of less than Ims

PROFINET has a master/slave configuration and utilizes Ethernet to communicate. It has a controller, a device
(field device monitored by the controller), and a supervisor (the software on a PC to interact with the systems).

PROFINET commonly has “profiles” that are predefined configurations for different applications, such as
managing energy usage in a plant. These profiles are often available through the PROFINET working group and
allow for interoperability. If you identify a facility that is using PROFINET, by identifying the type of systems, you
may be able to identify the profile being used to understand more about the process.

Additionally, PROFINET uses Discovery and Configuration Protocol (DCP) which is a way for it to utilize a
naming schema. Every PROFINET device should have an IP address and a name. These names can also be stored
in a DNS server; i.e., look for a DNS server and pull names if you are trying to identify the devices. However, this
isn’t a mandatory configuration; it’s just an option sometimes used.

Notice in the screenshot above that there is no IP and TCP communication. Instead, the PROFINET communication
has been copied to a virtual LAN for collection. There isn’t a specific port being accessed, but we can identify that
it is PROFINET by the frame IDs. In this case, we also see the frame ID of 0xc010, which is the classification for

RT.

A fantastic webinar explaining PROFINET can be found here: https://us.profinet.com/webinar/an-introduction-to-
profinet/

96 © 2021 Robert M. Lee

eH ®

rT DP DP ®D WD WM

7 ® ® @® @® ® MW DM WM DW WM OW DW DW ®D
ey es we ww

wa

w w |) ww ww ww w Ww Ww Ww ww w

w

+ Often on UDP port

€4 Confirwed-REQ readProperty[ 20] device,86001 fireware-revision 47808
72 Complex-ACk _readProperty[ 28] device,s6001 firaware-revision © Src and Dst
AB. 64 Confirmed: RFO___ceadPronertul 21)_dewice.£6001_annlication-saftwa . Tah
Frese 29: 75 bytes on wire (600 bits) : : ¢ Found in building

> Ethernet IT, Src: IceQube_03:00:61 (08: 00:61), Ost: Dell_bf:1d:@8 (00:21:70:b#:1d:08) automation systems
> Internet Protocol Version 4, Src: 172.16.96,1, Dst: 172.16.36.1
[> user oatagran Protocol, Src Port: 47808, Ost Port: 47808 and data centers

> BACnet Virtual Link Control
Building Automation and Control. Network NPDU * Often Internet

Version: @x@l (ASHRAE 135-1995)
> Control: @x@a, Source specifier connected

Source Network Addcess: 8601 60 Confirmed-REQ  readProperty[ device,4194303 object-identifier
Source MAC Layer Address Length: 2 65 Complex-ACK readproperty[ device,1337 object-identifier device,1337
aalelieg F aiton and Control Network spy «00 CONFirmed-REQ — readProperty[ device, 4194303 vendor identifier
‘ 63 Complex-Ack readrroperty[ device ,1337 vendor -identifier
: 60 Confirmed-REQ _readProperty[ device ,4194303 vendor-name
Invoke 1D: 19 73 Complex-ACK readProperty[ device,1337 vendor-name
Service Choice: readProperty (12) 60 Confirmed-REQ = readProperty[ device,4194303 firmware-revision
levice;, 20081 68 Comp]ex-ACK readproperty[ device,1337 firmware-revision
+ model-nose (70) 60 Confirmed-REQ  readProperty[ device,4194303 application-software-version
65 Complex-ACK readProperty[ device ,1337 application-software-version
60 Confirmed-REQ readProperty[ device,4194303 object-name
70 Complex-ACK readproperty[ device,1337 object-name
60 Confirmed-REQ  readProperty[ device,4194303 model-name
76 Com Tex-Ack readproperty[ device,1337 model-name
60 Confirmed-REQ  readProperty[ device ,4194303 description

ICS515 | ICS Visibility, Detection,and Response 97

BACnet is a protocol found mostly in the building automation sector. Shown above is the IP version of the protocol.
In this view, we can see that BACnet has a fair amount of details displayed. BACnet information often contains the
type of devices that are communicating; it can include their location as well. Wireshark can pull a lot of this data
out natively, as it has a dissector for the protocol built in.

BACnet Properties

In Wireshark, the BACnet properties explain what devices are being communicated with. Additionally, the different
commands, such as object-name, model-name, firmware-revision, vendor-name, and description are all available. It
is important to know the tags inside the protocol to identify the exact information contained for these declared
fields. Working with vendors and identifying their documentation can help pull out this granular information and
provide a lot of context to what is on the network. For example, knowing exactly what each field and value in
BACnet represents could be used to enhance the dissector to natively pull out and display that information.

© 2021 Robert M. Lee 97
therNet/IP and CIP

i Frame 6: 117 bytes on wire (936 bits), 117 bytes captured (936 bits)
@ Ethernet IZ, Src: Rockwel1_a4:01:80 (00:1d:9c:a4:01:80), Dst: 00:73:63:61:64:61 (00:73:63:61:64:61)
if Internet Protocol version 4, Src: 172.16.1.30 (172.16.1.30), Dst: 172.16.1.10 (472.16.1.10)

Transmission Control Protocol, Sr¢ port: etherne’ (44818), Dst Port: 49321 (49321), Seq: 1, Ack: 74, Len: 63
2 Ethernet /ie (Industrial Protocol), session: OxABDD86F6, Send Unit Data
© Encapsulation Header |
command: Send unit Data (0x0070) |
Length: 39
session Handle: Oxabdd86f6é
Status: Success (0x00000000)
sender context: 0200000000000000
Options: 0x00000000
@ Command specific Data
= Common Industrial protocg)
@ service: Unknown Service (Ox4b) (Response)
@ Status: Success
[Request path size: 2 (words)]
@ [Request Path: Class: 0x67, Instance: 0x01]
©) Ip class Generic
_PCommand specific..pata. si 7 - — -
Configured to TCP port 448 18 for explicit messaging and UDP port 2222 for implicit messaging
Commonly found in manufacturing and Rockwell based environments
Protocol stack is mostly open but can change based on implementation

Useful for configuration but contains many security concerns in CIP as CIP is routable to anywhere

ICS5IS | ICS Visibility, Detection, and Response

EtherNet/IP is common in manufacturing networks due to its wide use by Rockwell Automation. It is one of the
protocols that uses the Common Industrial Protocol (CIP). EtherNet/IP has implicit-based messaging (UDP) as well
as explicit messaging (TCP). In the implicit form, it is common for the protocol to transfer I/O data. In the explicit
messaging, it is common for parameters, setpoints, etc. to be uploaded and downloaded. Therefore, TCP should be
looked for when looking for the changing of information, whereas UDP should be looked for when trying to

identify I/O data.

EtherNet/IP can be a one-to-one, one-to-many, and one-to-all communication - unicast, multicast, or broadcast. It is
usually seen on port 44818 for TCP and 2222 for UDP. Explicit (44818) is used to transfer parameters, setpoints,
programs, etc. Implicit (2222) is used to transfer I/O data.

EtherNet/IP itself is an application layer protocol, even though it contains two distinctive sections. The first section
is the Encapsulation Header. The second section is the Command Specific Data, which is the CIP protocol inside of
it that contains the actual data blob. CIP uses Objects to set attributes such as the vendor ID, device serial number,
and identity data. There are also Application Objects inside CIP, which are defined by the type of device and its
function (work with your architects/engineers to determine what these values mean). These Application Objects
contain information describing aspects of the I/O or controller such as frequencies, the current rating, and more.
Vendor Specific Objects can also be contained in CIP, which you will have to work with your vendor to figure out

exactly what the data means.

When looking for EtherNet/IP and CIP, it is useful to identify abnormalities in addressing and the EtherNet/IP
Encapsulation Header commands (such as "Send Unit Data") to determine if there is anything odd going on.
Understanding the deeper levels of EtherNet/IP and CIP can be useful for network configuration monitoring but has
a lower return on investment for security analysis.

Reference:
http://www.rtaautomation.com/technologies/ethernetip/
https://literature.rockwellautomation.com/ide/; groups/literature/documents/wp/enet-wp001_-en-p.pdf

98 © 2021 Robert M. Lee

wy) ww

oa ao ® 8 @®8 HH OH OH H OH ww

a @ @

oo Oo @ Oo ® @® @
ow a wa wy a wy 7 oe ~~ ww

vw wo wow we we we ww

we w w wo w

726955 984 806136 oS A681 Success
984.806802 192.168.1.175 . i. Unknown Service (@x4b)
726964 984.816321 192.168.1.51 -168.1. cIP 118 Success
726967 984.822935 192.168.1.175 -168.1. cIP 112 Unknown Service (@x4b)
726976 984.836134 192.168.1.51 -168.1. cIP 134 Success
726978 984.836983 192.168.1.175 -168.1. cIP 121 Unknown Service (@x4b)
As an example in Ethernet/IP _sveem coment

CIP you can use the protocol
to perform queries that will
yield asset information

Here we see a reference to a teal “ 5 Vee o. .

MuxL..F.we. .J.#1763-LEC

device as a 1763, combined with ~
the understanding that this is a
Rockwell device we can deduce
that this is a Micrologix 1100
Allen Bradley 1763

ICS515 | ICS Visibility, Detection, and Response
Sometimes you will see queries and information native in the protocol being used in normal operations conditions.
Being able to passively examine and analyze this information is key to pulling out different asset identification

information. Additionally, sometimes you will also see tags in the network as well helping you understand what
various registers and process values correlate to in the physical environment.

© 2021 Robert M. Lee 99
Example: GE Grid Solutions’ Multilin

Enterprise Systems = [
oe”. GE’s Multilin D4oo is a
substation gateway device for
collecting metering, status,
event, and fault report data

ata Historian

Daca de Comme “wuinesee To interact in the substation,

it needs to support a wide
Local HM variety of possible protocols

Single Line

"Geir [oan ||... Stwtotenbe «The graphic to the left helps

* eceusociet illustrate where you might see
> : ' er different protocols leveraged

Cs = | ee 2 | we in a substation automation

environment

Bay Protection Switches, PRP Enabling 61850 Non-PRP
Controllers Relays Meters Device Device

ICS515 | ICS Visibility, Detection, and Response 100

The point of including GE’s Multilin here is to note how the manufacturer thinks about the protocols and where
you'd find them. Importantly, it also shows how some of the protocols can be interchangeable. As an example,
you'd likely not use DNP3, ModbusTCP, and IEC-104 to communicate from a given HMI/DMS/Historian to the
gateway. It’s more likely you’d just use one and be able to poll the data necessary from the gateway.

The gateway itself can then communicate to the various devices, leveraging their native protocols such as DNP3,
61850, Modbus, SEL, or IEC104. Additionally, there is support for the various serial protocols at any given level.

Understanding the ICS protocols is useful, but it’s important to also understand their role, and what they are being
used for at a given time. That will help guide the value you extract from the protocols themselves and what they can

provide.

Reference:
https://www.gegridsolutions.com/multilin/energy/catalog/d400.htm

100 © 2021 Robert M. Lee

(By (‘®>

@®

> PDP DB PD OP OH Hh OH WP OS HP
wy a

eo we & ww

wo © Ww wo Ww |] ww Ww ww Ww Ww Ww Ww we w

we ow

ty for Root Cause Analy RTU Commands

¢ Transmission company began noticing voltage shifts at their substations
¢ Could not determine what was happening to the RTUs

¢ The team was aware that in Ukraine in 2015, commands were sent from the SCADA system to the
RTUs without operator interaction
« There was no forensics such as Sequence of Event logs available

« Incident response took place and deployed an ICS visibility solution

« Luckily, the issue continued and was picked up

« There was a bug in the SCADA system that was sending reset commands itself to the RTUs
« Analyzing the ICS protocol was the mechanism to determine this issue

ICS5I5 | ICS Visibility, Detection, and Response 101

At an anonymous power company there was a voltage shift across the transmission system and multiple substations’
RTUs were impacted. The company couldn’t figure out what was going on. They knew of a similar event occurring
in an actual adversary-based incident, and so they rightfully took precautions. After declaring it an event and calling
in an incident response team, the company determined the issue. The incident response team deployed an ICS
network visibility product that let them analyze the ICS protocols and determined that the SCADA system had a
bug that was sending reset commands to the RTUs unexpectedly. This allowed them to take the right actions, as
they now understood the root cause, and no larger impact occurred.

© 2021 Robert M. Lee 101
Lab 2.3
ICS Protocol Analysis

Calistoga Refinery |)

ICSS5I5 | [CS Visibility, Detection, and Response — 107

This page intentionally left blank.

102 © 2021 Robert M. Lee

(@) es

rTP WP WP OD OO OO WD OD DW DW DW Ow

7 ® @® @® @® @ ® ®
ww w WW @ & BS Bw ww www wo wo we Ww wo BS BS BS BS w

Course Scenario Goals (4)

* Calistoga Refinery
* What is the make and model of 10.10.20.10?

Rockwell Automation / Allen-Bradley

1756-L55/A and 1756-M12/A LOGIX5555

ICS5I5 | |\CSVisibility, Detection,and Response 103

This page intentionally left blank.

© 2021 Robert M. Lee 103
Course Scenario Goals (5)

* Calistoga Refinery

* C3PO:

What is the adversary’s IP address and domain?

What is the name of the malicious project file?

What did the adversary do to the safety PLC?

What is the malicious routine in the logic and what does it do?
What is the root cause of the attack?

Is the incident connected to C3PO’s incident?

* Create a topology of the control network.

* What is the malicious action on the HMI?

* What Register was manipulated with what value?

* What malicious file executed on the HMI and when?

ICS5I5 | ICS Visibility, Detection,and Response 104

This page intentionally left blank.

104

© 2021 Robert M. Lee

PT RP DP OP OD DP H

eo @®

oo nnnn tm? @®& 7 & DP ® ®

eS

ww we w ww we WwW Ww w

ew w w&

Case Study:
DRAGONFLY and HAVEX

ICS515 | ICS Visibility, Detection,and Response 10:

This page intentionally left blank.

© 2021 Robert M. Lee 105
- Threat group active since at least 2011

Initially targeted defense and aviation sectors

- Pivoted to targeting industrial infrastructure companies in 2013

« Common tactics include compromising websites and trojanizing
legitimate software installers to gain access, and then perform
internal reconnaissance

* Leveraged the HAVEX malware, the ond ever discovered ICS tailored

malware family

e

ICS515 | ICSVisibility, Detection, and Response

Dragonfly is a threat group identified by Symantec that has been active since at least 2011. Initially it targeted
defense and aviation sectors in Europe, giving it a classic espionage focus of state adversaries. Around 2013 the
group began targeting industrial sectors, including electric companies. Symantec assessed that the targeting was
highly focused on energy, however further analysis of victims made it clear that far more than just electric
companies were being targeted.

The interesting thing about Dragonfly to the ICS community is their use of HAVEX, which was the second ever
ICS tailored malware discovered.

Reference:
Symantecs Dragonfly Report

106 © 2021 Robert M. Lee

What is DRAGONFLY?

106

mmm DW ® WW @® © ® ® OH DH OP WH Ow

ef, ® @ @

7

mm,
we Ww J ww

What Is Havex?

¢ Havex is a Remote Access Trojan (RAT):
* Ona system, it scans for connected resources and systems to map network
topologies and gather data

* Modular malware allows various plugins/modules:
* One module looked specifically for ICS present on the network using OPC

* One module leveraged common ICS ports to gather information on what was present
* After infecting a system, it connects back to one of hundreds of Command

and Control (C2) servers:

* Useful as a backdoor to allow remote access for an attacker

* Can be used to install other malware or run executables

* Can receive commands or upload stolen data

ICS515 | ICS Visibility, Detection,and Response 107

Havex is a RAT used in espionage campaigns predating any activity related to ICS. However, when an updated
variant of Havex was found containing ICS modules, it caught the world off guard. It was the second-ever piece of
malware to have ICS-specific portions/payloads. Although other pieces of malware have impacted ICS before, this
threat was made by a well-funded, possibly nation-state team that understood ICS networks and wanted to gather
intelligence from them. It is the type of capability that would be deployed while trying to gather enough information
to create a destructive piece of malware like we saw with Stuxnet. There is no reason to be an alarmist, but this is
not a threat to be taken lightly.

© 2021 Robert M. Lee 107
DRAGONELY ICS Operations Timeline

June 2023 «July 2023
Company A Comprom
and software trejanized

May iB -dor St
Watering-hole attack
Multiote energy related wab sites

iG 1é Maid apeid Mayid junds Auge
1 August, 2026

January 20, 2044 «January 20,2018
oomoany 8 compromised
and software trojanized
250 uneque downloads:

ICS515 | [CS Visibility, Detection, and Response _ ica

Throughout 2013, Dragonfly compromised vendors as a supply chain compromise to target ICS companies. The
operations went after a few major companies, such as eWon and MBConnect, which were VPN appliances tailored

to ICS networks.

Reference:
Symantecs Dragonfly Report.pdf

108 © 2021 Robert M. Lee

Onqnnennmmmmmmmmm®menemnen ® ® ® O ®H ®&

mw
How Is it Delivered?

Phishing Emails Waterhole Attack Embedded in Installers

p> Malicious embedded -~ Most common ICS

C] i i A
_ Files .| Compromised websites version

[_] Opened to infect systems [7] Visitors redirected | Vulnerable websites

| Earliest versions (] Copy/Paste Metasploit _", Trojanized installers

_. Exploit kit triggered _. Direct into environment

__| Havex delivered

ICS515 | ICS Visibility, Detection, and Response

Havex was delivered in numerous ways, including:

* Phishing emails were sent to targets with malicious files that allowed the malware to infect the targets'
systems.
° Waterhole attack:

* Victims visiting a compromised website were redirected to a website hosting an exploit kit; this exploit
kit then downloaded the Havex malware onto the infected machines.

* The exploit kits were all well-known, publicly available exploits. Nothing about these exploits was
advanced or costly to the adversary. In some cases, they were verbatim Metasploit modules.

* Embedded in installers or firmware on vendor websites:

* The ICS version of this malware was largely seen delivered from compromised vendor websites. The
adversary knew what vendors to compromise to infect the targets they wanted, which shows another
level of sophistication.

* The vendor websites were using unpatched, vulnerable versions of web applications that allowed for the
websites to be compromised with well-known and publicly available exploits.

Havex was not advanced in and of itself. It was advanced because of the logistics and planning that went into it. It
is not easy to manage a campaign that targets thousands of facilities around the world—it is also especially costly.
Additionally, the type of data gathered was not worth a lot financially. It was worth a lot for planning and espionage
for a nation-state. These factors and others combined to give a look into a very clever use of malware that made for
an advanced threat.

© 2021 Robert M. Lee 109

too

Where Would It Land?

Level 5 — Internet/Cloud Resources ae a

= Level 3 — Plant/Site oy

= Level 2 — Supervisory Control a

me «Level 1 — Control Devices
Level 0 — Process/Sensors/Actuators

ICS515 | ICS Visibility, Detection, and Response — 10

Here is a simplified Purdue Model looking at the six levels of a well-structured network with ICS, Where would
Havex land in these areas, based on the intrusion vectors?

In the spearphishing emails, it would have likely found its way into Level 4 and maybe Level 5. In the waterhole
intrusion vector, it may have landed in Level 5, Level 4, and potentially Level 3 if folks were browsing the Internet.
But with the trojanized patches, it would have made it into the Level 2 area. Over time, the adversary’s efforts
(whether they intended it or not) walked them deeper into the ICS.

We cannot determine intent from an adversary’s code or intrusions usually, but it’s useful to note what they are
doing and what it might mean for your organization.

110 © 2021 Robert M. Lee

” & ©

@

~— ™— mm Om OO mM ®
Sd

a ae ew

vw w w | WwW Sw WwW

Who Did It

get?

Havex infected more than 2,800 victims
Used more than 50 different versions of the malware

Two original ICS victims were eWON and MB Connect Line:
* Act as OEM for various PLC supplies such as Siemens, Rockwell Automation, Mitsubishi
Electric, and more

Various individuals and companies have claimed specific target industries such
as pharmaceuticals and energy
* In actuality, various malware researchers/companies have access to limited data sets and
samples, so we have incomplete analysis

ICSSIS5 | ICS Visibility, Detection, and Response

Digital Bond identified two of the original victims as eWON and MB Connect Line. These companies deal in
manufacturing, energy infrastructure systems, wind turbines, and more as OEM providers. Symantec identified five
energy control system companies and six energy companies that were redirecting visitors to a compromised site.
Joel Langill identified multiple pharmaceutical companies as targets. Understanding what companies were targeted
not only helps identify other victims, but it also helps to understand the motives of the attackers. What is interesting
is the sheer vastness of the campaign. Think about the type of logistics it would require to use information from
thousands of facilities. All of these facilities may not have been the target. However, to have such a far-reaching
campaign, there would at least be a significant portion of this data set that was the intended target (all of them could
have been, but we cannot assume the intent of an adversary). The money and resources that go into training and
staffing individuals to analyze collected intelligence is expensive. It speaks to the sophistication of the adversary.

Obviously, there was a large interest in ICS, but there is a lot of competing analysis/evidence on exactly what
vertical was the primary target. It is more important, though, to stress how there was limited data available and that
many ICS companies did not share their threat data—so we may never know.

"Don't be a metric on the malware attacker's slide."

Reference:
http://www.digitalbond.com/blog/2014/07/02/havex-hype-unhelpful-mystery/

© 2021 Robert M. Lee 111

ut

eWON Devices in ICS Networks

1CS515 | ICS Visibility, Detection, and Response 112

Ilere we sce a reference to what eWon’s eFive VPN device would look like in an ICS network. It in essence gave
direct access to L2 and below devices in the ICS. The figure on the right shows what type of vendors eWon claimed
support of, and understanding of, their protocols. eWon in many ways was a perfect vendor to target to compromise

significant sets of victims.

Image Reference:
ewon.biz

Reference:
Belden Whitepaper Dragonfly.pdf

112 © 2021 Robert M. Lee

@

PO OH OO HH HH HF HH OH HH

m@ @ @ @ @
B

ww w WwW Ww OT OBO BW WwW WB WY Be we

Se Sw Ww

)

ww ww 5

HAVEX Communications

. Legitimate Software
HAVEX was embedded in :
legitimate installers andhad ™
hardcoded C2 servers ; pene fname

swissitaly.com ("}

egrabitsetup.exe

* Would attempt to reach out

every ~24 minutes

Sw. ssrangerSetupl. 0.14. 706.exe _None observed

Packet num |Hostname [Content Type [size [Filename

37 sinfulcelebs freesexycomics.com text/html 150 bytes tmp.php?id=62992 131148615 180900090FD80-c8a7af4196405
978 rapidecharge.gigfa.com text/html 244 kB bp~-settings~sre._php?id =62992131148615180900090FD80-c8a,
© 2085 rapidecharge.gigfa.com text/html 359 kB bp~settings~src.p! prid=6299 13; inn orerepcerpepne

opc | 3042 rapidecharge.gigfa.com text/html! 236 kB bp-settings—sre. Se ickisatiai Tass sibacbiooeseocae
3661 sinfulcelebs.freesexycomics.com text/html 150 bytes tmp.php?id=629921 31148615 180900090FD80-c8a7af4196405

ICS515 | ICS Visibility, Detection,and Response 113

HAVEX would attempt to reach out to its C2 servers roughly every 24 minutes. It used hardcoded domains, some
of which should have stood out in any analysis of traffic in these environments. More importantly, its useful to note
that the compromised VPN sessions means that the logs collected wouldn’t just be network traffic and DNS, but the
VPN logs themselves to identify these communications.

Reference:
Belden Whitepaper Dragonfly.pdf

© 2021 Robert M. Lee 113
The OPC Module

jr
(S) .rdata:10030CD0 Programm was started at %02i:%02i:%02i\n
rdata:10030020 at
-tdata:10030D28 OZ Oi: 202i. 160i:
‘-date:10030D58 sernentwetineannnntaaent
-fdata:L0030DFO a. Start finging of LAN hosts.
stdata:h0030E30 Finding was fault. Unexpective error\n
srdata:}0030E7C Was found %i hosts in LAN:\n
‘s) .dateLOO30EB4 Hosts was't found.\n
[S) .rdata:100306D¢ AA\E\E\ENE902i) [%s]\n
"| .rdata:10030F00 Start finging of OPC Servers...\n
ardata:10030F44 Was found %i, \n
-rdata:10030F80 unic... \tt%i) [%s\\%s]\n\t\NtCLSID: %s\n
|] .rdata:10030FD8 unic... \tht\tUserType: Ses\nit\titVerindProgID: — %s\n
-rdata:0031048 unic.. \t\t\tOPC version support: %s\n
(3) .rdate-t0031080 unic.. OPC Servers not found. Programm finished\n

¢ The module can identify OPC servers using WNet

* Discovered data is then zipped and encrypted

¢ It gets placed into a temporary folder or sent to a C2 server
¢ The adversary then collected and analyzed the data

sRRAARRRRA Seen REREREREREEETERRREE ERE TEER RE An

ICSSI5 | ICS Visibility, Detection, and Response

OPC stands for Object linking and embedding for Process Control. It is sometimes referred to as the Open Platform
Communications protocol. It is an extremely common protocol and can interface across numerous verticals in ICS.
The module used Windows Networking (WNet) functionality to map the network. This is an awesome play by the
adversary because it used native commands—it is unfortunate for the victim because it is harder for anti-malware
systems to identify native commands being used in the way they were designed.

In short, Windows provides an API to enumerate network resources using the command WNetOpenEnum and
WNetEnumResources. Many Windows systems in ICS with OPC also have OPCEnum, which allows for the

discovery of connected OPC-specific servers.

Interestingly, in some cases the data seemed to be stored on the perfect system, but not uploaded to a C2 server.
Meaning there was either a desire for the attacker to remotely log in and collect that data themselves, or there was
some sort of safeguard built into the malware so that it did not upload data under suspect conditions.

For the graphic above, F-Secure ran a sample of Havex on its systems. Looking at the program revealed references
to OPC servers in the code. This helped the analysts, who were not trained in ICS or engineering, to identify the

ICS connection early.

114 © 2021 Robert M. Lee

da

@)

rT mr PO OO OO HH HO HO WH WP #H wo

™ ® ® o

o
ww we Ww Ww WO WO WO WO GF OO GF DP GF FF SF Se BS w

we we w YS &

OLE for Process Control (OPC)

Designed to gather relevant
data from important systems
in a vendor neutral way
Provides a consolidated or
converged view of that with

othe
data :
OPC allows us to gather data
and generate views for the z pre.
business ~
HMIs, Alarm Servers, ‘Aiceealbdacuisnae

Control] Network

[

Historians

i .
| i

ICS5I5 | ICS Visibility, Detection, and Response

OLE is a technology developed by Microsoft and stands for Object Linking and Embedding. It is used to embed and
link to documents and other objects within an application. OPC was designed to gather relevant data from important
systems and provide a consolidated or converged view of that with data from another disparate system. Previously,
control system vendor A would need to write custom interfaces and code to see control system B data, or humans
would enter data manually. As business intelligence systems developed and users outside of the control system
environment wanted to see operations performance data, production schedules, maintenance work, etc., there was a
growing need to get data in a single system to allow viewing and access. By using OPC entities, we're able to gather
data and generate the views that were needed for the business. http://www.opcfoundation.org

Often described as the "interoperability standard” for industrial automation, OPC originally stood for Object
Linking and Embedding for Process Control. OPC was developed through industry collaboration in the late 90s and
has been specified by the community to stand for "open platform communications”. The standard has continued to
grow and evolve as it has integrated new technologies. It acts like a common bridge, allowing communications that
come to the OPC server to be provided to OPC clients. Based on OLE, COM, and DCOM from Microsoft, DCOM-
related vulnerabilities have resulted in susceptible systems using OPC. DCOM/RPC is very complex, and this
results in bugs that are difficult to anticipate and discover. DCOM-based vulnerabilities, such as MS-086, needed to
be addressed by control system end-users. Also, some consider OPC a very firewall unfriendly protocol that takes
extra care to segment properly.

OPC Servers can be a bridge for an attacker from one system to another. See the ICS-CERT advisory:
https://www.us-cert.gov/ics/alerts/ICS-ALERT- 1 1-285-01

© 2021 Robert M. Lee 115

115

ample OPC Implementation

Pe

Hardware PLC} (OPC Server OPC Client;
: Software =;

weet

ICS515 | ICS Visibility, Detection, and Response

This image was taken from a blog by FireEye on the OPC module in Havex. This picture shows a normal OPC
implementation, which should help even those unfamiliar with the OPC protocol understand the module better.
Essentially, OPC acts as a translation layer, especially when you have a highly heterogenous ICS with different
vendors, equipment, and communication methods.

Reference:
HAVEX Its Down with OPC.pdf

116 © 2021 Robert M. Lee

@, @® @ @, @, @ we ey a, @) oe (e) ao

@,

@

@
w w Ww Ww Ww

Why OPC?

¢ OPC is found in numerous ICS facilities:
* OPC is often commonly found and vendor-neutral

¢ Good for enterprise -> ICS network transition:
* OSIsoft and other companies use OPC as the "universal translator" for data historians and

business systems

¢ Theories:
Proof of concept: The attacker could have been trying a new plugin and got caught
Specific data: The wide distribution of malware could inaccurately represent the intent of
the operation
Database building: The sheer number and type of data could indicate the adversary was
building a database of networks/targets

ICSSIS | ICS Visibility, Detection, and Response

As touched on earlier, OPC is a great target because it is found in many different ICS facilities. It is also a useful
interface for translating 1CS network data to data useful for the enterprise networks, such as billing systems. OPC is
also exactly the type of interface you would want to target if you were gathering intelligence on targets. Its
capability to scan and document assets on the network make it the target for gathering important network data.
Because this interface allows different types of protocols and connections to talk together, this could have been an
attack vector to pivot from the ICS environment into the enterprise. (Although, ICS likely presented a more
lucrative target.) In addition, we could potentially be seeing a threat's first attempt at ICS malware—this could be
acting as a proof of concept, while stealing whatever data was possible to understand more about ICS. The attack
could have also been very targeted and effective. Just because there were thousands of victims does not mean
thousands of facilities were the target. Those other victims could have been accidental or a diversion tactic from the
true targets.

© 2021 Robert M. Lee 117

417

Who Used It?

° 50% energy control system victims
* Identified trojanized firmware

contractor victims

Attributed the campaign to Russian Federation

| ¢ Observed 2,800 victims worldwide and OPC module
eae, ¢ Said it was not Russia
| Yeti

|
|
|
}

ICS515 | |CS Visibility, Detection, and Response

The three main companies that have come out with claimed attribution for this campaign are Symantec,
CrowdStrike, and Kaspersky. Symantec did not make any bold claims about attribution, although it identified the
attack as Dragonfly and noted that Havex was delivered in the software bundle for firmware updates. They also
noted that the campaign started on Sept. 13 and there was another campaign March 2014-June 2014, CrowdStrike
more boldly came out in its report to state that this activity was part of a group it has been tracking for a few years;
the group, in its opinion, was most certainly of Russian Federation origin. Shortly after the CrowdStrike report,
Kaspersky Labs released its report to state that it was most certainly not Russian (but it doesn't know who it was).
Its analysis also included a module in Havex that no one else has seen or reported since. However, there were many
modules to Havex, and it was easy to swap them out with others.

118 © 2021 Robert M. Lee

a ge ff &® ® Hh B® DH HD HH @&

a oo ®
re ee a ee

ww ww w w wy ww ww w w w ww

Why the "Who" Is Less Important

True Attribution means nothing for tactical security:
* Not doing business in China or Russia following an espionage campaign by them may be a
decision made in the board room
Attribution to a group or campaign does have value
* Understanding TTPs, targets, etc. helps guide security practices

Havex persisted for multiple years against 2,800+ victims:
¢ Each victim identified could have alerted its users or others
* Each victim that found it had important threat data to share

You do not have to be a large organization to be a target:
* You do not get to decide if you are a good target

ICS515 | ICS Visibility, Detection, and Response

Often in the larger security community, it becomes the highlight of any report for there to be attribution to a
malware campaign. "Russia attacks again" or "China probes U.S. infrastructure" captures headlines quickly. And
truly, that kind of data is important (if it is accurate) for risk-informed decision making and after-action strategy
development, such as where a company should and should not do business. But true attribution means nothing for
security. The attribution of a threat to decide what type of threat (such as nation-state, cyber-criminal gang, lone
threat, and so on) is important to understand motives, but the attribution, as in the person's name or nationality, is
not valuable. The defense systems, signatures, and network configurations you utilize do not care if the attacker is
Russian or Chinese. They care about you understanding your infrastructure and understanding the threat you face. It
is important to identify TTPs, malware that is part of a larger campaign, and the motives of attackers; however,
being overly concerned about attribution is a waste of time and effort. In short, there are great benefits to security
that can be had by being able to understand the adversary’s motives based on the type of threat they are and by
being able to group the adversary and their TTPs into an identifiable group. To worry with and to try to understand
what specific cyber-crime group, what specific nation, or what the individual actor's name and Facebook profile
picture is presents far less value and is a waste when considering return on investment.

Reference:
http://ics-isac.org/robert-lee-crouching-yeti-dragonfly-energetic-bear-S-takeaways-ics-community/

© 2021 Robert M. Lee 119

119

Havex Re-Examined

Architecture: Passive defense:
* How many o days? * 146+ C2 servers
° 0 * Traffic and callouts easily blocked by
« Reused Metasploit Modules passive defenses configured to
* Vulnerable web servers known infrastructure
Patching would have eliminated the * Whitelists would have eliminated this
website/watering hole attack vector attack vector

Active defense:
* Havex performed unusual Open Platform Communication (OPC) scans:
Limits: Sensitive environment required nontraditional defenses
NSM: Easily identifiable unusual traffic/patterns or C2 servers
Incident response: Identified the backdoor/initial infection
Manipulation: Architecture changes available to sinkhole C2 server requests
Threat Intel Consumption: IOCs available for others to use to ensure < 2,800 victims

ICS515 | ICS Visibility, Detection,and Response 20

So, what about Havex? It is the successful and second-ever, ICS-specific malware. How does the Active Cyber
Defense Cycle line up? Proper architecture of the original infected sites would have eliminated the most successful
and longest running portion of the campaign (the watering hole websites). There were no 0 days used; it was all
reused, nearly verbatim Metasploit modules publicly available with well-known patches. The infection vector
would have been useless. However, if the victims that were infected from these initial websites understood their
network traffic enough to tune and maintain passive defenses (whether it were intensive as a whitelist or just basic
enough to understand that their normal network traffic didn't include DNS look-ups in the Czech Republic), they
would have identified the infection early and we'd have a lot more information about a not-as-successful campaign.

Active defense would have done exceptionally well against Havex. The OPC scans and system calls were most
certainly unusual. The C2 servers connected from OT networks to the active Internet were (or at least most
certainly should have been) unusual. Active defense could have sinkholed those domains to gather information
about the C2 servers, while neutralizing Havex's capability to steal data. Network Security Monitoring would have
identified the malware. Incident response would have identified and cleaned up the initial infection points. Threat
intelligence could have been shared throughout the community with Indicators of Compromise so that 2.8 k victims
over multiple years wouldn't be the number we are looking at for this campaign. Defense didn't fail. We failed to do
defense. But it's hard. It's not always that easy. Those victims shouldn't be shamed—they are victims. The focus is
not on showing how "terrible" these industries or sites were, but instead to show lessons learned that we can all
employ to make defense doable.

120 © 2021 Robert M. Lee

«®) me, om

Ce er ee ee ee) ee | eo
ae w

we 2 &

wwee &© 8 & © &© © & BS YB © GY WwW

me

Se

Havex in the ICS Cyber Kill Chain

“STAGE I - Intrusion Observable Steps

— 235]
Targeting ¢ oe er

— poe

Delivery | Eternal Network Hoes
(Buenas or Plant Netwesk)

STAGE 2 — ICS Attack

Develop

Test

Execute ICS Attack

Attack with Impact

ICSS5I5 | ICS Visibility, Detection, and Response

The Havex malware, used in a campaign against ICS to gather sensitive data and network architecture information
from thousands of sites around the world, was a Remote Access Trojan that was originally used for general-purpose
espionage and evolved into a criminal tool set. It was also adapted to target ICS by including new code and modules
specific to ICS environments. From publicly available information, it has been determined that the campaign took
place over the course of at least three years. The actors behind Havex utilized multiple methods to get the Havex
malware onto defenders’ networks. Three of the most common were the following:

* Sending spearphishing emails with a malicious file attached

° Infecting ICS vendor websites with malware and compromising ICS defenders when they visited those websites
(known as a watering hole technique)

* Providing a trojanized version of ICS software installers that infected the host system when staff ran the installer

These multiple methods of compromise highlight that adversaries remain flexible, and are not bound by a single
technique for delivery and intrusion when conducting a campaign. The observed techniques indicate the attackers
were successful in their planning phase of identifying weaknesses to exploit, such as the general trusting nature of
engineers and inherent trust and reliance on the ICS supply chain. Additionally, it offers three intrusions to map
against the ICS Cyber Kill Chain. In the first intrusion, the spearphishing email, the adversary would have first
performed reconnaissance to determine good targets and tailor the phishing emails. Next, the actors performed
weaponization by combining a file with an exploit and attaching it to the spearphishing email. Specific targeting
took place to choose which people would receive the email. The email itself was the delivery mechanism, and when
the user opened the file attached to the email, it exploited the system to install the Havex malware. Then, the Havex
malware attempted to communicate with one of hundreds of C2 servers. Havex then scanned the environment to
discover ICS components, collect the information and exfiltrate it to the C2 server for the adversary to gather. The
phishing email-based intrusion mostly impacted the external network. This method was less likely to provide
specific information about the ICS, except in cases where organizations kept engineering files on the business
network. The second intrusion, the infected websites, followed the first intrusion closely, but used other methods to
carry out Stage 1. Note, the intrusion against the ICS vendor websites had its own kill chain, and the adversary’s.

The HAVEX intrusions reached Stage 2 with access to the ICS networks by the time the ICS port scanning and
OPC scanning were taking place. That would qualify for the Develop stage of Stage 2.

© 2021 Robert M. Lee 124

I

GONF (Possible) Re-emergence

* In 2017 Symantec reported a re-
emergence of Dragonfly dubbed

Feature Dragonfly (2013-2014) Dragonfly 2.0 (2015-2017) Link strength

Backdoor.Oldrea Yes No None
Dragonfly 2.0

Trojan.Heriplor (Oldrea stage ll} Yes Yes Strong

* The group compromised

numerous electric companies to ‘Trojan.Karagany Yes Yes (Trojan.karagany.B) Medium-Strong
the control level and exfiltrating | pojsnussiccarogany stage) Yes ves Mediumisirong
out HMI screenshots and other
internal information “Western energy sector targeted Yes Yes Medium

Strategic website compromises Yes Yes Weak

* The assessment it was for
sabotage and strongly linked to { phishing emai Yes Yes Weak
Dragonfly 2.0 was debated

Trojanized applications. Yes Yes Weak

ICS515 | ICS Visibility, Detection, and Response

In 2017 Symantec identified the Dragonfly 2.0 group and noted that they had compromised a number of US electric
companies on the OT network side. The analysis was spot on about the compromises and was backed up by Dragos
who identified the threat group as DYMALLOY and identified numerous victims across the US electric
community. However, Symantec and Dragos disagreed on the connection to DRAGONFLY. Symantec positioned
the chart on the right as evidence of the connection, but the connections were very weak from what was presented
publicly. Additionally, Symantec noted how this meant that the group was ready to “flip the switch” on US power
generation capability. Dragos also refuted this, noting that the espionage that the group was performing, e.g.,
stealing HMI screenshots and engineering documents, was worrisome, but more evidence of the group’s inability to
be disruptive at the time. The argument was essentially that stealing such information showed the group to be ina
learning and espionage mode still. It is the type of information you would steal to eventually disrupt targets, but not
immediately be able to.

However, regardless of the debate, the group showed the continued target of ICS by threat groups and an increasing
sophistication in targeting ICS/OT networks directly.

Reference:
Dragonfly 2 Symantec.pdf

122 © 2021 Robert M. Lee

422

i)

@)

a ® ® &

af hh ®
-» ww ww w@ wow ww wow wow ww ww ww w&w ww wow ww wb ww Ww wT Ww ww w

ICS Architectures and
Topologies

ICSS15 | ICS Visibility, Detection,and Response 123

This page intentionally left blank.

© 2021 Robert M. Lee

123
Various Control System Architectures

* Many operations environments are diverse and contain a wide
variety of vendor equipment and architectures

* However, many of the more complex automation environments rely
heavily on DCS and SCADA vendors which have starting

architectures
+ These architectures get adapted and change from the original design quickly
* They are still useful to have as a conceptual understanding
» You may find logical addressing similar from plant to plant of the
same type of DCS

» Example: Emerson Ovation IP schemes can be consistent between sites

ICS515 | ICSVisibility, Detection,and Response 14

It would be a mistake to assume that there are just a few architectures that exist or a few setups of control systems
that can be memorized. However, some of the major vendors will offer a full DCS or SCADA setup for customers
or a specific setup for things like a burner management system. Many customers take advantage of this and have a
near copy/paste of the typical reference architecture. That being said, many customers also have highly diverse and
integrated environments made up of multiple vendors and there is no standard architecture.

It is useful to be aware of some of the architectures and how they operate to understand how ICS networks can be
architected.

124 © 2021 Robert M. Lee

Hy @&

7 ® & HH OO OH HH H Ww

ao @® @

na nannnaaeaa ao
wy

oOo 8 © WO OB Oo WO BH ee SP YS wb

wo WO oO Ww Ww

wo

Example: Ethylene Plant

ICS515 | ICS Visibility, Detection, and Response

Over the next few slides, we will show an Ethylene Plant view from a Siemens environment to show what a
topology can look like from plant level to network addressing. At a high level, an ethylene plant provides feedstock
for the creation of a wide variety of products throughout the petrochemical industry. A common product is polymer
grade ethylene. At such a plant, one of the interested industrial processes is a cracking furnace, sometimes known
as a steam cracker or carbon cracker. Cracking is a process where organic molecules, such as long-chain
hydrocarbons, are broken down into simpler molecules.

Reference:
digitaltwin-ethylene.pdf

© 2021 Robert M. Lee 125

125

1CS515 | ICSVisibility, Detection, and Response 126

As we focus on the carbon cracker in the plant, on the left-hand side we can see a schematic view of a carbon
cracker. On the right-hand side, a similar cracker but shown with a better understanding of the physics that is taking
place. There are lots of points in this process for sensing and measurements, as well as ensuring that the system and
process is under control. Lots of instrumentation takes place, and it needs to be monitored closely. That would take
place in the control system like a DCS.

Reference:
digitaltwin-ethylene.pdf

126 © 2021 Robert M. Lee

" ®

voeowommn he OW O® WH WH

rnnremm a

®

"> m ® ®
Oo Ww Ww we Hw Pe DP ey wD wD ee Ow

wo wo Ow Ww Ww w

wo ws Ww

we

ICSSI5 | ICS Visibility, Detection, and Response

Here we see a sample HMI of that carbon cracker from a Siemens SIMATIC PCS7 system. This DCS is displaying
a piping and instrumentation diagram of the process. We see the various measurements that are getting sensed at
any given time, and the schematic-like view that gives an operator a view into the physical process, and what
systems are operational, such as specific valves and their states (open/closed).

Reference:
digitaltwin-ethylene.pdf

© 2021 Robert M. Lee 127

427

Control System Architecture

ICS515 | ICS Visibility, Detection, and Response

Ata control system architecture point of view, we can see the Siemens system laid out at a high level, including
their SCALANCE X industrial switches, the network options for Profibus (serial) or Profinet (IP), and the different
controllers such as the Siemens SIMATIC ET 200. The Siemens SIMATIC ET 200 is a modular I/O often used
with controllers such as the SIMATIC S7-300.

This architecture would help us understand the types of devices we should be seeing on the network and what
devices wouldn’t be network visible but are still present.

Reference:
digitaltwin-ethylene.pdf

128 © 2021 Robert M. Lee

428

oeoe@neo mm © M7 DOD HD HD DH DH DH MO wH Oo

oo @

no fF © ®
eS © 6 @ BY Oo WO WY FP OS OS DS DS DS ww

w we wo Fw Ww Ww &

wy

Networking Information

ee is SERIO ena ale

Assign device name

Device name: [eT200Mnct x] Oe

™ Show only devices ofthe same type I~ Display only devices without names

ICS515 | ICSVisibility, Detection, and Response 129

The DCS itself allows the networking and control of the devices such as the ET 200M. Here we see that operators
can assign the devices networking address information and names. The IP, MAC, Device Type, and Device Name
are all great items to capture for the inventory and, more importantly to the concept of a topology, are useful in
helping decipher what we see on the network and validating it with the operations view. This information can be
gleaned passively on the network through traffic analysis, but this is a good opportunity to validate the
Configuration with what we are seeing through Traffic Analysis.

Reference:
PCS7Engineering.pdf

© 2021 Robert M. Lee 129
Westinghouse erson Ovation I&C Syst

Tegument Security (Anti-Virus) Host

Controtier(s)
1&C systems platform

ICS515 | ICSVisibility, Detection,and Response 20

Westinghouse is a well-known name in the nuclear power industry. They have custom made components and
leverage Emerson Ovation control systems and DCS as well. In this example we can get an understanding of the
topology of the ICS network to start with. Obviously, we do not have the addressing and not every asset is going to
be displayed here, but it’s a good starting point. Understanding the context and role of the systems that we will find
on the network, such as the Advant Ovation Interface Gateway and how its receiving one-way communications
from the safety system) is incredibly useful context to have. This is a standard type of deployment.

Reference:
NA-0093 Information and Control.pdf

130 © 2021 Robert M. Lee

“” tf w&

fo@me@nonmnmm? 7 @® DMD DH HD DH HN

7omnmmn @& @

a
wow wD ewe ob be De w

wow wW

w

Emerson Ovation for Concentrated Solar Power

Corporate

¢ Emerson Ovation
architecture for a
Concentrated Solar
Power plant

Note that the
architecture isn’t
solar specific until
the instrumentation
and control of the
field components

ICS515 | ICS Visibility, Detection, and Response

Interestingly, if we consider Emerson Ovation and focus there for another two slides, we’ll see that the Ovation
setup is pretty similar by default to start with, regardless of the industry its used in. Here they map to a Purdue-like
model and give an architectural view of what the network will look like from an operator Windows HMI/EWS
perspective, as well as the Ovation controllers and what’s behind them. We also see that there should be Smart
Wireless Gateways on the network and wireless devices down below.

Focus though on the very bottom that talks through the different interactions with the physical layer and other
remote I/O located at the Concentrated Solar Power facility.

Reference:
Ovation DCS and SCADA for CRPs.pdf

© 2021 Robert M. Lee 131

$31

Emerson Ovation for Hydroelectric Plant

Ovation) SCADA Architecture
for Large Hydroclectric Piants

« Asan example, the
hydroelectric plant
architecture is identical
to the solar architecture

OEM architectures for
different integrated
product lines often
remain similar

The networks, specifics,
customization, etc. all
become highly different

ICS515 | ICS Visibility, Detection, and Response

Compare what we see here to the Concentrated Solar Power plant in the previous slide. It’s the exact same setup
with the Smart Wireless Gateway moved from the right side of the screen to the left. This isn’t clever marketing,
it’s just that from Emerson’s perspective, as other OEMs, the automation systems they build, and the controllers are
meant to be repurposed and used in a variety of different environments. So the topology will change when we get
into the network and see the different setups and interactions, but many of the components and some of the higher-
level architecture may be very similar, not only from site to site but industry to industry. Being familiar with this
will speed up our assessments and identifying of assets and their communications.

Reference:
https://studylib.net/doc/183 15893/ovation-dces-and-scada-solution-for-hydroelectric-power-pl...

132 © 2021 Robert M. Lee

432

“- @&

om@?me@oeen® © ® WHHH HH WH NH

Qo @D @® &® &®

a

oo Ye wy &

w

w

vy Fe wo WO ww Ww

ee YS 6 S&S SC EB GF BY YG

w

Case Study: Electric Grid Control Cente

Primary Control Center

* What are the critical functions?
* Collect and evaluate from the
primary
* Quickly assess the backup to
ensure functionality
* How would you do data collection?

* Windows-based environment
* Focus on core systems and those
with redundant systems
* What would be interesting?
* Is adversary positioning in the
backup systems first?
* Is the adversary on any training fonminaiiddnamene

systems? r connected through corporate,
an -e leased, or dedicated SCADA
communications paths

ICS515 | ICS Visibility, Detection, and Response

Consider this sample architecture of an electric grid control center. We have the Primary Control Center (PCC) and
the Backup Control Center (BCC). The two are likely connected in a number of ways but not without passing
through security systems such as firewalls. The control center is using a Distribution Management System (DMS)
which is utilized to reduce downtime, efficiency, schedule work, maintain awareness on outages and repairs, and
ultimately serve as the supervisory control for the distribution of electricity. The Energy Management System
(EMS) here is just a test environment. An EMS is usually focused on increasing the efficiency and maintaining
balance for the generation and transmission of electricity.

In this environment, we’d have to know ahead of the incident what the critical functions were. An infection of any
targeted nature in both the PCC and the BCC would be cause for great concern, whereas an infection in just one
would be alarming but not as dire since the backup is maintained. Data collection would likely need to be
coordinated, especially if there was any physical separation for these sites. However, even in the same control
center, we’d want to focus on taking data from systems such as the control servers, operator stations, and
engineering stations before attempting to evaluate file and print servers, backup office servers, support systems, etc.
We'd need to scope the entire environment, but it’s important to focus on collecting data from the core systems and
the ones that had redundant systems. As an example, there might be five different HMIs and there may only need to
be one or two in operation at a time.

What the adversary is doing in the environment could also be very telling for-us. Are they positioning in the backup
environment first and then attempting to gain access to the PCC? This could be an attempt by a smart adversary to
cripple the control center. Are they in the EMS test environment and exfiltrating off data? They may likely be in the
earlier stages of the ICS Cyber Kill Chain and not have good familiarity with the environment. ~

© 2021 Robert M. Lee 133

133

Honeywell Experion HS SCADA System

* Many components of
any DCS/SCADA/etc.
type architecture will
be similar including
data servers, historians,
EWS, HMI, PLCs,
IEDs, etc.

The designs do change
for different types of
processes such as a
Burner Management
System

1CS515 | ICS Visibility, Detection, and Response

The architectures between different vendors are roughly going to follow the same structure of having data servers
and historians, operator stations such as HMIs and EWS, and controllers like PLCs. The higher-level architecture
tends to conform to the industry approach. The components themselves, their communication links, and how they
integrate with other components will be different. Comprehending this can simplify the approach to trying to
quickly understand different ICS locations. This is specifically comparing vendors. When we view completely
different types of processes (batch vs. discrete vs. continuous as an example) or industries, we often times will find
significant differences.

Reference:
HoneywellProcess.com

134 © 2021 Robert M. Lee

‘)

nn nnenm} wh ® ww

ao

2

onan om @

on
wy

»o » @&

vy YY YY ww» wD wD Ww

wo © oS & G&S YB YS YY wow wy

SS

Rockwell Automation Plant Control System

Converged Plantwide Ethernet
. . . industrial Network Model
Different industries at comoate ote

times will have different TH xsi ace Hf Applications,
: | ~~ ont | a Internetworking,
architectures and [| | Data Servers,

back-office Mainframes and_/ Fai, 1 Storage
dependencies Servers (ERP, MES, etc.) Lf

This Rockwell focused & t i} a

Controller

plant highlights the || Superior | sft conte |
necessity of the ERP and - | =<

Human Machine Safety 7 1 8 Human

£ ‘. a Interface (HMI | | po fPoofiid Machi
MES in this environment "=" && tors ives) 0 Lecbeobent BB ics
ISOS at (HM)

| |

Ri i | Other h

cbs FS ‘op er npulOutpu
Industrial Network

EtherNeviP>>

ICS515 | ICS Visibility, Detection, and Response 135

In the example above, we see a Rockwell architecture for a converged plantwide industrial network model. You’ ll
note that there are connections to corporate for data sharing and processing, as well as connections to “back-office”
systems the plant depends on such as the Enterprise Resources Planning (ERP) system. The ERP system manages
business processes such as order fulfillment, tasking, and shipping information. The Manufacturing Execution
System (MES) is an important part of most manufacturing processes where the full tracking and documentation of
raw materials to finished goods is done. While these may seem like IT systems, they are definitely OT systems; if
they go down, the manufacturing process will be impacted or have to shut down completely.

The basic principles behind all ICS still apply with HMIs, actuators, controllers, EWS, etc., but the types of systems
you’d expect to find and the higher-level architecture of the manufacturing plant may be completely different than

what you’d expect to find in a carbon cracker.

Reference:
Rockwellplantwide.pdf

© 2021 Robert M. Lee 135
OSlsoft Pi Historian

* Beyond the traditional
ICS network components, Avion
it’s incredibly important
to understand the

architecture of historians

and different efforts to

optimize the plant or take -
advantage of digital
transformation initiatives |

These can often reveal
dependencies or cloud
connectivity

ICS515 | ICS Visibility, Detection, and Response 136

As important as it is to understand the ICS, it’s also incredibly important to understand the architecture of the data.
Historians are a great example of a system in ICS networks that are not only there to help troubleshoot and
understand failures, but to also offer opportunities to optimize the ICS with more efficient production processes.
Additionally, the historian information can be useful in billing and tracking what is being done at the plant. As an
example, you might use a Pi Historian to help understand how much electricity is being used by an industrial
customer to bill them appropriately.

The Pi Historian architecture in this case won’t relate directly to the networking topology, but at a high level we can
quickly understand what types of connections we should be seeing. We might find a Pi Vision connection back to
the corporate network, but also might find direct connections out to an AWS cloud server. The OPC
communications internally between controllers back to the historian at the plant would also be important
communications to be prepared to find.

Reference:

https://www.automationworld.com/analytics/article/2117381 2/data-analysis-helps-glassmaker-see-through-its-
processes

136 © 2021 Robert M. Lee

roeow@eeon@ewnnn»#wnnmnnm wm @

@ @ @ im ® dD @@

ft 2D
wwe ew wv» wm Dy vw wo wD w

w w aw

w

>

2

ay ay aw as

as

Topology Maps

¢ Value:
* Create network drawings, data flows, and application interaction diagrams to understand
how the network looks and what can be considered normal activity
* Have reference points easily available for incidents
* Source:
* Open-source and paid tools are available
* Document findings on digital or physical maps
* Methodology:
* Use traffic analysis, config files, and available information to understand the network
* Document your findings along the way, even if temporarily hand-drawn
* Build a comprehensive network picture with the date of the information
* Always safely and securely store network diagrams

ICS515 | ICS Visibility, Detection, and Response

Identifying and validating assets and networks is ultimately useless if you do not document the findings. Topology
maps should be created for the network and assets as well as the data flows and application interactions. The most
important map to create is the network and asset map. After that is correctly done, it is then important to move to
the data flow, which would be the type and volume of data that is normal, instead of just the connections between
devices. Lastly, it is important to document the applications and services on the network and how they interact.
Network architecture teams should be providing most, if not all, of this information to active defense personnel. In
the real world, though, it is common that active defense personnel need to identify this by themselves.
Architecture maps are usually outdated or poorly constructed. When you have these maps, be sure to share them
with the architecture personnel.

Document everything you have found through scanning, traffic analysis, physical inspection, and configuration
file analysis. Combine your documentation with any known or supporting information. This information may
come in the form of help from operators and engineers, or from purchase orders. (Follow the money!) It is best to
use hand-drawn maps while you are taking initial notes on what is present on the network. However, hand-drawn
maps are not a permanent solution. Eventually, you will want to build a comprehensive map (or one each for the
network and its assets, data flows, and application interaction) to work from and share. Understanding your threat
landscape and performing network security monitoring is going to be difficult without this regularly updated map.
One free way to build such maps is to use the OpenDraw tool, which is part of the larger free OpenOffice suite. It
is essentially an open-source version of Visio. It contains icons that can be used to represent assets and network
devices, as well as connections between them. However, as with most free tools, it is more time-consuming than
purchasing something such as Visio, or using a more robust tool.

© 2021 Robert M. Lee 137

Case Study: Example Oil Rig Ballast Control System

* Offshore oil rig
* Ballast control system and a
safety system for each leg
* Mostly flat network
* Two network segments
* Purdue levels are conceptual
* Multiple collection points
* mGuard firewall for ingress
and egress communication
* Network switch (ICS side) for
inner control network
communications

ICS515 | ICS Visibility, Detection,and Response 138

To understand how protocols can work together in an ICS, consider an offshore oil rig’s ballast control system. The
system is important to the rig to make sure it stays afloat properly without becoming unbalanced or tipping over.
Each “leg” of the rig has its own ballast control system and, in this setup, also has a safety system. The ballast
control system in this case is operating on a network that has an mGuard Firewall (a type of ICS firewall from
Phoenix Contact that does deep packet inspection on ICS protocols. In many cases, these are also able to support
port mirroring). The rig is thus remotely accessible through the VSAT and through various remote access points for
the control system vendor and integrator. The rig has a server farm like a normal IT network and has numerous
communications ongoing. Inside the control network, it is all a fairly static process. The next slide will go into
further detail on the ICS network itself.

138 © 2021 Robert M. Lee

@

ror 8 OO DO wh oO

oo @ @ @ @ @

@®

wow ww» Pw Pp ww YD wD w

we wo OW WwW Ww Ww Ww Ww

Ww

Case Study: Oil

Protocol
© Frame c Soa PINES eV Aa! iim ieee

© Ethernet

© Intemet Protocel Version 4

© Transmission Control Protoco! Ballast Control System Ballast Safety System

| EtherNet/lP (Industrial Protocol) B mee [a] eee
® Common industrial Protocol = Read/Write =

iE
© TPKT - ISO on TCP - RFC1006

ISO 8073/X.224 COTP Connection-Oriented Transport Protocol
© Modbus/TCP
Text item
{NetBIOS Session Service
\F User Dategram Protacol

--an-n-n-=====-BPCS Serial Request for SI&—-----——-----|

Address Resolution Protocol
Link Layer Discovery Protocol

* Modbus TCP and EtherNet/IP for the Rockwell PLC operating the Ballast Control System
* SZ over ISO-TSAP for the Siemens-based Safety System (LLDP also issued by the Siemens PLC)
* NetBIOS specific to the Microsoft-based Windows HMI with predictable requests

ICS5IS | ICS Visibility, Detection,and Response —_139

If we dig into the terminal bus network for the ballast control system on this oil rig, we'll find that each leg (four on
the rig) has a ballast control system and a safety system. The screenshot shows a drawing of one of the legs. The
HMIs are Windows-based systems and, in this specific case, are operating out of a virtual machine although that
cannot be discerned in the picture (utilizing NetBIOS which can be searched in Wireshark using the “nbns” filter.
Checking for the NetBIOS in a network can help reveal names of systems as well as potential infections as systems
call out to nonpredictable requests. Predictable requests would be things like “Adobe” on systems that have Adobe
Reader). One HMI is dedicated to the Rockwell PLC and utilizes Modbus TCP and CIP over EtherNet/IP for
monitoring and control. The safety system has a serial communication (PROFIBUS in this case) connecting it to the
PLC so that it can take control if there is an unsafe situation. The safety system is a Siemens PLC and is connected
to another HMI and is communicating via S7 over the ISO-TSAP protocol. The Siemens system is also using LLDP
to broadcast its information.

© 2021 Robert M. Lee 139
Ai on

Topologies Manually Created

Tshark Conversations

* Leverage open-source tools to identify
communication records

IIPva Conversations
Filter:<No Filter>

om ®

192.168.1.
192.168.1.
192.168.1.
192.168.1.
192.168.1.
192.168.1.
192.168.1.

¢ Sre/Dst IP, Sre/Dst Port, Protocol 192.168.1.

192.168.1.

* Capture in text form of manual drawing 2.1681.

1292.168.1.

such as Visio diagram 192. 168.1.

VVVV UNV

192. 168.1.
192. 168.1.
192. 168.1.
192. 168.1.
Ethemet: 19 @ IPva: 9) IPv6: 3. A uP » Sip] ]192. 168.1.
192. 168.1.
239.255.255.258
* | Porta Address 8 Port B a 239.255.255.250

Wireshark’s Conversations

10.0.6.204
192.168.1.1
192, 168.1.193
192.168.1.253
A9638 992 168:1.57 EtherNet-iP-2° 224.0.0.22 -> 192.168.1.253
49690 192.168.1.20 asa-appl-proto I224.0.0.22 192. 168.1.
49689 192.168.1509 EtherNet-IP-2 224.0.0.252 -> 192.168.1.
1
1
1
1

oo ®

192.168.1215 49717 192.168.1.30 iso-tsap 192.168.1.255 192.168.1.
192.166.1175 49869 192.168.1.51 EtherNet-tP-2 192.168.1.255 -> 192.168.1.
192.168.1.5 49689 192.168.1.51 EtherNet-tP-2 192.168.1.255 192.168.1.
192,168.15 49690 192.168.1.50 EtherNet-tP-2 224.0,.0.252 192.168.1.

mn @®

ICS515 | ICS Visibility, Detection, and Response 140

While professional tools are nice it is entirely doable to create topologies manually using open-source tools. As an
example, leveraging Wireshark as we’ve done in the labs, or Tshark from the command line, to identify and capture
conversations is perfectly reasonable. The problem is this topology is a point in time and not continuously updated
as you would expect in a professional tool. However, this is a great starting point, especially when you are doing an
assessment of a network to try to identify the connections and map it against the ICS architectures you are already
familiar with.

mm ®

It is important at a minimum to capture the Five Tuple information (Src/Dst IP, Sre/Dst Port, and Protocol).

nm @

140 © 2021 Robert M. Lee

=
Y

fp
oe we wZ

we ww wh

ww WwW wW

Se Fee eeEewey w@B ww wy w

w&

Professional Tools: ' Open Source:
Dragos Platform Industrial Defender GRASSMARLIN
Tenable/Indegy Forescout/SecurityMatters

Nozomi

ICS5I5 | ICS Visibility, Detection,and Response 141

Wireshark, TCPdump, and Tshark will always be good options, but professional tools built for ICS networks often
have features useful to an ICS network, such as understanding the ICS protocols, utilizing ICS protocols to safely
identify assets, or utilizing purely passive methods to identify systems. These tools also usually have visualization
features to make topology maps.

GRASSMARLIN was developed by the NSA’s Information Assurance Directorate and released to the public here:
https://github.com/nsacyber/GRASSMARLIN.

It is also now available to interface with the DHS CSET tool.

Ferrett is specifically a Rockwell tool for finding Rockwell devices on your network. It interacts with the systems to
determine the configuration status. You should look to your vendors to determine if they have any similar tools.

Professional tools include Dragos’s Dragos Platform, Tenable.OT/Indegy, Industrial Defender,
Forescout/SecurityMatters, and Nozomi. There is also an educational focused tool that is provided in class for free
called CyberLens—also produced by Dragos back in 2013 as one of the community’s first assessment asset
identification tools. It does not share any code or similarities to the Dragos Platform, but it is something that the
team has maintained so that it can be used in SANS classes for educational purposes.

© 2021 Robert M. Lee 144
Educational Tool Case Study: CyberLens

° Value:
Captures network traffic live off the network or analyzes captures taken from pre-existing
infrastructure offline
Performs deep packet inspection to identify IT and ICS protocols
Provides rich, granular netflow data to visualize the network, its required services, and timeline data
useful for analysis and incident response

Performs metadata analysis to protect privacy data and store at 1% of peap

¢ Source:
« Assessment tool just for educational purposes
* CyberLens is *NOT* the Dragos Platform, which is an ICS platform with asset identification, intel,
and response capabilities

° Methodology:

* Use to capture and analyze traffic in real time or input packet captures
* Use its automated analysis features to provide network topologies and basic deep packet inspection

ICS515 | ICSVisibility, Detection, and Response

CyberLens was specifically created for the ICS community. It performs deep packet inspection on protocols to
identify I/O and protocol commands of IP-based communication. Additionally, it has a number of features for
automated reports, baselines, and timeline analysis. Useful to understand for this section is the ability for
CyberLens to identify assets and visualize the network. This highlights the power of passive scanning and its ability
to see the natural and true network flow without manipulating data with active scanning. The tool is commercial,
but the company is releasing a free at-home version to get analysts familiar with the value of these types of tools,
and to help understand and protect home networks.

**Disclaimer: The course author is one of the developers of CyberLens. This is not meant as a product pitch, or to
indicate that CyberLens is better than any other product. The purpose of this slide is simply to visualize the type of
functionality passive scanning offers and the importance of understanding various layers through Deep Packet
Inspection. Also, the tool is completely free. It’s not the Dragos’s tool - it’s just a free tool to folks to help them get
started.

The reason for highlighting this case study is to identify some core features that any professional asset tool should
have. The next few slides will show some of those features.

Reference:
https://dragos.com/

142 © 2021 Robert M. Lee

@

@

> om. a] om

o.

=

?=

=

>
we ww ww ‘es

Fw we Vw VY VV Ve VP Ve Vey wy WP Ww Ww Ww wh

w

In RELICS we will start the CyberLens
application and go to the Server Console to start
the server or ensure it’s running

EULA®

Sign in

Server Port (Default 133718

, —

ICSSIS5 | ICS Visibility, Detection, and Response

This page intentionally left blank.

© 2021 Robert M. Lee 143

143

CyberLens Loading Pcaps

After starting
the server we'll
navigate the
sensor page,
select a file to
upload the peap
(in this case the
baseline of
Calistoga Water
Utility) and
then click
Upload

This page intentionally left blank.

144

interface options

eno

Window size @

Baisancics. Ba besktop | 1cssi5, fae
Jarge_bas

Name

ently Used smaill_baselinegcop
fy sansics
By Desktop
GB ile System
ee Step 2:
Ed ropay nick Doubla cick
Upload PCAP:
sep 3

Click “upload” after the
file,is loaded

Abies leper than Sosa may tae Pome to process on th

ICSSIS | ICS Visibility, Detection, and Response

© 2021 Robert M. Lee

144

“of @&

owen © © ® OD OH DH OH &

o 7”

oe

.®s
we wo wo w

Vv vw eyyvrvsve ve VveerVewVevVvevyvevw YB Www ww

The Window Size relates to the granularity of the
changes we observe in the timeline; we aren’t
investigating small changes via a timeline so 2
minutes is fine here.

CyberLens Processing the Pcap

Suep'3:
Change ta?

Start the processing and it'll notify when it’s done.

Stop 2
Solect Minutes

Step 4:

—o Click Start

Elapsed Time: 0¢.00:0m

ICS515 | ICS Visibility, Detection,and Response 14s

This page intentionally left blank.

© 2021 Robert M. Lee 145
CyberLens Viewing the Map

Once the pcap is processed we'll choose
Interactive Map, click the Start button to review
Interface options the Offline Capture, and then choose a Tree
Layout to make the map look better

Load
Lve/Offline Capture

, Archives
Sensor id

1 Snapshots

Compare
Current Map

192.168.1.20
(00:20:45:06:08:46
Phoenix

1CS515 | ICSVisibility, Detection, and Response — 146

This page intentionally left blank.

146 © 2021 Robert M. Lee

» > >» >» > Hh ® ®

wm

m)

ao f. @& & th HF

a @
ww ww we w

Ly

ia

4

Ww we

vu vv Vv Ve Ve ve ve Vee wVPeVywyw wy

CyberLens Reviewing Ma

At this point you
can review the map
as you'd like and
structure it into
zones that make
sense for you

Additionally, er
h : i . 168, eas poorereneoren
selecting devices 00:10:9¢:a0:a9:50 | (Ys tai tae we Bars
will show you Rockwell pte
information about
them such as the
protocols they’ve

been seen using “ ol
sso
po |

ICSS515 | ICS Visibility, Detection, and Response

This page intentionally left blank.

© 2021 Robert M. Lee 147
Control Zone

aweuseag ered (2) Operations Level

it  eaieaede

192,108.1.2%
oreea.90: 0-07 (2)
Prone

uaz ine.3.05
Done 7 S08 tee
Raastome

set:9NCO GOD: DOI: Tab TRIRT ASAIO
careers
Veore

192. 20m2.258
s80.9000:0000;0800 IAZR:4A IOI AE
henkarsetO4 3636

ICSSI5 | ICS Visibility, Detection, and Response 148

CyberLens is one example of a passive network scanning tool that performs deep packet inspection for ICS
communications. There are two things to specifically notice about this map. First, because the network wasn't
scanned actively, the "network flow" represented by the various lines between devices is the naturally occurring
flow. If this map was generated from active scanning, there would be additional lines between what device scanned
the network and all the other devices that it communicated to. The second thing to notice is the icon on the map
with the red arrows pointed to it, which will be zoomed in to on the next slide.

You should be able to simply visualize and navigate (such as using the timeline bar at the bottom) the network
traffic. Professional tools should help save analyst time by making the experience interactive, easy, and visual.

148 © 2021 Robert M. Lee

m™m we

PP?) mH ®

ronrmnr © ® ® © OO © ® ®

oa
we ee ee wh

we Ve vevevsese eee ye Vv wy wwwwiww

Lab 2.4
ICS Network Mapping

ICS515 | ICS Visibility, Detection,and Response 149

This page intentionally left blank.

© 2021 Robert M. Lee 449
Course Scenario Goals (6)

° C3PO:
+ Create a topology of the control network.

ine _ Hs,

00:0¢:29:45R4 86 ti
Vonweave’ 2.168.0.10
Tesh2c7:05
. KoyoEiec
192.168,

168,08
00:00:29:7b:ad:74
‘Vmware

ICSS15 | ICS Visibility, Detection, and Response

This page intentionally left blank.

150 © 2021 Robert M. Lee

150

nO H OH © H ©

oo®?® @®©® @ @®o 9 MO HMO WH ®

ao m®
iw

ww

Course Scenario Goals (7)

* Calistoga Refinery

What is the adversary’s IP address and domain?

What is the name of the malicious project file?

What did the adversary do to the safety PLC?

What is the malicious routine in the logic and what does it do?
What is the root cause of the attack?

Is the incident connected to C3PO’s incident?

* C3PO:

* What is the malicious action on the HMI?
* What Register was manipulated with what value?
* What malicious file executed on the HMI and when?

ICSS5I5 | ICS Visibility, Detection, and Response

This page intentionally left blank.

© 2021 Robert M. Lee 4151
